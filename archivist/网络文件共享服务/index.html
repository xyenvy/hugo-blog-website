<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>网络文件共享服务 | Cookie</title>
<meta name="keywords" content="">
<meta name="description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件">
<meta name="author" content="Cookie">
<link rel="canonical" href="http://hugo.itshare.work/archivist/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://hugo.itshare.work/img/Q.gif">
<link rel="apple-touch-icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="mask-icon" href="http://hugo.itshare.work/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="网络文件共享服务" />
<meta property="og:description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hugo.itshare.work/archivist/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/" />
<meta property="og:image" content="http://oss.itshare.work/itshare-work-images/2.jpg" /><meta property="article:section" content="archivist" />
<meta property="article:published_time" content="2022-12-04T12:03:44+00:00" />
<meta property="article:modified_time" content="2022-12-04T12:03:44+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://oss.itshare.work/itshare-work-images/2.jpg" />
<meta name="twitter:title" content="网络文件共享服务"/>
<meta name="twitter:description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📒归档",
          "item": "http://hugo.itshare.work/archivist/"
        }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "网络文件共享服务",
      "item": "http://hugo.itshare.work/archivist/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "网络文件共享服务",
  "name": "网络文件共享服务",
  "description": "Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件",
  "keywords": [
    
  ],
  "articleBody": "NFS服务 NFS工作原理 NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure CallProtocol 远程过程调用）实现。 RPC采用C/S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行。\nNFS优势：节省本地存储空间，将常用的数据,如：/home目录，存放在NFS服务器上且可以通过网络访 问，本地终端将可减少自身存储空间的使用。\nNFS软件介绍 软件包：nfs-utils（包括服务器和客户端相关工具，CentOS8 最小化安装时默认没有安装），nfs-common(Ubuntu中包名)\n相关软件包：rpcbind（必须），tcp_wrappers\nKernel支持：nfs.ko\n端口：2049(nfsd), 其它端口由portmap(111)分配\nNFS服务主要进程：\nrpc.nfsd 最主要的NFS进程，管理客户端是否可登录 rpc.mountd 挂载和卸载NFS文件系统，包括权限管理 rpc.lockd 非必要，管理文件锁，避免同时写出错 rpc.statd 非必要，检查文件一致性，可修复文件 说明：CentOS 6 开始portmap进程由rpcbind代替 日志：/var/lib/nfs/ NFS配置文件\n/etc/exports /etc/exports.d/*.exports 常用选项\n默认选项：(ro,sync,root_squash,no_all_squash) ro,rw 只读和读写 async 异步，数据变化后不立即写磁盘，先写入到缓冲区中，过一段时间再写入磁盘，性能高,安全性低 sync（1.0.0后为默认）同步，数据在请求时立即写入共享存储磁盘,性能低,安全性高 root_squash （默认）远程root映射为nfsnobody,UID为65534，CentOS8 为nobody,CentOS 7以前的版本为nfsnobody no_root_squash 远程root映射成NFS服务器的root用户 all_squash 所有远程用户(包括root)都变成nfsnobody,CentOS8 为nobody no_all_squash （默认）保留共享文件的UID和GID anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非nobody,可配合all_squash使 用 NFS工具 rpcinfo rpcinfo 工具可以查看RPC相关信息 查看注册在指定主机的RPC程序\nrpcinfo -p hostname 查看RPC注册程序\nrpcinfo -s hostname exportfs exportfs:可用于管理NFS导出的文件系统 常见选项\n-v #查看本机所有NFS共享 -r #重读配置文件，并共享目录 -a #输出本机所有共享 -au #停止本机所有共享 showmount 常见用法：\n#查看远程主机的NFS共享 showmount -e hostname mount.nfs 客户端NFS挂载 NFS相关的挂载选项：man 5 nfs\nfg #（默认）前台挂载 bg #后台挂载 hard #（默认）持续请求 soft #非持续请求 intr #和hard配合，请求可中断 rsize #和wsize 一次读和写数据最大字节数，rsize=32768 _netdev #无网络服务时不挂载NFS资源 vers #指定版本，客户端centos8默认4.2 ，centos7默认4.1 centos6默认4.0 提示：基于安全考虑，建议使用 nosuid,netdev,noexec 挂载选项\n实战案例 NFS服务器安装软件 yum install -y nfs-utils # 启动rpcbind systemctl start rpcbind # 启动nfs-server systemctl start nfs-server NFS服务器创建共享文件 # 共享根目录下的share目录 mkdir /share 添加uid和gid为300的用户nfs-upload [root@centos7-master ~]# groupadd -g 300 nfs-upload [root@centos7-master ~]# useradd -u 300 -g 300 nfs-upload [root@centos7-master ~]# #修改所属组权限 [root@centos7-master share]# chown -R 300:300 /share 修改NFS服务器配置文件 [root@centos7-master ~]# vim /etc/exports # 加入如下内容，*表示任何人，rw表示读写 /share/ 192.168.179.*(rw,anongid=300,anonuid=300) 重新加载配置 # 重新加载配置文件 [root@centos7-master ~]# exportfs -r [root@centos7-master ~]# exportfs -v /share 192.168.179.*(sync,wdelay,hide,no_subtree_check,anonuid=300,anongid=300,sec=sys,rw,secure,root_squash,no_all_squash) [root@centos7-master ~]# 客户端安装软件 yum install -y nfs-utils # 启动rpcbind systemctl start rpcbind # 启动nfs-server systemctl start nfs-server 添加用户和组 [root@centos7-slave /]# groupadd -g 300 nfs-upload [root@centos7-slave /]# useradd -u 300 -g 300 nfs-upload 在客户端挂载，挂载/nfsshare目录下 # 创建目录 mkdir /nfsshare # 查看服务器端可挂载点 [root@centos7-slave ~]# showmount -e 192.168.179.170 Export list for 192.168.179.170: /share * [root@centos7-slave nfsshare]# # 挂载方式1，关机重启会失效 [root@centos7-slave ~]# mount 192.168.179.170:/share/ /nfsshare # 方式二修改配置文件，关机重启不失效 [root@centos7-slave ~]# vim /etc/fstab # 加入如下内容 192.168.179.170:/share /nfsshare nfs defaults,_netdev 0 0 # 使配置文件生效 [root@centos7-slave nfsshare]# mount -a [root@centos7-slave nfsshare]# 测试 # 在客户端上查看/nfsshare的内容 [root@centos7-slave nfsshare]# ll total 8 -rw-r--r-- 1 nfs-upload nfs-upload 5 Dec 5 23:14 a.xtx drwxr-xr-x 2 nfs-upload nfs-upload 6 Dec 5 23:17 newfile -rw-r--r-- 1 nfs-upload nfs-upload 17 Dec 5 23:11 test.log [root@centos7-slave nfsshare]# # 在服务器端查看/share目录 [root@centos7-master share]# ll total 8 -rw-r--r-- 1 nfs-upload nfs-upload 5 Dec 5 23:14 a.xtx drwxr-xr-x 2 nfs-upload nfs-upload 6 Dec 5 23:17 newfile -rw-r--r-- 1 nfs-upload nfs-upload 17 Dec 5 23:11 test.log [root@centos7-master share]# 数据的实时同步 实时同步技术介绍 实现实时同步的方法\ninotify + rsync 方式实现数据同步 sersync ：前金山公司周洋（花椒直播）在 inotify 软件基础上进行开发的，功能更加强大 工作原理：\n要利用监控服务（inotify），监控同步数据服务器目录中信息的变化 发现目录中数据产生变化，就利用rsync服务推送到备份服务器上 inotify：\n异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如cron等的轮询机制来获取事件，linux内核从2.6.13起支持 inotify，通过inotify可以监控文件系统中添加、删除，修改、移动等各种事件\n实现inotify软件：\ninotify-tools sersync lrsyncd inotify+rsync使用方式\ninotify 对同步数据目录信息的监控 rsync 完成对数据的同步 利用脚本进行结合 实现 inotify 内核是否支持inotify Linux支持inotify的内核最小版本为 2.6.13，参看man 7 inotify\ninotify 内核参数说明：\nmax_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错 误，默认值：16384, 生产环境建议调大,比如:327679 max_user_instances：每个用户创建inotify实例最大值，默认值：128 max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大 inotify-tools工具 inotify-tools参考文档：https://github.com/rvoicilas/inotify-tools/wiki 安装inotify-tools：基于epel源\nyum install epel-release yum -y install inotify-tools inotify-tools包主要工具：\ninotifywait： 在被监控的文件或目录上等待特定文件系统事件（open ，close，delete等）发生， 常用于实时同步的目录监控 inotifywatch：收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计 inotifywait 命令 格式:\ninotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ] 常用选项\n-m, --monitor 始终保持事件监听 -d, --daemon 以守护进程方式执行，和-m相似，配合-o使用 -r, --recursive 递归监控目录数据信息变化 -q, --quiet 输出少量事件信息 --exclude 指定排除文件或目录，使用扩展的正则表达式匹配的模式实现 --excludei 和exclude相似，不区分大小写 -o, --outfile 打印事件到文件中，相当于标准正确输出，注意：使用绝对路径 -s, --syslogOutput 发送错误到syslog相当于标准错误输出 --timefmt 指定时间输出格式 --format 指定的输出格式；即实际监控输出内容 -e inotifywait 的–timefmt 时间格式 参考 man 3 strftime\n%Y #年份信息，包含世纪信息 %y #年份信息，不包括世纪信息 %m #显示月份，范围 01-12 %d #每月的第几天，范围是 01-31 %H #小时信息，使用 24小时制，范围 00-23 %M #分钟，范围 00-59 %S #秒，范例 0-60 范例：\n--timefmt \"%Y-%m-%d %H:%M:%S\" inotifywait 的 –format 格式定义\n%T #输出时间格式中定义的时间格式信息，通过 --timefmt option 语法格式指定时间信息 %w #事件出现时，监控文件或目录的名称信息，相当于dirname %f #事件出现时，将显示监控目录下触发事件的文件或目录信息，否则为空，相当于basename %e #显示发生的事件信息，不同的事件默认用逗号分隔 %Xe #显示发生的事件信息，不同的事件指定用X进行分隔 范例\n--format \"%T %w%f event: %;e\" --format '%T %w %f' inotifywait -e 选项指定的事件类型\ncreate #文件或目录创建 delete #文件或目录被删除 modify #文件或目录内容被写入 attrib #文件或目录属性改变 close_write #文件或目录关闭，在写入模式打开之后关闭的 close_nowrite #文件或目录关闭，在只读模式打开之后关闭的 close #文件或目录关闭，不管读或是写模式 open #文件或目录被打开 lsdir #浏览目录内容 moved_to #文件或目录被移动到监控的目录中 moved_from #文件或目录从监控的目录中被移动 move #文件或目录不管移动到或是移出监控目录都触发事件 access #文件或目录内容被读取 delete_self #文件或目录被删除，目录本身被删除 unmount #取消挂载 范例\n-e create,delete,moved_to,close_write,attrib 范例：使用inotifywait\n# 监控一次事件 [root@centos7 /]# inotifywait /data/www/ Setting up watches. Watches established. /data/www/ CREATE,ISDIR html [root@centos7 /]# # 持续前台监控 [root@centos7 /]# inotifywait -mrq /data/www --exclude=\".*\\.swx|\\.swp\" /data/www/ OPEN,ISDIR /data/www/ CLOSE_NOWRITE,CLOSE,ISDIR /data/www/ CREATE mysql.log /data/www/ OPEN mysql.log /data/www/ ATTRIB mysql.log /data/www/ CLOSE_WRITE,CLOSE mysql.log /data/www/ OPEN,ISDIR /data/www/ CLOSE_NOWRITE,CLOSE,ISDIR /data/www/ MODIFY mysql.log /data/www/ OPEN mysql.log /data/www/ MODIFY mysql.log /data/www/ CLOSE_WRITE,CLOSE mysql.log /data/www/ OPEN,ISDIR /data/www/ CLOSE_NOWRITE,CLOSE,ISDIR /data/www/ OPEN mysql.log /data/www/ ACCESS mysql.log /data/www/ CLOSE_NOWRITE,CLOSE mysql.log #持续后台监控，并记录日志 inotifywait -o /root/inotify.log -drq /data/www --timefmt \"%Y-%m-%d %H:%M:%S\" -- format \"%T %w%f event: %e\" #持续前台监控特定事件 inotifywait -mrq /data/www --timefmt \"%F %H:%M:%S\" --format \"%T %w%f event: %;e\" -e create,delete,moved_to,close_write,attrib rsync 服务 rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、 rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或 sersync，可以实现触发式的实时数据同步 官方网站: http://rsync.samba.org/\n软件包：rsync，rsync-daemon（CentOS 8） 服务文件：/usr/lib/systemd/system/rsyncd.service 配置文件：/etc/rsyncd.conf 端口：873/tcp\nrsync命令 rsync 格式\n#Local: rsync [OPTION...] SRC... [DEST] #Access via remote shell: Pull: rsync [OPTION...] [USER@]HOST:SRC... [DEST] Push: rsync [OPTION...] SRC... [USER@]HOST:DEST #Access via rsync daemon: Pull: rsync [OPTION...] [USER@]HOST::SRC... [DEST] rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST] Push: rsync [OPTION...] SRC... [USER@]HOST::DEST rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST The ':' usages connect via remote shell, while '::' \u0026 'rsync://' usages connect to an rsync daemon, and require SRC or DEST to start with a module name. rsync有三种工作方式：\n本地文件系统上实现同步。命令行语法格式为上述\"Local\"段的格式。 本地主机使用远程shell和远程主机通信。命令行语法格式为上述\"Access via remote shell\"段的格 式。 本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述\"Access via rsync daemon\"段的格式。 前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一 个端口上，等待客户端的连接。 常见选项： -v：显示rsync过程中详细信息。可以使用\"-vvvv\"获取更详细信息。 -P：显示文件传输的进度信息。(实际上\"-P\"=\"--partial --progress\"，其中的\"--progress\"才是显 示进度信息的)。 -n --dry-run ：仅测试传输，而不实际传输。常和\"-vvvv\"配合使用来查看rsync是如何工作的。 -a --archive ：归档模式，表示递归传输并保持文件属性。等同于\"-rtopgDl\"。 -r --recursive：递归到目录中去。 -t --times：保持mtime属性。强烈建议任何时候都加上\"-t\"，否则目标文件mtime会设置为系统时间，导 致下次更新 ：检查出mtime不同从而导致增量传输无效。 -o --owner：保持owner属性(属主)。 -g --group：保持group属性(属组)。 -p --perms：保持perms属性(权限，不包括特殊权限) -D ：是\"--device --specials\"选项的组合，即也拷贝设备文件和特殊文件。 -l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象 -z ：传输时进行压缩提高效率 -R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端， 包括它们的属性。用法见下文示例。 --size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。 -u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会 影响删除行为。 -d --dirs ：以不递归的方式拷贝目录本身。默认递归时，如果源为\"dir1/file1\"，则不会拷贝dir1 目录，使用该选项将拷贝dir1但不拷贝file1。 --max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如：\"-- max-size=1.5m\") --min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。 --exclude ：指定排除规则来排除不需要传输的文件。 --delete ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意\"--delete\"是在接收端执行 的，所以它是在 ：exclude/include规则生效之后才执行的。 -b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用\"~\"做后缀。 --backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。 -e ：指定所要使用的远程shell程序，默认为ssh。 --port ：连接daemon时使用的端口号，默认为873端口。 --password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell 认证的密码，而是rsync模块认证的密码。 -W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增 量传输更高效。 --existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如 果上层目录不存在也不会传输。 --ignore-existing：要求只更新目标端不存在的文件。和\"--existing\"结合使用有特殊功能，见下文示 例。 --remove-source-files：要求删除源端已经成功传输的文件 范例：两种格式访问 rsync daemon 服务\n环境 data-server:192.168.179.171(数据服务器) backup-server:192.168.179.165(备份服务器) #在备份服务器启动 rsync 进程 [root@centos8-backup ~]#rsync --daemon Failed to parse config file: /etc/rsyncd.conf [root@centos8-backup ~]#touch /etc/rsyncd.conf [root@centos8-backup ~]#rsync --daemon [root@centos8-backup /]# cat /etc/rsyncd.conf [backup] path = /web/www/ read only = no [root@centos8-backup /]# #指定目录给nobody权限，默认用户以nobody访问此目录 [root@centos8-backup ~]#setfacl -m u:nobody:rwx /data/backup/ #查看rsync服务器的模块名称 [root@centos7-slave /]# rsync rsync://192.168.179.165 backup [root@centos7-slave /]# [root@centos7-slave /]# rsync 192.168.179.165:: backup #访问rsync服务器的共享目录 #推 [root@centos7-slave /]# rsync /xy.log 192.168.179.165::backup [root@centos7-slave /]# rsync /etc/shells rsync://root@192.168.179.165/backup [root@centos7-slave /]#rsync 192.168.179.165::backup/* /opt [root@centos7-slave /]#rsync rsync://192.168.179.165/backup/* /mnt 范例：以独立服务方式运行 rsync\n# 修改配置文件 [root@centos8-backup etc]# cat rsyncd.conf #uid = root #提定以哪个用户来访问共享目录，将之指定为生成的文件所有者，默认为nobody #gid = root #默认为nobody,Ubuntu中为nogroup #port = 874 可指定非标准端口,默认873/tcp #use chroot = no #max connections = 0 #ignore errors #exclude = lost+found/ #log file = /var/log/rsyncd.log #pid file = /var/run/rsyncd.pid #lock file = /var/run/rsyncd.lock #reverse lookup = no #hosts allow = 10.0.0.0/24 #[backup] #每个模块名对应一个不同的path目录，如果同名后面模块生效 #path = /data/backup/ #comment = backup dir #read only = no #默认是yes,即只读 #auth users = rsyncuser #默认anonymous可以访问rsync服务器 #secrets file = /etc/rsync.pas # /etc/rsyncd: configuration file for rsync daemon mode # See rsyncd.conf man page for more options. # configuration example: # uid = nobody # gid = nobody # use chroot = yes # max connections = 4 # pid file = /var/run/rsyncd.pid # exclude = lost+found/ # transfer logging = yes # timeout = 900 # ignore nonreadable = yes # dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2 # [ftp] # path = /home/ftp # comment = ftp export area uid = root gid = root max connections = 0 ignore errors exclude = lost+found/ log file = /var/log/rsyncd.log pid file = /var/run/rsyncd.pid lock file = /var/run/rsyncd.lock reverse lookup = no [backup] path = /web/backup/ comment = backup dir read only = no auth users = rsyncuser secrets file = /etc/rsync.pas [root@centos8-backup etc]# #服务器端生成验证文件 [root@centos8-backup ~]#echo \"rsyncuser:123456\" \u003e /etc/rsync.pas [root@centos8-backup ~]#chmod 600 /etc/rsync.pas #服务器端启动rsync服务 [root@centos8-backup ~]#rsync --daemon #可加入/etc/rc.d/rc.local实现开 机启动 #客户端配置密码文件 #也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全 #export RSYNC_PASSWORD=123456 [root@centos7-slave ~]#echo \"123456\" \u003e /etc/rsync.pas [root@centos7-slave ~]#chmod 600 /etc/rsync.pas #此为必要项,权限必须修改 #查看远程rsync服务器的模块信息 [root@centos7-slave etc]# rsync rsync://192.168.179.165 backup backup dir [root@centos7-slave etc]# #交互式验证查看具体模块内的文件 [root@centos7-slave etc]# rsync rsync://rsyncuser@192.168.179.165/backup Password: #非交互式查看共享目录 [root@centos7-slave etc]# rsync --password-file=/etc/rsync.pas rsync://rsyncuser@192.168.179.165/backup drwxrwxrwx 34 2022/12/07 16:20:07 . -rw-r--r-- 0 2022/12/07 16:20:07 xy.log -rw-r--r-- 0 2022/12/07 16:09:50 zz.log [root@centos7-slave etc]# #客户端测试同步数据 [root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@rsync服务器IP::backup [root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas rsyncuser@rsync服务器IP::backup /data/www/ inotify+rsync+shell 脚本实现实时数据同步 按 5.3 搭建好 rsyncd的备份服务器，在数据服务器上创建inotify_rsync.sh脚本 注意: 此脚本执行前先确保两主机初始数据处于同步状态,此脚本实现后续的数据同步\n[root@centos7-slave ~]# vim inotify_rsync.sh #!/bin/bash SRC='/data/www/' #注意最后的/ DEST='rsyncuser@rsync服务器IP::backup' rpm -q inotify-tools \u0026\u003e /dev/null ||yum -y install inotify-tools rpm -q rsync \u0026\u003e /dev/null || yum -y install rsync inotifywait -mrq --exclude=\".*\\.swp\" --timefmt '%Y-%m-%d %H:%M:%S' --format '%T %w %f' -e create,delete,moved_to,close_write,attrib ${SRC} |while read DATE TIME DIR FILE;do FILEPATH=${DIR}${FILE} rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST \u0026\u0026 echo \"At ${TIME} on ${DATE}, file $FILEPATH was backuped up via rsync\" \u003e\u003e /var/log/changelist.log done #查看文件传输日志 [root@centos7-slave www]# tail -f /var/log/changelist.log sersync 实现实时数据同步 ###　sersync 介绍 sersync类似于inotify，同样用于监控，但它克服了inotify的缺点. inotify最大的不足是会产生重复事件，或者同一个目录下多个文件的操作会产生多个事件，例如，当监 控目录中有5个文件时，删除目录时会产生6个监控事件，从而导致重复调用rsync命令。另外比如：vim 文件时，inotify会监控到临时文件的事件，但这些事件相对于rsync来说是不应该被监控的\nsersync 优点：\nsersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤， 所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。 sersync配置很简单，其中提供了静态编译好的二进制文件和xml配置文件，直接使用即可 sersync使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态 sersync有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对 同步失败的文件重新同步 sersync不仅可以实现实时同步，另外还自带crontab功能，只需在xml配置文件中开启，即也可以 按要求隔一段时间整体同步一次，而无需再额外配置crontab功能 sersync 可以二次开发 sersync项目地址： https://code.google.com/archive/p/sersync/ sersync下载地址： https://code.google.com/archive/p/sersync/downloads\n基于rsync daemon 实现 sersync # #在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量 wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz [root@centos7-slave ~]# tar -vxf sersync2.5.4_64bit_binary_stable_final.tar.gz [root@centos7-slave ~]# cp -r GNU-Linux-x86/ /usr/local/sersync [root@centos7-slave sersync]# echo 'PATH=/usr/local/sersync:$PATH' \u003e /etc/profile.d/sersync.sh [root@centos7-slave sersync]# source /etc/profile.d/sersync.sh [root@centos7-slave sersync]# #确认安装rsync客户端工具 rpm -q rsync \u0026\u003e /dev/null || dnf -y install rsync #备份sersync配置文件 cp /usr/local/sersync/confxml.xml{,.bak} # 修改配置文件 vim /usr/local/sersync/confxml.xml \u003c?xml version=\"1.0\" encoding=\"ISO-8859-1\"?\u003e # 是否开启调试模式 #不开启文件过滤功能，当为true时,以下类型的文件将不同 步 # 监控事件，默认监控 delete/close_write/moved_from/moved_to/create folder #修改此行为true，文件属性变化后也会同步 # rsync命令的配置段 #修改此行,需要同步的源目录或文件，建议同步目 录 #修改此行,指定备份服务器地址和rsync daemon的模块名，如果下面开启了ssh start，此时name为远程shell方式运行时的目标目录 # 指定rsync选项 #修 改此行为true,指定备份服务器的rsync配置的用户和密码文件 #指定rsync的非 标准端口号 #默认使用rsync daemon运行rsync命令,true为使用远程shell模 式 #错误重传及日志文件路径 #不开启crontab功能 #不开启crontab定时传输的筛选功能 #####################################以下行不需要修改 #################################### ",
  "wordCount" : "8187",
  "inLanguage": "en",
  "image":"http://oss.itshare.work/itshare-work-images/2.jpg","datePublished": "2022-12-04T12:03:44Z",
  "dateModified": "2022-12-04T12:03:44Z",
  "author":[{
    "@type": "Person",
    "name": "Cookie"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://hugo.itshare.work/archivist/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie",
    "logo": {
      "@type": "ImageObject",
      "url": "http://hugo.itshare.work/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://hugo.itshare.work/" accesskey="h" title="Cookie (Alt + H)">
            <img src="http://hugo.itshare.work/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Cookie</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://hugo.itshare.work/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archivist" title="📒 归档">
                <span>📒 归档</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="http://hugo.itshare.work/">🏠 主页</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/archivist/">📒归档</a></div>
            <h1 class="post-title">
                网络文件共享服务
            </h1>
            <div class="post-description">
                Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-12-04
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>8187字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>17分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Cookie
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "http://hugo.itshare.work/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="http://oss.itshare.work/itshare-work-images/2.jpg" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#nfs%e6%9c%8d%e5%8a%a1" aria-label="NFS服务">NFS服务</a><ul>
                        
                <li>
                    <a href="#nfs%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="NFS工作原理">NFS工作原理</a></li>
                <li>
                    <a href="#nfs%e8%bd%af%e4%bb%b6%e4%bb%8b%e7%bb%8d" aria-label="NFS软件介绍">NFS软件介绍</a></li>
                <li>
                    <a href="#nfs%e5%b7%a5%e5%85%b7" aria-label="NFS工具">NFS工具</a><ul>
                        
                <li>
                    <a href="#rpcinfo" aria-label="rpcinfo">rpcinfo</a></li>
                <li>
                    <a href="#exportfs" aria-label="exportfs">exportfs</a></li>
                <li>
                    <a href="#showmount" aria-label="showmount">showmount</a></li>
                <li>
                    <a href="#mountnfs" aria-label="mount.nfs">mount.nfs</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8b" aria-label="实战案例">实战案例</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e7%9a%84%e5%ae%9e%e6%97%b6%e5%90%8c%e6%ad%a5" aria-label="数据的实时同步">数据的实时同步</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e6%97%b6%e5%90%8c%e6%ad%a5%e6%8a%80%e6%9c%af%e4%bb%8b%e7%bb%8d" aria-label="实时同步技术介绍">实时同步技术介绍</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0-inotify" aria-label="实现 inotify">实现 inotify</a><ul>
                        
                <li>
                    <a href="#inotify-tools%e5%b7%a5%e5%85%b7" aria-label="inotify-tools工具">inotify-tools工具</a></li></ul>
                </li></ul>
                    
                <li>
                    <a href="#rsync-%e6%9c%8d%e5%8a%a1" aria-label="rsync 服务">rsync 服务</a><ul>
                        <ul>
                        
                <li>
                    <a href="#rsync%e5%91%bd%e4%bb%a4" aria-label="rsync命令">rsync命令</a></li></ul>
                    
                <li>
                    <a href="#inotifyrsyncshell-%e8%84%9a%e6%9c%ac%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" aria-label="inotify&#43;rsync&#43;shell 脚本实现实时数据同步">inotify+rsync+shell 脚本实现实时数据同步</a></li></ul>
                </li>
                <li>
                    <a href="#sersync-%e5%ae%9e%e7%8e%b0%e5%ae%9e%e6%97%b6%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" aria-label="sersync 实现实时数据同步">sersync 实现实时数据同步</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8ersync-daemon-%e5%ae%9e%e7%8e%b0-sersync" aria-label="基于rsync daemon 实现 sersync">基于rsync daemon 实现 sersync</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="nfs服务">NFS服务<a hidden class="anchor" aria-hidden="true" href="#nfs服务">#</a></h1>
<h2 id="nfs工作原理">NFS工作原理<a hidden class="anchor" aria-hidden="true" href="#nfs工作原理">#</a></h2>
<p><img loading="lazy" src="/posts.images/image.assets/1670127215657.png" alt="1670127215657"  />
</p>
<p>NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure CallProtocol 远程过程调用）实现。
RPC采用C/S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行。</p>
<p><img loading="lazy" src="/posts.images/image.assets/1670127252975.png" alt="1670127252975"  />
</p>
<p>NFS优势：节省本地存储空间，将常用的数据,如：/home目录，存放在NFS服务器上且可以通过网络访
问，本地终端将可减少自身存储空间的使用。</p>
<h2 id="nfs软件介绍">NFS软件介绍<a hidden class="anchor" aria-hidden="true" href="#nfs软件介绍">#</a></h2>
<p>软件包：nfs-utils（包括服务器和客户端相关工具，CentOS8 最小化安装时默认没有安装），nfs-common(Ubuntu中包名)<br>
相关软件包：rpcbind（必须），tcp_wrappers<br>
Kernel支持：nfs.ko<br>
端口：2049(nfsd), 其它端口由portmap(111)分配<br>
NFS服务主要进程：</p>
<ul>
<li>rpc.nfsd 最主要的NFS进程，管理客户端是否可登录</li>
<li>rpc.mountd 挂载和卸载NFS文件系统，包括权限管理</li>
<li>rpc.lockd 非必要，管理文件锁，避免同时写出错</li>
<li>rpc.statd 非必要，检查文件一致性，可修复文件</li>
</ul>
<p>说明：CentOS 6 开始portmap进程由rpcbind代替
日志：/var/lib/nfs/
NFS配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/etc/exports
</span></span><span style="display:flex;"><span>/etc/exports.d/*.exports
</span></span></code></pre></div><p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>默认选项：(ro,sync,root_squash,no_all_squash)
</span></span><span style="display:flex;"><span>ro,rw 只读和读写
</span></span><span style="display:flex;"><span>async 异步，数据变化后不立即写磁盘，先写入到缓冲区中，过一段时间再写入磁盘，性能高,安全性低
</span></span><span style="display:flex;"><span>sync（1.0.0后为默认）同步，数据在请求时立即写入共享存储磁盘,性能低,安全性高
</span></span><span style="display:flex;"><span>root_squash （默认）远程root映射为nfsnobody,UID为65534，CentOS8 为nobody,CentOS
</span></span><span style="display:flex;"><span>7以前的版本为nfsnobody
</span></span><span style="display:flex;"><span>no_root_squash 远程root映射成NFS服务器的root用户
</span></span><span style="display:flex;"><span>all_squash 所有远程用户(包括root)都变成nfsnobody,CentOS8 为nobody
</span></span><span style="display:flex;"><span>no_all_squash （默认）保留共享文件的UID和GID
</span></span><span style="display:flex;"><span>anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非nobody,可配合all_squash使
</span></span><span style="display:flex;"><span>用
</span></span></code></pre></div><h2 id="nfs工具">NFS工具<a hidden class="anchor" aria-hidden="true" href="#nfs工具">#</a></h2>
<h3 id="rpcinfo">rpcinfo<a hidden class="anchor" aria-hidden="true" href="#rpcinfo">#</a></h3>
<p>rpcinfo 工具可以查看RPC相关信息
查看注册在指定主机的RPC程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>rpcinfo -p hostname
</span></span></code></pre></div><p>查看RPC注册程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>rpcinfo -s hostname
</span></span></code></pre></div><h3 id="exportfs">exportfs<a hidden class="anchor" aria-hidden="true" href="#exportfs">#</a></h3>
<p>exportfs:可用于管理NFS导出的文件系统
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-v #查看本机所有NFS共享
</span></span><span style="display:flex;"><span>-r #重读配置文件，并共享目录
</span></span><span style="display:flex;"><span>-a #输出本机所有共享
</span></span><span style="display:flex;"><span>-au #停止本机所有共享
</span></span></code></pre></div><h3 id="showmount">showmount<a hidden class="anchor" aria-hidden="true" href="#showmount">#</a></h3>
<p>常见用法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>#查看远程主机的NFS共享
</span></span><span style="display:flex;"><span>showmount -e hostname
</span></span></code></pre></div><h3 id="mountnfs">mount.nfs<a hidden class="anchor" aria-hidden="true" href="#mountnfs">#</a></h3>
<p>客户端NFS挂载
NFS相关的挂载选项：man 5 nfs</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>fg #（默认）前台挂载
</span></span><span style="display:flex;"><span>bg #后台挂载
</span></span><span style="display:flex;"><span>hard #（默认）持续请求
</span></span><span style="display:flex;"><span>soft #非持续请求
</span></span><span style="display:flex;"><span>intr #和hard配合，请求可中断
</span></span><span style="display:flex;"><span>rsize #和wsize 一次读和写数据最大字节数，rsize=32768
</span></span><span style="display:flex;"><span>_netdev #无网络服务时不挂载NFS资源
</span></span><span style="display:flex;"><span>vers #指定版本，客户端centos8默认4.2 ，centos7默认4.1 centos6默认4.0
</span></span></code></pre></div><p>提示：基于安全考虑，建议使用 nosuid,<em>netdev,noexec 挂载选项</em></p>
<h1 id="实战案例">实战案例<a hidden class="anchor" aria-hidden="true" href="#实战案例">#</a></h1>
<p><img loading="lazy" src="/posts.images/image.assets/1670246134779.png" alt="1670246134779"  />
</p>
<ul>
<li>NFS服务器安装软件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>yum install -y nfs-utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 启动rpcbind
</span></span><span style="display:flex;"><span>systemctl start rpcbind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 启动nfs-server
</span></span><span style="display:flex;"><span>systemctl start nfs-server
</span></span></code></pre></div><ul>
<li>NFS服务器创建共享文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 共享根目录下的share目录
</span></span><span style="display:flex;"><span>mkdir /share
</span></span></code></pre></div><ul>
<li>添加uid和gid为300的用户nfs-upload</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos7-master ~]# groupadd -g 300 nfs-upload
</span></span><span style="display:flex;"><span>[root@centos7-master ~]# useradd -u 300 -g 300 nfs-upload
</span></span><span style="display:flex;"><span>[root@centos7-master ~]# 
</span></span><span style="display:flex;"><span>#修改所属组权限
</span></span><span style="display:flex;"><span>[root@centos7-master share]# chown -R 300:300 /share
</span></span></code></pre></div><ul>
<li>修改NFS服务器配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos7-master ~]# vim /etc/exports
</span></span><span style="display:flex;"><span># 加入如下内容，*表示任何人，rw表示读写
</span></span><span style="display:flex;"><span>/share/ 192.168.179.*(rw,anongid=300,anonuid=300)
</span></span></code></pre></div><ul>
<li>重新加载配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 重新加载配置文件
</span></span><span style="display:flex;"><span>[root@centos7-master ~]# exportfs -r
</span></span><span style="display:flex;"><span>[root@centos7-master ~]# exportfs -v
</span></span><span style="display:flex;"><span>/share        	192.168.179.*(sync,wdelay,hide,no_subtree_check,anonuid=300,anongid=300,sec=sys,rw,secure,root_squash,no_all_squash)
</span></span><span style="display:flex;"><span>[root@centos7-master ~]# 
</span></span></code></pre></div><ul>
<li>客户端安装软件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>yum install -y nfs-utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 启动rpcbind
</span></span><span style="display:flex;"><span>systemctl start rpcbind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 启动nfs-server
</span></span><span style="display:flex;"><span>systemctl start nfs-server
</span></span></code></pre></div><ul>
<li>添加用户和组</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos7-slave /]# groupadd -g 300 nfs-upload
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# useradd -u 300 -g 300 nfs-upload
</span></span></code></pre></div><ul>
<li>在客户端挂载，挂载/nfsshare目录下</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 创建目录
</span></span><span style="display:flex;"><span>mkdir /nfsshare
</span></span><span style="display:flex;"><span># 查看服务器端可挂载点
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]# showmount -e 192.168.179.170
</span></span><span style="display:flex;"><span>Export list for 192.168.179.170:
</span></span><span style="display:flex;"><span>/share *
</span></span><span style="display:flex;"><span>[root@centos7-slave nfsshare]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 挂载方式1，关机重启会失效
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]# mount 192.168.179.170:/share/ /nfsshare
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 方式二修改配置文件，关机重启不失效
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]# vim /etc/fstab 
</span></span><span style="display:flex;"><span># 加入如下内容
</span></span><span style="display:flex;"><span>192.168.179.170:/share                    /nfsshare  nfs     defaults,_netdev 0 0
</span></span><span style="display:flex;"><span># 使配置文件生效
</span></span><span style="display:flex;"><span>[root@centos7-slave nfsshare]# mount -a
</span></span><span style="display:flex;"><span>[root@centos7-slave nfsshare]# 
</span></span></code></pre></div><ul>
<li>测试</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 在客户端上查看/nfsshare的内容
</span></span><span style="display:flex;"><span>[root@centos7-slave nfsshare]# ll
</span></span><span style="display:flex;"><span>total 8
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx
</span></span><span style="display:flex;"><span>drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log
</span></span><span style="display:flex;"><span>[root@centos7-slave nfsshare]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 在服务器端查看/share目录
</span></span><span style="display:flex;"><span>[root@centos7-master share]# ll
</span></span><span style="display:flex;"><span>total 8
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx
</span></span><span style="display:flex;"><span>drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log
</span></span><span style="display:flex;"><span>[root@centos7-master share]#
</span></span></code></pre></div><h1 id="数据的实时同步">数据的实时同步<a hidden class="anchor" aria-hidden="true" href="#数据的实时同步">#</a></h1>
<h3 id="实时同步技术介绍">实时同步技术介绍<a hidden class="anchor" aria-hidden="true" href="#实时同步技术介绍">#</a></h3>
<p>实现实时同步的方法</p>
<ul>
<li>inotify + rsync 方式实现数据同步</li>
<li>sersync ：前金山公司周洋（花椒直播）在 inotify 软件基础上进行开发的，功能更加强大</li>
</ul>
<p>工作原理：</p>
<ul>
<li>要利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li>
<li>发现目录中数据产生变化，就利用rsync服务推送到备份服务器上</li>
</ul>
<p>inotify：<br>
异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如cron等的轮询机制来获取事件，linux内核从2.6.13起支持 inotify，通过inotify可以监控文件系统中添加、删除，修改、移动等各种事件</p>
<p><strong>实现inotify软件：</strong></p>
<ul>
<li>inotify-tools</li>
<li>sersync</li>
<li>lrsyncd</li>
</ul>
<p><strong>inotify+rsync使用方式</strong></p>
<ul>
<li>inotify 对同步数据目录信息的监控</li>
<li>rsync 完成对数据的同步</li>
<li>利用脚本进行结合</li>
</ul>
<h3 id="实现-inotify">实现 inotify<a hidden class="anchor" aria-hidden="true" href="#实现-inotify">#</a></h3>
<p>内核是否支持inotify
Linux支持inotify的内核最小版本为 2.6.13，参看man 7 inotify</p>
<p><strong>inotify 内核参数说明：</strong></p>
<ul>
<li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错
误，默认值：16384, 生产环境建议调大,比如:327679</li>
<li>max_user_instances：每个用户创建inotify实例最大值，默认值：128</li>
<li>max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大</li>
</ul>
<h4 id="inotify-tools工具">inotify-tools工具<a hidden class="anchor" aria-hidden="true" href="#inotify-tools工具">#</a></h4>
<p>inotify-tools参考文档：https://github.com/rvoicilas/inotify-tools/wiki
安装inotify-tools：基于epel源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>yum install epel-release
</span></span><span style="display:flex;"><span>yum -y install inotify-tools
</span></span></code></pre></div><p><strong>inotify-tools包主要工具：</strong></p>
<ul>
<li>inotifywait： 在被监控的文件或目录上等待特定文件系统事件（open ，close，delete等）发生，
常用于实时同步的目录监控</li>
<li>inotifywatch：收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</li>
</ul>
<p>inotifywait 命令
格式:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]
</span></span></code></pre></div><p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-m, --monitor 始终保持事件监听
</span></span><span style="display:flex;"><span>-d, --daemon 以守护进程方式执行，和-m相似，配合-o使用
</span></span><span style="display:flex;"><span>-r, --recursive 递归监控目录数据信息变化
</span></span><span style="display:flex;"><span>-q, --quiet 输出少量事件信息
</span></span><span style="display:flex;"><span>--exclude &lt;pattern&gt; 指定排除文件或目录，使用扩展的正则表达式匹配的模式实现
</span></span><span style="display:flex;"><span>--excludei &lt;pattern&gt; 和exclude相似，不区分大小写
</span></span><span style="display:flex;"><span>-o, --outfile &lt;file&gt; 打印事件到文件中，相当于标准正确输出，注意：使用绝对路径
</span></span><span style="display:flex;"><span>-s, --syslogOutput 发送错误到syslog相当于标准错误输出
</span></span><span style="display:flex;"><span>--timefmt &lt;fmt&gt; 指定时间输出格式
</span></span><span style="display:flex;"><span>--format &lt;fmt&gt; 指定的输出格式；即实际监控输出内容
</span></span><span style="display:flex;"><span>-e
</span></span></code></pre></div><p><strong>inotifywait 的&ndash;timefmt 时间格式</strong>
参考 man 3 strftime</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>%Y #年份信息，包含世纪信息
</span></span><span style="display:flex;"><span>%y #年份信息，不包括世纪信息
</span></span><span style="display:flex;"><span>%m #显示月份，范围 01-12
</span></span><span style="display:flex;"><span>%d #每月的第几天，范围是 01-31
</span></span><span style="display:flex;"><span>%H #小时信息，使用 24小时制，范围 00-23
</span></span><span style="display:flex;"><span>%M #分钟，范围 00-59
</span></span><span style="display:flex;"><span>%S #秒，范例 0-60
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>--timefmt &#34;%Y-%m-%d %H:%M:%S&#34;
</span></span></code></pre></div><p><strong>inotifywait 的 &ndash;format 格式定义</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>%T #输出时间格式中定义的时间格式信息，通过 --timefmt option 语法格式指定时间信息
</span></span><span style="display:flex;"><span>%w #事件出现时，监控文件或目录的名称信息，相当于dirname
</span></span><span style="display:flex;"><span>%f #事件出现时，将显示监控目录下触发事件的文件或目录信息，否则为空，相当于basename
</span></span><span style="display:flex;"><span>%e #显示发生的事件信息，不同的事件默认用逗号分隔
</span></span><span style="display:flex;"><span>%Xe #显示发生的事件信息，不同的事件指定用X进行分隔
</span></span></code></pre></div><p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>--format &#34;%T %w%f event: %;e&#34;
</span></span><span style="display:flex;"><span>--format &#39;%T %w %f&#39;
</span></span></code></pre></div><p>inotifywait -e 选项指定的事件类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>create #文件或目录创建
</span></span><span style="display:flex;"><span>delete #文件或目录被删除
</span></span><span style="display:flex;"><span>modify #文件或目录内容被写入
</span></span><span style="display:flex;"><span>attrib #文件或目录属性改变
</span></span><span style="display:flex;"><span>close_write #文件或目录关闭，在写入模式打开之后关闭的
</span></span><span style="display:flex;"><span>close_nowrite #文件或目录关闭，在只读模式打开之后关闭的
</span></span><span style="display:flex;"><span>close #文件或目录关闭，不管读或是写模式
</span></span><span style="display:flex;"><span>open #文件或目录被打开
</span></span><span style="display:flex;"><span>lsdir #浏览目录内容
</span></span><span style="display:flex;"><span>moved_to #文件或目录被移动到监控的目录中
</span></span><span style="display:flex;"><span>moved_from #文件或目录从监控的目录中被移动
</span></span><span style="display:flex;"><span>move #文件或目录不管移动到或是移出监控目录都触发事件
</span></span><span style="display:flex;"><span>access #文件或目录内容被读取
</span></span><span style="display:flex;"><span>delete_self #文件或目录被删除，目录本身被删除
</span></span><span style="display:flex;"><span>unmount #取消挂载
</span></span></code></pre></div><p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-e create,delete,moved_to,close_write,attrib
</span></span></code></pre></div><p>范例：使用inotifywait</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 监控一次事件
</span></span><span style="display:flex;"><span>[root@centos7 /]# inotifywait /data/www/
</span></span><span style="display:flex;"><span>Setting up watches.
</span></span><span style="display:flex;"><span>Watches established.
</span></span><span style="display:flex;"><span>/data/www/ CREATE,ISDIR html
</span></span><span style="display:flex;"><span>[root@centos7 /]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 持续前台监控
</span></span><span style="display:flex;"><span>[root@centos7 /]# inotifywait -mrq /data/www --exclude=&#34;.*\.swx|\.swp&#34;
</span></span><span style="display:flex;"><span>/data/www/ OPEN,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ CREATE mysql.log
</span></span><span style="display:flex;"><span>/data/www/ OPEN mysql.log
</span></span><span style="display:flex;"><span>/data/www/ ATTRIB mysql.log
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_WRITE,CLOSE mysql.log
</span></span><span style="display:flex;"><span>/data/www/ OPEN,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ MODIFY mysql.log
</span></span><span style="display:flex;"><span>/data/www/ OPEN mysql.log
</span></span><span style="display:flex;"><span>/data/www/ MODIFY mysql.log
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_WRITE,CLOSE mysql.log
</span></span><span style="display:flex;"><span>/data/www/ OPEN,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR 
</span></span><span style="display:flex;"><span>/data/www/ OPEN mysql.log
</span></span><span style="display:flex;"><span>/data/www/ ACCESS mysql.log
</span></span><span style="display:flex;"><span>/data/www/ CLOSE_NOWRITE,CLOSE mysql.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#持续后台监控，并记录日志
</span></span><span style="display:flex;"><span>inotifywait -o /root/inotify.log -drq /data/www --timefmt &#34;%Y-%m-%d %H:%M:%S&#34; --
</span></span><span style="display:flex;"><span>format &#34;%T %w%f event: %e&#34;
</span></span><span style="display:flex;"><span>#持续前台监控特定事件
</span></span><span style="display:flex;"><span>inotifywait -mrq /data/www --timefmt &#34;%F %H:%M:%S&#34; --format &#34;%T %w%f event:
</span></span><span style="display:flex;"><span>%;e&#34; -e create,delete,moved_to,close_write,attrib
</span></span></code></pre></div><h2 id="rsync-服务">rsync 服务<a hidden class="anchor" aria-hidden="true" href="#rsync-服务">#</a></h2>
<p>rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、
rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或
sersync，可以实现触发式的实时数据同步
官方网站: <a href="http://rsync.samba.org/">http://rsync.samba.org/</a></p>
<p>软件包：rsync，rsync-daemon（CentOS 8）
服务文件：/usr/lib/systemd/system/rsyncd.service
配置文件：/etc/rsyncd.conf
端口：873/tcp</p>
<h4 id="rsync命令">rsync命令<a hidden class="anchor" aria-hidden="true" href="#rsync命令">#</a></h4>
<p>rsync 格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>#Local:
</span></span><span style="display:flex;"><span>rsync [OPTION...] SRC... [DEST]
</span></span><span style="display:flex;"><span>#Access via remote shell:
</span></span><span style="display:flex;"><span>Pull:
</span></span><span style="display:flex;"><span>rsync [OPTION...] [USER@]HOST:SRC... [DEST]
</span></span><span style="display:flex;"><span>Push:
</span></span><span style="display:flex;"><span>rsync [OPTION...] SRC... [USER@]HOST:DEST
</span></span><span style="display:flex;"><span>#Access via rsync daemon:
</span></span><span style="display:flex;"><span>Pull:
</span></span><span style="display:flex;"><span>rsync [OPTION...] [USER@]HOST::SRC... [DEST]
</span></span><span style="display:flex;"><span>rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]
</span></span><span style="display:flex;"><span>Push:
</span></span><span style="display:flex;"><span>rsync [OPTION...] SRC... [USER@]HOST::DEST
</span></span><span style="display:flex;"><span>rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST
</span></span><span style="display:flex;"><span>The &#39;:&#39; usages connect via remote shell, while &#39;::&#39; &amp; &#39;rsync://&#39; usages connect
</span></span><span style="display:flex;"><span>to an rsync daemon, and require SRC or DEST to start with a module name.
</span></span></code></pre></div><p>rsync有三种工作方式：</p>
<ol>
<li>本地文件系统上实现同步。命令行语法格式为上述&quot;Local&quot;段的格式。</li>
<li>本地主机使用远程shell和远程主机通信。命令行语法格式为上述&quot;Access via remote shell&quot;段的格
式。</li>
<li>本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述&quot;Access via
rsync daemon&quot;段的格式。
前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一
个端口上，等待客户端的连接。
常见选项：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-v：显示rsync过程中详细信息。可以使用&#34;-vvvv&#34;获取更详细信息。
</span></span><span style="display:flex;"><span>-P：显示文件传输的进度信息。(实际上&#34;-P&#34;=&#34;--partial --progress&#34;，其中的&#34;--progress&#34;才是显
</span></span><span style="display:flex;"><span>示进度信息的)。
</span></span><span style="display:flex;"><span>-n --dry-run ：仅测试传输，而不实际传输。常和&#34;-vvvv&#34;配合使用来查看rsync是如何工作的。
</span></span><span style="display:flex;"><span>-a --archive ：归档模式，表示递归传输并保持文件属性。等同于&#34;-rtopgDl&#34;。
</span></span><span style="display:flex;"><span>-r --recursive：递归到目录中去。
</span></span><span style="display:flex;"><span>-t --times：保持mtime属性。强烈建议任何时候都加上&#34;-t&#34;，否则目标文件mtime会设置为系统时间，导
</span></span><span style="display:flex;"><span>致下次更新
</span></span><span style="display:flex;"><span>：检查出mtime不同从而导致增量传输无效。
</span></span><span style="display:flex;"><span>-o --owner：保持owner属性(属主)。
</span></span><span style="display:flex;"><span>-g --group：保持group属性(属组)。
</span></span><span style="display:flex;"><span>-p --perms：保持perms属性(权限，不包括特殊权限)
</span></span><span style="display:flex;"><span>-D ：是&#34;--device --specials&#34;选项的组合，即也拷贝设备文件和特殊文件。
</span></span><span style="display:flex;"><span>-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象
</span></span><span style="display:flex;"><span>-z ：传输时进行压缩提高效率
</span></span><span style="display:flex;"><span>-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，
</span></span><span style="display:flex;"><span>包括它们的属性。用法见下文示例。
</span></span><span style="display:flex;"><span>--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。
</span></span><span style="display:flex;"><span>-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会
</span></span><span style="display:flex;"><span>影响删除行为。
</span></span><span style="display:flex;"><span>-d --dirs ：以不递归的方式拷贝目录本身。默认递归时，如果源为&#34;dir1/file1&#34;，则不会拷贝dir1
</span></span><span style="display:flex;"><span>目录，使用该选项将拷贝dir1但不拷贝file1。
</span></span><span style="display:flex;"><span>--max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如：&#34;--
</span></span><span style="display:flex;"><span>max-size=1.5m&#34;)
</span></span><span style="display:flex;"><span>--min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。
</span></span><span style="display:flex;"><span>--exclude ：指定排除规则来排除不需要传输的文件。
</span></span><span style="display:flex;"><span>--delete ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意&#34;--delete&#34;是在接收端执行
</span></span><span style="display:flex;"><span>的，所以它是在
</span></span><span style="display:flex;"><span>：exclude/include规则生效之后才执行的。
</span></span><span style="display:flex;"><span>-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用&#34;~&#34;做后缀。
</span></span><span style="display:flex;"><span>--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。
</span></span><span style="display:flex;"><span>-e ：指定所要使用的远程shell程序，默认为ssh。
</span></span><span style="display:flex;"><span>--port ：连接daemon时使用的端口号，默认为873端口。
</span></span><span style="display:flex;"><span>--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell
</span></span><span style="display:flex;"><span>认证的密码，而是rsync模块认证的密码。
</span></span><span style="display:flex;"><span>-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增
</span></span><span style="display:flex;"><span>量传输更高效。
</span></span><span style="display:flex;"><span>--existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如
</span></span><span style="display:flex;"><span>果上层目录不存在也不会传输。
</span></span><span style="display:flex;"><span>--ignore-existing：要求只更新目标端不存在的文件。和&#34;--existing&#34;结合使用有特殊功能，见下文示
</span></span><span style="display:flex;"><span>例。
</span></span><span style="display:flex;"><span>--remove-source-files：要求删除源端已经成功传输的文件
</span></span></code></pre></div><p>范例：两种格式访问 rsync daemon 服务</p>
<p><img loading="lazy" src="/posts.images/image.assets/1670396738139.png" alt="1670396738139"  />
</p>
<ul>
<li>环境</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>data-server:192.168.179.171(数据服务器)
</span></span><span style="display:flex;"><span>backup-server:192.168.179.165(备份服务器)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>#在备份服务器启动 rsync 进程
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#rsync --daemon
</span></span><span style="display:flex;"><span>Failed to parse config file: /etc/rsyncd.conf
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#touch /etc/rsyncd.conf
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#rsync --daemon
</span></span><span style="display:flex;"><span>[root@centos8-backup /]# cat /etc/rsyncd.conf 
</span></span><span style="display:flex;"><span>[backup]
</span></span><span style="display:flex;"><span>path = /web/www/
</span></span><span style="display:flex;"><span>read only = no 
</span></span><span style="display:flex;"><span>[root@centos8-backup /]# 
</span></span><span style="display:flex;"><span>#指定目录给nobody权限，默认用户以nobody访问此目录
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#setfacl -m u:nobody:rwx /data/backup/
</span></span><span style="display:flex;"><span>#查看rsync服务器的模块名称
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# rsync rsync://192.168.179.165
</span></span><span style="display:flex;"><span>backup    	
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# 
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# rsync 192.168.179.165::
</span></span><span style="display:flex;"><span>backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#访问rsync服务器的共享目录
</span></span><span style="display:flex;"><span>#推
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# rsync /xy.log 192.168.179.165::backup
</span></span><span style="display:flex;"><span>[root@centos7-slave /]# rsync /etc/shells rsync://root@192.168.179.165/backup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@centos7-slave /]#rsync 192.168.179.165::backup/* /opt
</span></span><span style="display:flex;"><span>[root@centos7-slave /]#rsync rsync://192.168.179.165/backup/* /mnt
</span></span></code></pre></div><p>范例：以独立服务方式运行 rsync</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 修改配置文件
</span></span><span style="display:flex;"><span>[root@centos8-backup etc]# cat rsyncd.conf
</span></span><span style="display:flex;"><span>#uid = root #提定以哪个用户来访问共享目录，将之指定为生成的文件所有者，默认为nobody
</span></span><span style="display:flex;"><span>#gid = root #默认为nobody,Ubuntu中为nogroup
</span></span><span style="display:flex;"><span>#port = 874 可指定非标准端口,默认873/tcp
</span></span><span style="display:flex;"><span>#use chroot = no
</span></span><span style="display:flex;"><span>#max connections = 0
</span></span><span style="display:flex;"><span>#ignore errors
</span></span><span style="display:flex;"><span>#exclude = lost+found/
</span></span><span style="display:flex;"><span>#log file = /var/log/rsyncd.log
</span></span><span style="display:flex;"><span>#pid file = /var/run/rsyncd.pid
</span></span><span style="display:flex;"><span>#lock file = /var/run/rsyncd.lock
</span></span><span style="display:flex;"><span>#reverse lookup = no
</span></span><span style="display:flex;"><span>#hosts allow = 10.0.0.0/24
</span></span><span style="display:flex;"><span>#[backup] #每个模块名对应一个不同的path目录，如果同名后面模块生效
</span></span><span style="display:flex;"><span>#path = /data/backup/
</span></span><span style="display:flex;"><span>#comment = backup dir
</span></span><span style="display:flex;"><span>#read only = no #默认是yes,即只读
</span></span><span style="display:flex;"><span>#auth users = rsyncuser #默认anonymous可以访问rsync服务器
</span></span><span style="display:flex;"><span>#secrets file = /etc/rsync.pas
</span></span><span style="display:flex;"><span># /etc/rsyncd: configuration file for rsync daemon mode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># See rsyncd.conf man page for more options.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># configuration example:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># uid = nobody
</span></span><span style="display:flex;"><span># gid = nobody
</span></span><span style="display:flex;"><span># use chroot = yes
</span></span><span style="display:flex;"><span># max connections = 4
</span></span><span style="display:flex;"><span># pid file = /var/run/rsyncd.pid
</span></span><span style="display:flex;"><span># exclude = lost+found/
</span></span><span style="display:flex;"><span># transfer logging = yes
</span></span><span style="display:flex;"><span># timeout = 900
</span></span><span style="display:flex;"><span># ignore nonreadable = yes
</span></span><span style="display:flex;"><span># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># [ftp]
</span></span><span style="display:flex;"><span>#        path = /home/ftp
</span></span><span style="display:flex;"><span>#        comment = ftp export area
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uid = root 
</span></span><span style="display:flex;"><span>gid = root  
</span></span><span style="display:flex;"><span>max connections = 0
</span></span><span style="display:flex;"><span>ignore errors
</span></span><span style="display:flex;"><span>exclude = lost+found/
</span></span><span style="display:flex;"><span>log file = /var/log/rsyncd.log
</span></span><span style="display:flex;"><span>pid file = /var/run/rsyncd.pid
</span></span><span style="display:flex;"><span>lock file = /var/run/rsyncd.lock
</span></span><span style="display:flex;"><span>reverse lookup = no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[backup] 
</span></span><span style="display:flex;"><span>path = /web/backup/  
</span></span><span style="display:flex;"><span>comment = backup dir
</span></span><span style="display:flex;"><span>read only = no 
</span></span><span style="display:flex;"><span>auth users = rsyncuser  
</span></span><span style="display:flex;"><span>secrets file = /etc/rsync.pas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@centos8-backup etc]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#服务器端生成验证文件
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#echo &#34;rsyncuser:123456&#34; &gt; /etc/rsync.pas
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#chmod 600 /etc/rsync.pas
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#服务器端启动rsync服务
</span></span><span style="display:flex;"><span>[root@centos8-backup ~]#rsync --daemon #可加入/etc/rc.d/rc.local实现开
</span></span><span style="display:flex;"><span>机启动
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#客户端配置密码文件
</span></span><span style="display:flex;"><span>#也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全
</span></span><span style="display:flex;"><span>#export RSYNC_PASSWORD=123456
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]#echo &#34;123456&#34; &gt; /etc/rsync.pas
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]#chmod 600 /etc/rsync.pas #此为必要项,权限必须修改
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#查看远程rsync服务器的模块信息
</span></span><span style="display:flex;"><span>[root@centos7-slave etc]# rsync rsync://192.168.179.165
</span></span><span style="display:flex;"><span>backup         	backup dir
</span></span><span style="display:flex;"><span>[root@centos7-slave etc]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#交互式验证查看具体模块内的文件
</span></span><span style="display:flex;"><span>[root@centos7-slave etc]# rsync rsync://rsyncuser@192.168.179.165/backup
</span></span><span style="display:flex;"><span>Password: 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#非交互式查看共享目录
</span></span><span style="display:flex;"><span>[root@centos7-slave etc]# rsync --password-file=/etc/rsync.pas rsync://rsyncuser@192.168.179.165/backup
</span></span><span style="display:flex;"><span>drwxrwxrwx             34 2022/12/07 16:20:07 .
</span></span><span style="display:flex;"><span>-rw-r--r--              0 2022/12/07 16:20:07 xy.log
</span></span><span style="display:flex;"><span>-rw-r--r--              0 2022/12/07 16:09:50 zz.log
</span></span><span style="display:flex;"><span>[root@centos7-slave etc]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#客户端测试同步数据
</span></span><span style="display:flex;"><span>[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@rsync服务器IP::backup
</span></span><span style="display:flex;"><span>[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas rsyncuser@rsync服务器IP::backup /data/www/
</span></span></code></pre></div><h3 id="inotifyrsyncshell-脚本实现实时数据同步">inotify+rsync+shell 脚本实现实时数据同步<a hidden class="anchor" aria-hidden="true" href="#inotifyrsyncshell-脚本实现实时数据同步">#</a></h3>
<p><img loading="lazy" src="/posts.images/image.assets/1670403695085.png" alt="1670403695085"  />
</p>
<p>按 5.3 搭建好 rsyncd的备份服务器，在数据服务器上创建inotify_rsync.sh脚本
注意: 此脚本执行前先确保两主机初始数据处于同步状态,此脚本实现后续的数据同步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos7-slave ~]# vim inotify_rsync.sh 
</span></span><span style="display:flex;"><span>#!/bin/bash
</span></span><span style="display:flex;"><span>SRC=&#39;/data/www/&#39; #注意最后的/
</span></span><span style="display:flex;"><span>DEST=&#39;rsyncuser@rsync服务器IP::backup&#39;
</span></span><span style="display:flex;"><span>rpm -q inotify-tools &amp;&gt; /dev/null ||yum -y install inotify-tools
</span></span><span style="display:flex;"><span>rpm -q rsync &amp;&gt; /dev/null || yum -y install rsync
</span></span><span style="display:flex;"><span>inotifywait -mrq --exclude=&#34;.*\.swp&#34; --timefmt &#39;%Y-%m-%d %H:%M:%S&#39; --format
</span></span><span style="display:flex;"><span>&#39;%T %w %f&#39; -e create,delete,moved_to,close_write,attrib ${SRC} |while read DATE
</span></span><span style="display:flex;"><span>TIME DIR FILE;do
</span></span><span style="display:flex;"><span>FILEPATH=${DIR}${FILE}
</span></span><span style="display:flex;"><span>rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST &amp;&amp; echo
</span></span><span style="display:flex;"><span>&#34;At ${TIME} on ${DATE}, file $FILEPATH was backuped up via rsync&#34; &gt;&gt;
</span></span><span style="display:flex;"><span>/var/log/changelist.log
</span></span><span style="display:flex;"><span>done
</span></span><span style="display:flex;"><span>#查看文件传输日志
</span></span><span style="display:flex;"><span>[root@centos7-slave www]# tail -f /var/log/changelist.log 
</span></span></code></pre></div><h2 id="sersync-实现实时数据同步">sersync 实现实时数据同步<a hidden class="anchor" aria-hidden="true" href="#sersync-实现实时数据同步">#</a></h2>
<p>###　sersync 介绍
sersync类似于inotify，同样用于监控，但它克服了inotify的缺点.
inotify最大的不足是会产生重复事件，或者同一个目录下多个文件的操作会产生多个事件，例如，当监
控目录中有5个文件时，删除目录时会产生6个监控事件，从而导致重复调用rsync命令。另外比如：vim
文件时，inotify会监控到临时文件的事件，但这些事件相对于rsync来说是不应该被监控的</p>
<p><strong>sersync 优点：</strong></p>
<ul>
<li>sersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤，
所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。</li>
<li>sersync配置很简单，其中提供了静态编译好的二进制文件和xml配置文件，直接使用即可</li>
<li>sersync使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li>
<li>sersync有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对
同步失败的文件重新同步</li>
<li>sersync不仅可以实现实时同步，另外还自带crontab功能，只需在xml配置文件中开启，即也可以
按要求隔一段时间整体同步一次，而无需再额外配置crontab功能</li>
<li>sersync 可以二次开发</li>
</ul>
<p>sersync项目地址： <a href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a>
sersync下载地址： <a href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p>
<h3 id="基于rsync-daemon-实现-sersync">基于rsync daemon 实现 sersync<a hidden class="anchor" aria-hidden="true" href="#基于rsync-daemon-实现-sersync">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># #在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量
</span></span><span style="display:flex;"><span>wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]# tar -vxf sersync2.5.4_64bit_binary_stable_final.tar.gz 
</span></span><span style="display:flex;"><span>[root@centos7-slave ~]# cp -r GNU-Linux-x86/ /usr/local/sersync
</span></span><span style="display:flex;"><span>[root@centos7-slave sersync]# echo &#39;PATH=/usr/local/sersync:$PATH&#39; &gt; /etc/profile.d/sersync.sh
</span></span><span style="display:flex;"><span>[root@centos7-slave sersync]# source /etc/profile.d/sersync.sh
</span></span><span style="display:flex;"><span>[root@centos7-slave sersync]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#确认安装rsync客户端工具
</span></span><span style="display:flex;"><span>rpm -q rsync &amp;&gt; /dev/null || dnf -y install rsync
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#备份sersync配置文件
</span></span><span style="display:flex;"><span>cp /usr/local/sersync/confxml.xml{,.bak}
</span></span><span style="display:flex;"><span># 修改配置文件
</span></span><span style="display:flex;"><span>vim /usr/local/sersync/confxml.xml
</span></span><span style="display:flex;"><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
</span></span><span style="display:flex;"><span>&lt;head version=&#34;2.5&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;host hostip=&#34;localhost&#34; port=&#34;8008&#34;&gt;&lt;/host&gt;
</span></span><span style="display:flex;"><span>&lt;debug start=&#34;false&#34;/&gt; # 是否开启调试模式
</span></span><span style="display:flex;"><span>&lt;fileSystem xfs=&#34;false&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;filter start=&#34;false&#34;&gt; #不开启文件过滤功能，当为true时,以下类型的文件将不同
</span></span><span style="display:flex;"><span>步
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;(.*)\.svn&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;(.*)\.gz&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;^info/*&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;^static/*&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;/filter&gt;
</span></span><span style="display:flex;"><span>&lt;inotify&gt; # 监控事件，默认监控
</span></span><span style="display:flex;"><span>delete/close_write/moved_from/moved_to/create folder
</span></span><span style="display:flex;"><span>&lt;delete start=&#34;true&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;createFolder start=&#34;true&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;createFile start=&#34;false&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;closeWrite start=&#34;true&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;moveFrom start=&#34;true&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;moveTo start=&#34;true&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;attrib start=&#34;true&#34;/&gt; #修改此行为true，文件属性变化后也会同步
</span></span><span style="display:flex;"><span>&lt;modify start=&#34;false&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;/inotify&gt;
</span></span><span style="display:flex;"><span>&lt;sersync&gt; # rsync命令的配置段
</span></span><span style="display:flex;"><span>&lt;localpath watch=&#34;/data/www&#34;&gt; #修改此行,需要同步的源目录或文件，建议同步目
</span></span><span style="display:flex;"><span>录
</span></span><span style="display:flex;"><span>&lt;remote ip=&#34;备份服务器IP&#34; name=&#34;backup&#34;/&gt; #修改此行,指定备份服务器地址和rsync
</span></span><span style="display:flex;"><span>daemon的模块名，如果下面开启了ssh start，此时name为远程shell方式运行时的目标目录
</span></span><span style="display:flex;"><span>&lt;!--&lt;remote ip=&#34;192.168.8.39&#34; name=&#34;tongbu&#34;/&gt;--&gt;
</span></span><span style="display:flex;"><span>&lt;!--&lt;remote ip=&#34;192.168.8.40&#34; name=&#34;tongbu&#34;/&gt;--&gt;
</span></span><span style="display:flex;"><span>&lt;/localpath&gt;
</span></span><span style="display:flex;"><span>&lt;rsync&gt;
</span></span><span style="display:flex;"><span>&lt;commonParams params=&#34;-artuz&#34;/&gt; # 指定rsync选项
</span></span><span style="display:flex;"><span>&lt;auth start=&#34;true&#34; users=&#34;rsyncuser&#34; passwordfile=&#34;/etc/rsync.pas&#34;/&gt; #修
</span></span><span style="display:flex;"><span>改此行为true,指定备份服务器的rsync配置的用户和密码文件
</span></span><span style="display:flex;"><span>&lt;userDefinedPort start=&#34;false&#34; port=&#34;874&#34;/&gt;&lt;!-- port=874 --&gt;#指定rsync的非
</span></span><span style="display:flex;"><span>标准端口号
</span></span><span style="display:flex;"><span>&lt;timeout start=&#34;false&#34; time=&#34;100&#34;/&gt;&lt;!-- timeout=100 --&gt;
</span></span><span style="display:flex;"><span>&lt;ssh start=&#34;false&#34;/&gt; #默认使用rsync daemon运行rsync命令,true为使用远程shell模
</span></span><span style="display:flex;"><span>式
</span></span><span style="display:flex;"><span>&lt;/rsync&gt;
</span></span><span style="display:flex;"><span>&lt;failLog path=&#34;/tmp/rsync_fail_log.sh&#34; timeToExecute=&#34;60&#34;/&gt;&lt;!--default every
</span></span><span style="display:flex;"><span>60mins execute once--&gt; #错误重传及日志文件路径
</span></span><span style="display:flex;"><span>&lt;crontab start=&#34;false&#34; schedule=&#34;600&#34;&gt;&lt;!--600mins--&gt; #不开启crontab功能
</span></span><span style="display:flex;"><span>&lt;crontabfilter start=&#34;false&#34;&gt; #不开启crontab定时传输的筛选功能
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;*.php&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;exclude expression=&#34;info/*&#34;&gt;&lt;/exclude&gt;
</span></span><span style="display:flex;"><span>&lt;/crontabfilter&gt;
</span></span><span style="display:flex;"><span>&lt;/crontab&gt;
</span></span><span style="display:flex;"><span>&lt;plugin start=&#34;false&#34; name=&#34;command&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;/sersync&gt;
</span></span><span style="display:flex;"><span>#####################################以下行不需要修改
</span></span><span style="display:flex;"><span>####################################
</span></span><span style="display:flex;"><span>&lt;plugin name=&#34;command&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;param prefix=&#34;/bin/sh&#34; suffix=&#34;&#34; ignoreError=&#34;true&#34;/&gt; &lt;!--prefix
</span></span><span style="display:flex;"><span>/opt/tongbu/mmm.sh suffix--&gt;
</span></span><span style="display:flex;"><span>&lt;filter start=&#34;false&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;include expression=&#34;(.*)\.php&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;include expression=&#34;(.*)\.sh&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;/filter&gt;
</span></span><span style="display:flex;"><span>&lt;/plugin&gt;
</span></span><span style="display:flex;"><span>&lt;plugin name=&#34;socket&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;localpath watch=&#34;/opt/tongbu&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;deshost ip=&#34;192.168.138.20&#34; port=&#34;8009&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;/localpath&gt;
</span></span><span style="display:flex;"><span>&lt;/plugin&gt;
</span></span><span style="display:flex;"><span>&lt;plugin name=&#34;refreshCDN&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;localpath watch=&#34;/data0/htdocs/cms.xoyo.com/site/&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;cdninfo domainname=&#34;ccms.chinacache.com&#34; port=&#34;80&#34; username=&#34;xxxx&#34;
</span></span><span style="display:flex;"><span>passwd=&#34;xxxx&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;sendurl base=&#34;http://pic.xoyo.com/cms&#34;/&gt;
</span></span><span style="display:flex;"><span> &lt;regexurl regex=&#34;false&#34; match=&#34;cms.xoyo.com/site([/a-zA-Z0-
</span></span><span style="display:flex;"><span>9]*).xoyo.com/images&#34;/&gt;
</span></span><span style="display:flex;"><span>&lt;/localpath&gt;
</span></span><span style="display:flex;"><span>&lt;/plugin&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#创建连接rsynd服务器的用户密码文件,并必须修改权限
</span></span><span style="display:flex;"><span>echo 123456 &gt; /etc/rsync.pas
</span></span><span style="display:flex;"><span>chmod 600 /etc/rsync.pas
</span></span><span style="display:flex;"><span>#查看帮助
</span></span><span style="display:flex;"><span>sersync2 -h
</span></span><span style="display:flex;"><span>set the system param
</span></span><span style="display:flex;"><span>execute：echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches
</span></span><span style="display:flex;"><span>execute：echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events
</span></span><span style="display:flex;"><span>parse the command param
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_______________________________________________________
</span></span><span style="display:flex;"><span>参数-d:启用守护进程模式
</span></span><span style="display:flex;"><span>参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
</span></span><span style="display:flex;"><span>c参数-n: 指定开启守护线程的数量，默认为10个
</span></span><span style="display:flex;"><span>参数-o:指定配置文件，默认使用当前工作目录下的confxml.xml文件
</span></span><span style="display:flex;"><span>参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块
</span></span><span style="display:flex;"><span>参数-m:单独启用其他模块，使用 -m socket 开启socket模块
</span></span><span style="display:flex;"><span>参数-m:单独启用其他模块，使用 -m http 开启http模块
</span></span><span style="display:flex;"><span>不加-m参数，则默认执行同步程序
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#以后台方式执行同步
</span></span><span style="display:flex;"><span>sersync2 -dro /usr/local/sersync/confxml.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#如果同步失败,可以手动执行下面命令,观察过程
</span></span><span style="display:flex;"><span>cd /data/www &amp;&amp; rsync -artuz -R --delete ./ rsyncuser@backup-server::backup --password-file=/etc/rsync.pas &gt;/dev/null 2&gt;&amp;1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#sersync支持多实例，也即监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行
</span></span><span style="display:flex;"><span>sersync2 -rd -o /etc/sersync.d/nginx.xml
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="http://hugo.itshare.work/archivist/nginx/">
    <span class="title">« 上一页</span>
    <br>
    <span>Nginx</span>
  </a>
  <a class="next" href="http://hugo.itshare.work/archivist/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/">
    <span class="title">下一页 »</span>
    <br>
    <span>日志服务管理</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="http://hugo.itshare.work/" style="color:#939393;">Cookie</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
