<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>运维自动化工具Ansible(一) | Cookie</title>
<meta name="keywords" content="Ansible">
<meta name="description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗">
<meta name="author" content="Cookie">
<link rel="canonical" href="http://hugo.itshare.work/posts/ansible/ansible/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://hugo.itshare.work/img/Q.gif">
<link rel="apple-touch-icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="mask-icon" href="http://hugo.itshare.work/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="运维自动化工具Ansible(一)" />
<meta property="og:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hugo.itshare.work/posts/ansible/ansible/" />
<meta property="og:image" content="http://oss.itshare.work/itshare-work-images/2.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-21T19:12:21+00:00" />
<meta property="article:modified_time" content="2023-02-21T19:12:21+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://oss.itshare.work/itshare-work-images/2.jpg" />
<meta name="twitter:title" content="运维自动化工具Ansible(一)"/>
<meta name="twitter:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "http://hugo.itshare.work/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "🧿 Ansible",
          "item": "http://hugo.itshare.work/posts/ansible/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "运维自动化工具Ansible(一)",
      "item": "http://hugo.itshare.work/posts/ansible/ansible/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "运维自动化工具Ansible(一)",
  "name": "运维自动化工具Ansible(一)",
  "description": "Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗",
  "keywords": [
    "Ansible"
  ],
  "articleBody": "Ansible介绍和架构 Ansible发展史 Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗 2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购 官网：https://www.ansible.com/ 官方文档：https://docs.ansible.com/\nAnsible 功能 批量执行远程命令,可以对远程的多台主机同时进行命令的执行 批量安装和配置软件服务，可以对远程的多台主机进行自动化的方式配置和管理各种服务 编排高级的企业级复杂的IT架构任务, Ansible的Playbook和role可以轻松实现大型的IT复杂架构 提供自动化运维工具的开发API, 有很多运维工具,如jumpserver就是基于 ansible 实现自动化管工功能 Ansible 特点 优点\n功能丰富的模块：提供了多达数千个的各种功能的模块,完成特定任务只需调用特定模块即可，还 支持自定义模块，可使用任何编程语言写模块 使用和部署简单: 无需安装专用代理软件,基于python和SSH(默认已安装)实现 安全: 基于OpenSSH实现安全通讯无需专用协议 幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况,此特性和模块有关 支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构 较强大的多层解决方案 Role Python语言实现, 基于Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块 属于红帽(IBM)公司产品,背景强大,未来发展前景光明 缺点\n如果管理的主机较多时,执行效率不如saltstack高 当前还不支持像MySQL数据库一样的事务回滚 Ansible 架构 Ansible 组成 组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具\nINVENTORY：Ansible管理主机的清单文件,默认为 /etc/ansible/hosts MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义 PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用 API：供第三方程序调用的应用程序编程接口 Ansible 命令执行来源 USER 普通用户，即SYSTEM ADMINISTRATOR PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件 CMDB（配置管理数据库） API 调用 PUBLIC/PRIVATE CLOUD API调用 USER-\u003e Ansible Playbook -\u003e Ansibile 注意事项 执行ansible的主机一般称为管理端, 主控端，中控，master或堡垒机 主控端Python版本需要2.6或以上 被控端Python版本小于2.4，需要安装python-simplejson 被控端如开启SELinux需要安装libselinux-python windows 不能做为主控端,只能做为被控制端 Ansible 安装和常见模块 Ansible 安装 ansible的安装方法有多种 官方文档\nhttps://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html https://docs.ansible.com/ansible/latest/installation_guide/index.html 下载\nhttps://releases.ansible.com/ansible/ pip 下载\nhttps://pypi.org/project/ansible/ 包安装方式 #CentOS 的EPEL源的rpm包安装 [root@centos ~]#yum install ansible #ubuntu 安装 [root@ubuntu ~]#apt -y install ansible pip安装 pip 是安装Python包的管理器，类似 yum 范例: 在rocky8上通过pip3安装ansible\n[root@rocky8 ~]#yum -y install python39 rust [root@rocky8 ~]#pip3 install ansible [root@rocky8 ~]#ansible --version ansible [core 2.12.6] config file = None configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.9/site-packages/ansible ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)] jinja version = 3.1.2 libyaml = True [root@rocky8 ~]#ansible-doc -l 2\u003e /dev/null|wc -l 6763 范例: 安装python3.8 支持ansible2.12以上版本\n[root@rocky8 ~]#yum -y install python38 python38-pip [root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple [root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/ [root@rocky8 ~]#ansible --version ansible [core 2.12.6] config file = None configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/local/lib/python3.8/site- packages/ansible ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections executable location = /usr/local/bin/ansible python version = 3.8.8 (default, Nov 9 2021, 13:31:34) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)] jinja version = 3.1.2 libyaml = True 范例: 安装默认的python3.6版本会有警报提示\n[root@rocky8 ~]#yum -y install python3 [root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple [root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/ [root@rocky8 ~]#ansible --version [DEPRECATION WARNING]: Ansible will require Python 3.8 or newer on the controller starting with Ansible 2.12. Current version: 3.6.8 (default, Nov 9 2021, 14:44:26) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)]. This feature will be removed from ansible-core in version 2.12. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg. /usr/local/lib/python3.6/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python core team. Therefore, support for it is deprecated in cryptography and will be removed in a future release. from cryptography.exceptions import InvalidSignature ansible [core 2.11.12] config file = None configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/local/lib/python3.6/site- packages/ansible ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections executable location = /usr/local/bin/ansible python version = 3.6.8 (default, Nov 9 2021, 14:44:26) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)] jinja version = 3.0.3 libyaml = True [root@rocky8 ~]#ansible-doc -l 2\u003e /dev/null|wc -l 6141 范例\n[root@centos7 ~]#yum -y install python-pip [root@centos7 ~]#pip install --upgrade pip [root@centos7 ~]#pip install ansible --upgrade [root@centos7 ~]#ansible --version /usr/lib64/python2.7/site-packages/cryptography/__init__.py:39: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in a future release. CryptographyDeprecationWarning, ansible 2.9.12 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Apr 2 2020, 13:16:51) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] [root@centos7 ~]#ll /opt/etc/ansible/ansible.cfg -rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg 确认安装 [root@ansible ~]#ansible --version ansible 2.9.5 config file = /etc/ansible/ansible.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.6/site-packages/ansible executable location = /usr/bin/ansible python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507 (Red Hat 8.3.1-4)] Ansible 相关文件 Ansible 配置文件列表 /etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性,也可以在项目的目录中创建此文件,当前目录下如果也有ansible.cfg,则此文件优先生效,建议每个项目目录下,创建独有的ansible.cfg文 件 /etc/ansible/hosts 主机清单 /etc/ansible/roles/ 存放角色的目录 Ansible 主配置文件 Ansible 的配置文件可以放在多个不同地方,优先级从高到低顺序如下\nANSIBLE_CONFIG #环境变量,目录下的文件必须存在才能生效 ./ansible.cfg #当前目录下的ansible.cfg,一般一个项目对应一个专用配置文件,推荐使用 ~/.ansible.cfg #当前用户家目录下的.ansible.cfg /etc/ansible/ansible.cfg #系统默认配置文件 Ansible 的默认配置文件 /etc/ansible/ansible.cfg ,其中大部分的配置内容无需进行修改\n[defaults] #inventory = /etc/ansible/hosts #主机列表配置文件 #library = /usr/share/my_modules/ #库文件存放目录 #remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录 #local_tmp = $HOME/.ansible/tmp #本机的临时命令执行目录 #forks = 5 #默认并发数 #sudo_user = root #默认sudo 用户 #ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码 #ask_pass = True #remote_port = 22 #host_key_checking = False #检查对应服务器的host_key，建议取消此行注释,实现第一次连 接自动信任目标主机 #log_path=/var/log/ansible.log #日志文件，建议启用 #module_name = command #默认模块，可以修改为shell模块 [privilege_escalation] #普通用户提权配置 #become=True #become_method=sudo #become_user=root #become_ask_pass=False 范例: 通过环境变量ANSIBLE_CONFIG指定ansible配置文件路径\n[root@rocky8 ~]#cd /data/ansible/ [root@rocky8 ansible]#cat ansbile.cfg [defaults] inventory = ./hosts [root@rocky8 ansible]#cat hosts [ubuntu] 10.0.0.100 [centos] 10.0.0.7 10.0.0.8 #定义变量 [root@rocky8 ansible]#export ANSIBLE_CONFIG=./ansbile.cfg [root@rocky8 ansible]#ansible --version ansible [core 2.12.6] config file = /data/ansible/ansbile.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.9/site-packages/ansible ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)] jinja version = 3.1.2 libyaml = True [root@rocky8 ansible]#ansible --list-hosts all hosts (3): 10.0.0.100 10.0.0.7 10.0.0.8 范例: 创建ansible 指定项目专用的配置文件\n[root@ubuntu2004 ~]#ansible --version ansible 2.9.6 config file = /etc/ansible/ansible.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3/dist-packages/ansible executable location = /usr/bin/ansible python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0] [root@ubuntu2004 ~]#mkdir /data/ansible -p [root@ubuntu2004 ~]#cd /data/ansible/ [root@ubuntu2004 ansible]#touch ansible.cfg [root@ubuntu2004 ansible]#ansible --version ansible 2.9.6 config file = /data/ansible/ansible.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3/dist-packages/ansible executable location = /usr/bin/ansible python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0] [root@ubuntu2004 ansible]#cd [root@ubuntu2004 ~]#ansible --version ansible 2.9.6 config file = /etc/ansible/ansible.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3/dist-packages/ansible executable location = /usr/bin/ansible python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0] 范例: 当前目录下的ansible的配置文件优先生效\n[root@ansible ~]#ansible --version ansible 2.9.17 config file = /etc/ansible/ansible.cfg configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.6/site-packages/ansible executable location = /usr/bin/ansible python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121 (Red Hat 8.3.1-5)] [root@ansible ~]#cp /etc/ansible/ansible.cfg . [root@ansible ~]#ansible --version ansible 2.9.17 config file = /root/ansible.cfg #注意配置文件路径 configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python3.6/site-packages/ansible executable location = /usr/bin/ansible python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121 (Red Hat 8.3.1-5)] [root@ansible ~]# Inventory 主机清单文件 ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory 主机清单文件中将其分组组织 默认的inventory file为 /etc/ansible/hosts inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成 注意:\n生产建议在每个项目目录下创建项目独立的hosts文件 通过项目目录下的ansible.cfg文件中的 inventory = ./hosts实现 官方文档:\nhttps://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html 主机清单文件格式 inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中,此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明,如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机 Inventory 参数说明\nansible_ssh_host #将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置. ansible_ssh_port #ssh端口号.如果不是默认的端口号,通过此变量设置.这种可以使用 ip:端口 192.168.1.100:2222 ansible_ssh_user #默认的 ssh 用户名 ansible_ssh_pass #ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥) ansible_sudo_pass #sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass) ansible_sudo_exe (new in version 1.8) #sudo 命令路径(适用于1.8及以上版本) ansible_connection #与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 'smart','smart' 方式会根据是否支持 ControlPersist,来判断'ssh' 方式是否可行. ansible_ssh_private_key_file #ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况. ansible_shell_type #目标系统的shell类型.默认情况下,命令的执行使用 'sh' 语法,可设置为'csh' 或 'fish'. ansible_python_interpreter #目标主机的 python 路径.适用于的情况: 系统中有多个 Python,或者命令路径不是\"/usr/bin/python\",比如 \\*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python.之所以不使用 \"/usr/bin/env\" 机制,因为这要求远程用户的路径设置正确,且要求 \"python\"可执行程序名不可为 python以外的名字(实际有可能名为python26).与ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径.... 范例：\nntp.wang.org [webservers] www1.wang.org:2222 www2.wang.org [dbservers] db1.wang.org db2.wang.org db3.wang.org #或者 db[1:3].wang.org 范例: 组嵌套\n[webservers] www[1:100].example.com [dbservers] db-[a:f].example.com [appservers] 10.0.0.[1:100] #定义testsrvs组中包括两个其它分组,实现组嵌套 [testsrvs:children] webservers dbservers 范例: 基于用户名和密码的ssh连接主机清单\n[test] 10.0.0.8 ansible_connection=local #指定本地连接,无需ssh配置 #每个主机分别指定用户和密码,ansible_connection=ssh 需要StrictHostKeyChecking no 或者host_key_checking = False 10.0.0.7 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=wangansible_ssh_password=123456 10.0.0.6 ansible_ssh_user=root ansible_ssh_password=123456 #对每个分组的所有主机统一定义用户和密码,执行ansible命令时显示别名,如web01 [websrvs] web01 ansible_ssh_host=10.0.0.101 web02 ansible_ssh_host=10.0.0.102 [websrvs:vars] ansible_ssh_password=magedu some_host ansible_ssh_port=2222 ansible_ssh_user=manager aws_host ansible_ssh_private_key_file=/home/example/.ssh/aws.pem freebsd_host ansible_python_interpreter=/usr/local/bin/python ruby_module_host ansible_ruby_interpreter=/usr/bin/ruby.1.9.3 Ansible相关工具 /usr/bin/ansible 主程序，临时命令执行工具\n/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man\n/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本\n/usr/bin/ansible-pull 远程执行命令的工具\n/usr/bin/ansible-vault 文件加密工具\n/usr/bin/ansible-console 基于Console界面与用户交互的执行工具\n/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台\n利用ansible实现管理的主要方式：\nAnsible Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景\nAnsible playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程\nansible 使用前准备 ansible 相关工具大多数是通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能 建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点 范例：利用sshpass批量实现基于key验证脚本1\n[root@centos8 ~]#vim /etc/ssh/ssh_config #修改下面一行 StrictHostKeyChecking no [root@centos8 ~]#cat hosts.list 192.168.32.178 192.168.32.179 [root@centos8 ~]#vim push_ssh_key.sh #!/bin/bash rpm -ql shpass \u0026\u003e /dev/null || yum -y install sshpass [ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P '' export SSHPASS=123456 while read IP;do sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP done \u003c hosts.list 范例: 实现基于key验证的脚本2\n[root@centos8 ~]#cat ssh_key.sh #!/bin/bash PLIST=\" 192.168.32.178 192.168.32.179\" rpm -q sshpass \u0026\u003e /dev/null || yum -y install sshpass [ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P '' export SSHPASS=123456 for IP in $IPLIST;do { sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP; } \u0026 done wait ansible-doc 此工具用来显示模块帮助,相当于man 格式\nansible-doc [options] [module...] -l, --list #列出可用模块 -s, --snippet #显示指定模块的playbook片段 范例: 查看帮助\n[root@rocky ~]# ansible-doc --help usage: ansible-doc [-h] [--version] [-v] [-M MODULE_PATH] [--playbook-dir BASEDIR] [-t {become,cache,callback,cliconf,connection,httpapi,inventory,lookup,netconf,shell,vars,module,strategy,role,keyword}] [-j] [-r ROLES_PATH] [-e ENTRY_POINT | -s | -F | -l | --metadata-dump] [--no-fail-on-errors] [plugin ...] plugin documentation tool positional arguments: plugin Plugin 范例：\n#列出所有模块 ansible-doc -l #查看指定模块帮助用法 ansible-doc ping #查看指定模块帮助用法 ansible-doc -s ping 范例: 查看指定的插件\n[root@rocky ~]# ansible-doc -t connection -l local execute on controller paramiko_ssh Run tasks via python ssh (paramiko) psrp Run tasks over Microsoft PowerShell Remoting Protocol ssh connect via SSH client binary winrm Run tasks over Microsoft's WinRM [root@rocky ~]# [root@rocky ~]# ansible-doc -t lookup -l config Lookup current Ansible configuration values csvfile read data from a TSV or CSV file dict returns key/value pair items from dictionaries env Read the value of environment variables file read file contents fileglob list files matching a pattern first_found return first file found from list indexed_items rewrites lists to return 'indexed items' ini read data from an ini file inventory_hostnames list of inventory hosts matching a host pattern items list of items lines read lines from command list simply returns what it is given nested composes a list with nested elements of other lists password retrieve or generate a random password, stored in a file pipe read output from a command random_choice return random element from list sequence generate a list based on a number sequence subelements traverse nested key from a list of dictionaries template retrieve contents of file after templating with Jinja2 together merges lists into synchronized list unvault read vaulted file(s) contents url return contents from URL varnames Lookup matching variable names vars Lookup templated value of variables [root@rocky ~]# ansible Ansible Ad-Hoc 介绍 Ansible Ad-Hoc 的执行方式的主要工具就是 ansible 特点: 一次性的执行,不会保存执行命令信息,只适合临时性或测试性的任务\nansible 命令用法 格式：\nansible [-m module_name] [-a args] 选项说明：\n--version #显示版本 -m module #指定模块，默认为command -v #详细过程 -vv -vvv更详细 --list-hosts #显示主机列表，可简写 --list -C, --check #检查，并不执行 -T, --timeout=TIMEOUT #执行命令的超时时间，默认10s -k, --ask-pass #提示输入ssh连接密码，默认Key验证 -u, --user=REMOTE_USER #执行远程执行的用户,默认root -b, --become #代替旧版的sudo实现通过sudo机制实现提升权限 --become-user=USERNAME #指定sudo的runas用户，默认为root -K, --ask-become-pass #提示输入sudo时的口令 -f FORKS, --forks FORKS #指定并发同时执行ansible任务的主机数 -i INVENTORY, --inventory INVENTORY #指定主机清单文件 范例:\n#以wang用户执行ping存活检测 ansible all -m ping -u wang -k #以wang sudo至root执行ping存活检测 ansible all -m ping -u wang -k -b #以wang sudo至mage用户执行ping存活检测 ansible all -m ping -u wang -k -b --become-user=mage #以wang sudo至root用户执行ls ansible all -m command -u wang -a 'ls /root' -b --become-user=root -k -K 范例: 并发执行控制\n#分别执行下面两条命令观察结果 [root@ansible ~]#ansible all -a 'sleep 5' -f1 [root@ansible ~]#ansible all -a 'sleep 5' -f10 范例: 使用普能用户进行远程管理\n#在所有控制端和被控制端创建用户和密码 [root@rocky8 ~]#useradd wang [root@rocky8 ~]#echo wang:123456 | chpasswd #在所有被控制端对用户sudo授权 [root@rocky8 ~]#visudo wang ALL=(ALL) NOPASSWD: ALL [root@rocky8 ~]#visudo -c /etc/sudoers: parsed OK #实现从控制端到被控制端的基于key验证 [root@ansible ~]#su - wang wang@ansible:~$ssh-keygen -f ~/.ssh/id_rsa -P '' wang@ansible:~$$ssh-copy-id wang@'10.0.0.8' #使用普通用户测试连接,默认连接权限不足失败 wang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root' 10.0.0.8 | FAILED | rc=2 \u003e\u003e ls: cannot open directory '/root': Permission deniednon-zero return code #使用普通用户通过-b选项连接实现sudo提权后连接成功 wang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root' -b --become-user root 10.0.0.8 | CHANGED | rc=0 \u003e\u003e anaconda-ks.cfg #修改配置文件指定sudo机制 [root@ansible ~]#vim /etc/ansible/ansible.cfg #取消下面行前面的注释 [privilege_escalation] become=True become_method=sudo become_user=root become_ask_pass=False #再次测试 [root@ansible ~]#su - wang wang@ansible:~$ ansible 10.0.0.8 -m shell -a 'ls /root' 10.0.0.8 | CHANGED | rc=0 \u003e\u003e anaconda-ks.cfg 范例: 使用普通用户连接远程主机执行代替另一个用户身份执行操作\n[root@centos8 ~]#useradd wang [root@centos8 ~]#echo wang:123456 | chpasswd #先在被控制端能过sudo对普通用户授权 [root@centos8 ~]#grep wang /etc/sudoers wang ALL=(ALL) NOPASSWD: ALL #以wang的用户连接用户,并利用sudo代表mage执行whoami命令 [root@ansible ~]#ansible 10.0.0.8 -m shell -a 'whoami' -u wang -k -b --become- user=mage SSH password: #输入远程主机wang用户ssh连接密码 10.0.0.8 | CHANGED | rc=0 \u003e\u003e mage ansible的Host-pattern 用于匹配被控制的主机的列表 All ：表示所有Inventory中的所有主机 范例\nansible all -m ping *:通配符\nansible \"*\" -m ping ansible 192.168.1.* -m ping ansible \"srvs\" -m ping ansible \"10.0.0.6 10.0.0.7\" -m ping 或关系\nansible \"websrvs:appsrvs\" -m ping ansible \"192.168.1.10:192.168.1.20\" -m ping 逻辑与\n#在websrvs组并且在dbsrvs组中的主机 ansible \"websrvs:\u0026dbsrvs\" -m ping 逻辑非\n#在所有主机,但不在websrvs组和dbsrvs组中的主机 #注意：此处为单引号 ansible 'all:!dbsrvs:!websrvs' -m ping 综合逻辑\nansible 'websrvs:dbsrvs:\u0026appsrvs:!ftpsrvs' -m ping 正则表达式\nansible \"websrvs:dbsrvs\" -m ping ansible \"~(web|db).*\\.magedu\\.com\" -m ping ansible 命令的执行过程 加载自己的配置文件,默认/etc/ansible/ansible.cfg 查找主机清单中对应的主机或主机组 加载自己对应的模块文件，如：command 通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户 $HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件 给文件+x执行 执行并返回结果 删除临时py文件，退出 ansible 命令的执行状态 [root@centos8 ~]#grep -A 14 '\\[colors\\]' /etc/ansible/ansible.cfg [colors] #highlight = white #verbose = blue #warn = bright purple #error = red #debug = dark gray #deprecate = purple #skip = cyan #unreachable = red #ok = green #changed = yellow #diff_add = green #diff_remove = red #diff_lines = cyan 绿色：执行成功并且对目标主机不需要做改变的操作 黄色：执行成功并且对目标主机做变更 红色：执行失败 ansible-console 此工具可交互执行命令，支持tab，ansible 2.0+新增 提示符格式：\n执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$ 常用子命令：\n设置并发数： forks n 例如： forks 10 切换组： cd 主机组 例如： cd web 列出当前组主机列表： list 列出所有的内置命令： ?或help 范例\n[root@ansible ~]#ansible-console Welcome to the ansible console. Type help or ? to list commands. root@all (3)[f:5]$ ping 10.0.0.7 | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false, \"ping\": \"pong\" } 10.0.0.6 | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false, \"ping\": \"pong\" } 10.0.0.8 | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/libexec/platform-python\" }, \"changed\": false, \"ping\": \"pong\" } root@all (3)[f:5]$ list 10.0.0.8 10.0.0.7 10.0.0.6 root@all (3)[f:5]$ cd websrvs root@websrvs (2)[f:5]$ list 10.0.0.7 10.0.0.8 root@websrvs (2)[f:5]$ forks 10 root@websrvs (2)[f:10]$ cd appsrvs root@appsrvs (2)[f:5]$ yum name=httpd state=present root@appsrvs (2)[f:5]$ service name=httpd state=started ansible-playbook 此工具用于执行编写好的 playbook 任务 范例：\nansible-playbook hello.yml cat hello.yml --- #hello world yml file - hosts: websrvs remote_user: root gather_facts: no tasks: - name: hello world command: /usr/bin/wall hello world ansible-vault 此工具可以用于加密解密yml文件 格式：\nansible-vault [create|decrypt|edit|encrypt|rekey|view] 范例\nansible-vault encrypt hello.yml #加密 ansible-vault decrypt hello.yml #解密 ansible-vault view hello.yml #查看 ansible-vault edit hello.yml #编辑加密文件 ansible-vault rekey hello.yml #修改口令 ansible-vault create new.yml #创建新文件 #执行加密的playbook,交互式输入密码 chmod 600 hello.yml ansible-playbook --ask-vault-pass hello.yml #从pass.txt文件中读取密码 ansible-playbook --vault-password-file pass.txt hello.yml #从配置文件中取得密码 #vi /etc/ansible/ansible.cfg [defaults] ault-password-file=pass.txt #可以直接执行加密文件 ansible-playbook hello.yml ansible-galaxy Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。 Ansible 提供了ansible-galaxy命令行工具连接 https://galaxy.ansible.com 网站下载相应的roles, 进行init(初始化、search( 查拘、install(安装、 remove(移除)等操作。\n范例：\n#搜索项目 [root@ansible ~]#ansible-galaxy search lamp #列出所有已安装的galaxy ansible-galaxy list #安装galaxy,默认下载到~/.ansible/roles下 ansible-galaxy install geerlingguy.mysql ansible-galaxy install geerlingguy.redis #删除galaxy ansible-galaxy remove geerlingguy.redis Ansible常用模块 2015年12月只270多个模块 2016年12年26日ansible 1.9.2 有540个模块 2018年01月12日ansible 2.3.8 有1378个模块 2018年05月28日ansible 2.5.3 有1562个模块 2018年07月15日ansible 2.6.3 有1852个模块 2018年11月19日ansible 2.7.2 有2080个模块 2020年03月02日ansible 2.9.5 有3387个模块 2021年12月22日ansible 2.11.8 有6141个模块 2022年06月04日ansible 2.12.6 有6763个模块 虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只需要熟悉10几个模块即可 常用模块帮助文档参考：\nhttps://docs.ansible.com/ansible/2.9/modules/modules_by_category.html https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html https://docs.ansible.com/ansible/latest/modules/modules_by_category.html Command 模块 功能：在远程主机执行命令，此为默认模块，可忽略 -m 选项 注意：此命令不支持 $VARNAME \u003c \u003e | ; \u0026 等，可用shell模块实现 注意：此模块不具有幂等性 常见选项\nchdir=dir #执行命令前,先切换至目录dir creates=file #当file不存在时才会执行 removes=file #当file存在时才会执行 范例：\n[root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc cat centos-release' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.7.1908 (Core) 10.0.0.8 | CHANGED | rc=0 \u003e\u003e CentOS Linux release 8.1.1911 (Core) [root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc creates=/data/f1.txt cat centos-release' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.7.1908 (Core) 10.0.0.8 | SUCCESS | rc=0 \u003e\u003e skipped, since /data/f1.txt exists [root@ansible ~]#ansible websrvs -m command -a 'chdir=/etc removes=/data/f1.txt cat centos-release' 10.0.0.7 | SUCCESS | rc=0 \u003e\u003e skipped, since /data/f1.txt does not exist 10.0.0.8 | CHANGED | rc=0 \u003e\u003e CentOS Linux release 8.1.1911 (Core) ansible websrvs -m command -a 'service vsftpd start' ansible websrvs -m command -a 'echo magedu |passwd --stdin wang' ansible websrvs -m command -a 'rm -rf /data/' ansible websrvs -m command -a 'echo hello \u003e /data/hello.log' ansible websrvs -m command -a \"echo $HOSTNAME\" Shell 模块 功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, \u003e , 相当于增强版的command模块 注意：此模块不具有幂等性,建议能不能就用此模块,最好使用专用模块 常见选项\nchdir=dir #执行命令前,先切换至目录dir creates=file #当file不存在时才会执行 removes=file #当file存在时才会执行 范例：\n[root@ansible ~]#ansible websrvs -m shell -a \"echo $HOSTNAME\" 10.0.0.7 | CHANGED | rc=0 \u003e\u003e ansible 10.0.0.8 | CHANGED | rc=0 \u003e\u003e ansible [root@ansible ~]#ansible websrvs -m shell -a 'echo $HOSTNAME' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e centos7.wangxiaochun.com 10.0.0.8 | CHANGED | rc=0 \u003e\u003e centos8.localdomain [root@ansible ~]#ansible websrvs -m shell -a 'echo centos | passwd --stdin wang' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e Changing password for user wang. passwd: all authentication tokens updated successfully. 10.0.0.8 | CHANGED | rc=0 \u003e\u003e Changing password for user wang. passwd: all authentication tokens updated successfully. [root@ansible ~]#ansible websrvs -m shell -a 'ls -l /etc/shadow' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e ---------- 1 root root 889 Mar 2 14:34 /etc/shadow 10.0.0.8 | CHANGED | rc=0 \u003e\u003e ---------- 1 root root 944 Mar 2 14:34 /etc/shadow [root@ansible ~]#ansible websrvs -m shell -a 'echo hello \u003e /data/hello.log' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e 10.0.0.8 | CHANGED | rc=0 \u003e\u003e [root@ansible ~]#ansible websrvs -m shell -a 'cat /data/hello.log' 10.0.0.7 | CHANGED | rc=0 \u003e\u003e hello 10.0.0.8 | CHANGED | rc=0 \u003e\u003e hello 注意：调用bash执行命令 类似 cat /tmp/test.md | awk -F’|’ ‘{print $1,$2}’ \u0026\u003e /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器 范例：将shell模块代替command，设为模块\n[root@ansible ~]#vim /etc/ansible/ansible.cfg #修改下面一行 module_name = shell Script 模块 功能：在远程主机上运行ansible服务器上的脚本(无需执行权限) 注意：此模块不具有幂等性 常见选项\nchdir=dir #执行命令前,先切换至目录dir cmd #指定ansible主机的命令 creates=file #当file不存在时才会执行 removes=file #当file存在时才会执行 范例：\nansible websrvs -m script -a /data/test.sh Copy 模块 功能：复制ansible服务器主控端或远程的本机的文件到远程主机 注意: src=file 如果是没指明路径,则为当前目录或当前目录下的files目录下的file文件 常见选项\nsrc #控制端的源文件路径 dest #被控端的文件路径 owner #属主 group #属组 mode #权限 backup #是否备份 validate #验证成功才会执行copy remote_src #no是默认值,表示src文件在ansible主机,yes表示src文件在远程主机 范例:\n#如目标存在，默认覆盖，此处指定先备 ansible websrvs -m copy -a \"src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes\" #指定内容，直接生成目标文件 ansible websrvs -m copy -a \"content='wang 123456\\nxiao 654321\\n' dest=/etc/rsync.pas owner=root group=root mode=0600\" #复制/etc目录自身,注意/etc/后面没有/ ansible websrvs -m copy -a \"src=/etc dest=/backup\" #复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/ ansible websrvs -m copy -a \"src=/etc/ dest=/backup\" #复制/etc/suders,并校验语法 ansible websrvs -m copy -a \"src=/etc/suders dest=/etc/sudoers.edit remote_src=yes validate=/usr/sbin/visudo -csf %s\" Get_url 模块 功能: 用于将文件从http、https或ftp下载到被管理机节点上 常用参数如下：\nurl #下载文件的URL,支持HTTP，HTTPS或FTP协议 dest #下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标 设置的名称 owner #指定属主 group #指定属组 mode #指定权限 force #如果yes，dest不是目录，将每次下载文件，如果内容改变替换文件。如果no，则只有在目标不存 在时才会下载 checksum #对目标文件在下载后计算摘要，以确保其完整性 #示例: checksum=\"sha256:D98291AC[...]B6DC7B97\", checksum=\"sha256:http://example.com/path/sha256sum.txt\" url_username #用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用`url_password' url_password #用于HTTP基本认证的密码。 如果未指定`url_username'参数，则不会使用`url_password'参数 validate_certs #如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用 timeout #URL请求的超时时间,秒为单位 范例: 下载并MD5验证\n[root@ansible ~]#ansible websrvs -m get_url -a 'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz checksum=\"md5:b2d33d24d89b8b1f87ff5d251aa27eb8\"' Fetch 模块 功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录 常见选项\nsrc #被控制端的源文件路径,只支持文件 dest #ansible控制端的目录路径 范例：\nansible websrvs -m fetch -a 'src=/root/test.sh dest=/data/scripts' 范例：\n[root@ansible ~]#ansible all -m fetch -a 'src=/etc/redhat-release dest=/data/os' [root@ansible ~]#tree /data/os/ /data/os/ ├── 10.0.0.6 │ └── etc │ └── redhat-release ├── 10.0.0.7 │ └── etc │ └── redhat-release └── 10.0.0.8 └── etc └── redhat-release 6 directories, 3 files File 模块 功能：设置文件属性,创建文件,目录和软链接等 常见选项\npath #在被控端创建的路径 owner #属主 group #属组 mode #权限 state #状态 =touch #创建文件 =directory #创建目录 =link #软链接 =hard #硬链接 recurse #yes表示递归授权 范例：\n#创建空文件 ansible all -m file -a 'path=/data/test.txt state=touch' ansible all -m file -a 'path=/data/test.txt state=absent' ansible all -m file -a \"path=/root/test.sh owner=wang mode=755\" #创建目录 ansible all -m file -a \"path=/data/mysql state=directory owner=mysql group=mysql\" #创建软链接 ansible all -m file -a 'src=/data/testfile path|dest|name=/data/testfile-link state=link' #创建目录 ansible all -m file -a 'path=/data/testdir state=directory' #递归修改目录属性,但不递归至子目录 ansible all -m file -a \"path=/data/mysql state=directory owner=mysql group=mysql\" #递归修改目录及子目录的属性 ansible all -m file -a \"path=/data/mysql state=directory owner=mysql group=mysql recurse=yes\" stat 模块 功能：检查文件或文件系统的状态 注意：对于Windows目标，请改用win_stat模块\n常见选项\npath #文件/对象的完整路径（必须） 常用的返回值判断：\nexists： 判断是否存在 isuid： 调用用户的ID与所有者ID是否匹配 范例:\n[root@ansible ~]#ansible 127.0.0.1 -m stat -a 'path=/etc/passwd' 127.0.0.1 | SUCCESS =\u003e { \"changed\": false, \"stat\": { \"atime\": 1614601466.7493012, \"attr_flags\": \"\", \"attributes\": [], \"block_size\": 4096, \"blocks\": 8, \"charset\": \"us-ascii\", \"checksum\": \"8f7a9a996d24de98bf1eab4a047f8e89e9c708cf\", \"ctime\": 1614334259.4498665, \"dev\": 2050, \"device_type\": 0, \"executable\": false, \"exists\": true, \"gid\": 0, \"gr_name\": \"root\", \"inode\": 134691833, \"isblk\": false, \"ischr\": false, \"isdir\": false, \"isfifo\": false, \"isgid\": false, \"islnk\": false, \"isreg\": true, \"issock\": false, \"isuid\": false, \"mimetype\": \"text/plain\", \"mode\": \"0000\", \"mtime\": 1614334259.4498665, \"nlink\": 1, \"path\": \"/etc/passwd\", \"pw_name\": \"root\", \"readable\": true, \"rgrp\": false, \"roth\": false, \"rusr\": false, \"size\": 1030, \"uid\": 0, \"version\": \"671641160\", \"wgrp\": false, \"woth\": false, \"writeable\": true, \"wusr\": false, \"xgrp\": false, \"xoth\": false, \"xusr\": false } } 案例：\n- name: install | Check if file is already configured. stat: path={{ nginx_file_path }} connection: local register: nginx_file_result - name: install | Download nginx file get_url: url={{ nginx_file_url }} dest={{ software_files_path }} validate_certs=no connection: local when:，not. nginx_file_result.stat.exists 范例:\n[root@ansible ansible]#cat stat.yml --- - hosts: websrvs tasks: - name: check file stat: path=/data/mysql register: st - name: debug debug: msg: \"/data/mysql is not exist\" when: not st.stat.exists [root@ansible ansible]#ansible-playbook stat.yml PLAY [websrvs] ******************************************************************************** *************************************** TASK [Gathering Facts] ******************************************************************************** ******************************* ok: [10.0.0.7] ok: [10.0.0.8] TASK [check file] ******************************************************************************** ************************************ ok: [10.0.0.7] ok: [10.0.0.8] TASK [debug] ******************************************************************************** ***************************************** ok: [10.0.0.7] =\u003e { \"msg\": \"/data/mysql is not exist\" } ok: [10.0.0.8] =\u003e { \"msg\": \"/data/mysql is not exist\" } PLAY RECAP ******************************************************************************** ******************************************* 10.0.0.7 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 10.0.0.8 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 unarchive 模块 功能：解包解压缩 实现有两种用法：\n将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置remote_src=no,此为默认值,可省略 将远程本主机上或非ansible的其它主机的某个压缩包解压缩到远程主机本机的指定路径下，需要设置remote_src=yes 常见参数：\nremote_src #和copy功能一样且选项互斥，yes表示源文件在远程被控主机或其它非ansible的其它主机上，no表示文件在ansible主机上,默认值为no, 此选项代替copy选项 copy #默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件,此选项已废弃 src #源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置remote_src=yes dest #远程主机上的目标路径 mode #设置解压缩后的文件权限 creates=/path/file #当绝对路径/path/file不存在时才会执行 范例：\nansible all -m unarchive -a 'src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin' ansible all -m unarchive -a 'src=/tmp/foo.zip dest=/data mode=0777' ansible all -m unarchive -a 'src=https://example.com/example.zip dest=/data ' ansible websrvs -m unarchive -a 'src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/ owner=root remote_src=yes' ansible websrvs -m unarchive -a 'src=http://nginx.org/download/nginx- 1.18.0.tar.gz dest=/usr/local/src/ remote_src=yes'' Archive 模块 功能：打包压缩保存在被管理节点\n常见选项\npath #压缩的文件或目录 dest #压缩后的文件 format #压缩格式,支持gz,bz2,xz,tar,zip 范例：\nansible websrvs -m archive -a 'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600' Hostname 模块 功能：管理主机名 常见选项\nname #修改后的主机名称 范例：\nansible node1 -m hostname -a \"name=websrv\" ansible 10.0.0.18 -m hostname -a 'name=node18.wang.org' Cron 模块 功能：计划任务 支持时间：minute，hour，day，month，weekday 常见选项\nname #描述脚本的作用 minute #分钟 hour #小时 weekday #周 user #任务由哪个用户运行；默认root job #任务 范例：\n#备份数据库脚本 [root@centos8 ~]#cat /root/mysql_backup.sh #!/bin/bash mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip \u003e /data/mysql_`date +%F_%T`.sql.gz #创建任务 ansible 10.0.0.8 -m cron -a 'hour=2 minute=30 weekday=1-5 name=\"backup mysql\" job=/root/mysql_backup.sh' ansible websrvs -m cron -a \"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com \u0026\u003e/dev/null' name=Synctime\" #禁用计划任务 ansible websrvs -m cron -a \"minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 \u0026\u003e/dev/null' name=Synctime disabled=yes\" #启用计划任务 ansible websrvs -m cron -a \"minute=*/5 job='/usr/sbin/ntpdate 172.20.0.1 \u0026\u003e /dev/null' name=Synctime disabled=no\" #删除任务 ansible websrvs -m cron -a \"name='backup mysql' state=absent\" ansible websrvs -m cron -a 'state=absent name=Synctime' Yum 和 Apt 模块 功能：管理软件包 yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本 apt 模块管理 Debian 相关版本的软件包 yum常见选项\nname #软件包名称 state #状态 =present #安装,此为默认值 =absent #删除 =latest #最新版 list #列出指定包 enablerepo #启用哪个仓库安装 disablerepo #不使用哪些仓库的包 exclude #排除指定的包 validate #是否检验,默认为yes 范例：\n[root@ansible ~]#ansible websrvs -m yum -a 'name=httpd state=present' #安装zabbix agent rpm包 [root@ansible ~]#ansible websrvs -m yum -a 'name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no' #启用epel源进行安装 [root@ansible ~]#ansible websrvs -m yum -a 'name=nginx state=present enablerepo=epel' #升级除kernel和foo开头以外的所有包 [root@ansible ~]#ansible websrvs -m yum -a 'name=* state=lastest exclude=kernel*,foo*' #删除 [root@ansible ~]#ansible websrvs -m yum -a 'name=httpd state=absent' [root@ansible ~]#ansible websrvs -m yum -a 'name=sl,cowsay' yum_repository 模块 功能: 此模块实现yum的仓库配置管理 常见选项\nname #仓库id description #仓库描述名称,对应配置文件中的name= baseurl #仓库的地址 gpgcheck #验证开启 gpgkey #仓库公钥路径 state=absen #删除 范例：\nansible websrvs -m yum_repository -a 'name=ansible_nginx description=\"nginx repo\" baseurl=\"http://nginx.org/packages/centos/$releasever/$basearch/\" gpgcheck=yes gpgkey=\"https://nginx.org/keys/nginx_signing.key\"' [root@rocky8 ~]#cat /etc/yum.repos.d/ansible_nginx.repo [ansible_nginx] baseurl = http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck = 1 gpgkey = https://nginx.org/keys/nginx_signing.key name = nginx repo Service 模块 此模块和sytemd功能相似,选项很多相同 功能：管理服务 常见选项\nname #服务名称 state #服务状态 =started #启动 =stopped #停止 =restarted #重启 =reloaded #重载 enabled #开启自启动 daemon_reload #加载新的配置文件,适用于systemd模块 范例：\nansible all -m service -a 'name=httpd state=started enabled=yes' ansible all -m service -a 'name=httpd state=stopped' ansible all -m service -a 'name=httpd state=reloaded' ansible all -m shell -a \"sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf\" ansible all -m service -a 'name=httpd state=restarted' #重启动指定网卡服务 ansible all -m service -a 'name=network state=absent args=eth0' User 模块 功能：管理用户 常见选项\nname #创建的名称 uid #指定uid group #指定基本组 shell #登录shell类型默认/bin/bash create_home #是否创建家目录 password #设定对应的密码，必须是加密后的字符串才行，否则不生效 system #yes表示系统用户 groups #附加组 append #追加附加组使用,yes表示增加新的附加组 state #absen删除 remove #yes表示删除用户时将家目录一起删除 generate_ssh_key #创建私钥 ssh_keyu_bits #私钥位数 ssh_key_file #私钥文件路径 范例：\n#创建用户 ansible all -m user -a 'name=user1 comment=\"test user\" uid=2048 home=/app/user1group=root' ansible all -m user -a 'name=nginx comment=nginx uid=88 group=nginxgroups=\"root,daemon\" shell=/sbin/nologin system=yes create_home=nohome=/data/nginx non_unique=yes' #remove=yes表示删除用户及家目录等数据,默认remove=no ansible all -m user -a 'name=nginx state=absent remove=yes' #生成123456加密的密码 ansible localhost -m debug -a \"msg={{ '123456'| password_hash('sha512','salt')}}\" localhost | SUCCESS =\u003e { \"msg\": \"$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.\" } #用上面创建的密码创建用户 ansible websrvs -m user -a 'name=www group=www system=yes shell=/sbin/nlogin password=\"$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.\"' #创建用户test,并生成4096bit的私钥 ansible websrvs -m user -a 'name=test generate_ssh_key=yes ssh_key_bits=4096 ssh_key_file=.ssh/id_rsa' Group 模块 功能：管理组 常见选项\nname #指定组名称 gid #指定gid state =present #创建,默认 =absent #删除 范例：\n#创建组 ansible websrvs -m group -a 'name=nginx gid=88 system=yes' #删除组 ansible websrvs -m group -a 'name=nginx state=absent' Lineinfile 模块 ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时， 会存在问题，无法正常进行替换 。\nansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块 功能：相当于sed，主要用于修改一行的文件内容 常见选项\npath #被控端文件的路径 regexp #正则匹配语法格式,表示被替换的内容 line #替换为的内容 state #absent表示删除 insertafter #插入到替换内容前面,如和regexp同时存在,只在没找到与regexp匹配时才使用 insertafter insertbefore #插入到替换内容后面,如和regexp同时存在,只在没找到与regexp匹配时才使用 insertafter backrefs #支持后面引用,yes和no backup #修改前先备份 create #如果文件不存在,则创建,默认不存在会出错 mode #指定权限 owner #指定用户 group #指定组 #注意 regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被 匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。 注意: 如果想进行多行匹配进行替换需要使用replace模块 范例：\n#修改监听端口 ansible websrvs -m lineinfile -a \"path=/etc/httpd/conf/httpd.conf regexp='^Listen' line='Listen 8080'\" #修改SELinux ansible all -m lineinfile -a \"path=/etc/selinux/config regexp='^SELINUX='line='SELINUX=disabled'\" #添加网关 ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 line=\"GATEWAY=10.0.0.254\"' #给主机增加一个网关，但需要增加到NAME=下面 ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 insertafter=\"^NAME=\" line=\"GATEWAY=10.0.0.254\"' #效果如下 cat /etc/sysconfig/network-scripts/ifcfg-eth0 DEVICE=eth0 NAME=eth0 GATEWAY=10.0.0.254 #给主机增加一个网关，但需要增加到NAME=上面 ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg- eth0 insertbefore=\"^NAME=\" line=\"GATEWAY=10.0.0.254\"' #效果如下 cat /etc/sysconfig/network-scripts/ifcfg-eth0 DEVICE=eth0 GATEWAY=10.0.0.254 NAME=eth0 #删除网关 ansible webservers -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-eth0 regexp=\"^GATEWAY\" state=absent' #删除#开头的行 ansible all -m lineinfile -a 'dest=/etc/fstab state=absent regexp=\"^#\"' Replace 模块 该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用 功能: 多行修改替换 常见选项\npath #被控端文件的路径 regexp #正则匹配语法格式,表示被替换的内容 replace #替换为的内容 after #插入到替换内容前面, before #插入到替换内容后面 backup #修改前先备份 mode #指定权限 owner #指定用户 group #指定组 范例\nansible all -m replace -a \"path=/etc/fstab regexp='^(UUID.*)' replace='#\\1'\" ansible all -m replace -a \"path=/etc/fstab regexp='^#(UUID.*)' replace='\\1'\" SELinux 模块 功能: 该模块管理 SELInux 策略 常见选项\npolicy #指定SELINUXTYPE=targeted state #指定SELINUX=disabled 范例\n[root@rocky ansible-apps]# ansible 192.168.32.132 -m selinux -a 'state=disabled' 192.168.32.132 | FAILED! =\u003e { \"msg\": \"The module selinux was redirected to ansible.posix.selinux, which could not be loaded.\" } # ansible版本2.13.3出现如下错误 \"msg\": \"The module selinux was redirected to ansible.posix.selinux, which could not be loaded.\" # 解决方法 [root@rocky ansible-apps]# ansible-galaxy collection install ansible.posix # 再次执行，显示成功 [root@rocky ansible-apps]# ansible 192.168.32.132 -m selinux -a 'state=disabled' [WARNING]: SELinux state temporarily changed from 'enforcing' to 'permissive'. State change will take effect next reboot. 192.168.32.132 | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/libexec/platform-python\" }, \"changed\": true, \"configfile\": \"/etc/selinux/config\", \"msg\": \"Config SELinux state changed from 'enforcing' to 'disabled'\", \"policy\": \"targeted\", \"reboot_required\": true, \"state\": \"disabled\" } reboot 模块 功能: 重启 常见选项\nmsg #重启提示 pre_reboot_delay #重启前延迟时间的秒数 post_reboot_delay #重启后延迟时间的秒数后,再验证系统正常启动 reboot_timeout #重启后延迟时间再执行测试成功与否的命令 test_command #执行测试成功与否的命令 范例:\n[root@ansible ~]#ansible websrvs -m reboot -a 'msg=\"host will be reboot\"' mount 模块 功能: 挂载和卸载文件系统 常见选项\nsrc #源设备路径，或网络地址 path #挂载至本地哪个路径下 fstype #设备类型； nfs opts #挂载的选项 state #挂载还是卸载 =present #永久挂载，但没有立即生效 =absent #卸载临时挂载,并删除永久挂载 =mounted #临时挂载 =unmounted #临时卸载 范例:\n#修改fstab文件永久挂载,但不立即生效 mount websrvs -m mount -a 'src=\"UUID=b3e48f45-f933-4c8e-a700-22a159ec9077\" path=/home fstype=xfs opts=noatime state=present' #临时取消挂载 mount websrvs -m mount -a 'path=/home fstype=xfs opts=noatime state=unmounted' #永久挂载,并立即生效 ansible websrvs -m mount -a 'src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads opts=\"_netdev\" state=mounted' #永久卸载,并立即生效 ansible websrvs -m mount -a 'src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads state=absent' Setup 模块 功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机 较多，会影响执行速度 可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息 常见选项\nfilter #指定过滤条件 范例:\nansible all -m setup ansible all -m setup -a \"filter=ansible_nodename\" ansible all -m setup -a \"filter=ansible_hostname\" # 主机名称 ansible all -m setup -a \"filter=ansible_domain\" ansible all -m setup -a \"filter=ansible_memtotal_mb\" ansible all -m setup -a \"filter=ansible_memory_mb\" ansible all -m setup -a \"filter=ansible_memfree_mb\" ansible all -m setup -a \"filter=ansible_os_family\" ansible all -m setup -a \"filter=ansible_distribution\" ansible all -m setup -a \"filter=ansible_distribution_major_version\" ansible all -m setup -a \"filter=ansible_distribution_version\" ansible all -m setup -a \"filter=ansible_processor_vcpus\" ansible all -m setup -a \"filter=ansible_all_ipv4_addresses\" ansible all -m setup -a \"filter=ansible_architecture\" ansible all -m setup -a \"filter=ansible_uptime_seconds\" ansible all -m setup -a \"filter=ansible_processor*\" ansible all -m setup -a 'filter=ansible_env' 范例：\n[root@ansible ~]#ansible all -m setup -a 'filter=ansible_python_version' 10.0.0.7 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_python_version\": \"2.7.5\", \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false } 10.0.0.6 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_python_version\": \"2.6.6\", \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false } 10.0.0.8 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_python_version\": \"3.6.8\", \"discovered_interpreter_python\": \"/usr/libexec/platform-python\" }, \"changed\": false } [root@ansible ~]# 范例：取IP地址\n#取所有IP ansible 10.0.0.101 -m setup -a 'filter=ansible_all_ipv4_addresses' 10.0.0.101 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_all_ipv4_addresses\": [ \"192.168.0.1\", \"192.168.0.2\", \"192.168.64.238\", \"192.168.13.36\", \"10.0.0.101\", \"172.16.1.0\", \"172.17.0.1\" ] }, \"changed\": false } #取默认IP ansible all -m setup -a 'filter=\"ansible_default_ipv4\"' 10.0.0.101 | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_default_ipv4\": { \"address\": \"10.0.0.101\", \"alias\": \"eth0\", \"broadcast\": \"10.0.0.255\", \"gateway\": \"10.0.0.2\", \"interface\": \"eth0\", \"macaddress\": \"00:0c:29:e8:c7:9b\", \"mtu\": 1500, \"netmask\": \"255.255.255.0\", \"network\": \"10.0.0.0\", \"type\": \"ether\" } }, \"changed\": false } debug 模块 功能: 此模块可以用于输出信息,并且通过 msg 定制输出的信息内容,功能类似于echo命令 注意: msg后面的变量有时需要加 \" \" 引起来 常见选项\nmsg #指定命令输出的信息 var #指定变量名,和msg互斥 verbosity #详细度 范例: debug 模块默认输出Hello world\n[root@ansible ~]#ansible 10.0.0.18 -m debug 10.0.0.18 | SUCCESS =\u003e { \"msg\": \"Hello world!\" } [root@ansible ansible]#cat debug.yml --- - hosts: websrvs tasks: - name: output Hello world debug: #默认没有指定msg,默认输出\"Hello world!\" [root@ansible ansible]#ansible-playbook debug.yml ..... TASK [output variables] ******************************************************************************** ****************************** ok: [10.0.0.7] =\u003e { \"msg\": \"Hello world!\" } ok: [10.0.0.8] =\u003e { \"msg\": \"Hello world!\" } PLAY RECAP ******************************************************************************** ******************************************* 10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 范例: 利用debug 模块输出变量\n[root@centos8 ~]#cat debug.yaml --- - hosts: websrvs tasks: - name: output variables debug: msg: Host \"{{ ansible_nodename }}\" Ip \"{{ ansible_default_ipv4.address }}\" [root@centos8 ~]#ansible-playbook debug.yaml PLAY [websrvs] ******************************************************************************** *************************************** TASK [Gathering Facts] ******************************************************************************** ******************************* ok: [10.0.0.7] ok: [10.0.0.8] TASK [output variables] ******************************************************************************** ****************************** ok: [10.0.0.7] =\u003e { \"msg\": \"Host \\\"centos7.wangxiaochun.com\\\" Ip \\\"10.0.0.7\\\"\" } ok: [10.0.0.8] =\u003e { \"msg\": \"Host \\\"centos8.wangxiaochun.com\\\" Ip \\\"10.0.0.8\\\"\" } PLAY RECAP ******************************************************************************** ******************************************* 10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 范例: 显示字符串特定字符\n# cat debug.yml - hosts: all gather_facts: no vars: a: \"12345\" tasks: - debug: msg: - \"{{a[0]}}\" - \"{{a[1]}}\" - \"{{a[2]}}\" #定义了一个字符串变量a，如果想要获取a字符串的第3个字符，则可以使用”a[2]”获取，索引从0开始，执行上例playbook，debug的输出信息如下： TASK [debug] ************************* ok: [test1] =\u003e { \"msg\": \"1\" \"msg\": \"2\" \"msg\": \"3\" } sysctl 模块 功能: 修改内核参数 常见选项\nname #内核参数 value #指定值 state #是否保存在sysctl.conf文件中,默认present sysctl_set #使用sysctl -w 验证值生效 范例:\nansible websrvs -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present' 范例: 内核参数优化\n- name: Change Port Range sysctl: name: net.ipv4.ip_local_port_range value: '1024 65000' sysctl_set: yes - name: Enabled Forward sysctl: name: net.ipv4.ip_forward value: '1' sysctl_set: yes - name: Enabled tcp_reuse sysctl: name: net.ipv4.tcp_tw_reuse value: '1' sysctl_set: yes - name: Chanage tcp tw_buckets sysctl: name: net.ipv4.tcp_max_tw_buckets value: '5000' sysctl_set: yes - name: Chanage tcp_syncookies sysctl: name: net.ipv4.tcp_syncookies value: '1' sysctl_set: yes - name: Chanage tcp max_syn_backlog sysctl: name: net.ipv4.tcp_max_syn_backlog value: '8192' sysctl_set: yes - name: Chanage tcp Established Maxconn sysctl: name: net.core.somaxconn value: '32768' sysctl_set: yes state: present - name: Chanage tcp_syn_retries sysctl: name: net.ipv4.tcp_syn_retries value: '2' sysctl_set: yes state: present - name: Chanage net.ipv4.tcp_synack_retries sysctl: name: net.ipv4.tcp_synack_retries value: '2' sysctl_set: yes state: presen pam_limits 功能: 管理资源限制 范例\n- name: Change Limit /etc/security/limit.conf pam_limits: domain: \"*\" limit_type: \"{{ item.limit_type }}\" limit_item: \"{{ item.limit_item }}\" value: \"{{ item.value }}\" loop: - { limit_type: 'soft', limit_item: 'nofile',value: '100000' } - { limit_type: 'hard', limit_item: 'nofile',value: '10000' } apt_repository 模块 功能: 此模块实现apt的仓库配置管理 常见选项\nrepo #仓库信息 state #添加或删除 update_cache #是否apt update,默认yes filename #仓库文件,默认放在/etc/apt/sources.list.d/file.list 范例:\nansible ubuntu-servers -m apt_repository -a 'repo=\"deb http://archive.canonical.com/ubuntu focal partner\" filename=google-chrome' [root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/google-chrome.list deb http://archive.canonical.com/ubuntu focal partner apt_key 模块 功能: 添加和删除apt key 常见选项\nurl #key路径 state #添加或删除 范例: 生成ceph仓库配置\n#先导入key,注意先后顺序 ansible ubuntu-servers -m apt_key -a 'url=https://download.ceph.com/keys/release.asc state=present' #再生成apt配置,如果不导入key此步会出错 ansible ubuntu-servers -m apt_repository -a 'repo=\"deb http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main\" filename=ansible_ceph' #验证结果 [root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/ansible_ceph.list deb http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main 其它模块 ansible 还提供了很多针对各种应用的模块,比如\nnginx_status_info nginx_status_facts mysql_db #需要安装MySQL-python包 mysql_user #需要安装MySQL-python包 redis mongodb* postgresql* haproxy git ",
  "wordCount" : "13602",
  "inLanguage": "en",
  "image":"http://oss.itshare.work/itshare-work-images/2.jpg","datePublished": "2023-02-21T19:12:21Z",
  "dateModified": "2023-02-21T19:12:21Z",
  "author":[{
    "@type": "Person",
    "name": "Cookie"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://hugo.itshare.work/posts/ansible/ansible/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie",
    "logo": {
      "@type": "ImageObject",
      "url": "http://hugo.itshare.work/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://hugo.itshare.work/" accesskey="h" title="Cookie (Alt + H)">
            <img src="http://hugo.itshare.work/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Cookie</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://hugo.itshare.work/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archivist" title="📒 归档">
                <span>📒 归档</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="http://hugo.itshare.work/">🏠 主页</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/">📚文章</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/ansible/">🧿 Ansible</a></div>
            <h1 class="post-title">
                运维自动化工具Ansible(一)
            </h1>
            <div class="post-description">
                Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-02-21
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>13602字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>28分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Cookie
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="http://hugo.itshare.work/tags/ansible/" style="color: var(--secondary)!important;">Ansible</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "http://hugo.itshare.work/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="http://oss.itshare.work/itshare-work-images/2.jpg" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#ansible%e4%bb%8b%e7%bb%8d%e5%92%8c%e6%9e%b6%e6%9e%84" aria-label="Ansible介绍和架构">Ansible介绍和架构</a><ul>
                        
                <li>
                    <a href="#ansible%e5%8f%91%e5%b1%95%e5%8f%b2" aria-label="Ansible发展史">Ansible发展史</a></li>
                <li>
                    <a href="#ansible-%e5%8a%9f%e8%83%bd" aria-label="Ansible 功能">Ansible 功能</a></li>
                <li>
                    <a href="#ansible-%e7%89%b9%e7%82%b9" aria-label="Ansible 特点">Ansible 特点</a></li>
                <li>
                    <a href="#ansible-%e6%9e%b6%e6%9e%84" aria-label="Ansible 架构">Ansible 架构</a><ul>
                        
                <li>
                    <a href="#ansible-%e7%bb%84%e6%88%90" aria-label="Ansible 组成">Ansible 组成</a></li>
                <li>
                    <a href="#ansible-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%9d%a5%e6%ba%90" aria-label="Ansible 命令执行来源">Ansible 命令执行来源</a></li>
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="注意事项">注意事项</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ansible-%e5%ae%89%e8%a3%85%e5%92%8c%e5%b8%b8%e8%a7%81%e6%a8%a1%e5%9d%97" aria-label="Ansible 安装和常见模块">Ansible 安装和常见模块</a><ul>
                        
                <li>
                    <a href="#ansible-%e5%ae%89%e8%a3%85" aria-label="Ansible 安装">Ansible 安装</a><ul>
                        
                <li>
                    <a href="#%e5%8c%85%e5%ae%89%e8%a3%85%e6%96%b9%e5%bc%8f" aria-label="包安装方式">包安装方式</a></li>
                <li>
                    <a href="#pip%e5%ae%89%e8%a3%85" aria-label="pip安装">pip安装</a></li>
                <li>
                    <a href="#%e7%a1%ae%e8%ae%a4%e5%ae%89%e8%a3%85" aria-label="确认安装">确认安装</a></li></ul>
                </li>
                <li>
                    <a href="#ansible-%e7%9b%b8%e5%85%b3%e6%96%87%e4%bb%b6" aria-label="Ansible 相关文件">Ansible 相关文件</a><ul>
                        
                <li>
                    <a href="#ansible-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%88%97%e8%a1%a8" aria-label="Ansible 配置文件列表">Ansible 配置文件列表</a></li>
                <li>
                    <a href="#ansible-%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="Ansible 主配置文件">Ansible 主配置文件</a></li>
                <li>
                    <a href="#inventory-%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6" aria-label="Inventory 主机清单文件">Inventory 主机清单文件</a></li></ul>
                </li>
                <li>
                    <a href="#ansible%e7%9b%b8%e5%85%b3%e5%b7%a5%e5%85%b7" aria-label="Ansible相关工具">Ansible相关工具</a><ul>
                        
                <li>
                    <a href="#ansible-doc" aria-label="ansible-doc">ansible-doc</a></li>
                <li>
                    <a href="#ansible" aria-label="ansible">ansible</a><ul>
                        
                <li>
                    <a href="#ansible-ad-hoc-%e4%bb%8b%e7%bb%8d" aria-label="Ansible Ad-Hoc 介绍">Ansible Ad-Hoc 介绍</a></li>
                <li>
                    <a href="#ansible-%e5%91%bd%e4%bb%a4%e7%94%a8%e6%b3%95" aria-label="ansible 命令用法">ansible 命令用法</a></li>
                <li>
                    <a href="#ansible%e7%9a%84host-pattern" aria-label="ansible的Host-pattern">ansible的Host-pattern</a><ul>
                        
                <li>
                    <a href="#ansible-%e5%91%bd%e4%bb%a4%e7%9a%84%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" aria-label="ansible 命令的执行过程">ansible 命令的执行过程</a></li>
                <li>
                    <a href="#ansible-%e5%91%bd%e4%bb%a4%e7%9a%84%e6%89%a7%e8%a1%8c%e7%8a%b6%e6%80%81" aria-label="ansible 命令的执行状态">ansible 命令的执行状态</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ansible-console" aria-label="ansible-console">ansible-console</a></li>
                <li>
                    <a href="#ansible-playbook" aria-label="ansible-playbook">ansible-playbook</a></li>
                <li>
                    <a href="#ansible-vault" aria-label="ansible-vault">ansible-vault</a></li>
                <li>
                    <a href="#ansible-galaxy" aria-label="ansible-galaxy">ansible-galaxy</a></li></ul>
                </li>
                <li>
                    <a href="#ansible%e5%b8%b8%e7%94%a8%e6%a8%a1%e5%9d%97" aria-label="Ansible常用模块">Ansible常用模块</a><ul>
                        
                <li>
                    <a href="#command-%e6%a8%a1%e5%9d%97" aria-label="Command 模块">Command 模块</a></li>
                <li>
                    <a href="#shell-%e6%a8%a1%e5%9d%97" aria-label="Shell 模块">Shell 模块</a></li>
                <li>
                    <a href="#script-%e6%a8%a1%e5%9d%97" aria-label="Script 模块">Script 模块</a></li>
                <li>
                    <a href="#copy-%e6%a8%a1%e5%9d%97" aria-label="Copy 模块">Copy 模块</a></li>
                <li>
                    <a href="#get_url-%e6%a8%a1%e5%9d%97" aria-label="Get_url 模块">Get_url 模块</a></li>
                <li>
                    <a href="#fetch-%e6%a8%a1%e5%9d%97" aria-label="Fetch 模块">Fetch 模块</a></li>
                <li>
                    <a href="#file-%e6%a8%a1%e5%9d%97" aria-label="File 模块">File 模块</a></li>
                <li>
                    <a href="#stat-%e6%a8%a1%e5%9d%97" aria-label="stat 模块">stat 模块</a></li>
                <li>
                    <a href="#unarchive-%e6%a8%a1%e5%9d%97" aria-label="unarchive 模块">unarchive 模块</a></li>
                <li>
                    <a href="#archive-%e6%a8%a1%e5%9d%97" aria-label="Archive 模块">Archive 模块</a></li>
                <li>
                    <a href="#hostname-%e6%a8%a1%e5%9d%97" aria-label="Hostname 模块">Hostname 模块</a></li>
                <li>
                    <a href="#cron-%e6%a8%a1%e5%9d%97" aria-label="Cron 模块">Cron 模块</a></li>
                <li>
                    <a href="#yum-%e5%92%8c-apt-%e6%a8%a1%e5%9d%97" aria-label="Yum 和 Apt 模块">Yum 和 Apt 模块</a></li>
                <li>
                    <a href="#yum_repository-%e6%a8%a1%e5%9d%97" aria-label="yum_repository 模块">yum_repository 模块</a></li>
                <li>
                    <a href="#service-%e6%a8%a1%e5%9d%97" aria-label="Service 模块">Service 模块</a></li>
                <li>
                    <a href="#user-%e6%a8%a1%e5%9d%97" aria-label="User 模块">User 模块</a></li>
                <li>
                    <a href="#group-%e6%a8%a1%e5%9d%97" aria-label="Group 模块">Group 模块</a></li>
                <li>
                    <a href="#lineinfile-%e6%a8%a1%e5%9d%97" aria-label="Lineinfile 模块">Lineinfile 模块</a></li>
                <li>
                    <a href="#replace-%e6%a8%a1%e5%9d%97" aria-label="Replace 模块">Replace 模块</a></li>
                <li>
                    <a href="#selinux-%e6%a8%a1%e5%9d%97" aria-label="SELinux 模块">SELinux 模块</a></li>
                <li>
                    <a href="#reboot-%e6%a8%a1%e5%9d%97" aria-label="reboot 模块">reboot 模块</a></li>
                <li>
                    <a href="#mount-%e6%a8%a1%e5%9d%97" aria-label="mount 模块">mount 模块</a></li>
                <li>
                    <a href="#setup-%e6%a8%a1%e5%9d%97" aria-label="Setup 模块">Setup 模块</a></li>
                <li>
                    <a href="#debug-%e6%a8%a1%e5%9d%97" aria-label="debug 模块">debug 模块</a></li>
                <li>
                    <a href="#sysctl-%e6%a8%a1%e5%9d%97" aria-label="sysctl 模块">sysctl 模块</a></li>
                <li>
                    <a href="#pam_limits" aria-label="pam_limits">pam_limits</a></li>
                <li>
                    <a href="#apt_repository-%e6%a8%a1%e5%9d%97" aria-label="apt_repository 模块">apt_repository 模块</a></li>
                <li>
                    <a href="#apt_key-%e6%a8%a1%e5%9d%97" aria-label="apt_key 模块">apt_key 模块</a></li>
                <li>
                    <a href="#%e5%85%b6%e5%ae%83%e6%a8%a1%e5%9d%97" aria-label="其它模块">其它模块</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="ansible介绍和架构">Ansible介绍和架构<a hidden class="anchor" aria-hidden="true" href="#ansible介绍和架构">#</a></h1>
<h2 id="ansible发展史">Ansible发展史<a hidden class="anchor" aria-hidden="true" href="#ansible发展史">#</a></h2>
<p>Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗
2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购
官网：https://www.ansible.com/
官方文档：https://docs.ansible.com/</p>
<h2 id="ansible-功能">Ansible 功能<a hidden class="anchor" aria-hidden="true" href="#ansible-功能">#</a></h2>
<ul>
<li>批量执行远程命令,可以对远程的多台主机同时进行命令的执行</li>
<li>批量安装和配置软件服务，可以对远程的多台主机进行自动化的方式配置和管理各种服务</li>
<li>编排高级的企业级复杂的IT架构任务, Ansible的Playbook和role可以轻松实现大型的IT复杂架构</li>
<li>提供自动化运维工具的开发API, 有很多运维工具,如jumpserver就是基于 ansible 实现自动化管工功能</li>
</ul>
<h2 id="ansible-特点">Ansible 特点<a hidden class="anchor" aria-hidden="true" href="#ansible-特点">#</a></h2>
<p><strong>优点</strong></p>
<ul>
<li>功能丰富的模块：提供了多达数千个的各种功能的模块,完成特定任务只需调用特定模块即可，还</li>
<li>支持自定义模块，可使用任何编程语言写模块</li>
<li>使用和部署简单: 无需安装专用代理软件,基于python和SSH(默认已安装)实现</li>
<li>安全: 基于OpenSSH实现安全通讯无需专用协议</li>
<li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况,此特性和模块有关</li>
<li>支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案 Role</li>
<li>Python语言实现, 基于Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li>
<li>属于红帽(IBM)公司产品,背景强大,未来发展前景光明</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>如果管理的主机较多时,执行效率不如saltstack高</li>
<li>当前还不支持像MySQL数据库一样的事务回滚</li>
</ul>
<h2 id="ansible-架构">Ansible 架构<a hidden class="anchor" aria-hidden="true" href="#ansible-架构">#</a></h2>
<h3 id="ansible-组成">Ansible 组成<a hidden class="anchor" aria-hidden="true" href="#ansible-组成">#</a></h3>
<p>组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具</p>
<p><img loading="lazy" src="/posts.images/image.assets/1676984392121.png" alt="1676984392121"  />
</p>
<ul>
<li>INVENTORY：Ansible管理主机的清单文件,默认为 /etc/ansible/hosts</li>
<li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li>
<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
</ul>
<h3 id="ansible-命令执行来源">Ansible 命令执行来源<a hidden class="anchor" aria-hidden="true" href="#ansible-命令执行来源">#</a></h3>
<ul>
<li>USER 普通用户，即SYSTEM ADMINISTRATOR</li>
<li>PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li>
<li>CMDB（配置管理数据库） API 调用</li>
<li>PUBLIC/PRIVATE CLOUD API调用</li>
<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>
</ul>
<h3 id="注意事项">注意事项<a hidden class="anchor" aria-hidden="true" href="#注意事项">#</a></h3>
<ul>
<li>执行ansible的主机一般称为管理端, 主控端，中控，master或堡垒机</li>
<li>主控端Python版本需要2.6或以上</li>
<li>被控端Python版本小于2.4，需要安装python-simplejson</li>
<li>被控端如开启SELinux需要安装libselinux-python</li>
<li>windows 不能做为主控端,只能做为被控制端</li>
</ul>
<h1 id="ansible-安装和常见模块">Ansible 安装和常见模块<a hidden class="anchor" aria-hidden="true" href="#ansible-安装和常见模块">#</a></h1>
<h2 id="ansible-安装">Ansible 安装<a hidden class="anchor" aria-hidden="true" href="#ansible-安装">#</a></h2>
<p>ansible的安装方法有多种
官方文档</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html
</span></span><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/installation_guide/index.html
</span></span></code></pre></div><p>下载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>https://releases.ansible.com/ansible/
</span></span></code></pre></div><p>pip 下载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>https://pypi.org/project/ansible/
</span></span></code></pre></div><h3 id="包安装方式">包安装方式<a hidden class="anchor" aria-hidden="true" href="#包安装方式">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>#CentOS 的EPEL源的rpm包安装
</span></span><span style="display:flex;"><span>[root@centos ~]#yum install ansible
</span></span><span style="display:flex;"><span>#ubuntu 安装
</span></span><span style="display:flex;"><span>[root@ubuntu ~]#apt -y install ansible
</span></span></code></pre></div><h3 id="pip安装">pip安装<a hidden class="anchor" aria-hidden="true" href="#pip安装">#</a></h3>
<p>pip 是安装Python包的管理器，类似 yum
范例: 在rocky8上通过pip3安装ansible</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@rocky8 ~]#yum -y install python39 rust
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#pip3 install ansible
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible [core 2.12.6]
</span></span><span style="display:flex;"><span>config file = None
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3.9/site-packages/ansible
</span></span><span style="display:flex;"><span>ansible collection location =
</span></span><span style="display:flex;"><span>/root/.ansible/collections:/usr/share/ansible/collections
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514
</span></span><span style="display:flex;"><span>(Red Hat 8.5.0-3)]
</span></span><span style="display:flex;"><span>jinja version = 3.1.2
</span></span><span style="display:flex;"><span>libyaml = True
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#ansible-doc -l 2&gt; /dev/null|wc -l
</span></span><span style="display:flex;"><span>6763
</span></span></code></pre></div><p>范例: 安装python3.8 支持ansible2.12以上版本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@rocky8 ~]#yum -y install python38 python38-pip
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible [core 2.12.6]
</span></span><span style="display:flex;"><span>config file = None
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/local/lib/python3.8/site-
</span></span><span style="display:flex;"><span>packages/ansible
</span></span><span style="display:flex;"><span>ansible collection location =
</span></span><span style="display:flex;"><span>/root/.ansible/collections:/usr/share/ansible/collections
</span></span><span style="display:flex;"><span>executable location = /usr/local/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.8.8 (default, Nov 9 2021, 13:31:34) [GCC 8.5.0 20210514
</span></span><span style="display:flex;"><span>(Red Hat 8.5.0-3)]
</span></span><span style="display:flex;"><span>jinja version = 3.1.2
</span></span><span style="display:flex;"><span>libyaml = True
</span></span></code></pre></div><p>范例: 安装默认的python3.6版本会有警报提示</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@rocky8 ~]#yum -y install python3
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#ansible --version
</span></span><span style="display:flex;"><span>[DEPRECATION WARNING]: Ansible will require Python 3.8 or newer on the
</span></span><span style="display:flex;"><span>controller starting with Ansible 2.12. Current version: 3.6.8 (default, Nov
</span></span><span style="display:flex;"><span>9 2021, 14:44:26) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)]. This feature will be
</span></span><span style="display:flex;"><span>removed from ansible-core in version 2.12. Deprecation warnings
</span></span><span style="display:flex;"><span>can be disabled by setting deprecation_warnings=False in ansible.cfg.
</span></span><span style="display:flex;"><span>/usr/local/lib/python3.6/site-packages/ansible/parsing/vault/__init__.py:44:
</span></span><span style="display:flex;"><span>CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python
</span></span><span style="display:flex;"><span>core team. Therefore, support for it is deprecated in cryptography and will be
</span></span><span style="display:flex;"><span>removed in a future release.
</span></span><span style="display:flex;"><span>from cryptography.exceptions import InvalidSignature
</span></span><span style="display:flex;"><span>ansible [core 2.11.12]
</span></span><span style="display:flex;"><span>config file = None
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/local/lib/python3.6/site-
</span></span><span style="display:flex;"><span>packages/ansible
</span></span><span style="display:flex;"><span>ansible collection location =
</span></span><span style="display:flex;"><span>/root/.ansible/collections:/usr/share/ansible/collections
</span></span><span style="display:flex;"><span>executable location = /usr/local/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.6.8 (default, Nov 9 2021, 14:44:26) [GCC 8.5.0 20210514
</span></span><span style="display:flex;"><span>(Red Hat 8.5.0-3)]
</span></span><span style="display:flex;"><span>jinja version = 3.0.3
</span></span><span style="display:flex;"><span>libyaml = True
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#ansible-doc -l 2&gt; /dev/null|wc -l
</span></span><span style="display:flex;"><span>6141
</span></span></code></pre></div><p><img loading="lazy" src="/posts.images/image.assets/1676985923345.png" alt="1676985923345"  />
</p>
<p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos7 ~]#yum -y install python-pip
</span></span><span style="display:flex;"><span>[root@centos7 ~]#pip install --upgrade pip
</span></span><span style="display:flex;"><span>[root@centos7 ~]#pip install ansible --upgrade
</span></span><span style="display:flex;"><span>[root@centos7 ~]#ansible --version
</span></span><span style="display:flex;"><span>/usr/lib64/python2.7/site-packages/cryptography/__init__.py:39:
</span></span><span style="display:flex;"><span>CryptographyDeprecationWarning: Python 2 is no longer supported by the Python
</span></span><span style="display:flex;"><span>core team. Support for it is now deprecated in cryptography, and will be removed
</span></span><span style="display:flex;"><span>in a future release.
</span></span><span style="display:flex;"><span>CryptographyDeprecationWarning,
</span></span><span style="display:flex;"><span>ansible 2.9.12
</span></span><span style="display:flex;"><span>config file = None
</span></span><span style="display:flex;"><span>configured module search path = [u&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>u&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python2.7/site-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 2.7.5 (default, Apr 2 2020, 13:16:51) [GCC 4.8.5 20150623
</span></span><span style="display:flex;"><span>(Red Hat 4.8.5-39)]
</span></span><span style="display:flex;"><span>[root@centos7 ~]#ll /opt/etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg
</span></span></code></pre></div><h3 id="确认安装">确认安装<a hidden class="anchor" aria-hidden="true" href="#确认安装">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@ansible ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.5
</span></span><span style="display:flex;"><span>config file = /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3.6/site-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507
</span></span><span style="display:flex;"><span>(Red Hat 8.3.1-4)]
</span></span></code></pre></div><h2 id="ansible-相关文件">Ansible 相关文件<a hidden class="anchor" aria-hidden="true" href="#ansible-相关文件">#</a></h2>
<h3 id="ansible-配置文件列表">Ansible 配置文件列表<a hidden class="anchor" aria-hidden="true" href="#ansible-配置文件列表">#</a></h3>
<ul>
<li>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性,也可以在项目的目录中创建此文件,当前目录下如果也有ansible.cfg,则此文件优先生效,建议每个项目目录下,创建独有的ansible.cfg文
件</li>
<li>/etc/ansible/hosts 主机清单</li>
<li>/etc/ansible/roles/ 存放角色的目录</li>
</ul>
<h3 id="ansible-主配置文件">Ansible 主配置文件<a hidden class="anchor" aria-hidden="true" href="#ansible-主配置文件">#</a></h3>
<p>Ansible 的配置文件可以放在多个不同地方,优先级从高到低顺序如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ANSIBLE_CONFIG #环境变量,目录下的文件必须存在才能生效
</span></span><span style="display:flex;"><span>./ansible.cfg #当前目录下的ansible.cfg,一般一个项目对应一个专用配置文件,推荐使用
</span></span><span style="display:flex;"><span>~/.ansible.cfg #当前用户家目录下的.ansible.cfg
</span></span><span style="display:flex;"><span>/etc/ansible/ansible.cfg #系统默认配置文件
</span></span></code></pre></div><p>Ansible 的默认配置文件 /etc/ansible/ansible.cfg ,其中大部分的配置内容无需进行修改</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[defaults]
</span></span><span style="display:flex;"><span>#inventory = /etc/ansible/hosts #主机列表配置文件
</span></span><span style="display:flex;"><span>#library = /usr/share/my_modules/ #库文件存放目录
</span></span><span style="display:flex;"><span>#remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录
</span></span><span style="display:flex;"><span>#local_tmp = $HOME/.ansible/tmp #本机的临时命令执行目录
</span></span><span style="display:flex;"><span>#forks = 5 #默认并发数
</span></span><span style="display:flex;"><span>#sudo_user = root #默认sudo 用户
</span></span><span style="display:flex;"><span>#ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码
</span></span><span style="display:flex;"><span>#ask_pass = True
</span></span><span style="display:flex;"><span>#remote_port = 22
</span></span><span style="display:flex;"><span>#host_key_checking = False #检查对应服务器的host_key，建议取消此行注释,实现第一次连
</span></span><span style="display:flex;"><span>接自动信任目标主机
</span></span><span style="display:flex;"><span>#log_path=/var/log/ansible.log #日志文件，建议启用
</span></span><span style="display:flex;"><span>#module_name = command #默认模块，可以修改为shell模块
</span></span><span style="display:flex;"><span>[privilege_escalation] #普通用户提权配置
</span></span><span style="display:flex;"><span>#become=True
</span></span><span style="display:flex;"><span>#become_method=sudo
</span></span><span style="display:flex;"><span>#become_user=root
</span></span><span style="display:flex;"><span>#become_ask_pass=False
</span></span></code></pre></div><p>范例: 通过环境变量ANSIBLE_CONFIG指定ansible配置文件路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@rocky8 ~]#cd /data/ansible/
</span></span><span style="display:flex;"><span>[root@rocky8 ansible]#cat ansbile.cfg
</span></span><span style="display:flex;"><span>[defaults]
</span></span><span style="display:flex;"><span>inventory = ./hosts
</span></span><span style="display:flex;"><span>[root@rocky8 ansible]#cat hosts
</span></span><span style="display:flex;"><span>[ubuntu]
</span></span><span style="display:flex;"><span>10.0.0.100
</span></span><span style="display:flex;"><span>[centos]
</span></span><span style="display:flex;"><span>10.0.0.7
</span></span><span style="display:flex;"><span>10.0.0.8
</span></span><span style="display:flex;"><span>#定义变量
</span></span><span style="display:flex;"><span>[root@rocky8 ansible]#export ANSIBLE_CONFIG=./ansbile.cfg
</span></span><span style="display:flex;"><span>[root@rocky8 ansible]#ansible --version
</span></span><span style="display:flex;"><span>ansible [core 2.12.6]
</span></span><span style="display:flex;"><span>config file = /data/ansible/ansbile.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3.9/site-packages/ansible
</span></span><span style="display:flex;"><span>ansible collection location =
</span></span><span style="display:flex;"><span>/root/.ansible/collections:/usr/share/ansible/collections
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514
</span></span><span style="display:flex;"><span>(Red Hat 8.5.0-3)]
</span></span><span style="display:flex;"><span>jinja version = 3.1.2
</span></span><span style="display:flex;"><span>libyaml = True
</span></span><span style="display:flex;"><span>[root@rocky8 ansible]#ansible --list-hosts all
</span></span><span style="display:flex;"><span>hosts (3):
</span></span><span style="display:flex;"><span>10.0.0.100
</span></span><span style="display:flex;"><span>10.0.0.7
</span></span><span style="display:flex;"><span>10.0.0.8
</span></span></code></pre></div><p>范例: 创建ansible 指定项目专用的配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@ubuntu2004 ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.6
</span></span><span style="display:flex;"><span>config file = /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3/dist-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ~]#mkdir /data/ansible -p
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ~]#cd /data/ansible/
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ansible]#touch ansible.cfg
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ansible]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.6
</span></span><span style="display:flex;"><span>config file = /data/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3/dist-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ansible]#cd
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.6
</span></span><span style="display:flex;"><span>config file = /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3/dist-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]
</span></span></code></pre></div><p>范例: 当前目录下的ansible的配置文件优先生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@ansible ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.17
</span></span><span style="display:flex;"><span>config file = /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3.6/site-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121
</span></span><span style="display:flex;"><span>(Red Hat 8.3.1-5)]
</span></span><span style="display:flex;"><span>[root@ansible ~]#cp /etc/ansible/ansible.cfg .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible --version
</span></span><span style="display:flex;"><span>ansible 2.9.17
</span></span><span style="display:flex;"><span>config file = /root/ansible.cfg #注意配置文件路径
</span></span><span style="display:flex;"><span>configured module search path = [&#39;/root/.ansible/plugins/modules&#39;,
</span></span><span style="display:flex;"><span>&#39;/usr/share/ansible/plugins/modules&#39;]
</span></span><span style="display:flex;"><span>ansible python module location = /usr/lib/python3.6/site-packages/ansible
</span></span><span style="display:flex;"><span>executable location = /usr/bin/ansible
</span></span><span style="display:flex;"><span>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121
</span></span><span style="display:flex;"><span>(Red Hat 8.3.1-5)]
</span></span><span style="display:flex;"><span>[root@ansible ~]#
</span></span></code></pre></div><h3 id="inventory-主机清单文件">Inventory 主机清单文件<a hidden class="anchor" aria-hidden="true" href="#inventory-主机清单文件">#</a></h3>
<p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory 主机清单文件中将其分组组织
默认的inventory file为 /etc/ansible/hosts
inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成
注意:</p>
<ul>
<li>生产建议在每个项目目录下创建项目独立的hosts文件</li>
<li>通过项目目录下的ansible.cfg文件中的 inventory = ./hosts实现</li>
</ul>
<p>官方文档:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html
</span></span></code></pre></div><p><strong>主机清单文件格式</strong>
inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中,此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明,如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机
<strong>Inventory 参数说明</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ansible_ssh_host #将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.
</span></span><span style="display:flex;"><span>ansible_ssh_port #ssh端口号.如果不是默认的端口号,通过此变量设置.这种可以使用 ip:端口
</span></span><span style="display:flex;"><span>192.168.1.100:2222
</span></span><span style="display:flex;"><span>ansible_ssh_user #默认的 ssh 用户名
</span></span><span style="display:flex;"><span>ansible_ssh_pass #ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)
</span></span><span style="display:flex;"><span>ansible_sudo_pass #sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)
</span></span><span style="display:flex;"><span>ansible_sudo_exe (new in version 1.8) #sudo 命令路径(适用于1.8及以上版本)
</span></span><span style="display:flex;"><span>ansible_connection #与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 &#39;smart&#39;,&#39;smart&#39; 方式会根据是否支持 ControlPersist,来判断&#39;ssh&#39; 方式是否可行.
</span></span><span style="display:flex;"><span>ansible_ssh_private_key_file #ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.
</span></span><span style="display:flex;"><span>ansible_shell_type #目标系统的shell类型.默认情况下,命令的执行使用 &#39;sh&#39; 语法,可设置为&#39;csh&#39; 或 &#39;fish&#39;.
</span></span><span style="display:flex;"><span>ansible_python_interpreter #目标主机的 python 路径.适用于的情况: 系统中有多个 Python,或者命令路径不是&#34;/usr/bin/python&#34;,比如 \*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python.之所以不使用 &#34;/usr/bin/env&#34; 机制,因为这要求远程用户的路径设置正确,且要求 &#34;python&#34;可执行程序名不可为 python以外的名字(实际有可能名为python26).与ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ntp.wang.org
</span></span><span style="display:flex;"><span>[webservers]
</span></span><span style="display:flex;"><span>www1.wang.org:2222
</span></span><span style="display:flex;"><span>www2.wang.org
</span></span><span style="display:flex;"><span>[dbservers]
</span></span><span style="display:flex;"><span>db1.wang.org
</span></span><span style="display:flex;"><span>db2.wang.org
</span></span><span style="display:flex;"><span>db3.wang.org
</span></span><span style="display:flex;"><span>#或者
</span></span><span style="display:flex;"><span>db[1:3].wang.org
</span></span></code></pre></div><p>范例: 组嵌套</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[webservers]
</span></span><span style="display:flex;"><span>www[1:100].example.com
</span></span><span style="display:flex;"><span>[dbservers]
</span></span><span style="display:flex;"><span>db-[a:f].example.com
</span></span><span style="display:flex;"><span>[appservers]
</span></span><span style="display:flex;"><span>10.0.0.[1:100]
</span></span><span style="display:flex;"><span>#定义testsrvs组中包括两个其它分组,实现组嵌套
</span></span><span style="display:flex;"><span>[testsrvs:children]
</span></span><span style="display:flex;"><span>webservers
</span></span><span style="display:flex;"><span>dbservers
</span></span></code></pre></div><p>范例: 基于用户名和密码的ssh连接主机清单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[test]
</span></span><span style="display:flex;"><span>10.0.0.8 ansible_connection=local #指定本地连接,无需ssh配置
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#每个主机分别指定用户和密码,ansible_connection=ssh 需要StrictHostKeyChecking no 或者host_key_checking = False
</span></span><span style="display:flex;"><span>10.0.0.7 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=wangansible_ssh_password=123456
</span></span><span style="display:flex;"><span>10.0.0.6 ansible_ssh_user=root ansible_ssh_password=123456
</span></span><span style="display:flex;"><span>#对每个分组的所有主机统一定义用户和密码,执行ansible命令时显示别名,如web01
</span></span><span style="display:flex;"><span>[websrvs]
</span></span><span style="display:flex;"><span>web01 ansible_ssh_host=10.0.0.101
</span></span><span style="display:flex;"><span>web02 ansible_ssh_host=10.0.0.102
</span></span><span style="display:flex;"><span>[websrvs:vars]
</span></span><span style="display:flex;"><span>ansible_ssh_password=magedu
</span></span><span style="display:flex;"><span>some_host ansible_ssh_port=2222 ansible_ssh_user=manager
</span></span><span style="display:flex;"><span>aws_host ansible_ssh_private_key_file=/home/example/.ssh/aws.pem
</span></span><span style="display:flex;"><span>freebsd_host ansible_python_interpreter=/usr/local/bin/python
</span></span><span style="display:flex;"><span>ruby_module_host ansible_ruby_interpreter=/usr/bin/ruby.1.9.3
</span></span></code></pre></div><h2 id="ansible相关工具">Ansible相关工具<a hidden class="anchor" aria-hidden="true" href="#ansible相关工具">#</a></h2>
<ul>
<li>
<p>/usr/bin/ansible 主程序，临时命令执行工具</p>
</li>
<li>
<p>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man</p>
</li>
<li>
<p>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</p>
</li>
<li>
<p>/usr/bin/ansible-pull 远程执行命令的工具</p>
</li>
<li>
<p>/usr/bin/ansible-vault 文件加密工具</p>
</li>
<li>
<p>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</p>
</li>
<li>
<p>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</p>
</li>
</ul>
<p><strong>利用ansible实现管理的主要方式：</strong></p>
<ul>
<li>
<p>Ansible Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景</p>
</li>
<li>
<p>Ansible playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</p>
</li>
</ul>
<p><strong>ansible 使用前准备</strong>
ansible 相关工具大多数是通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能
建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点
范例：利用sshpass批量实现基于key验证脚本1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos8 ~]#vim /etc/ssh/ssh_config
</span></span><span style="display:flex;"><span>#修改下面一行
</span></span><span style="display:flex;"><span>StrictHostKeyChecking no
</span></span><span style="display:flex;"><span>[root@centos8 ~]#cat hosts.list
</span></span><span style="display:flex;"><span>192.168.32.178
</span></span><span style="display:flex;"><span>192.168.32.179
</span></span><span style="display:flex;"><span>[root@centos8 ~]#vim push_ssh_key.sh
</span></span><span style="display:flex;"><span>#!/bin/bash
</span></span><span style="display:flex;"><span>rpm -ql shpass &amp;&gt; /dev/null || yum -y install sshpass
</span></span><span style="display:flex;"><span>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P &#39;&#39;
</span></span><span style="display:flex;"><span>export SSHPASS=123456
</span></span><span style="display:flex;"><span>while read IP;do
</span></span><span style="display:flex;"><span>	sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done &lt; hosts.list
</span></span></code></pre></div><p>范例: 实现基于key验证的脚本2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[root@centos8 ~]#cat ssh_key.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#!/bin/bash
</span></span><span style="display:flex;"><span>PLIST=&#34;
</span></span><span style="display:flex;"><span>192.168.32.178
</span></span><span style="display:flex;"><span>192.168.32.179&#34;
</span></span><span style="display:flex;"><span>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass
</span></span><span style="display:flex;"><span>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P &#39;&#39;
</span></span><span style="display:flex;"><span>export SSHPASS=123456
</span></span><span style="display:flex;"><span>for IP in $IPLIST;do
</span></span><span style="display:flex;"><span>       { sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP; } &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>done
</span></span><span style="display:flex;"><span>wait
</span></span></code></pre></div><h3 id="ansible-doc">ansible-doc<a hidden class="anchor" aria-hidden="true" href="#ansible-doc">#</a></h3>
<p>此工具用来显示模块帮助,相当于man
格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-doc [options] [module...]
</span></span><span style="display:flex;"><span>-l, --list #列出可用模块
</span></span><span style="display:flex;"><span>-s, --snippet #显示指定模块的playbook片段
</span></span></code></pre></div><p>范例: 查看帮助</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@rocky ~]# ansible-doc --help
</span></span><span style="display:flex;"><span>usage: ansible-doc [-h] [--version] [-v] [-M MODULE_PATH] [--playbook-dir BASEDIR]
</span></span><span style="display:flex;"><span>                   [-t {become,cache,callback,cliconf,connection,httpapi,inventory,lookup,netconf,shell,vars,module,strategy,role,keyword}]
</span></span><span style="display:flex;"><span>                   [-j] [-r ROLES_PATH] [-e ENTRY_POINT | -s | -F | -l | --metadata-dump] [--no-fail-on-errors]
</span></span><span style="display:flex;"><span>                   [plugin ...]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plugin documentation tool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>positional arguments:
</span></span><span style="display:flex;"><span>  plugin                Plugin
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#列出所有模块
</span></span><span style="display:flex;"><span>ansible-doc -l
</span></span><span style="display:flex;"><span>#查看指定模块帮助用法
</span></span><span style="display:flex;"><span>ansible-doc ping
</span></span><span style="display:flex;"><span>#查看指定模块帮助用法
</span></span><span style="display:flex;"><span>ansible-doc -s ping
</span></span></code></pre></div><p>范例: 查看指定的插件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@rocky ~]# ansible-doc -t connection -l
</span></span><span style="display:flex;"><span>local        execute on controller                                                                                                 
</span></span><span style="display:flex;"><span>paramiko_ssh Run tasks via python ssh (paramiko)                                                                                   
</span></span><span style="display:flex;"><span>psrp         Run tasks over Microsoft PowerShell Remoting Protocol                                                                 
</span></span><span style="display:flex;"><span>ssh          connect via SSH client binary                                                                                         
</span></span><span style="display:flex;"><span>winrm        Run tasks over Microsoft&#39;s WinRM                                                                                      
</span></span><span style="display:flex;"><span>[root@rocky ~]# 
</span></span><span style="display:flex;"><span>[root@rocky ~]# ansible-doc -t lookup -l
</span></span><span style="display:flex;"><span>config              Lookup current Ansible configuration values                                                                    
</span></span><span style="display:flex;"><span>csvfile             read data from a TSV or CSV file                                                                               
</span></span><span style="display:flex;"><span>dict                returns key/value pair items from dictionaries                                                                 
</span></span><span style="display:flex;"><span>env                 Read the value of environment variables                                                                        
</span></span><span style="display:flex;"><span>file                read file contents                                                                                             
</span></span><span style="display:flex;"><span>fileglob            list files matching a pattern                                                                                  
</span></span><span style="display:flex;"><span>first_found         return first file found from list                                                                              
</span></span><span style="display:flex;"><span>indexed_items       rewrites lists to return &#39;indexed items&#39;                                                                       
</span></span><span style="display:flex;"><span>ini                 read data from an ini file                                                                                     
</span></span><span style="display:flex;"><span>inventory_hostnames list of inventory hosts matching a host pattern                                                                
</span></span><span style="display:flex;"><span>items               list of items                                                                                                  
</span></span><span style="display:flex;"><span>lines               read lines from command                                                                                        
</span></span><span style="display:flex;"><span>list                simply returns what it is given                                                                                
</span></span><span style="display:flex;"><span>nested              composes a list with nested elements of other lists                                                            
</span></span><span style="display:flex;"><span>password            retrieve or generate a random password, stored in a file                                                       
</span></span><span style="display:flex;"><span>pipe                read output from a command                                                                                     
</span></span><span style="display:flex;"><span>random_choice       return random element from list                                                                                
</span></span><span style="display:flex;"><span>sequence            generate a list based on a number sequence                                                                     
</span></span><span style="display:flex;"><span>subelements         traverse nested key from a list of dictionaries                                                                
</span></span><span style="display:flex;"><span>template            retrieve contents of file after templating with Jinja2                                                         
</span></span><span style="display:flex;"><span>together            merges lists into synchronized list                                                                            
</span></span><span style="display:flex;"><span>unvault             read vaulted file(s) contents                                                                                  
</span></span><span style="display:flex;"><span>url                 return contents from URL                                                                                       
</span></span><span style="display:flex;"><span>varnames            Lookup matching variable names                                                                                 
</span></span><span style="display:flex;"><span>vars                Lookup templated value of variables                                                                            
</span></span><span style="display:flex;"><span>[root@rocky ~]# 
</span></span></code></pre></div><h3 id="ansible">ansible<a hidden class="anchor" aria-hidden="true" href="#ansible">#</a></h3>
<h4 id="ansible-ad-hoc-介绍">Ansible Ad-Hoc 介绍<a hidden class="anchor" aria-hidden="true" href="#ansible-ad-hoc-介绍">#</a></h4>
<p>Ansible Ad-Hoc 的执行方式的主要工具就是 ansible
特点: 一次性的执行,不会保存执行命令信息,只适合临时性或测试性的任务</p>
<h4 id="ansible-命令用法">ansible 命令用法<a hidden class="anchor" aria-hidden="true" href="#ansible-命令用法">#</a></h4>
<p>格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible &lt;host-pattern&gt; [-m module_name] [-a args]
</span></span></code></pre></div><p>选项说明：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-v" data-lang="v"><span style="display:flex;"><span><span style="color:#f92672">--</span>version <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">显示版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>m <span style="color:#f92672">module</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">指定模块，默认为</span>command
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>v <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">详细过程</span> <span style="color:#f92672">-</span>vv <span style="color:#f92672">-</span>vvv<span style="color:#960050;background-color:#1e0010">更详细</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>list<span style="color:#f92672">-</span>hosts <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">显示主机列表，可简写</span> <span style="color:#f92672">--</span>list
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#a6e22e">C</span>, <span style="color:#f92672">--</span>check <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">检查，并不执行</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#a6e22e">T</span>, <span style="color:#f92672">--</span>timeout<span style="color:#f92672">=</span><span style="color:#a6e22e">TIMEOUT</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">执行命令的超时时间，默认</span><span style="color:#ae81ff">10</span>s
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>k, <span style="color:#f92672">--</span>ask<span style="color:#f92672">-</span>pass <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">提示输入</span>ssh<span style="color:#960050;background-color:#1e0010">连接密码，默认</span><span style="color:#a6e22e">Key</span><span style="color:#960050;background-color:#1e0010">验证</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>u, <span style="color:#f92672">--</span>user<span style="color:#f92672">=</span><span style="color:#a6e22e">REMOTE_USER</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">执行远程执行的用户</span>,<span style="color:#960050;background-color:#1e0010">默认</span>root
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>b, <span style="color:#f92672">--</span>become <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">代替旧版的</span>sudo<span style="color:#960050;background-color:#1e0010">实现通过</span>sudo<span style="color:#960050;background-color:#1e0010">机制实现提升权限</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>become<span style="color:#f92672">-</span>user<span style="color:#f92672">=</span><span style="color:#a6e22e">USERNAME</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">指定</span>sudo<span style="color:#960050;background-color:#1e0010">的</span>runas<span style="color:#960050;background-color:#1e0010">用户，默认为</span>root
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#a6e22e">K</span>, <span style="color:#f92672">--</span>ask<span style="color:#f92672">-</span>become<span style="color:#f92672">-</span>pass <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">提示输入</span>sudo<span style="color:#960050;background-color:#1e0010">时的口令</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>f <span style="color:#a6e22e">FORKS</span>, <span style="color:#f92672">--</span>forks <span style="color:#a6e22e">FORKS</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">指定并发同时执行</span>ansible<span style="color:#960050;background-color:#1e0010">任务的主机数</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>i <span style="color:#a6e22e">INVENTORY</span>, <span style="color:#f92672">--</span>inventory <span style="color:#a6e22e">INVENTORY</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">指定主机清单文件</span>
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#以wang用户执行ping存活检测
</span></span><span style="display:flex;"><span>ansible all -m ping -u wang -k
</span></span><span style="display:flex;"><span>#以wang sudo至root执行ping存活检测
</span></span><span style="display:flex;"><span>ansible all -m ping -u wang -k -b
</span></span><span style="display:flex;"><span>#以wang sudo至mage用户执行ping存活检测
</span></span><span style="display:flex;"><span>ansible all -m ping -u wang -k -b --become-user=mage
</span></span><span style="display:flex;"><span>#以wang sudo至root用户执行ls
</span></span><span style="display:flex;"><span>ansible all -m command -u wang -a &#39;ls /root&#39; -b --become-user=root -k -K
</span></span></code></pre></div><p>范例: 并发执行控制</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#分别执行下面两条命令观察结果
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible all -a &#39;sleep 5&#39; -f1
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible all -a &#39;sleep 5&#39; -f10
</span></span></code></pre></div><p>范例: 使用普能用户进行远程管理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#在所有控制端和被控制端创建用户和密码
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#useradd wang
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#echo wang:123456 | chpasswd
</span></span><span style="display:flex;"><span>#在所有被控制端对用户sudo授权
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#visudo
</span></span><span style="display:flex;"><span>wang ALL=(ALL) NOPASSWD: ALL
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#visudo -c
</span></span><span style="display:flex;"><span>/etc/sudoers: parsed OK
</span></span><span style="display:flex;"><span>#实现从控制端到被控制端的基于key验证
</span></span><span style="display:flex;"><span>[root@ansible ~]#su - wang
</span></span><span style="display:flex;"><span>wang@ansible:~$ssh-keygen -f ~/.ssh/id_rsa -P &#39;&#39;
</span></span><span style="display:flex;"><span>wang@ansible:~$$ssh-copy-id wang@&#39;10.0.0.8&#39;
</span></span><span style="display:flex;"><span>#使用普通用户测试连接,默认连接权限不足失败
</span></span><span style="display:flex;"><span>wang@ansible:~$ ansible 10.0.0.8 -m shell -a &#39;ls /root&#39;
</span></span><span style="display:flex;"><span>10.0.0.8 | FAILED | rc=2 &gt;&gt;
</span></span><span style="display:flex;"><span>ls: cannot open directory &#39;/root&#39;: Permission deniednon-zero return code
</span></span><span style="display:flex;"><span>#使用普通用户通过-b选项连接实现sudo提权后连接成功
</span></span><span style="display:flex;"><span>wang@ansible:~$ ansible 10.0.0.8 -m shell -a &#39;ls /root&#39; -b --become-user root
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>anaconda-ks.cfg
</span></span><span style="display:flex;"><span>#修改配置文件指定sudo机制
</span></span><span style="display:flex;"><span>[root@ansible ~]#vim /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>#取消下面行前面的注释
</span></span><span style="display:flex;"><span>[privilege_escalation]
</span></span><span style="display:flex;"><span>become=True
</span></span><span style="display:flex;"><span>become_method=sudo
</span></span><span style="display:flex;"><span>become_user=root
</span></span><span style="display:flex;"><span>become_ask_pass=False
</span></span><span style="display:flex;"><span>#再次测试
</span></span><span style="display:flex;"><span>[root@ansible ~]#su - wang
</span></span><span style="display:flex;"><span>wang@ansible:~$ ansible 10.0.0.8 -m shell -a &#39;ls /root&#39;
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>anaconda-ks.cfg
</span></span></code></pre></div><p>范例: 使用普通用户连接远程主机执行代替另一个用户身份执行操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@centos8 ~]#useradd wang
</span></span><span style="display:flex;"><span>[root@centos8 ~]#echo wang:123456 | chpasswd
</span></span><span style="display:flex;"><span>#先在被控制端能过sudo对普通用户授权
</span></span><span style="display:flex;"><span>[root@centos8 ~]#grep wang /etc/sudoers
</span></span><span style="display:flex;"><span>wang ALL=(ALL) NOPASSWD: ALL
</span></span><span style="display:flex;"><span>#以wang的用户连接用户,并利用sudo代表mage执行whoami命令
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible 10.0.0.8 -m shell -a &#39;whoami&#39; -u wang -k -b --become-
</span></span><span style="display:flex;"><span>user=mage
</span></span><span style="display:flex;"><span>SSH password: #输入远程主机wang用户ssh连接密码
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>mage
</span></span></code></pre></div><h4 id="ansible的host-pattern">ansible的Host-pattern<a hidden class="anchor" aria-hidden="true" href="#ansible的host-pattern">#</a></h4>
<p>用于匹配被控制的主机的列表
All ：表示所有Inventory中的所有主机
范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible all -m ping
</span></span></code></pre></div><p>*:通配符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible &#34;*&#34; -m ping
</span></span><span style="display:flex;"><span>ansible 192.168.1.* -m ping
</span></span><span style="display:flex;"><span>ansible &#34;srvs&#34; -m ping
</span></span><span style="display:flex;"><span>ansible &#34;10.0.0.6 10.0.0.7&#34; -m ping
</span></span></code></pre></div><p>或关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible &#34;websrvs:appsrvs&#34; -m ping
</span></span><span style="display:flex;"><span>ansible &#34;192.168.1.10:192.168.1.20&#34; -m ping
</span></span></code></pre></div><p>逻辑与</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#在websrvs组并且在dbsrvs组中的主机
</span></span><span style="display:flex;"><span>ansible &#34;websrvs:&amp;dbsrvs&#34; -m ping
</span></span></code></pre></div><p>逻辑非</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#在所有主机,但不在websrvs组和dbsrvs组中的主机
</span></span><span style="display:flex;"><span>#注意：此处为单引号
</span></span><span style="display:flex;"><span>ansible &#39;all:!dbsrvs:!websrvs&#39; -m ping
</span></span></code></pre></div><p>综合逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; -m ping
</span></span></code></pre></div><p>正则表达式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible &#34;websrvs:dbsrvs&#34; -m ping
</span></span><span style="display:flex;"><span>ansible &#34;~(web|db).*\.magedu\.com&#34; -m ping
</span></span></code></pre></div><h5 id="ansible-命令的执行过程">ansible 命令的执行过程<a hidden class="anchor" aria-hidden="true" href="#ansible-命令的执行过程">#</a></h5>
<ol>
<li>加载自己的配置文件,默认/etc/ansible/ansible.cfg</li>
<li>查找主机清单中对应的主机或主机组</li>
<li>加载自己对应的模块文件，如：command</li>
<li>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户
$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</li>
<li>给文件+x执行</li>
<li>执行并返回结果</li>
<li>删除临时py文件，退出</li>
</ol>
<h5 id="ansible-命令的执行状态">ansible 命令的执行状态<a hidden class="anchor" aria-hidden="true" href="#ansible-命令的执行状态">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@centos8 ~]#grep -A 14 &#39;\[colors\]&#39; /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>[colors]
</span></span><span style="display:flex;"><span>#highlight = white
</span></span><span style="display:flex;"><span>#verbose = blue
</span></span><span style="display:flex;"><span>#warn = bright purple
</span></span><span style="display:flex;"><span>#error = red
</span></span><span style="display:flex;"><span>#debug = dark gray
</span></span><span style="display:flex;"><span>#deprecate = purple
</span></span><span style="display:flex;"><span>#skip = cyan
</span></span><span style="display:flex;"><span>#unreachable = red
</span></span><span style="display:flex;"><span>#ok = green
</span></span><span style="display:flex;"><span>#changed = yellow
</span></span><span style="display:flex;"><span>#diff_add = green
</span></span><span style="display:flex;"><span>#diff_remove = red
</span></span><span style="display:flex;"><span>#diff_lines = cyan
</span></span></code></pre></div><ul>
<li>绿色：执行成功并且对目标主机不需要做改变的操作</li>
<li>黄色：执行成功并且对目标主机做变更</li>
<li>红色：执行失败</li>
</ul>
<h3 id="ansible-console">ansible-console<a hidden class="anchor" aria-hidden="true" href="#ansible-console">#</a></h3>
<p>此工具可交互执行命令，支持tab，ansible 2.0+新增
提示符格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$
</span></span></code></pre></div><p>常用子命令：</p>
<ul>
<li>设置并发数： forks n 例如： forks 10</li>
<li>切换组： cd 主机组 例如： cd web</li>
<li>列出当前组主机列表： list</li>
<li>列出所有的内置命令： ?或help</li>
</ul>
<p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible-console
</span></span><span style="display:flex;"><span>Welcome to the ansible console.
</span></span><span style="display:flex;"><span>Type help or ? to list commands.
</span></span><span style="display:flex;"><span>root@all (3)[f:5]$ ping
</span></span><span style="display:flex;"><span>10.0.0.7 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>&#34;ping&#34;: &#34;pong&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>10.0.0.6 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>&#34;ping&#34;: &#34;pong&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>10.0.0.8 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/libexec/platform-python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>&#34;ping&#34;: &#34;pong&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>root@all (3)[f:5]$ list
</span></span><span style="display:flex;"><span>10.0.0.8
</span></span><span style="display:flex;"><span>10.0.0.7
</span></span><span style="display:flex;"><span>10.0.0.6
</span></span><span style="display:flex;"><span>root@all (3)[f:5]$ cd websrvs
</span></span><span style="display:flex;"><span>root@websrvs (2)[f:5]$ list
</span></span><span style="display:flex;"><span>10.0.0.7
</span></span><span style="display:flex;"><span>10.0.0.8
</span></span><span style="display:flex;"><span>root@websrvs (2)[f:5]$ forks 10
</span></span><span style="display:flex;"><span>root@websrvs (2)[f:10]$ cd appsrvs
</span></span><span style="display:flex;"><span>root@appsrvs (2)[f:5]$ yum name=httpd state=present
</span></span><span style="display:flex;"><span>root@appsrvs (2)[f:5]$ service name=httpd state=started
</span></span></code></pre></div><h3 id="ansible-playbook">ansible-playbook<a hidden class="anchor" aria-hidden="true" href="#ansible-playbook">#</a></h3>
<p>此工具用于执行编写好的 playbook 任务
范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-playbook hello.yml
</span></span><span style="display:flex;"><span>cat hello.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>#hello world yml file
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: hello world
</span></span><span style="display:flex;"><span>    command: /usr/bin/wall hello world
</span></span></code></pre></div><h3 id="ansible-vault">ansible-vault<a hidden class="anchor" aria-hidden="true" href="#ansible-vault">#</a></h3>
<p>此工具可以用于加密解密yml文件
格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-vault [create|decrypt|edit|encrypt|rekey|view]
</span></span></code></pre></div><p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-vault encrypt hello.yml #加密
</span></span><span style="display:flex;"><span>ansible-vault decrypt hello.yml #解密
</span></span><span style="display:flex;"><span>ansible-vault view hello.yml #查看
</span></span><span style="display:flex;"><span>ansible-vault edit hello.yml #编辑加密文件
</span></span><span style="display:flex;"><span>ansible-vault rekey hello.yml #修改口令
</span></span><span style="display:flex;"><span>ansible-vault create new.yml #创建新文件
</span></span><span style="display:flex;"><span>#执行加密的playbook,交互式输入密码
</span></span><span style="display:flex;"><span>chmod 600 hello.yml
</span></span><span style="display:flex;"><span>ansible-playbook --ask-vault-pass hello.yml
</span></span><span style="display:flex;"><span>#从pass.txt文件中读取密码
</span></span><span style="display:flex;"><span>ansible-playbook --vault-password-file pass.txt hello.yml
</span></span><span style="display:flex;"><span>#从配置文件中取得密码
</span></span><span style="display:flex;"><span>#vi /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>[defaults]
</span></span><span style="display:flex;"><span>ault-password-file=pass.txt
</span></span><span style="display:flex;"><span>#可以直接执行加密文件
</span></span><span style="display:flex;"><span>ansible-playbook hello.yml
</span></span></code></pre></div><h3 id="ansible-galaxy">ansible-galaxy<a hidden class="anchor" aria-hidden="true" href="#ansible-galaxy">#</a></h3>
<p>Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。
Ansible 提供了ansible-galaxy命令行工具连接 <a href="https://galaxy.ansible.com">https://galaxy.ansible.com</a> 网站下载相应的roles, 进行init(初始化、search( 查拘、install(安装、 remove(移除)等操作。</p>
<p><img loading="lazy" src="/posts.images/image.assets/1677156776774.png" alt="1677156776774"  />
</p>
<p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#搜索项目
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-galaxy search lamp
</span></span><span style="display:flex;"><span>#列出所有已安装的galaxy
</span></span><span style="display:flex;"><span>ansible-galaxy list
</span></span><span style="display:flex;"><span>#安装galaxy,默认下载到~/.ansible/roles下
</span></span><span style="display:flex;"><span>ansible-galaxy install geerlingguy.mysql
</span></span><span style="display:flex;"><span>ansible-galaxy install geerlingguy.redis
</span></span><span style="display:flex;"><span>#删除galaxy
</span></span><span style="display:flex;"><span>ansible-galaxy remove geerlingguy.redis
</span></span></code></pre></div><h2 id="ansible常用模块">Ansible常用模块<a hidden class="anchor" aria-hidden="true" href="#ansible常用模块">#</a></h2>
<p>2015年12月只270多个模块
2016年12年26日ansible 1.9.2 有540个模块
2018年01月12日ansible 2.3.8 有1378个模块
2018年05月28日ansible 2.5.3 有1562个模块
2018年07月15日ansible 2.6.3 有1852个模块
2018年11月19日ansible 2.7.2 有2080个模块
2020年03月02日ansible 2.9.5 有3387个模块
2021年12月22日ansible 2.11.8 有6141个模块
2022年06月04日ansible 2.12.6 有6763个模块
虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只需要熟悉10几个模块即可
常用模块帮助文档参考：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html
</span></span><span style="display:flex;"><span>https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html
</span></span><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html
</span></span><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/modules/modules_by_category.html
</span></span></code></pre></div><h3 id="command-模块">Command 模块<a hidden class="anchor" aria-hidden="true" href="#command-模块">#</a></h3>
<p>功能：在远程主机执行命令，此为默认模块，可忽略 -m 选项
注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，可用shell模块实现
注意：此模块不具有幂等性
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>chdir=dir #执行命令前,先切换至目录dir
</span></span><span style="display:flex;"><span>creates=file #当file不存在时才会执行
</span></span><span style="display:flex;"><span>removes=file #当file存在时才会执行
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m command -a &#39;chdir=/etc cat centos-release&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>CentOS Linux release 7.7.1908 (Core)
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>CentOS Linux release 8.1.1911 (Core)
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m command -a &#39;chdir=/etc creates=/data/f1.txt cat centos-release&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>CentOS Linux release 7.7.1908 (Core)
</span></span><span style="display:flex;"><span>10.0.0.8 | SUCCESS | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>skipped, since /data/f1.txt exists
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m command -a &#39;chdir=/etc removes=/data/f1.txt cat centos-release&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | SUCCESS | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>skipped, since /data/f1.txt does not exist
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>CentOS Linux release 8.1.1911 (Core)
</span></span><span style="display:flex;"><span>ansible websrvs -m command -a &#39;service vsftpd start&#39;
</span></span><span style="display:flex;"><span>ansible websrvs -m command -a &#39;echo magedu |passwd --stdin wang&#39;
</span></span><span style="display:flex;"><span>ansible websrvs -m command -a &#39;rm -rf /data/&#39;
</span></span><span style="display:flex;"><span>ansible websrvs -m command -a &#39;echo hello &gt; /data/hello.log&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible websrvs -m command -a &#34;echo $HOSTNAME&#34;
</span></span></code></pre></div><h3 id="shell-模块">Shell 模块<a hidden class="anchor" aria-hidden="true" href="#shell-模块">#</a></h3>
<p>功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, &gt; , 相当于增强版的command模块
注意：此模块不具有幂等性,建议能不能就用此模块,最好使用专用模块
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>chdir=dir #执行命令前,先切换至目录dir
</span></span><span style="display:flex;"><span>creates=file #当file不存在时才会执行
</span></span><span style="display:flex;"><span>removes=file #当file存在时才会执行
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#34;echo $HOSTNAME&#34;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>ansible
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>ansible
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#39;echo $HOSTNAME&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>centos7.wangxiaochun.com
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>centos8.localdomain
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#39;echo centos | passwd --stdin wang&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>Changing password for user wang.
</span></span><span style="display:flex;"><span>passwd: all authentication tokens updated successfully.
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>Changing password for user wang.
</span></span><span style="display:flex;"><span>passwd: all authentication tokens updated successfully.
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#39;ls -l /etc/shadow&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>---------- 1 root root 889 Mar 2 14:34 /etc/shadow
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>---------- 1 root root 944 Mar 2 14:34 /etc/shadow
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#39;echo hello &gt; /data/hello.log&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m shell -a &#39;cat /data/hello.log&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>hello
</span></span><span style="display:flex;"><span>10.0.0.8 | CHANGED | rc=0 &gt;&gt;
</span></span><span style="display:flex;"><span>hello
</span></span></code></pre></div><p>注意：调用bash执行命令 类似 cat /tmp/test.md | awk -F&rsquo;|&rsquo; &lsquo;{print $1,$2}&rsquo; &amp;&gt; /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器
范例：将shell模块代替command，设为模块</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#vim /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>#修改下面一行
</span></span><span style="display:flex;"><span>module_name = shell
</span></span></code></pre></div><h3 id="script-模块">Script 模块<a hidden class="anchor" aria-hidden="true" href="#script-模块">#</a></h3>
<p>功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)
注意：此模块不具有幂等性
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>chdir=dir #执行命令前,先切换至目录dir
</span></span><span style="display:flex;"><span>cmd #指定ansible主机的命令
</span></span><span style="display:flex;"><span>creates=file #当file不存在时才会执行
</span></span><span style="display:flex;"><span>removes=file #当file存在时才会执行
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible websrvs -m script -a /data/test.sh
</span></span></code></pre></div><h3 id="copy-模块">Copy 模块<a hidden class="anchor" aria-hidden="true" href="#copy-模块">#</a></h3>
<p>功能：复制ansible服务器主控端或远程的本机的文件到远程主机
注意: src=file 如果是没指明路径,则为当前目录或当前目录下的files目录下的file文件
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>src #控制端的源文件路径
</span></span><span style="display:flex;"><span>dest #被控端的文件路径
</span></span><span style="display:flex;"><span>owner #属主
</span></span><span style="display:flex;"><span>group #属组
</span></span><span style="display:flex;"><span>mode #权限
</span></span><span style="display:flex;"><span>backup #是否备份
</span></span><span style="display:flex;"><span>validate #验证成功才会执行copy
</span></span><span style="display:flex;"><span>remote_src #no是默认值,表示src文件在ansible主机,yes表示src文件在远程主机
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#如目标存在，默认覆盖，此处指定先备
</span></span><span style="display:flex;"><span>ansible websrvs -m copy -a &#34;src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes&#34;
</span></span><span style="display:flex;"><span>#指定内容，直接生成目标文件
</span></span><span style="display:flex;"><span>ansible websrvs -m copy -a &#34;content=&#39;wang 123456\nxiao 654321\n&#39; dest=/etc/rsync.pas owner=root group=root mode=0600&#34;
</span></span><span style="display:flex;"><span>#复制/etc目录自身,注意/etc/后面没有/
</span></span><span style="display:flex;"><span>ansible websrvs -m copy -a &#34;src=/etc dest=/backup&#34;
</span></span><span style="display:flex;"><span>#复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/
</span></span><span style="display:flex;"><span>ansible websrvs -m copy -a &#34;src=/etc/ dest=/backup&#34;
</span></span><span style="display:flex;"><span>#复制/etc/suders,并校验语法
</span></span><span style="display:flex;"><span>ansible websrvs -m copy -a &#34;src=/etc/suders dest=/etc/sudoers.edit remote_src=yes validate=/usr/sbin/visudo -csf %s&#34;
</span></span></code></pre></div><h3 id="get_url-模块">Get_url 模块<a hidden class="anchor" aria-hidden="true" href="#get_url-模块">#</a></h3>
<p>功能: 用于将文件从http、https或ftp下载到被管理机节点上
常用参数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>url #下载文件的URL,支持HTTP，HTTPS或FTP协议
</span></span><span style="display:flex;"><span>dest #下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标
</span></span><span style="display:flex;"><span>设置的名称
</span></span><span style="display:flex;"><span>owner #指定属主
</span></span><span style="display:flex;"><span>group #指定属组
</span></span><span style="display:flex;"><span>mode #指定权限
</span></span><span style="display:flex;"><span>force #如果yes，dest不是目录，将每次下载文件，如果内容改变替换文件。如果no，则只有在目标不存
</span></span><span style="display:flex;"><span>在时才会下载
</span></span><span style="display:flex;"><span>checksum #对目标文件在下载后计算摘要，以确保其完整性
</span></span><span style="display:flex;"><span>#示例: checksum=&#34;sha256:D98291AC[...]B6DC7B97&#34;,
</span></span><span style="display:flex;"><span>checksum=&#34;sha256:http://example.com/path/sha256sum.txt&#34;
</span></span><span style="display:flex;"><span>url_username #用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用`url_password&#39;
</span></span><span style="display:flex;"><span>url_password #用于HTTP基本认证的密码。 如果未指定`url_username&#39;参数，则不会使用`url_password&#39;参数
</span></span><span style="display:flex;"><span>validate_certs #如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用
</span></span><span style="display:flex;"><span>timeout #URL请求的超时时间,秒为单位
</span></span></code></pre></div><p>范例: 下载并MD5验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m get_url -a &#39;url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz checksum=&#34;md5:b2d33d24d89b8b1f87ff5d251aa27eb8&#34;&#39;
</span></span></code></pre></div><h3 id="fetch-模块">Fetch 模块<a hidden class="anchor" aria-hidden="true" href="#fetch-模块">#</a></h3>
<p>功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>src #被控制端的源文件路径,只支持文件
</span></span><span style="display:flex;"><span>dest #ansible控制端的目录路径
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible websrvs -m fetch -a &#39;src=/root/test.sh dest=/data/scripts&#39;
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible all -m fetch -a &#39;src=/etc/redhat-release
</span></span><span style="display:flex;"><span>dest=/data/os&#39;
</span></span><span style="display:flex;"><span>[root@ansible ~]#tree /data/os/
</span></span><span style="display:flex;"><span>/data/os/
</span></span><span style="display:flex;"><span>├── 10.0.0.6
</span></span><span style="display:flex;"><span>│ └── etc
</span></span><span style="display:flex;"><span>│ └── redhat-release
</span></span><span style="display:flex;"><span>├── 10.0.0.7
</span></span><span style="display:flex;"><span>│ └── etc
</span></span><span style="display:flex;"><span>│ └── redhat-release
</span></span><span style="display:flex;"><span>└── 10.0.0.8
</span></span><span style="display:flex;"><span>└── etc
</span></span><span style="display:flex;"><span>└── redhat-release
</span></span><span style="display:flex;"><span>6 directories, 3 files
</span></span></code></pre></div><h3 id="file-模块">File 模块<a hidden class="anchor" aria-hidden="true" href="#file-模块">#</a></h3>
<p>功能：设置文件属性,创建文件,目录和软链接等
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>path #在被控端创建的路径
</span></span><span style="display:flex;"><span>owner #属主
</span></span><span style="display:flex;"><span>group #属组
</span></span><span style="display:flex;"><span>mode #权限
</span></span><span style="display:flex;"><span>state #状态
</span></span><span style="display:flex;"><span>=touch #创建文件
</span></span><span style="display:flex;"><span>=directory #创建目录
</span></span><span style="display:flex;"><span>=link #软链接
</span></span><span style="display:flex;"><span>=hard #硬链接
</span></span><span style="display:flex;"><span>recurse #yes表示递归授权
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#创建空文件
</span></span><span style="display:flex;"><span>ansible all -m file -a &#39;path=/data/test.txt state=touch&#39;
</span></span><span style="display:flex;"><span>ansible all -m file -a &#39;path=/data/test.txt state=absent&#39;
</span></span><span style="display:flex;"><span>ansible all -m file -a &#34;path=/root/test.sh owner=wang mode=755&#34;
</span></span><span style="display:flex;"><span>#创建目录
</span></span><span style="display:flex;"><span>ansible all -m file -a &#34;path=/data/mysql state=directory owner=mysql group=mysql&#34;
</span></span><span style="display:flex;"><span>#创建软链接
</span></span><span style="display:flex;"><span>ansible all -m file -a &#39;src=/data/testfile path|dest|name=/data/testfile-link state=link&#39;
</span></span><span style="display:flex;"><span>#创建目录
</span></span><span style="display:flex;"><span>ansible all -m file -a &#39;path=/data/testdir state=directory&#39;
</span></span><span style="display:flex;"><span>#递归修改目录属性,但不递归至子目录
</span></span><span style="display:flex;"><span>ansible all -m file -a &#34;path=/data/mysql state=directory owner=mysql group=mysql&#34;
</span></span><span style="display:flex;"><span>#递归修改目录及子目录的属性
</span></span><span style="display:flex;"><span>ansible all -m file -a &#34;path=/data/mysql state=directory owner=mysql group=mysql recurse=yes&#34;
</span></span></code></pre></div><h3 id="stat-模块">stat 模块<a hidden class="anchor" aria-hidden="true" href="#stat-模块">#</a></h3>
<p>功能：检查文件或文件系统的状态
注意：对于Windows目标，请改用win_stat模块</p>
<p>常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>path #文件/对象的完整路径（必须）
</span></span></code></pre></div><p>常用的返回值判断：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exists： 判断是否存在
</span></span><span style="display:flex;"><span>isuid： 调用用户的ID与所有者ID是否匹配
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible 127.0.0.1 -m stat -a &#39;path=/etc/passwd&#39;
</span></span><span style="display:flex;"><span>127.0.0.1 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>&#34;stat&#34;: {
</span></span><span style="display:flex;"><span>&#34;atime&#34;: 1614601466.7493012,
</span></span><span style="display:flex;"><span>&#34;attr_flags&#34;: &#34;&#34;,
</span></span><span style="display:flex;"><span>&#34;attributes&#34;: [],
</span></span><span style="display:flex;"><span>&#34;block_size&#34;: 4096,
</span></span><span style="display:flex;"><span>&#34;blocks&#34;: 8,
</span></span><span style="display:flex;"><span>&#34;charset&#34;: &#34;us-ascii&#34;,
</span></span><span style="display:flex;"><span>&#34;checksum&#34;: &#34;8f7a9a996d24de98bf1eab4a047f8e89e9c708cf&#34;,
</span></span><span style="display:flex;"><span>&#34;ctime&#34;: 1614334259.4498665,
</span></span><span style="display:flex;"><span>&#34;dev&#34;: 2050,
</span></span><span style="display:flex;"><span>&#34;device_type&#34;: 0,
</span></span><span style="display:flex;"><span>&#34;executable&#34;: false,
</span></span><span style="display:flex;"><span>&#34;exists&#34;: true,
</span></span><span style="display:flex;"><span>&#34;gid&#34;: 0,
</span></span><span style="display:flex;"><span>&#34;gr_name&#34;: &#34;root&#34;,
</span></span><span style="display:flex;"><span>&#34;inode&#34;: 134691833,
</span></span><span style="display:flex;"><span>&#34;isblk&#34;: false,
</span></span><span style="display:flex;"><span>&#34;ischr&#34;: false,
</span></span><span style="display:flex;"><span>&#34;isdir&#34;: false,
</span></span><span style="display:flex;"><span>&#34;isfifo&#34;: false,
</span></span><span style="display:flex;"><span>&#34;isgid&#34;: false,
</span></span><span style="display:flex;"><span>&#34;islnk&#34;: false,
</span></span><span style="display:flex;"><span>&#34;isreg&#34;: true,
</span></span><span style="display:flex;"><span>&#34;issock&#34;: false,
</span></span><span style="display:flex;"><span>&#34;isuid&#34;: false,
</span></span><span style="display:flex;"><span>&#34;mimetype&#34;: &#34;text/plain&#34;,
</span></span><span style="display:flex;"><span>&#34;mode&#34;: &#34;0000&#34;,
</span></span><span style="display:flex;"><span>&#34;mtime&#34;: 1614334259.4498665,
</span></span><span style="display:flex;"><span>&#34;nlink&#34;: 1,
</span></span><span style="display:flex;"><span>&#34;path&#34;: &#34;/etc/passwd&#34;,
</span></span><span style="display:flex;"><span>&#34;pw_name&#34;: &#34;root&#34;,
</span></span><span style="display:flex;"><span>&#34;readable&#34;: true,
</span></span><span style="display:flex;"><span>&#34;rgrp&#34;: false,
</span></span><span style="display:flex;"><span>&#34;roth&#34;: false,
</span></span><span style="display:flex;"><span>&#34;rusr&#34;: false,
</span></span><span style="display:flex;"><span>&#34;size&#34;: 1030,
</span></span><span style="display:flex;"><span>&#34;uid&#34;: 0,
</span></span><span style="display:flex;"><span>&#34;version&#34;: &#34;671641160&#34;,
</span></span><span style="display:flex;"><span>&#34;wgrp&#34;: false,
</span></span><span style="display:flex;"><span>&#34;woth&#34;: false,
</span></span><span style="display:flex;"><span>&#34;writeable&#34;: true,
</span></span><span style="display:flex;"><span>&#34;wusr&#34;: false,
</span></span><span style="display:flex;"><span>&#34;xgrp&#34;: false,
</span></span><span style="display:flex;"><span>&#34;xoth&#34;: false,
</span></span><span style="display:flex;"><span>&#34;xusr&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>案例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- name: install | Check if file is already configured.
</span></span><span style="display:flex;"><span>  stat: path={{ nginx_file_path }}
</span></span><span style="display:flex;"><span>  connection: local
</span></span><span style="display:flex;"><span>  register: nginx_file_result
</span></span><span style="display:flex;"><span>- name: install | Download nginx file
</span></span><span style="display:flex;"><span>  get_url: url={{ nginx_file_url }} dest={{ software_files_path }}
</span></span><span style="display:flex;"><span>  validate_certs=no
</span></span><span style="display:flex;"><span>  connection: local
</span></span><span style="display:flex;"><span>  when:，not. nginx_file_result.stat.exists
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]#cat stat.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: check file
</span></span><span style="display:flex;"><span>    stat: path=/data/mysql
</span></span><span style="display:flex;"><span>    register: st
</span></span><span style="display:flex;"><span>  - name: debug
</span></span><span style="display:flex;"><span>    debug:
</span></span><span style="display:flex;"><span>      msg: &#34;/data/mysql is not exist&#34;
</span></span><span style="display:flex;"><span>    when: not st.stat.exists
</span></span><span style="display:flex;"><span>[root@ansible ansible]#ansible-playbook stat.yml
</span></span><span style="display:flex;"><span>PLAY [websrvs]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>***************************************
</span></span><span style="display:flex;"><span>TASK [Gathering Facts]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7]
</span></span><span style="display:flex;"><span>ok: [10.0.0.8]
</span></span><span style="display:flex;"><span>TASK [check file]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>************************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7]
</span></span><span style="display:flex;"><span>ok: [10.0.0.8]
</span></span><span style="display:flex;"><span>TASK [debug]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*****************************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;/data/mysql is not exist&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [10.0.0.8] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;/data/mysql is not exist&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PLAY RECAP
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************************
</span></span><span style="display:flex;"><span>10.0.0.7 : ok=3 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span><span style="display:flex;"><span>10.0.0.8 : ok=3 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span></code></pre></div><h3 id="unarchive-模块">unarchive 模块<a hidden class="anchor" aria-hidden="true" href="#unarchive-模块">#</a></h3>
<p>功能：解包解压缩
实现有两种用法：</p>
<ul>
<li>将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置remote_src=no,此为默认值,可省略</li>
<li>将远程本主机上或非ansible的其它主机的某个压缩包解压缩到远程主机本机的指定路径下，需要设置remote_src=yes</li>
</ul>
<p>常见参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>remote_src #和copy功能一样且选项互斥，yes表示源文件在远程被控主机或其它非ansible的其它主机上，no表示文件在ansible主机上,默认值为no, 此选项代替copy选项
</span></span><span style="display:flex;"><span>copy #默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件,此选项已废弃
</span></span><span style="display:flex;"><span>src #源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置remote_src=yes
</span></span><span style="display:flex;"><span>dest #远程主机上的目标路径
</span></span><span style="display:flex;"><span>mode #设置解压缩后的文件权限
</span></span><span style="display:flex;"><span>creates=/path/file #当绝对路径/path/file不存在时才会执行
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible all -m unarchive -a &#39;src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible all -m unarchive -a &#39;src=/tmp/foo.zip dest=/data  mode=0777&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible all -m unarchive -a &#39;src=https://example.com/example.zip dest=/data &#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible websrvs -m unarchive -a &#39;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/ owner=root remote_src=yes&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible websrvs -m unarchive -a &#39;src=http://nginx.org/download/nginx- 1.18.0.tar.gz dest=/usr/local/src/ remote_src=yes&#39;&#39;
</span></span></code></pre></div><h3 id="archive-模块">Archive 模块<a hidden class="anchor" aria-hidden="true" href="#archive-模块">#</a></h3>
<p>功能：打包压缩保存在被管理节点</p>
<p>常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>path #压缩的文件或目录
</span></span><span style="display:flex;"><span>dest #压缩后的文件
</span></span><span style="display:flex;"><span>format #压缩格式,支持gz,bz2,xz,tar,zip
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible websrvs -m archive -a &#39;path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600&#39;
</span></span></code></pre></div><h3 id="hostname-模块">Hostname 模块<a hidden class="anchor" aria-hidden="true" href="#hostname-模块">#</a></h3>
<p>功能：管理主机名
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #修改后的主机名称
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible node1 -m hostname -a &#34;name=websrv&#34;
</span></span><span style="display:flex;"><span>ansible 10.0.0.18 -m hostname -a &#39;name=node18.wang.org&#39;
</span></span></code></pre></div><h3 id="cron-模块">Cron 模块<a hidden class="anchor" aria-hidden="true" href="#cron-模块">#</a></h3>
<p>功能：计划任务
支持时间：minute，hour，day，month，weekday
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #描述脚本的作用
</span></span><span style="display:flex;"><span>minute #分钟
</span></span><span style="display:flex;"><span>hour #小时
</span></span><span style="display:flex;"><span>weekday #周
</span></span><span style="display:flex;"><span>user #任务由哪个用户运行；默认root
</span></span><span style="display:flex;"><span>job #任务
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#备份数据库脚本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@centos8 ~<span style="color:#f92672">]</span><span style="color:#75715e">#cat /root/mysql_backup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>mysqldump -A -F --single-transaction --master-data<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -q -uroot |gzip &gt; /data/mysql_<span style="color:#e6db74">`</span>date +%F_%T<span style="color:#e6db74">`</span>.sql.gz
</span></span><span style="display:flex;"><span><span style="color:#75715e">#创建任务</span>
</span></span><span style="display:flex;"><span>ansible 10.0.0.8 -m cron -a <span style="color:#e6db74">&#39;hour=2 minute=30 weekday=1-5 name=&#34;backup mysql&#34; job=/root/mysql_backup.sh&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible websrvs -m cron -a <span style="color:#e6db74">&#34;minute=*/5 job=&#39;/usr/sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null&#39; name=Synctime&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#禁用计划任务</span>
</span></span><span style="display:flex;"><span>ansible websrvs -m cron -a <span style="color:#e6db74">&#34;minute=*/5 job=&#39;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#39; name=Synctime disabled=yes&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#启用计划任务</span>
</span></span><span style="display:flex;"><span>ansible websrvs -m cron -a <span style="color:#e6db74">&#34;minute=*/5 job=&#39;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt; /dev/null&#39; name=Synctime disabled=no&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#删除任务</span>
</span></span><span style="display:flex;"><span>ansible websrvs -m cron -a <span style="color:#e6db74">&#34;name=&#39;backup mysql&#39; state=absent&#34;</span>
</span></span><span style="display:flex;"><span>ansible websrvs -m cron -a <span style="color:#e6db74">&#39;state=absent name=Synctime&#39;</span>
</span></span></code></pre></div><h3 id="yum-和-apt-模块">Yum 和 Apt 模块<a hidden class="anchor" aria-hidden="true" href="#yum-和-apt-模块">#</a></h3>
<p>功能：管理软件包
yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本
apt 模块管理 Debian 相关版本的软件包
yum常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #软件包名称
</span></span><span style="display:flex;"><span>state #状态
</span></span><span style="display:flex;"><span>=present #安装,此为默认值
</span></span><span style="display:flex;"><span>=absent #删除
</span></span><span style="display:flex;"><span>=latest #最新版
</span></span><span style="display:flex;"><span>list #列出指定包
</span></span><span style="display:flex;"><span>enablerepo #启用哪个仓库安装
</span></span><span style="display:flex;"><span>disablerepo #不使用哪些仓库的包
</span></span><span style="display:flex;"><span>exclude #排除指定的包
</span></span><span style="display:flex;"><span>validate #是否检验,默认为yes
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=httpd state=present&#39;
</span></span><span style="display:flex;"><span>#安装zabbix agent rpm包
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#启用epel源进行安装
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=nginx state=present enablerepo=epel&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#升级除kernel和foo开头以外的所有包
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=* state=lastest exclude=kernel*,foo*&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#删除
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=httpd state=absent&#39;
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m yum -a &#39;name=sl,cowsay&#39;
</span></span></code></pre></div><h3 id="yum_repository-模块">yum_repository 模块<a hidden class="anchor" aria-hidden="true" href="#yum_repository-模块">#</a></h3>
<p>功能: 此模块实现yum的仓库配置管理
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #仓库id
</span></span><span style="display:flex;"><span>description #仓库描述名称,对应配置文件中的name=
</span></span><span style="display:flex;"><span>baseurl #仓库的地址
</span></span><span style="display:flex;"><span>gpgcheck #验证开启
</span></span><span style="display:flex;"><span>gpgkey #仓库公钥路径
</span></span><span style="display:flex;"><span>state=absen  #删除
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible websrvs -m yum_repository -a &#39;name=ansible_nginx description=&#34;nginx repo&#34; baseurl=&#34;http://nginx.org/packages/centos/$releasever/$basearch/&#34; gpgcheck=yes gpgkey=&#34;https://nginx.org/keys/nginx_signing.key&#34;&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@rocky8 ~]#cat /etc/yum.repos.d/ansible_nginx.repo
</span></span><span style="display:flex;"><span>[ansible_nginx]
</span></span><span style="display:flex;"><span>baseurl = http://nginx.org/packages/centos/$releasever/$basearch/
</span></span><span style="display:flex;"><span>gpgcheck = 1
</span></span><span style="display:flex;"><span>gpgkey = https://nginx.org/keys/nginx_signing.key
</span></span><span style="display:flex;"><span>name = nginx repo
</span></span></code></pre></div><h3 id="service-模块">Service 模块<a hidden class="anchor" aria-hidden="true" href="#service-模块">#</a></h3>
<p>此模块和sytemd功能相似,选项很多相同
功能：管理服务
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #服务名称
</span></span><span style="display:flex;"><span>state #服务状态
</span></span><span style="display:flex;"><span>=started #启动
</span></span><span style="display:flex;"><span>=stopped #停止
</span></span><span style="display:flex;"><span>=restarted #重启
</span></span><span style="display:flex;"><span>=reloaded #重载
</span></span><span style="display:flex;"><span>enabled #开启自启动
</span></span><span style="display:flex;"><span>daemon_reload #加载新的配置文件,适用于systemd模块
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible all -m service -a &#39;name=httpd state=started enabled=yes&#39;
</span></span><span style="display:flex;"><span>ansible all -m service -a &#39;name=httpd state=stopped&#39;
</span></span><span style="display:flex;"><span>ansible all -m service -a &#39;name=httpd state=reloaded&#39;
</span></span><span style="display:flex;"><span>ansible all -m shell -a &#34;sed -i &#39;s/^Listen 80/Listen 8080/&#39;
</span></span><span style="display:flex;"><span>/etc/httpd/conf/httpd.conf&#34;
</span></span><span style="display:flex;"><span>ansible all -m service -a &#39;name=httpd state=restarted&#39;
</span></span><span style="display:flex;"><span>#重启动指定网卡服务
</span></span><span style="display:flex;"><span>ansible all -m service -a &#39;name=network state=absent args=eth0&#39;
</span></span></code></pre></div><h3 id="user-模块">User 模块<a hidden class="anchor" aria-hidden="true" href="#user-模块">#</a></h3>
<p>功能：管理用户
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #创建的名称
</span></span><span style="display:flex;"><span>uid #指定uid
</span></span><span style="display:flex;"><span>group #指定基本组
</span></span><span style="display:flex;"><span>shell #登录shell类型默认/bin/bash
</span></span><span style="display:flex;"><span>create_home #是否创建家目录
</span></span><span style="display:flex;"><span>password #设定对应的密码，必须是加密后的字符串才行，否则不生效
</span></span><span style="display:flex;"><span>system #yes表示系统用户
</span></span><span style="display:flex;"><span>groups #附加组
</span></span><span style="display:flex;"><span>append #追加附加组使用,yes表示增加新的附加组
</span></span><span style="display:flex;"><span>state #absen删除
</span></span><span style="display:flex;"><span>remove #yes表示删除用户时将家目录一起删除
</span></span><span style="display:flex;"><span>generate_ssh_key #创建私钥
</span></span><span style="display:flex;"><span>ssh_keyu_bits #私钥位数
</span></span><span style="display:flex;"><span>ssh_key_file #私钥文件路径
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#创建用户
</span></span><span style="display:flex;"><span>ansible all -m user -a &#39;name=user1 comment=&#34;test user&#34; uid=2048 home=/app/user1group=root&#39;
</span></span><span style="display:flex;"><span>ansible all -m user -a &#39;name=nginx comment=nginx uid=88 group=nginxgroups=&#34;root,daemon&#34; shell=/sbin/nologin system=yes create_home=nohome=/data/nginx non_unique=yes&#39;
</span></span><span style="display:flex;"><span>#remove=yes表示删除用户及家目录等数据,默认remove=no
</span></span><span style="display:flex;"><span>ansible all -m user -a &#39;name=nginx state=absent remove=yes&#39;
</span></span><span style="display:flex;"><span>#生成123456加密的密码
</span></span><span style="display:flex;"><span>ansible localhost -m debug -a &#34;msg={{ &#39;123456&#39;| password_hash(&#39;sha512&#39;,&#39;salt&#39;)}}&#34; localhost | SUCCESS =&gt; { &#34;msg&#34;: &#34;$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>#用上面创建的密码创建用户
</span></span><span style="display:flex;"><span>ansible websrvs -m user -a &#39;name=www group=www system=yes shell=/sbin/nlogin password=&#34;$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.&#34;&#39;
</span></span><span style="display:flex;"><span>#创建用户test,并生成4096bit的私钥
</span></span><span style="display:flex;"><span>ansible websrvs -m user -a &#39;name=test generate_ssh_key=yes ssh_key_bits=4096 ssh_key_file=.ssh/id_rsa&#39;
</span></span></code></pre></div><h3 id="group-模块">Group 模块<a hidden class="anchor" aria-hidden="true" href="#group-模块">#</a></h3>
<p>功能：管理组
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #指定组名称
</span></span><span style="display:flex;"><span>gid #指定gid
</span></span><span style="display:flex;"><span>state
</span></span><span style="display:flex;"><span>=present #创建,默认
</span></span><span style="display:flex;"><span>=absent #删除
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#创建组
</span></span><span style="display:flex;"><span>ansible websrvs -m group -a &#39;name=nginx gid=88 system=yes&#39;
</span></span><span style="display:flex;"><span>#删除组
</span></span><span style="display:flex;"><span>ansible websrvs -m group -a &#39;name=nginx state=absent&#39;
</span></span></code></pre></div><h3 id="lineinfile-模块">Lineinfile 模块<a hidden class="anchor" aria-hidden="true" href="#lineinfile-模块">#</a></h3>
<p>ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时，
会存在问题，无法正常进行替换 。</p>
<p>ansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块
功能：相当于sed，主要用于修改一行的文件内容
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>path #被控端文件的路径
</span></span><span style="display:flex;"><span>regexp #正则匹配语法格式,表示被替换的内容
</span></span><span style="display:flex;"><span>line #替换为的内容
</span></span><span style="display:flex;"><span>state #absent表示删除
</span></span><span style="display:flex;"><span>insertafter #插入到替换内容前面,如和regexp同时存在,只在没找到与regexp匹配时才使用
</span></span><span style="display:flex;"><span>insertafter
</span></span><span style="display:flex;"><span>insertbefore #插入到替换内容后面,如和regexp同时存在,只在没找到与regexp匹配时才使用
</span></span><span style="display:flex;"><span>insertafter
</span></span><span style="display:flex;"><span>backrefs #支持后面引用,yes和no
</span></span><span style="display:flex;"><span>backup #修改前先备份
</span></span><span style="display:flex;"><span>create #如果文件不存在,则创建,默认不存在会出错
</span></span><span style="display:flex;"><span>mode #指定权限
</span></span><span style="display:flex;"><span>owner #指定用户
</span></span><span style="display:flex;"><span>group #指定组
</span></span><span style="display:flex;"><span>#注意
</span></span><span style="display:flex;"><span>regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被
</span></span><span style="display:flex;"><span>匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。
</span></span></code></pre></div><p>注意: 如果想进行多行匹配进行替换需要使用replace模块
范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#修改监听端口
</span></span><span style="display:flex;"><span>ansible websrvs -m lineinfile -a &#34;path=/etc/httpd/conf/httpd.conf regexp=&#39;^Listen&#39; line=&#39;Listen 8080&#39;&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#修改SELinux
</span></span><span style="display:flex;"><span>ansible all -m lineinfile -a &#34;path=/etc/selinux/config regexp=&#39;^SELINUX=&#39;line=&#39;SELINUX=disabled&#39;&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#添加网关
</span></span><span style="display:flex;"><span>ansible webservers -m lineinfile -a &#39;path=/etc/sysconfig/network-scripts/ifcfg-eth0 line=&#34;GATEWAY=10.0.0.254&#34;&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#给主机增加一个网关，但需要增加到NAME=下面
</span></span><span style="display:flex;"><span>ansible webservers -m lineinfile -a &#39;path=/etc/sysconfig/network-scripts/ifcfg-eth0 insertafter=&#34;^NAME=&#34; line=&#34;GATEWAY=10.0.0.254&#34;&#39;
</span></span><span style="display:flex;"><span>#效果如下
</span></span><span style="display:flex;"><span>cat /etc/sysconfig/network-scripts/ifcfg-eth0
</span></span><span style="display:flex;"><span>DEVICE=eth0
</span></span><span style="display:flex;"><span>NAME=eth0
</span></span><span style="display:flex;"><span>GATEWAY=10.0.0.254
</span></span><span style="display:flex;"><span>#给主机增加一个网关，但需要增加到NAME=上面
</span></span><span style="display:flex;"><span>ansible webservers -m lineinfile -a &#39;path=/etc/sysconfig/network-scripts/ifcfg-
</span></span><span style="display:flex;"><span>eth0 insertbefore=&#34;^NAME=&#34; line=&#34;GATEWAY=10.0.0.254&#34;&#39;
</span></span><span style="display:flex;"><span>#效果如下
</span></span><span style="display:flex;"><span>cat /etc/sysconfig/network-scripts/ifcfg-eth0
</span></span><span style="display:flex;"><span>DEVICE=eth0
</span></span><span style="display:flex;"><span>GATEWAY=10.0.0.254
</span></span><span style="display:flex;"><span>NAME=eth0
</span></span><span style="display:flex;"><span>#删除网关
</span></span><span style="display:flex;"><span>ansible webservers -m lineinfile -a &#39;path=/etc/sysconfig/network-scripts/ifcfg-eth0 regexp=&#34;^GATEWAY&#34; state=absent&#39;
</span></span><span style="display:flex;"><span>#删除#开头的行
</span></span><span style="display:flex;"><span>ansible all -m lineinfile -a &#39;dest=/etc/fstab state=absent regexp=&#34;^#&#34;&#39;
</span></span></code></pre></div><h3 id="replace-模块">Replace 模块<a hidden class="anchor" aria-hidden="true" href="#replace-模块">#</a></h3>
<p>该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用
功能: 多行修改替换
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>path #被控端文件的路径
</span></span><span style="display:flex;"><span>regexp #正则匹配语法格式,表示被替换的内容
</span></span><span style="display:flex;"><span>replace #替换为的内容
</span></span><span style="display:flex;"><span>after #插入到替换内容前面,
</span></span><span style="display:flex;"><span>before #插入到替换内容后面
</span></span><span style="display:flex;"><span>backup #修改前先备份
</span></span><span style="display:flex;"><span>mode #指定权限
</span></span><span style="display:flex;"><span>owner #指定用户
</span></span><span style="display:flex;"><span>group #指定组
</span></span></code></pre></div><p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible all -m replace -a &#34;path=/etc/fstab regexp=&#39;^(UUID.*)&#39; replace=&#39;#\1&#39;&#34;
</span></span><span style="display:flex;"><span>ansible all -m replace -a &#34;path=/etc/fstab regexp=&#39;^#(UUID.*)&#39; replace=&#39;\1&#39;&#34;
</span></span></code></pre></div><h3 id="selinux-模块">SELinux 模块<a hidden class="anchor" aria-hidden="true" href="#selinux-模块">#</a></h3>
<p>功能: 该模块管理 SELInux 策略
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>policy #指定SELINUXTYPE=targeted
</span></span><span style="display:flex;"><span>state #指定SELINUX=disabled
</span></span></code></pre></div><p>范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-v" data-lang="v"><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">rocky</span> <span style="color:#a6e22e">ansible</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">apps</span>]<span style="color:#f92672">#</span> ansible <span style="color:#ae81ff">192.168.32.132</span> <span style="color:#f92672">-</span>m selinux <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;state=disabled&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168.32.132</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">FAILED</span><span style="color:#f92672">!</span> <span style="color:#f92672">=</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> ansible<span style="color:#960050;background-color:#1e0010">版本</span><span style="color:#ae81ff">2.13.3</span><span style="color:#960050;background-color:#1e0010">出现如下错误</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">解决方法</span>
</span></span><span style="display:flex;"><span> [root<span style="color:#f92672">@</span>rocky ansible<span style="color:#f92672">-</span>apps]<span style="color:#f92672">#</span> ansible<span style="color:#f92672">-</span>galaxy collection install ansible.posix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">再次执行，显示成功</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">rocky</span> <span style="color:#a6e22e">ansible</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">apps</span>]<span style="color:#f92672">#</span> ansible <span style="color:#ae81ff">192.168.32.132</span> <span style="color:#f92672">-</span>m selinux <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;state=disabled&#39;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">WARNING</span>]: <span style="color:#a6e22e">SELinux</span> state temporarily changed from <span style="color:#e6db74">&#39;enforcing&#39;</span> to <span style="color:#e6db74">&#39;permissive&#39;</span>. <span style="color:#a6e22e">State</span> change will take effect next reboot.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168.32.132</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">CHANGED</span> <span style="color:#f92672">=</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;ansible_facts&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;discovered_interpreter_python&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/platform-python&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;changed&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;configfile&#34;</span>: <span style="color:#e6db74">&#34;/etc/selinux/config&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;Config SELinux state changed from &#39;enforcing&#39; to &#39;disabled&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;policy&#34;</span>: <span style="color:#e6db74">&#34;targeted&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;reboot_required&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;state&#34;</span>: <span style="color:#e6db74">&#34;disabled&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="reboot-模块">reboot 模块<a hidden class="anchor" aria-hidden="true" href="#reboot-模块">#</a></h3>
<p>功能: 重启
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>msg #重启提示
</span></span><span style="display:flex;"><span>pre_reboot_delay #重启前延迟时间的秒数
</span></span><span style="display:flex;"><span>post_reboot_delay #重启后延迟时间的秒数后,再验证系统正常启动
</span></span><span style="display:flex;"><span>reboot_timeout #重启后延迟时间再执行测试成功与否的命令
</span></span><span style="display:flex;"><span>test_command #执行测试成功与否的命令
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible websrvs -m reboot -a &#39;msg=&#34;host will be reboot&#34;&#39;
</span></span></code></pre></div><h3 id="mount-模块">mount 模块<a hidden class="anchor" aria-hidden="true" href="#mount-模块">#</a></h3>
<p>功能: 挂载和卸载文件系统
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>src #源设备路径，或网络地址
</span></span><span style="display:flex;"><span>path #挂载至本地哪个路径下
</span></span><span style="display:flex;"><span>fstype #设备类型； nfs
</span></span><span style="display:flex;"><span>opts #挂载的选项
</span></span><span style="display:flex;"><span>state #挂载还是卸载
</span></span><span style="display:flex;"><span>=present #永久挂载，但没有立即生效
</span></span><span style="display:flex;"><span>=absent #卸载临时挂载,并删除永久挂载
</span></span><span style="display:flex;"><span>=mounted #临时挂载
</span></span><span style="display:flex;"><span>=unmounted #临时卸载
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#修改fstab文件永久挂载,但不立即生效
</span></span><span style="display:flex;"><span>mount websrvs -m mount -a &#39;src=&#34;UUID=b3e48f45-f933-4c8e-a700-22a159ec9077&#34; path=/home fstype=xfs opts=noatime state=present&#39;
</span></span><span style="display:flex;"><span>#临时取消挂载
</span></span><span style="display:flex;"><span>mount websrvs -m mount -a &#39;path=/home fstype=xfs opts=noatime state=unmounted&#39;
</span></span><span style="display:flex;"><span>#永久挂载,并立即生效
</span></span><span style="display:flex;"><span>ansible websrvs -m mount -a &#39;src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads opts=&#34;_netdev&#34; state=mounted&#39;
</span></span><span style="display:flex;"><span>#永久卸载,并立即生效
</span></span><span style="display:flex;"><span>ansible websrvs -m mount -a &#39;src=10.0.0.8:/data/wordpress path=/var/www/html/wp- content/uploads state=absent&#39;
</span></span></code></pre></div><h3 id="setup-模块">Setup 模块<a hidden class="anchor" aria-hidden="true" href="#setup-模块">#</a></h3>
<p>功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机
较多，会影响执行速度
可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>filter #指定过滤条件
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible all -m setup
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_nodename&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_hostname&#34;  #  主机名称
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_domain&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_memtotal_mb&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_memory_mb&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_memfree_mb&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_os_family&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_distribution&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_distribution_major_version&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_distribution_version&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_processor_vcpus&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_all_ipv4_addresses&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_architecture&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_uptime_seconds&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#34;filter=ansible_processor*&#34;
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#39;filter=ansible_env&#39;
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible all -m setup -a &#39;filter=ansible_python_version&#39;
</span></span><span style="display:flex;"><span>10.0.0.7 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;ansible_python_version&#34;: &#34;2.7.5&#34;,
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>10.0.0.6 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;ansible_python_version&#34;: &#34;2.6.6&#34;,
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>10.0.0.8 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;ansible_python_version&#34;: &#34;3.6.8&#34;,
</span></span><span style="display:flex;"><span>&#34;discovered_interpreter_python&#34;: &#34;/usr/libexec/platform-python&#34;
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>[root@ansible ~]#
</span></span></code></pre></div><p>范例：取IP地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#取所有IP
</span></span><span style="display:flex;"><span>ansible 10.0.0.101 -m setup -a &#39;filter=ansible_all_ipv4_addresses&#39;
</span></span><span style="display:flex;"><span>10.0.0.101 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;ansible_all_ipv4_addresses&#34;: [
</span></span><span style="display:flex;"><span>&#34;192.168.0.1&#34;,
</span></span><span style="display:flex;"><span>&#34;192.168.0.2&#34;,
</span></span><span style="display:flex;"><span>&#34;192.168.64.238&#34;,
</span></span><span style="display:flex;"><span>&#34;192.168.13.36&#34;,
</span></span><span style="display:flex;"><span>&#34;10.0.0.101&#34;,
</span></span><span style="display:flex;"><span>&#34;172.16.1.0&#34;,
</span></span><span style="display:flex;"><span>&#34;172.17.0.1&#34;
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>#取默认IP
</span></span><span style="display:flex;"><span>ansible all -m setup -a &#39;filter=&#34;ansible_default_ipv4&#34;&#39;
</span></span><span style="display:flex;"><span>10.0.0.101 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>&#34;ansible_default_ipv4&#34;: {
</span></span><span style="display:flex;"><span>&#34;address&#34;: &#34;10.0.0.101&#34;,
</span></span><span style="display:flex;"><span>&#34;alias&#34;: &#34;eth0&#34;,
</span></span><span style="display:flex;"><span>&#34;broadcast&#34;: &#34;10.0.0.255&#34;,
</span></span><span style="display:flex;"><span>&#34;gateway&#34;: &#34;10.0.0.2&#34;,
</span></span><span style="display:flex;"><span>&#34;interface&#34;: &#34;eth0&#34;,
</span></span><span style="display:flex;"><span>&#34;macaddress&#34;: &#34;00:0c:29:e8:c7:9b&#34;,
</span></span><span style="display:flex;"><span>&#34;mtu&#34;: 1500,
</span></span><span style="display:flex;"><span>&#34;netmask&#34;: &#34;255.255.255.0&#34;,
</span></span><span style="display:flex;"><span>&#34;network&#34;: &#34;10.0.0.0&#34;,
</span></span><span style="display:flex;"><span>&#34;type&#34;: &#34;ether&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>&#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="debug-模块">debug 模块<a hidden class="anchor" aria-hidden="true" href="#debug-模块">#</a></h3>
<p>功能: 此模块可以用于输出信息,并且通过 msg 定制输出的信息内容,功能类似于echo命令
注意: msg后面的变量有时需要加 &quot; &quot; 引起来
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>msg #指定命令输出的信息
</span></span><span style="display:flex;"><span>var #指定变量名,和msg互斥
</span></span><span style="display:flex;"><span>verbosity #详细度
</span></span></code></pre></div><p>范例: debug 模块默认输出Hello world</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#ansible 10.0.0.18 -m debug
</span></span><span style="display:flex;"><span>10.0.0.18 | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;Hello world!&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat debug.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>tasks:
</span></span><span style="display:flex;"><span>- name: output Hello world
</span></span><span style="display:flex;"><span>debug:
</span></span><span style="display:flex;"><span>#默认没有指定msg,默认输出&#34;Hello world!&#34;
</span></span><span style="display:flex;"><span>[root@ansible ansible]#ansible-playbook debug.yml
</span></span><span style="display:flex;"><span>.....
</span></span><span style="display:flex;"><span>TASK [output variables]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>******************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;Hello world!&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [10.0.0.8] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;Hello world!&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PLAY RECAP
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************************
</span></span><span style="display:flex;"><span>10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span><span style="display:flex;"><span>10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span></code></pre></div><p>范例: 利用debug 模块输出变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@centos8 ~]#cat debug.yaml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>tasks:
</span></span><span style="display:flex;"><span>- name: output variables
</span></span><span style="display:flex;"><span>debug:
</span></span><span style="display:flex;"><span>msg: Host &#34;{{ ansible_nodename }}&#34; Ip &#34;{{ ansible_default_ipv4.address
</span></span><span style="display:flex;"><span>}}&#34;
</span></span><span style="display:flex;"><span>[root@centos8 ~]#ansible-playbook debug.yaml
</span></span><span style="display:flex;"><span>PLAY [websrvs]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>***************************************
</span></span><span style="display:flex;"><span>TASK [Gathering Facts]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7]
</span></span><span style="display:flex;"><span>ok: [10.0.0.8]
</span></span><span style="display:flex;"><span>TASK [output variables]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>******************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;Host \&#34;centos7.wangxiaochun.com\&#34; Ip \&#34;10.0.0.7\&#34;&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [10.0.0.8] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;Host \&#34;centos8.wangxiaochun.com\&#34; Ip \&#34;10.0.0.8\&#34;&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PLAY RECAP
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************************
</span></span><span style="display:flex;"><span>10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span><span style="display:flex;"><span>10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span></code></pre></div><p>范例: 显示字符串特定字符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># cat debug.yml
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    a: &#34;12345&#34;
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - debug:
</span></span><span style="display:flex;"><span>    msg:
</span></span><span style="display:flex;"><span>      - &#34;{{a[0]}}&#34;
</span></span><span style="display:flex;"><span>      - &#34;{{a[1]}}&#34;
</span></span><span style="display:flex;"><span>      - &#34;{{a[2]}}&#34;
</span></span><span style="display:flex;"><span>#定义了一个字符串变量a，如果想要获取a字符串的第3个字符，则可以使用”a[2]”获取，索引从0开始，执行上例playbook，debug的输出信息如下：
</span></span><span style="display:flex;"><span>TASK [debug] *************************
</span></span><span style="display:flex;"><span>ok: [test1] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;1&#34;
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;2&#34;
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;3&#34;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="sysctl-模块">sysctl 模块<a hidden class="anchor" aria-hidden="true" href="#sysctl-模块">#</a></h3>
<p>功能: 修改内核参数
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name #内核参数
</span></span><span style="display:flex;"><span>value #指定值
</span></span><span style="display:flex;"><span>state #是否保存在sysctl.conf文件中,默认present
</span></span><span style="display:flex;"><span>sysctl_set #使用sysctl -w 验证值生效
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible websrvs -m sysctl -a &#39;name=net.ipv4.ip_forward value=1 state=present&#39;
</span></span></code></pre></div><p>范例: 内核参数优化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- name: Change Port Range
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.ip_local_port_range
</span></span><span style="display:flex;"><span>	value: &#39;1024 65000&#39;
</span></span><span style="display:flex;"><span>	sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Enabled Forward
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>	name: net.ipv4.ip_forward
</span></span><span style="display:flex;"><span>	value: &#39;1&#39;
</span></span><span style="display:flex;"><span>	sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Enabled tcp_reuse
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_tw_reuse
</span></span><span style="display:flex;"><span>    value: &#39;1&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Chanage tcp tw_buckets
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_max_tw_buckets
</span></span><span style="display:flex;"><span>    value: &#39;5000&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Chanage tcp_syncookies
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_syncookies
</span></span><span style="display:flex;"><span>    value: &#39;1&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Chanage tcp max_syn_backlog
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_max_syn_backlog
</span></span><span style="display:flex;"><span>    value: &#39;8192&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>- name: Chanage tcp Established Maxconn
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.core.somaxconn
</span></span><span style="display:flex;"><span>    value: &#39;32768&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>- name: Chanage tcp_syn_retries
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_syn_retries
</span></span><span style="display:flex;"><span>    value: &#39;2&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>- name: Chanage net.ipv4.tcp_synack_retries
</span></span><span style="display:flex;"><span>  sysctl:
</span></span><span style="display:flex;"><span>    name: net.ipv4.tcp_synack_retries
</span></span><span style="display:flex;"><span>    value: &#39;2&#39;
</span></span><span style="display:flex;"><span>    sysctl_set: yes
</span></span><span style="display:flex;"><span>    state: presen
</span></span></code></pre></div><h3 id="pam_limits">pam_limits<a hidden class="anchor" aria-hidden="true" href="#pam_limits">#</a></h3>
<p>功能: 管理资源限制
范例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- name: Change Limit /etc/security/limit.conf
</span></span><span style="display:flex;"><span>  pam_limits:
</span></span><span style="display:flex;"><span>  domain: &#34;*&#34;
</span></span><span style="display:flex;"><span>    limit_type: &#34;{{ item.limit_type }}&#34;
</span></span><span style="display:flex;"><span>    limit_item: &#34;{{ item.limit_item }}&#34;
</span></span><span style="display:flex;"><span>    value: &#34;{{ item.value }}&#34;
</span></span><span style="display:flex;"><span>  loop:
</span></span><span style="display:flex;"><span>    - { limit_type: &#39;soft&#39;, limit_item: &#39;nofile&#39;,value: &#39;100000&#39; }
</span></span><span style="display:flex;"><span>    - { limit_type: &#39;hard&#39;, limit_item: &#39;nofile&#39;,value: &#39;10000&#39; }
</span></span></code></pre></div><h3 id="apt_repository-模块">apt_repository 模块<a hidden class="anchor" aria-hidden="true" href="#apt_repository-模块">#</a></h3>
<p>功能: 此模块实现apt的仓库配置管理
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>repo #仓库信息
</span></span><span style="display:flex;"><span>state #添加或删除
</span></span><span style="display:flex;"><span>update_cache #是否apt update,默认yes
</span></span><span style="display:flex;"><span>filename #仓库文件,默认放在/etc/apt/sources.list.d/file.list
</span></span></code></pre></div><p>范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible ubuntu-servers -m apt_repository -a &#39;repo=&#34;deb
</span></span><span style="display:flex;"><span>http://archive.canonical.com/ubuntu focal partner&#34; filename=google-chrome&#39;
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/google-chrome.list
</span></span><span style="display:flex;"><span>deb http://archive.canonical.com/ubuntu focal partner
</span></span></code></pre></div><h3 id="apt_key-模块">apt_key 模块<a hidden class="anchor" aria-hidden="true" href="#apt_key-模块">#</a></h3>
<p>功能: 添加和删除apt key
常见选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>url #key路径
</span></span><span style="display:flex;"><span>state #添加或删除
</span></span></code></pre></div><p>范例: 生成ceph仓库配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#先导入key,注意先后顺序
</span></span><span style="display:flex;"><span>ansible ubuntu-servers -m apt_key -a
</span></span><span style="display:flex;"><span>&#39;url=https://download.ceph.com/keys/release.asc state=present&#39;
</span></span><span style="display:flex;"><span>#再生成apt配置,如果不导入key此步会出错
</span></span><span style="display:flex;"><span>ansible ubuntu-servers -m apt_repository -a &#39;repo=&#34;deb
</span></span><span style="display:flex;"><span>http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main&#34;
</span></span><span style="display:flex;"><span>filename=ansible_ceph&#39;
</span></span><span style="display:flex;"><span>#验证结果
</span></span><span style="display:flex;"><span>[root@ubuntu2004 ~]#cat /etc/apt/sources.list.d/ansible_ceph.list
</span></span><span style="display:flex;"><span>deb http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main
</span></span></code></pre></div><h3 id="其它模块">其它模块<a hidden class="anchor" aria-hidden="true" href="#其它模块">#</a></h3>
<p>ansible 还提供了很多针对各种应用的模块,比如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>nginx_status_info
</span></span><span style="display:flex;"><span>nginx_status_facts
</span></span><span style="display:flex;"><span>mysql_db #需要安装MySQL-python包
</span></span><span style="display:flex;"><span>mysql_user #需要安装MySQL-python包
</span></span><span style="display:flex;"><span>redis
</span></span><span style="display:flex;"><span>mongodb*
</span></span><span style="display:flex;"><span>postgresql*
</span></span><span style="display:flex;"><span>haproxy
</span></span><span style="display:flex;"><span>git
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="http://hugo.itshare.work/" style="color:#939393;">Cookie</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
