<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>运维自动化工具Ansible(二) | Cookie</title>
<meta name="keywords" content="Ansible">
<meta name="description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗.">
<meta name="author" content="Cookie">
<link rel="canonical" href="http://hugo.itshare.work/posts/ansible/ansible2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.80f8b5fe8f64ae88f63a1d81f24ff3f7ed23569f1f34a841f23efea95bfb1711.css" integrity="sha256-gPi1/o9kroj2Oh2B8k/z9&#43;0jVp8fNKhB8j7&#43;qVv7FxE=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://hugo.itshare.work/img/Q.gif">
<link rel="apple-touch-icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="mask-icon" href="http://hugo.itshare.work/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="运维自动化工具Ansible(二)" />
<meta property="og:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hugo.itshare.work/posts/ansible/ansible2/" />
<meta property="og:image" content="http://oss.itshare.work/itshare-work-images/3.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T19:12:21+00:00" />
<meta property="article:modified_time" content="2023-02-25T19:12:21+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://oss.itshare.work/itshare-work-images/3.jpg" />
<meta name="twitter:title" content="运维自动化工具Ansible(二)"/>
<meta name="twitter:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "http://hugo.itshare.work/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "📕 Ansible",
          "item": "http://hugo.itshare.work/posts/ansible/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "运维自动化工具Ansible(二)",
      "item": "http://hugo.itshare.work/posts/ansible/ansible2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "运维自动化工具Ansible(二)",
  "name": "运维自动化工具Ansible(二)",
  "description": "Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗.",
  "keywords": [
    "Ansible"
  ],
  "articleBody": "Playbook playbook介绍 官方链接\nhttps://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html Playbook 组成 一个 playbook(剧本)文件是一个YAML语言编写的文本文件 通常一个playbook只包括一个play 一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。 一个tasks中可以有一个或多个task任务 每一个Task本质上就是调用ansible的一个module 在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务 Playbook 与 Ad-Hoc 对比 Playbook是对多个 AD-Hoc 的一种编排组合的实现方式 Playbook能控制任务执行的先后顺序 Playbook可以持久保存到文件中从而方便多次调用运行，而Ad-Hoc只能临时运行。 Playbook适合复杂的重复性的任务，而Ad-Hoc适合做快速简单的一次性任务 YAML 语言 YAML 语言介绍 YAML：YAML Ain’t Markup Language，即YAML不是标记语言。不过，在开发的这种语言时，YAML的 意思其实是：“Yet Another Markup Language”（仍是一种标记语言） YAML是一个可读性高的用来表达资料序列的格式。 YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。 Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者 目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等 YAML 官方网站：\nhttp://www.yaml.org ansible 官网:\nhttps://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html ###　YAML 语言特性\nYAML的可读性好 YAML和脚本语言的交互性好 YAML使用实现语言的数据类型 YAML有一个一致的信息模型 YAML易于实现 YAML可以基于流来处理 YAML表达能力强，扩展性好 YAML语法简介 在单一文件第一行，用连续三个连字号\"-\" 开始，还有选择性的连续三个点号( … )用来表示文件结尾 次行开始正常写Playbook的内容，一般建议写明该Playbook的功能 使用#号注释代码 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结行来实现的 缩进不支持tab,必须使用空格进行缩进 缩进的空格数不重要，只要相同层级的元素左对齐即可 YAML文件内容是区别大小写的，key/value的值均需大小写敏感 多个key/value可同行写也可换行写，同行使用，分隔 key后面冒号要加一个空格 比如: key: value value可是个字符串，也可是另一个列表 YAML文件扩展名通常为yml或yaml 支持的数据类型 YAML 支持以下常用几种数据类型：\n标量：单个的、不可再分的值 对象：键值对的集合，又称为: 字典（dictionary）/ 哈希（hashes） / 映射（mapping） 数组：一组按次序排列的值，又称为: 列表（list）/ 序列（sequence） scalar 标量 key对应value\nname: wang age: 18 使用缩进的方式\nname: wang age: 18 标量是最基本的，不可再分的值，包括：\n字符串 布尔值 整数 浮点数 Null 时间 日期 ####　Dictionary 字典 一个字典是由一个或多个key与value构成 key和value之间用冒号 ：分隔 冒号 : 后面有一个空格 所有 k/v 可以放在一行，,每个 k/v 之间用逗号分隔 所有每个 k/v 也可以分别放在不同行,一对k/v放在独立的一行 格式\naccount: { name: wang, age: 30 } 使用缩进方式\naccount: name: wang age: 18 范例：\n#不同行 # An employee record name: Example Developer job: Developer skill: Elite(社会精英) #同一行,也可以将key:value放置于{}中进行表示，用,分隔多个key:value # An employee record {name: \"Example Developer\", job: \"Developer\", skill: \"Elite\"} List 列表 列表由多个元素组成 每个元素放在不同行，每个元素一行,且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格 也可以将所有元素用 [ ] 括起来放在同一行,每个元素之间用逗号分隔 格式\ncourse: [ linux , golang , python ] 也可以写成以 - 开头的多行\ncourse: - linux - golang - python course: - linux: manjaro - golang: gin - python: django 范例：\n#不同行,行以-开头,后面有一个空格 # A list of tasty fruits - Apple - Orange - Strawberry - Mango #同一行 [Apple,Orange,Strawberry,Mango] 范例：YAML 表示一个家庭\nname: John Smith age: 41 gender: Male spouse: { name: Jane Smith, age: 37, gender: Female } # 写在一行里 name: Jane Smith #也可以写成多行 age: 37 gender: Female children: [ {name: Jimmy Smith,age: 17, gender: Male}, {name: Jenny Smith, age:13, gender: Female}, {name: hao Smith, age: 20, gender: Male } ] #写在一行 - name: Jimmy Smith #写在多行,更为推荐的写法 age: 17 gender: Male - {name: Jenny Smith, age: 13, gender: Female} - {name: hao Smith, age: 20, gender: Male } 三种常见的数据格式 XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置 JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释 YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab 可以用工具互相转换，参考网站： https://www.json2yaml.com/ http://www.bejson.com/json/json2yaml/\nPlaybook 核心组件 官方文档\nhttps://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#playbook-keywords 一个playbook 中由多个组件组成,其中所用到的常见组件类型如下:\nHosts 执行的远程主机列表 Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需少元素需包括 name 和 task,一个name只能包括一个task Variables 内置变量或自定义变量在playbook中调用 Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件 Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行 tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此 会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断 hosts 组件 Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中\none.example.com one.example.com:two.example.com 192.168.1.50 192.168.1.* Websrvs:dbsrvs #或者，两个组的并集 Websrvs:\u0026dbsrvs #与，两个组的交集 webservers:!dbsrvs #在websrvs组，但不在dbsrvs组 案例：\n- hosts: websrvs:appsrvs remote_user 组件 remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户\n- hosts: websrvs remote_user: root tasks: - name: test connection ping: remote_user: magedu sudo: yes #默认sudo为root sudo_user:wang #sudo为wang task列表和action组件 play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致 每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。 如果未提供name，则action的结果将用于输出 task两种格式：\naction: module arguments #示例: action: shell wall hello module: arguments #建议使用 #示例: shell: wall hello 注意：shell和command模块后面跟命令，而非key=value 范例:\n[root@ansible ansible]#cat hello.yml --- #first yaml文件 # - hosts: websrvs remote_user: root gather_facts: no tasks: - name: task1 debug: msg=\"task1 running\" - name: task2 debug: msg=\"task2 running\" - hosts: appsrvs remote_user: root gather_facts: no tasks: - name: task3 debug: msg=\"task3 running\" - name: task4 debug: msg=\"task4 running\" 其它组件说明 某任务的状态在运行后为changed时，可通过\"notify\"通知给相应的handlers任务 还可以通过\"tags\"给task 打标签，可在ansible-playbook命令上使用-t指定进行调用\nShellScripts VS Playbook 案例 #SHELL脚本实现 #!/bin/bash # 安装Apache yum install --quiet -y httpd # 复制配置文件 cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf cp/tmp/vhosts.conf /etc/httpd/conf.d/ # 启动Apache，并设置开机启动 systemctl enable --now httpd #Playbook实现 --- - hosts: websrvs remote_user: root gather_facts: no tasks: - name: \"安装Apache\" yum: name=httpd - name: \"复制配置文件\" copy: src=/tmp/httpd.conf dest=/etc/httpd/conf/ - name: \"复制配置文件\" copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/ - name: \"启动Apache，并设置开机启动\" service: name=httpd state=started enabled=yes playbook 命令 格式\nansible-playbook ... [options] 选项\n--syntax,--syntax-check #语法检查,功能相当于bash -n -C --check #模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作 --list-hosts #列出运行任务的主机 --list-tags #列出tag --list-tasks #列出task --limit 主机列表 #只针对主机列表中的特定主机执行 -i INVENTORY, --inventory INVENTORY #指定主机清单文件,通常一个项对应一个主机清单文件 --start-at-task START_AT_TASK #从指定task开始执行,而非从头开始,START_AT_TASK为任务的name -v -vv -vvv #显示过程 范例: 一个简单的 playbook\n[root@ansible ansible]#cat hello.yml --- - hosts: websrvs tasks: - name: hello command: echo \"hello ansible\" [root@ansible ansible]#ansible-playbook hello.yml [root@ansible ansible]#ansible-playbook -v hello.yml 范例: 检查和限制主机\nansible-playbook file.yml --check #只检测 ansible-playbook file.yml ansible-playbook file.yml --limit websrvs 范例: 一个playbook 多个play\ncat test_plays.yaml --- - hosts: localhost remote_user: root gather_facts: no tasks: - name: play1 command: echo \"play1\" - hosts: centos7 remote_user: root gather_facts: no tasks: - name: play2 command: echo \"play2\" 忽略错误 ignore_errors 如果一个task出错,默认将不会继续执行后续的其它task 利用 ignore_errors: yes 可以忽略此task的错误,继续向下执行playbook其它task\n[root@ansible ansible]#cat test_ignore.yml --- - hosts: centos7 tasks: - name: error command: /bin/false ignore_errors: yes - name: continue command: wall continue ansible-playbook案例 安装nginx --- - hosts: centos7 # yum install nginx remote_user: root gather_facts: no tasks: - name: install nginx yum: name=nginx state=present - name: service: name=nginx state=started enabled=yes 卸载httpd #remove_httpd.yml --- - hosts: webservers remote_user: root gather_facts: no tasks: - name: remove httpd package yum: name=httpd state=absent - name: remove apache user user: name=apache state=absent - name: remove config file file: name=/etc/httpd state=absent - name: remove web html file: name=/data/html/ state=absent Playbook中使用handlers和notify handlers和notify Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。 Notify对应的action 在所有task都执行完才会最后被触发，这样可避免多个task多次改变发生时每次都触发执行指定的操作，Handlers仅在所有的变化发生完成后一次性地执行指定操作。 在notify中列出的操作称为handler，也即notify中调用handler中定义的操作 注意:\n如果多个task通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。 只有notify对应的task发生改变了才会通知handlers， 没有改变则不会触发handlers handlers 是在所有前面的tasks都成功执行才会执行,如果前面任何一个task失败,会导致handle跳过执行 案例:\n案例：\n案例：\n范例: 部署haproxy\nforce_handlers 如果不论前面的task成功与否,都希望handlers能执行, 可以使用force_handlers: yes 强制执行handler 范例: 强制调用handlers\nPlaybook中使用tags组件 官方文档:\nhttps://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html 默认情况下， Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务，在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件 可以一个task对应多个tag,也可以多个task对应同一个tag 还有另外3个特殊关键字用于标签, tagged, untagged 和 all,它们分别是仅运行已标记，只有未标记和所有任务。 tags 主要用于调试环境 范例： tag 标签\nPlaybook中使用变量 Playbook中同样也支持变量 变量名：仅能由字母、数字和下划线组成，且只能以字母开头 变量定义：\nvariable=value variable: value 范例：\nhttp_port=80 http_port: 80 通过 {{ variable_name }} 调用变量，且变量名前后建议加空格，有时用\"{{ variable_name }}“才生效 变量来源：\nansible 的 setup facts 远程主机的所有变量都可直接调用 通过命令行指定变量，优先级最高 ansible-playbook -e varname=value test.yml 3.在playbook文件中定义\nvars: var1: value1 var2: value2 4.在独立的变量YAML文件中定义\n- hosts: all vars_files: - vars.yml 在主机清单文件中定义 主机（普通）变量：主机组中主机单独定义，优先级高于公共变量 组（公共）变量：针对主机组中所有主机定义统一变量 在项目中针对主机和主机组定义 在项目目录中创建 host_vars和group_vars目录 在role中定义 变量的优先级从高到低如下\n-e 选项定义变量 --\u003eplaybook中vars_files --\u003e playbook中vars变量定义 --\u003ehost_vars/主机名文件 --\u003e主机清单中主机变量--\u003e group_vars/主机组名文件--\u003egroup_vars/all文件--\u003e 主机清单组变量 使用 setup 模块中变量 使用 facts 变量 本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中 facts 包括的信息很多,如: 主机名,IP,CPU,内存,网卡等 facts 变量的实际使用场景案例\n通过facts变量获取被控端CPU的个数信息,从而生成不同的Nginx配置文件 通过facts变量获取被控端内存大小信息,从而生成不同的memcached的配置文件 通过facts变量获取被控端主机名称信息,从而生成不同的Zabbix配置文件 通过facts变量获取被控端网卡信息,从而生成不同的主机名 案例：使用setup变量\n[root@ansible ~]# ansible localhost -m setup -a 'filter=\"ansible_default_ipv4\"' localhost | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_default_ipv4\": { \"address\": \"192.168.32.133\", \"alias\": \"ens160\", \"broadcast\": \"192.168.32.255\", \"gateway\": \"192.168.32.2\", \"interface\": \"ens160\", \"macaddress\": \"00:0c:29:7c:80:cd\", \"mtu\": 1500, \"netmask\": \"255.255.255.0\", \"network\": \"192.168.32.0\", \"prefix\": \"24\", \"type\": \"ether\" } }, \"changed\": false } [root@ansible ~]# 范例：显示ens33的网卡的IP地址\n--- - hosts: centos7 tasks: - name: show ens33 ip debug: msg: IP address {{ ansible_ens33.ipv4.address }} #msg: IP address {{ ansible_facts[\"ens33\"][\"ipv4\"][\"address\"] }} #msg: IP address {{ ansible_facts.ens33.ipv4.address }} #msg: IP address {{ ansible_default_ipv4.address }} #msg: IP address {{ ansible_ens33.ipv4.address }} #msg: IP address {{ ansible_ens33.ipv4.address.split('.')[-1] }} #取IP中的最后一个数字 [root@ansible ansible]# ansible-playbook -v show_ip.yml Using /etc/ansible/ansible.cfg as config file PLAY [centos7] ************************************************************************************************************************* TASK [Gathering Facts] ***************************************************************************************************************** ok: [192.168.32.179] ok: [192.168.32.178] TASK [show ens33 ip] ******************************************************************************************************************* ok: [192.168.32.178] =\u003e { \"msg\": \"IP address 192.168.32.178\" } ok: [192.168.32.179] =\u003e { \"msg\": \"IP address 192.168.32.179\" } PLAY RECAP ***************************************************************************************************************************** 192.168.32.178 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.32.179 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 [root@ansible ansible]# 范例：修改主机名称为web-IP\n- hosts: centos7 tasks: - name: 打印facts变量 debug: msg={{ ansible_ens33.ipv4.address }} - name: 修改主机名 hostname: name=web-{{ ansible_ens33.ipv4.address }} #- name: 获取facts变量提取IP地址，以.结尾的最后一列,修改主机名为web-hostid #hostname: name=web-{{ ansible_ens33.ipv4.address.split('.')[-1] }} [root@ansible ansible]# ansible-playbook change_hostname.yml PLAY [centos7] ************************************************************************************************************************* TASK [Gathering Facts] ***************************************************************************************************************** ok: [192.168.32.178] ok: [192.168.32.179] TASK [打印facts变量] ******************************************************************************************************************* ok: [192.168.32.178] =\u003e { \"msg\": \"192.168.32.178\" } ok: [192.168.32.179] =\u003e { \"msg\": \"192.168.32.179\" } TASK [修改主机名] ********************************************************************************************************************** changed: [192.168.32.179] changed: [192.168.32.178] PLAY RECAP ***************************************************************************************************************************** 192.168.32.178 : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 192.168.32.179 : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 [root@ansible ansible]# ####　性能优化\n每次执行playbook,默认会收集每个主机的所有facts变量,将会导致速度很慢,可以采用下面方法加速 方法1 关闭facts采集加速执行,此方法将导致无法使用facts变量\n- hosts: all gather_facts: no 方法2 当使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置facts 的缓存,将facts变量信息存在redis服务器中\n[root@ansible ~]# cat /etc/ansible/ansible.cfg [defaults] # smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts # implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False # explicit 则表示默认不收集，要显式收集，必须使用gather_facts: True gathering = smart #在使用 facts 缓存时设置为smart fact_caching_timeout = 86400 #缓存时长 fact_caching = redis #缓存存在redis中 fact_caching_connection = 10.0.0.100:6379:0 #0表示redis的0号数据库 #若redis设置了密码 fact_caching_connection = 10.0.0.100:6379:0:password register 注册变量 在playbook中可以使用register将捕获命令的输出保存在临时变量中，方便后续调用此变量,比如可以使用debug模块进行显示输出 范例: 利用debug 模块输出变量\n--- - hosts: centos7 tasks: - name: get variable shell: hostname register: name - name: print variable debug: msg: \"{{ name }}\" #输出register注册的name变量的全部信息,注意变量要加\" \"引起来 #msg: \"{{ name.cmd }}\" #显示命令 #msg: \"{{ name.rc }}\" #显示命令成功与否 #msg: \"{{ name.stdout }}\" #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出 #msg: \"{{ name.stdout_lines }}\" #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示 #msg: \"{{ name['stdout_lines'] }}\" #显示命令的执行结果为列表形式,和效果上面相同 #msg: \"{{ name.stdout_lines[0] }}\" #显示命令的输出结果的列表中的第一个元素 #说明 第一个 task 中，使用了 register 注册变量名为 name ；当 shell 模块执行完毕后，会将数据放到该变量中。第二给 task 中，使用了 debug 模块，并从变量name中获取数据。 [root@ansible ansible]# ansible-playbook -C register.yml PLAY [centos7] ************************************************************************************************************************* TASK [Gathering Facts] ***************************************************************************************************************** ok: [192.168.32.179] ok: [192.168.32.178] TASK [get variable] ******************************************************************************************************************** skipping: [192.168.32.179] skipping: [192.168.32.178] TASK [print variable] ****************************************************************************************************************** ok: [192.168.32.178] =\u003e { \"msg\": { \"changed\": false, \"cmd\": \"hostname\", \"delta\": null, \"end\": null, \"failed\": false, \"msg\": \"Command would have run if not in check mode\", \"rc\": 0, \"skipped\": true, \"start\": null, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": [] } } ok: [192.168.32.179] =\u003e { \"msg\": { \"changed\": false, \"cmd\": \"hostname\", \"delta\": null, \"end\": null, \"failed\": false, \"msg\": \"Command would have run if not in check mode\", \"rc\": 0, \"skipped\": true, \"start\": null, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": [] } } PLAY RECAP ***************************************************************************************************************************** 192.168.32.178 : ok=2 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 192.168.32.179 : ok=2 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 [root@ansible ansible]# 范例: 安装启动服务并检查\n--- - hosts: centos7 vars: package_name: nginx service_name: nginx tasks: - name: install {{ package_name }} yum: name={{ package_name }} - name: start {{ service_name }} service: name={{ service_name }} state=started enabled=yes - name: check shell: ps axu|grep {{ service_name }} register: check_service - name: debug debug: msg: \"{{ check_service.stdout_lines }}\" 范例: 修改主机名形式为 web_\u003c随机字符\u003e\n- hosts: centos7 tasks: - name: genarate random shell: cmd: openssl rand -base64 12 |tr -dc '[:alnum:]' register: num - name: show random debug: msg: \"{{ num }}\" - name: change hostname hostname: name: web-{{ num.stdout }} 范例: 修改主机名形式为 web_随机数\n- hosts: centos7 tasks: - name: 定义一个随机数，设定为变量，然后后续调用 shell: echo $((RANDOM%255)) register: web_number - name: 使用debug输出变量结果 debug: msg={{ web_number }} - name: 使用hostname模块将主机名修改为web_随机数 hostname: name=web_{{ web_number.stdout }} 范例: 批量修改主机名为随机字符\n- hosts: centos7 vars: host: web domain: wang.org tasks: - name: get variable shell: echo $RANDOM | md5sum | cut -c 1-8 register: get_random - name: print variable debug: msg: \"{{ get_random.stdout }}\" - name: set hostname hostname: name={{ host }}-{{ get_random.stdout }}.{{ domain }} 范例: 批量修改主机名为IP最后1位数字\n- hosts: centos7 vars: host: web domain: wang.org tasks: - name: get variable shell: hostname -I | awk '{print $1}' register: get_ip - name: print variable debug: msg: \"{{ get_ip.stdout.split('.')[3] }}\" - name: set hostname hostname: name={{ host }}-{{ get_ip.stdout.split('.')[3] }}.{{ domain }} 在 Playbook 命令行中定义变量 范例：\n--- - hosts: centos7 remote_user: root tasks: - name: install nginx yum: name={{ pkname }} state=present [root@ansible ~]#ansible-playbook -e pkname=nginx var2.yml 范例：\n#也可以将多个变量放在一个文件中 [root@ansible ~]#cat vars pkname1: memcached pkname2: vsftpd [root@ansible ~]#vim var2.yml --- - hosts: centos7 remote_user: root tasks: - name: install package {{ pkname1 } yum: name={{ pkname1 }} state=present - name: install package {{ pkname2 } yum: name={{ pkname2 }} state=present [root@ansible ~]#ansible-playbook -e pkname1=memcached -e pkname2=httpd var2.yml [root@ansible ~]#ansible-playbook -e '@vars' var2.yml 在playbook文件中定义变量 此方式定义的是私有变量,即只能在当前playbook中使用,不能被其它Playbook共用 范例：\n- hosts: webservers remote_user: root vars: username: user1 groupname: group1 tasks: - name: create group {{ groupname }} group: name={{ groupname }} state=present - name: create user {{ username }} user: name={{ username }} group={{ groupname }} state=present [root@ansible ~]#ansible-playbook -e \"username=user2 groupname=group2\" var3.yml 范例：变量的相互调用\n--- - hosts: centos7 remote_user: root vars: collect_info: \"/data/test/{{ansible_default_ipv4['address']}}/\" tasks: - name: create IP directory file: name=\"{{collect_info}}\" state=directory 使用专用的公共的变量文件 可以在一个独立的playbook文件中定义公共变量，在其它的playbook文件中可以引用变量文件中的变量 此方式比playbook中定义的变量优化级高\nvim vars.yml --- # variables file package_name: mariadb-server service_name: mariadb vim var5.yml --- #install package and start service - hosts: dbsrvs remote_user: root vars_files: # 指定变量文件名 - vars.yml tasks: - name: install package yum: name={{ package_name }} tags: install - name: start service service: name={{ service_name }} state=started enabled=yes 在主机清单中定义主机和主机组的变量 所有项目的主机变量 在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用 范例：\n[webservers] www1.wang.org http_port=80 maxRequestsPerChild=808 www2.wang.org http_port=8080 maxRequestsPerChild=909 所有项目的组（公共）变量 在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量\n案例：\n[webservers:vars] http_port=80 ntp_server=ntp.wang.org nfs_server=nfs.wang.org [all:vars] # --------- Main Variables --------------- # Cluster container-runtime supported: docker, containerd CONTAINER_RUNTIME=\"docker\" # Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn CLUSTER_NETWORK=\"calico\" # Service proxy mode of kube-proxy: 'iptables' or 'ipvs' PROXY_MODE=\"ipvs\" # K8S Service CIDR, not overlap with node(host) networking SERVICE_CIDR=\"192.168.0.0/16\" # Cluster CIDR (Pod CIDR), not overlap with node(host) networking CLUSTER_CIDR=\"172.16.0.0/16\" # NodePort Range NODE_PORT_RANGE=\"20000-60000\" # Cluster DNS Domain CLUSTER_DNS_DOMAIN=\"magedu.local.\" 范例：\n[root@ansible ~]#vim /etc/ansible/hosts [webservers] 10.0.0.8 hname=www1 domain=magedu.io 10.0.0.7 hname=www2 [webservers:vars] mark=\"-\" [all:vars] domain=wang.org [root@ansible ~]#ansible webservers -m hostname -a 'name={{ hname }}{{ mark }} {{ domain }}' #命令行指定变量： [root@ansible ~]#ansible webservers -e domain=magedu.cn -m hostname -a 'name= {{ hname }}{{ mark }}{{ domain }}' 针对当前项目的主机和主机组的变量 上面的方式是针对所有项目都有效,而官方更建议的方式是使用ansible特定项目的主机变量和组变量.生产建议在每个项目对应的目录中创建额外的两个变量目录,分别是host_vars和group_vars\nhost_vars下面的文件名和主机清单主机名一致,针对单个主机进行变量定义格式:host_vars/hostname group_vars下面的文件名和主机清单中组名一致, 针对单个组进行变量定义格式: group_vars/groupname group_vars/all文件内定义的变量对所有组都有效 范例: 特定项目的主机和组变量\n[root@ansible ansible]#pwd /data/ansible [root@ansible ansible]#mkdir host_vars [root@ansible ansible]#mkdir group_vars [root@ansible ansible]#cat host_vars/10.0.0.8 id: 2 [root@ansible ansible]#cat host_vars/10.0.0.7 id: 1 [root@ansible ansible]#cat group_vars/webservers name: web [root@ansible ansible]#cat group_vars/all domain: wang.org [root@ansible ansible]#tree host_vars/ group_vars/ host_vars/ ├── 10.0.0.7 └── 10.0.0.8 group_vars/ ├── all └── webservers 0 directories, 4 files [root@ansible ansible]#cat test.yml - hosts: webservers tasks: - name: get variable command: echo \"{{name}}{{id}}.{{domain}}\" register: result - name: print variable debug: msg: \"{{result.stdout}}\" [root@ansible ansible]#ansible-playbook test.yml PLAY [webservers] ******************************************************************************** *************************************** TASK [Gathering Facts] ******************************************************************************** ******************************* ok: [10.0.0.7] ok: [10.0.0.8] TASK [get variable] ******************************************************************************** ********************************** changed: [10.0.0.7] changed: [10.0.0.8] TASK [print variable] ******************************************************************************** ******************************** ok: [10.0.0.7] =\u003e { \"msg\": \"web1.wang.org\" } ok: [10.0.0.8] =\u003e { \"msg\": \"web2.wang.org\" } PLAY RECAP ******************************************************************************** ******************************************* 10.0.0.7 : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 10.0.0.8 : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Template 模板 模板是一个文本文件，可以用于根据每个主机的不同环境而为生成不同的文件 模板文件中支持嵌套jinja2语言的指令,来实现变量,条件判断,循环等功能 需要使用template模块实现文件的复制到远程主机,但和copy模块不同,复制过去的文件每个主机可以会有所不同\njinja2语言 Jinja2 是一个现代的，设计者友好的，仿照 Django 模板的 Python 模板语言。 它速度快，被广泛使用，并且提供了可选的沙箱模板执行环境保证安全: 特性:\n沙箱中执行 强大的 HTML 自动转义系统保护系统免受 XSS 模板继承 及时编译最优的 python 代码 可选提前编译模板的时间 易于调试。异常的行数直接指向模板中的对应行。 可配置的语法 官方网站：\nhttp://jinja.pocoo.org/ https://jinja.palletsprojects.com/en/2.11.x/ 官方中文文档\nhttp://docs.jinkan.org/docs/jinja2/ https://www.w3cschool.cn/yshfid/ jinja2 语言支持多种数据类型和操作: 字面量，如: 字符串：使用单引号或双引号,数字：整数，浮点数 列表：[item1, item2, …] 元组：(item1, item2, …) 字典：{key1:value1, key2:value2, …} 布尔型：true/false 算术运算：+, -, *, /, //, %, ** 比较操作：==, !=, \u003e, \u003e=, \u003c, \u003c=\n逻辑运算：and，or，not 流表达式：For，If，When\n字面量： 表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如\"Hello World” 双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如42，42.23 数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的\n算术运算： Jinja 允许用计算值。支持下面的运算符 +：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接 它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 {{ 1 + 1 }} 等于 2 -：用第一个数减去第二个数。 {{ 3 - 2 }} 等于 1 /：对两个数做除法。返回值会是一个浮点数。 {{ 1 / 2 }} 等于 0.5 //：对两个数做除法，返回整数商。 {{ 20 // 7 }} 等于 2 %：计算整数除法的余数。 {{ 11 % 7 }} 等于 4 *：用右边的数乘左边的操作数。 {{ 2 * 2 }} 会返回 4 。也可以用于重 复一个字符串多次。 {{ ‘=’ * 80 }} 会打印 80 个等号的横条\n：取左操作数的右操作数次幂。 {{ 23 }} 会返回 8\n比较操作符\n== 比较两个对象是否相等 != 比较两个对象是否不等\n如果左边大于右边，返回 true = 如果左边大于等于右边，返回 true \u003c 如果左边小于右边，返回 true \u003c= 如果左边小于等于右边，返回 true 逻辑运算符\n对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式 and 如果左操作数和右操作数同为真，返回 true or 如果左操作数和右操作数有一个为真，返回 true not 对一个表达式取反 (expr)表达式组 true / false true 永远是 true ，而 false 始终是 false\ntemplate template功能：可以根据和参考模块文件，动态生成相类似的配置文件 template文件存建议放于templates目录下，且命名为 .j2 结尾\nyaml/yml 文件和templates目录平级，此时playbook中指定模版文件时可不用指定路径, 目录结构如下 示例：\n./ ├── temnginx.yml └── templates └── nginx.conf.j2 范例：利用template 同步nginx配置文件\n#准备templates/nginx.conf.j2文件 [root@ansible ~]#vim temnginx.yml --- - hosts: centos7 remote_user: root tasks: - name: template config to remote hosts template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf [root@ansible ~]#ansible-playbook temnginx.yml template变更替换 范例：\n#修改文件nginx.conf.j2 [root@ansible ~]#mkdir templates [root@ansible ~]#vim templates/nginx.conf.j2 ...... worker_processes {{ ansible_processor_vcpus }}; ...... [root@ansible ~]#vim temnginx2.yml --- - hosts: centos7 remote_user: root tasks: - name: install nginx yum: name=nginx - name: template config to remote hosts template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf - name: start service service: name=nginx state=started enabled=yes [root@ansible ~]#ansible-playbook temnginx2.yml Roles 角色 角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中 运维复杂的场景：建议使用 roles，代码复用度高 roles：多个角色的集合目录， 可以将多个的role，分别放至roles目录下的独立子目录中,如下示例\nroles/ mysql/ nginx/ tomcat/ redis/ 默认roles存放路径\n/root/.ansible/roles /usr/share/ansible/roles /etc/ansible/roles 官方文档:\nhttps://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html Ansible Roles目录编排 roles目录结构如下所示\n每个角色，以特定的层级目录结构进行组织 roles目录结构：\nplaybook1.yml playbook2.yml roles/ project1/ tasks/ files/ vars/ templates/ handlers/ default/ meta/ project2/ tasks/ files/ vars/ templates/ handlers/ default/ meta/ Roles各目录作用 roles/project/ :项目名称,有以下子目录\nfiles/ ：存放由copy或script模块等调用的文件 templates/：template模块查找所需要模板文件的目录 tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含 handlers/：至少应该包含一个名为main.yml的文件；此目录下的其它的文件需要在此文件中通过include进行包含 vars/：定义变量，至少应该包含一个名为main.yml的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含,也可以通过项目目录中的group_vars/all定义变量,从而实现角色通用代码和项目数据的分离 meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含 default/：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低 创建 role 创建role的步骤\n1 创建role的目录结构.在以roles命名的目录下分别创建以各角色名称命名的目录，如mysql等,在每个角色命名的目录中分别创建相关的目录和文件,比如tasks、files、handlers、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建 2 编写和准备指定role的功能文件,包括: tasks,templates,vars等相关文件 3 编写playbook文件调用上面定义的role,应用到指定的主机 针对大型项目使用Roles进行编排 范例: 利用 ansible-galaxy 创建角色目录的结构\n#创建初始化目录结构 [root@ansible roles]#ansible-galaxy role init test_role - Role test_role was created successfully [root@ansible roles]#tree test_role/ test_role/ ├── defaults │ └── main.yml ├── files ├── handlers │ └── main.yml ├── meta │ └── main.yml ├── README.md ├── tasks │ └── main.yml ├── templates ├── tests │ ├── inventory │ └── test.yml └── vars └── main.yml 8 directories, 8 files 范例：roles的目录结构\nnginx-role.yml roles/ └── nginx ├── files │ └── nginx.conf ├── tasks │ ├── groupadd.yml │ ├── install.yml │ ├── main.yml │ ├── restart.yml │ └── useradd.yml └── vars └── main.yml Playbook 调用角色 调用角色方法1：\n--- - hosts: webservers remote_user: root roles: - mysql - memcached - nginx 调用角色方法2： 键role用于指定角色名称，后续的k/v用于传递变量给角色\n--- - hosts: all remote_user: root roles: - role: mysql username: mysql - { role: nginx, username: nginx } 调用角色方法3： 还可基于条件测试实现角色调用\n--- - hosts: all remote_user: root roles: - { role: nginx, username: nginx, when: ansible_distribution_major_version == '7' } Roles 中 Tags 使用 [root@ansible ~]#vi app-role.yml --- #可以有多个play - hosts: lbserver roles: - role: haproxy - role: keepalived - hosts: appsrvs remote_user: root roles: - { role: nginx ,tags: [ 'nginx', 'web' ] ,when: ansible_distribution_major_version == \"6\" } - { role: httpd ,tags: [ 'httpd', 'web' ] } - { role: mysql ,tags: [ 'mysql', 'db' ] } - role: mariadb tags: - mariadb - db tags: app #play的tag [root@ansible ~]#ansible-playbook --tags=\"nginx,mysql\" app-role.yml 实战案例 实现httpd角色 # 创建role目录 [root@ansible data]# ansible-galaxy role init httpd - Role htppd was created successfully [root@ansible data]# tree httpd/ httpd/ ├── defaults │ └── main.yml ├── files ├── handlers │ └── main.yml ├── meta │ └── main.yml ├── README.md ├── tasks │ └── main.yml ├── templates ├── tests │ ├── inventory │ └── test.yml └── vars └── main.yml 8 directories, 8 files [root@ansible data]# #main.yml 是task的入口文件 [root@ansible tasks]# cat main.yml --- # tasks file for httpd - include: group.yml - include: user.yml - include: install_httpd.yml - include: config.yml - inclusde: index.yml - include: service.yml [root@ansible tasks]# # 创建用户组 [root@ansible httpd]# cat tasks/group.yml - name: add group group: name={{ httpd_group}} system=yes gid={{ httpd_gid }} [root@ansible htppd]# # 创建用户 [root@ansible httpd]# cat tasks/user.yml - name: add httpd user user: name={{ httpd_user }} system=yes shel=/sbin/nologin home=/var/www uid={{ httpd_uid }} group={{ httpd_group }} [root@ansible htppd]# # yum install httpd [root@ansible httpd]# cat tasks/install_httpd.yml - name: install httpd yum: name=httpd [root@ansible httpd]# # 拷贝配置文件 #注意: 文件是放在files目录下,但src的路径无需写files目录名 [root@ansible htppd]# cat tasks/config.yml - name: httpd config copy: src=httpd.conf dest=/etc/httpd/conf backup=yes notify: restart httpd # 准备测试文件 [root@ansible htppd]# cat tasks/index.yml - name: copy index.html copy: src=index.html dest=/var/www/html [root@ansible htppd]# # start httpd [root@ansible htppd]# cat tasks/service.yml - name: start httpd service: name=httpd state=started enabled=yes [root@ansible htppd]# # 配置文件修改则重启httpd [root@ansible htppd]# cat handlers/main.yml --- # handlers file for httpd - name: restart httpd service: name=httpd state=restarted [root@ansible htppd]# #在files目录下准备两个文件 [root@ansible data]# ll httpd/files total 16 -rw-r--r-- 1 root root 11753 Mar 1 18:36 httpd.conf -rw-r--r-- 1 root root 23 Mar 1 21:10 index.html # 准备变量文件 [root@ansible data]# cat httpd/vars/main.yml --- # vars file for httpd httpd_group: apache httpd_gid: 88 httpd_user: apache httpd_uid: 88 [root@ansible data]# #在playbook中调用角色 [root@ansible data]# cat web_roles.yml --- - hosts: centos7 remote_user: root roles: - httpd #运行playbook [root@ansible data]# ansible-playbook /data/web_roles.yml 实现Nginx角色 # 创建roles目录 [root@ansible data]# ansible-galaxy init nginx - Role nginx was created successfully [root@ansible data]# ll total 12 -rw-r--r-- 1 root root 614 Mar 1 21:07 ansible.cfg -rw-r--r-- 1 root root 1382 Mar 1 21:07 hosts drwxr-xr-x 10 root root 154 Mar 1 18:07 httpd drwxr-xr-x 10 root root 154 Mar 1 21:52 nginx -rw-r--r-- 1 root root 63 Mar 1 21:14 web_roles.yml [root@ansible data]# # 创建tasks文件 [root@ansible data]# cat nginx/tasks/main.yml --- # tasks file for nginx - include: install_nginx.yml - import_playbook: config.yml - include: index.yml - import_playbook: service.yml [root@ansible data]# # 安装nginx [root@ansible data]# cat nginx/tasks/install_nginx.yml --- - name: install nginx yum: name: nginx state: present [root@ansible data]# # 配置文件 [root@ansible data]# cat nginx/tasks/config.yml --- - name: copy config template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf notify: restart nginx # 创建测试文件 [root@ansible data]# cat nginx/tasks/index.yml --- - name: copt index.html copy: src=index.html dest=/usr/share/nginx/html/ # 启动nginx [root@ansible data]# cat nginx/tasks/service.yml --- - name: start nginx service: name=nginx state=started enabled=yes #创建handler文件 [root@ansible data]# cat nginx/handlers/main.yml --- # handlers file for nginx - name: restart nginx service: naem=nginx state=restarted [root@ansible data]# ll #创建template文件 [root@ansible data]# ll nginx/templates/ total 4 -rw-r--r-- 1 root root 2336 Mar 1 22:12 nginx.conf.j2 [root@ansible data]# # 创建测试文件 [root@ansible data]# ll nginx/files/ total 4 -rw-r--r-- 1 root root 23 Mar 1 22:14 index.html [root@ansible data]# #在playbook中调用角色 [root@ansible data]# cat web_roles.yml --- - hosts: centos7 remote_user: root roles: # - httpd - nginx [root@ansible data]# #运行playbook [root@ansible data]# ansible-playbook web_roles.yml 实现MySql8角色 创建角色目录 [root@ansible data]# ansible-galaxy init mysql8 [root@ansible data]# ll total 12 -rw-r--r-- 1 root root 614 Mar 1 21:07 ansible.cfg -rw-r--r-- 1 root root 1382 Mar 1 21:07 hosts drwxr-xr-x 10 root root 154 Mar 1 18:07 httpd drwxr-xr-x 10 root root 154 Mar 1 22:55 mysql8 drwxr-xr-x 8 root root 125 Mar 1 22:44 nginx -rw-r--r-- 1 root root 75 Mar 1 22:38 web_roles.yml [root@ansible data]# 创建tasks yml文件 # 安装包 [root@ansible data]# cat mysql8/tasks/install_package.yml --- - name: install package yum: name={{ item }} state=latest loop: - libaio - numactl-libs # add group [root@ansible data]# cat mysql8/tasks/group.yml --- - name: add group group: name={{ group }} gid={{ group_gid }} [root@ansible data]# # add user [root@ansible data]# cat mysql8/tasks/user.yml --- - name: add user user: name={{ user }} uid={{ user_uid }} shell=/sbin/nologin group={{ group }} create_home=no system=yes home=/data/mysql [root@ansible data]# # 准备my.cnf文件 [root@ansible data]# cat mysql8/files/my.cnf [mysqld] server-id=1 log-bin datadir=/data/mysql socket=/data/mysql/mysql.sock log-error=/data/mysql/mysql.log pid-file=/data/mysql/mysql.pid [client] socket=/data/mysql/mysql.sock # 准备mysql二进制包 [root@ansible data]# ll mysql8/files/ total 1176056 -rw-r--r-- 1 root root 181 Mar 1 23:10 my.cnf -rw-r--r-- 1 root root 1204277208 Dec 18 2021 mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz [root@ansible data]# # 将mysql二进制包解压到远程主机 [root@ansible data]# cat mysql8/tasks/unarchive.yml --- - name: copy mysql tar host # mysql_tar 为mysql二进制的压缩包名称 unarchive: src={{ mysql_tar }} dest=/usr/local/ owner=root group=root [root@ansible data]# # 将远程主机解压出的二进制包创建软连接 [root@ansible data]# cat mysql8/tasks/linkfile.yml --- - name: create link file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link [root@ansible data]# # 初始化数据库 [root@ansible data]# cat mysql8/tasks/init_mysql_data.yml --- - name: create datadir dir file: path=/data/mysql state=directory owner={{ user }} group={{ group } - name: init mysql data shell: /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --datadir=/data/mysql [root@ansible data]# # copy config.con [root@ansible data]# cat mysql8/tasks/config.yml --- - name: copy my.cnf copy: src=my.cnf dest=/etc/my.cnf [root@ansible data]# [root@ansible data]# cat mysql8/tasks/script.yml --- - name: service script shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld [root@ansible data]# [root@ansible data]# cat mysql8/tasks/path.yml --- - name: path copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh [root@ansible data]# [root@ansible data]# cat mysql8/tasks/service.yml --- - name: service shell: chkconfig --add mysqld;/etc/init.d/mysqld start [root@ansible data]# [root@ansible data]# cat mysql8/tasks/main.yml --- # tasks file for mysql8 - include: install_package.yml - include: group.yml - include: user.yml - include: unarchive.yml - include: linkfile.yml - include: linkfile.yml - include: init_mysql_data.yml - include: config.yml - include: script.yml - include: path.yml - include: service.yml - include: secure.yml # 创建变量文件 [root@ansible data]# cat mysql8/vars/main.yml --- # vars file for mysql8 group: mysql group_gid: 306 user: mysql user_uid: 306 mysql_tar: mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz mysql_version: 8.0.28 mysql_root_password: 123456 [root@ansible data]# # 调用角色 [root@ansible data]# cat web_roles.yml --- - hosts: centos7 remote_user: root roles: - mysql8 # 运行 [root@ansible data]# ansible-playbook web_roles.yml 实现Redis角色 # 创建角色目录 [root@ansible data]# ansible-galaxy init redis [root@ansible data]# tree redis/ redis/ ├── defaults │ └── main.yml ├── files ├── handlers │ └── main.yml ├── meta │ └── main.yml ├── README.md ├── tasks │ └── main.yml ├── templates ├── tests │ ├── inventory │ └── test.yml └── vars └── main.yml # 创建tasks文件 [root@ansible data]# cat redis/tasks/main.yml --- # tasks file for redis - name: Installed Redis Server yum: name: redis state: present - name: Configure Redis Server template: src: redis.conf.j2 dest: /etc/redis.conf owner: redis group: root mode: '0640' notify: Restart Redis Server - name: Start Redis Server systemd: name: redis state: started enabled: yes [root@ansible data]# # 创建handlers文件 [root@ansible data]# cat redis/handlers/main.yml --- # handlers file for redis - name: Restart Redis Server systemd: name: redis state: restarted [root@ansible data]# # 在/data/redis/templates目录下准备如下文件 [root@ansible data]# ll redis/templates/ total 48 -rw-r----- 1 root root 46729 Mar 2 02:51 redis.conf.j2 [root@ansible data]# # 调用角色 # 调用角色 [root@ansible data]# cat web_roles.yml --- - hosts: centos7 remote_user: root roles: - redis # 运行 [root@ansible data]# ansible-playbook web_roles.yml Ansible推荐学习资料 http://galaxy.ansible.com https://galaxy.ansible.com/explore#/ http://github.com/ http://ansible.com.cn/ https://github.com/ansible/ansible https://github.com/ansible/ansible-examples ",
  "wordCount" : "12246",
  "inLanguage": "en",
  "image":"http://oss.itshare.work/itshare-work-images/3.jpg","datePublished": "2023-02-25T19:12:21Z",
  "dateModified": "2023-02-25T19:12:21Z",
  "author":[{
    "@type": "Person",
    "name": "Cookie"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://hugo.itshare.work/posts/ansible/ansible2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie",
    "logo": {
      "@type": "ImageObject",
      "url": "http://hugo.itshare.work/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://hugo.itshare.work/" accesskey="h" title="Cookie (Alt + H)">
            <img src="http://hugo.itshare.work/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Cookie</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://hugo.itshare.work/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="http://hugo.itshare.work/">🏠 主页</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/">📚文章</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/ansible/">📕 Ansible</a></div>
            <h1 class="post-title">
                运维自动化工具Ansible(二)
            </h1>
            <div class="post-description">
                Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗.
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-02-25
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>12246字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>25分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Cookie
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="http://hugo.itshare.work/tags/ansible/" style="color: var(--secondary)!important;">Ansible</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "http://hugo.itshare.work/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="http://oss.itshare.work/itshare-work-images/3.jpg" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#playbook" aria-label="Playbook">Playbook</a><ul>
                        
                <li>
                    <a href="#playbook%e4%bb%8b%e7%bb%8d" aria-label="playbook介绍">playbook介绍</a><ul>
                        
                <li>
                    <a href="#playbook-%e7%bb%84%e6%88%90" aria-label="Playbook 组成">Playbook 组成</a></li>
                <li>
                    <a href="#playbook-%e4%b8%8e-ad-hoc-%e5%af%b9%e6%af%94" aria-label="Playbook 与 Ad-Hoc 对比">Playbook 与 Ad-Hoc 对比</a></li></ul>
                </li>
                <li>
                    <a href="#yaml-%e8%af%ad%e8%a8%80" aria-label="YAML 语言">YAML 语言</a><ul>
                        
                <li>
                    <a href="#yaml-%e8%af%ad%e8%a8%80%e4%bb%8b%e7%bb%8d" aria-label="YAML 语言介绍">YAML 语言介绍</a></li>
                <li>
                    <a href="#yaml%e8%af%ad%e6%b3%95%e7%ae%80%e4%bb%8b" aria-label="YAML语法简介">YAML语法简介</a></li>
                <li>
                    <a href="#%e6%94%af%e6%8c%81%e7%9a%84%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" aria-label="支持的数据类型">支持的数据类型</a><ul>
                        
                <li>
                    <a href="#scalar-%e6%a0%87%e9%87%8f" aria-label="scalar 标量">scalar 标量</a></li>
                <li>
                    <a href="#list-%e5%88%97%e8%a1%a8" aria-label="List 列表">List 列表</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%89%e7%a7%8d%e5%b8%b8%e8%a7%81%e7%9a%84%e6%95%b0%e6%8d%ae%e6%a0%bc%e5%bc%8f" aria-label="三种常见的数据格式">三种常见的数据格式</a></li></ul>
                </li>
                <li>
                    <a href="#playbook-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6" aria-label="Playbook 核心组件">Playbook 核心组件</a><ul>
                        
                <li>
                    <a href="#hosts-%e7%bb%84%e4%bb%b6" aria-label="hosts 组件">hosts 组件</a></li>
                <li>
                    <a href="#remote_user-%e7%bb%84%e4%bb%b6" aria-label="remote_user 组件">remote_user 组件</a></li>
                <li>
                    <a href="#task%e5%88%97%e8%a1%a8%e5%92%8caction%e7%bb%84%e4%bb%b6" aria-label="task列表和action组件">task列表和action组件</a></li>
                <li>
                    <a href="#%e5%85%b6%e5%ae%83%e7%bb%84%e4%bb%b6%e8%af%b4%e6%98%8e" aria-label="其它组件说明">其它组件说明</a></li>
                <li>
                    <a href="#shellscripts-vs-playbook-%e6%a1%88%e4%be%8b" aria-label="ShellScripts VS Playbook 案例">ShellScripts VS Playbook 案例</a></li></ul>
                </li>
                <li>
                    <a href="#playbook-%e5%91%bd%e4%bb%a4" aria-label="playbook 命令">playbook 命令</a></li>
                <li>
                    <a href="#%e5%bf%bd%e7%95%a5%e9%94%99%e8%af%af-ignore_errors" aria-label="忽略错误 ignore_errors">忽略错误 ignore_errors</a></li>
                <li>
                    <a href="#ansible-playbook%e6%a1%88%e4%be%8b" aria-label="ansible-playbook案例">ansible-playbook案例</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85nginx" aria-label="安装nginx">安装nginx</a></li>
                <li>
                    <a href="#%e5%8d%b8%e8%bd%bdhttpd" aria-label="卸载httpd">卸载httpd</a></li></ul>
                </li>
                <li>
                    <a href="#playbook%e4%b8%ad%e4%bd%bf%e7%94%a8handlers%e5%92%8cnotify" aria-label="Playbook中使用handlers和notify">Playbook中使用handlers和notify</a><ul>
                        
                <li>
                    <a href="#handlers%e5%92%8cnotify" aria-label="handlers和notify">handlers和notify</a></li>
                <li>
                    <a href="#force_handlers" aria-label="force_handlers">force_handlers</a></li></ul>
                </li>
                <li>
                    <a href="#playbook%e4%b8%ad%e4%bd%bf%e7%94%a8tags%e7%bb%84%e4%bb%b6" aria-label="Playbook中使用tags组件">Playbook中使用tags组件</a></li>
                <li>
                    <a href="#playbook%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f" aria-label="Playbook中使用变量">Playbook中使用变量</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-setup-%e6%a8%a1%e5%9d%97%e4%b8%ad%e5%8f%98%e9%87%8f" aria-label="使用 setup 模块中变量">使用 setup 模块中变量</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-facts-%e5%8f%98%e9%87%8f" aria-label="使用 facts 变量">使用 facts 变量</a></li></ul>
                </li>
                <li>
                    <a href="#register-%e6%b3%a8%e5%86%8c%e5%8f%98%e9%87%8f" aria-label="register 注册变量">register 注册变量</a></li>
                <li>
                    <a href="#%e5%9c%a8-playbook-%e5%91%bd%e4%bb%a4%e8%a1%8c%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f" aria-label="在 Playbook 命令行中定义变量">在 Playbook 命令行中定义变量</a></li>
                <li>
                    <a href="#%e5%9c%a8playbook%e6%96%87%e4%bb%b6%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f" aria-label="在playbook文件中定义变量">在playbook文件中定义变量</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e4%b8%93%e7%94%a8%e7%9a%84%e5%85%ac%e5%85%b1%e7%9a%84%e5%8f%98%e9%87%8f%e6%96%87%e4%bb%b6" aria-label="使用专用的公共的变量文件">使用专用的公共的变量文件</a></li>
                <li>
                    <a href="#%e5%9c%a8%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e4%b8%ad%e5%ae%9a%e4%b9%89%e4%b8%bb%e6%9c%ba%e5%92%8c%e4%b8%bb%e6%9c%ba%e7%bb%84%e7%9a%84%e5%8f%98%e9%87%8f" aria-label="在主机清单中定义主机和主机组的变量">在主机清单中定义主机和主机组的变量</a><ul>
                        
                <li>
                    <a href="#%e6%89%80%e6%9c%89%e9%a1%b9%e7%9b%ae%e7%9a%84%e4%b8%bb%e6%9c%ba%e5%8f%98%e9%87%8f" aria-label="所有项目的主机变量">所有项目的主机变量</a></li>
                <li>
                    <a href="#%e6%89%80%e6%9c%89%e9%a1%b9%e7%9b%ae%e7%9a%84%e7%bb%84%e5%85%ac%e5%85%b1%e5%8f%98%e9%87%8f" aria-label="所有项目的组（公共）变量">所有项目的组（公共）变量</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%92%88%e5%af%b9%e5%bd%93%e5%89%8d%e9%a1%b9%e7%9b%ae%e7%9a%84%e4%b8%bb%e6%9c%ba%e5%92%8c%e4%b8%bb%e6%9c%ba%e7%bb%84%e7%9a%84%e5%8f%98%e9%87%8f" aria-label="针对当前项目的主机和主机组的变量">针对当前项目的主机和主机组的变量</a></li></ul>
                </li>
                <li>
                    <a href="#template-%e6%a8%a1%e6%9d%bf" aria-label="Template 模板">Template 模板</a><ul>
                        
                <li>
                    <a href="#jinja2%e8%af%ad%e8%a8%80" aria-label="jinja2语言">jinja2语言</a></li>
                <li>
                    <a href="#template" aria-label="template">template</a></li></ul>
                </li>
                <li>
                    <a href="#roles-%e8%a7%92%e8%89%b2" aria-label="Roles 角色">Roles 角色</a><ul>
                        
                <li>
                    <a href="#ansible-roles%e7%9b%ae%e5%bd%95%e7%bc%96%e6%8e%92" aria-label="Ansible Roles目录编排">Ansible Roles目录编排</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba-role" aria-label="创建 role">创建 role</a></li>
                <li>
                    <a href="#playbook-%e8%b0%83%e7%94%a8%e8%a7%92%e8%89%b2" aria-label="Playbook 调用角色">Playbook 调用角色</a></li>
                <li>
                    <a href="#roles-%e4%b8%ad-tags-%e4%bd%bf%e7%94%a8" aria-label="Roles 中 Tags 使用">Roles 中 Tags 使用</a></li>
                <li>
                    <a href="#%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8b" aria-label="实战案例">实战案例</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0httpd%e8%a7%92%e8%89%b2" aria-label="实现httpd角色">实现httpd角色</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0nginx%e8%a7%92%e8%89%b2" aria-label="实现Nginx角色">实现Nginx角色</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0mysql8%e8%a7%92%e8%89%b2" aria-label="实现MySql8角色">实现MySql8角色</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0redis%e8%a7%92%e8%89%b2" aria-label="实现Redis角色">实现Redis角色</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ansible%e6%8e%a8%e8%8d%90%e5%ad%a6%e4%b9%a0%e8%b5%84%e6%96%99" aria-label="Ansible推荐学习资料">Ansible推荐学习资料</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="playbook">Playbook<a hidden class="anchor" aria-hidden="true" href="#playbook">#</a></h1>
<h2 id="playbook介绍">playbook介绍<a hidden class="anchor" aria-hidden="true" href="#playbook介绍">#</a></h2>
<p>官方链接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html
</span></span></code></pre></div><h3 id="playbook-组成">Playbook 组成<a hidden class="anchor" aria-hidden="true" href="#playbook-组成">#</a></h3>
<p><img loading="lazy" src="../image.assets/1677299110747.png" alt="1677299110747"  />
</p>
<ul>
<li>一个 playbook(剧本)文件是一个YAML语言编写的文本文件</li>
<li>通常一个playbook只包括一个play</li>
<li>一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。</li>
<li>一个tasks中可以有一个或多个task任务</li>
<li>每一个Task本质上就是调用ansible的一个module</li>
<li>在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务</li>
</ul>
<h3 id="playbook-与-ad-hoc-对比">Playbook 与 Ad-Hoc 对比<a hidden class="anchor" aria-hidden="true" href="#playbook-与-ad-hoc-对比">#</a></h3>
<ul>
<li>Playbook是对多个 AD-Hoc 的一种编排组合的实现方式</li>
<li>Playbook能控制任务执行的先后顺序</li>
<li>Playbook可以持久保存到文件中从而方便多次调用运行，而Ad-Hoc只能临时运行。</li>
<li>Playbook适合复杂的重复性的任务，而Ad-Hoc适合做快速简单的一次性任务</li>
</ul>
<h2 id="yaml-语言">YAML 语言<a hidden class="anchor" aria-hidden="true" href="#yaml-语言">#</a></h2>
<h3 id="yaml-语言介绍">YAML 语言介绍<a hidden class="anchor" aria-hidden="true" href="#yaml-语言介绍">#</a></h3>
<p>YAML：YAML Ain&rsquo;t Markup Language，即YAML不是标记语言。不过，在开发的这种语言时，YAML的
意思其实是：&ldquo;Yet Another Markup Language&rdquo;（仍是一种标记语言）
YAML是一个可读性高的用来表达资料序列的格式。
YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。
Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者
目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等
YAML 官方网站：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://www.yaml.org
</span></span></code></pre></div><p>ansible 官网:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html
</span></span></code></pre></div><p>###　YAML 语言特性</p>
<ul>
<li>YAML的可读性好</li>
<li>YAML和脚本语言的交互性好</li>
<li>YAML使用实现语言的数据类型</li>
<li>YAML有一个一致的信息模型</li>
<li>YAML易于实现</li>
<li>YAML可以基于流来处理</li>
<li>YAML表达能力强，扩展性好</li>
</ul>
<h3 id="yaml语法简介">YAML语法简介<a hidden class="anchor" aria-hidden="true" href="#yaml语法简介">#</a></h3>
<ul>
<li>在单一文件第一行，用连续三个连字号&quot;-&quot; 开始，还有选择性的连续三个点号( &hellip; )用来表示文件结尾</li>
<li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li>
<li>使用#号注释代码</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结行来实现的</li>
<li>缩进不支持tab,必须使用空格进行缩进</li>
<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>
<li>YAML文件内容是区别大小写的，key/value的值均需大小写敏感</li>
<li>多个key/value可同行写也可换行写，同行使用，分隔</li>
<li>key后面冒号要加一个空格 比如: key: value</li>
<li>value可是个字符串，也可是另一个列表</li>
<li>YAML文件扩展名通常为yml或yaml</li>
</ul>
<h3 id="支持的数据类型">支持的数据类型<a hidden class="anchor" aria-hidden="true" href="#支持的数据类型">#</a></h3>
<p>YAML 支持以下常用几种数据类型：</p>
<ul>
<li>标量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为: 字典（dictionary）/ 哈希（hashes） / 映射（mapping）</li>
<li>数组：一组按次序排列的值，又称为: 列表（list）/ 序列（sequence）</li>
</ul>
<h4 id="scalar-标量">scalar 标量<a hidden class="anchor" aria-hidden="true" href="#scalar-标量">#</a></h4>
<p>key对应value</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name: wang
</span></span><span style="display:flex;"><span>age: 18
</span></span></code></pre></div><p>使用缩进的方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name:
</span></span><span style="display:flex;"><span>wang
</span></span><span style="display:flex;"><span>age:
</span></span><span style="display:flex;"><span>18
</span></span></code></pre></div><p>标量是最基本的，不可再分的值，包括：</p>
<ul>
<li>字符串</li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
<p>####　Dictionary 字典
一个字典是由一个或多个key与value构成
key和value之间用冒号 ：分隔
冒号 : 后面有一个空格
所有 k/v 可以放在一行，,每个 k/v 之间用逗号分隔
所有每个 k/v 也可以分别放在不同行,一对k/v放在独立的一行
格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>account: { name: wang, age: 30 }
</span></span></code></pre></div><p>使用缩进方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>account:
</span></span><span style="display:flex;"><span>name: wang
</span></span><span style="display:flex;"><span>age: 18
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#不同行
</span></span><span style="display:flex;"><span># An employee record
</span></span><span style="display:flex;"><span>name: Example Developer
</span></span><span style="display:flex;"><span>job: Developer
</span></span><span style="display:flex;"><span>skill: Elite(社会精英)
</span></span><span style="display:flex;"><span>#同一行,也可以将key:value放置于{}中进行表示，用,分隔多个key:value
</span></span><span style="display:flex;"><span># An employee record
</span></span><span style="display:flex;"><span>{name: &#34;Example Developer&#34;, job: &#34;Developer&#34;, skill: &#34;Elite&#34;}
</span></span></code></pre></div><h4 id="list-列表">List 列表<a hidden class="anchor" aria-hidden="true" href="#list-列表">#</a></h4>
<p>列表由多个元素组成
每个元素放在不同行，每个元素一行,且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格
也可以将所有元素用 [ ] 括起来放在同一行,每个元素之间用逗号分隔
格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>course: [ linux , golang , python ]
</span></span></code></pre></div><p>也可以写成以 - 开头的多行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>course:
</span></span><span style="display:flex;"><span>	- linux
</span></span><span style="display:flex;"><span>	- golang
</span></span><span style="display:flex;"><span>	- python
</span></span><span style="display:flex;"><span>course:
</span></span><span style="display:flex;"><span>	- linux: manjaro
</span></span><span style="display:flex;"><span>	- golang: gin
</span></span><span style="display:flex;"><span>	- python: django
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#不同行,行以-开头,后面有一个空格
</span></span><span style="display:flex;"><span># A list of tasty fruits
</span></span><span style="display:flex;"><span>- Apple
</span></span><span style="display:flex;"><span>- Orange
</span></span><span style="display:flex;"><span>- Strawberry
</span></span><span style="display:flex;"><span>- Mango
</span></span><span style="display:flex;"><span>#同一行
</span></span><span style="display:flex;"><span>[Apple,Orange,Strawberry,Mango]
</span></span></code></pre></div><p>范例：YAML 表示一个家庭</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>name: John Smith
</span></span><span style="display:flex;"><span>age: 41
</span></span><span style="display:flex;"><span>gender: Male
</span></span><span style="display:flex;"><span>spouse: { name: Jane Smith, age: 37, gender: Female } # 写在一行里
</span></span><span style="display:flex;"><span>	name: Jane Smith #也可以写成多行
</span></span><span style="display:flex;"><span>	age: 37
</span></span><span style="display:flex;"><span>	gender: Female
</span></span><span style="display:flex;"><span>	children: [ {name: Jimmy Smith,age: 17, gender: Male}, {name: Jenny Smith, 		age:13, gender: Female}, {name: hao Smith, age: 20, gender: Male } ] #写在一行
</span></span><span style="display:flex;"><span>	- name: Jimmy Smith #写在多行,更为推荐的写法
</span></span><span style="display:flex;"><span>		age: 17
</span></span><span style="display:flex;"><span>		gender: Male
</span></span><span style="display:flex;"><span>	- {name: Jenny Smith, age: 13, gender: Female}
</span></span><span style="display:flex;"><span>	- {name: hao Smith, age: 20, gender: Male }
</span></span></code></pre></div><h3 id="三种常见的数据格式">三种常见的数据格式<a hidden class="anchor" aria-hidden="true" href="#三种常见的数据格式">#</a></h3>
<ul>
<li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li>
<li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li>
<li>YAML：YAML Ain&rsquo;t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</li>
</ul>
<p><img loading="lazy" src="../image.assets/1677310138888.png" alt="1677310138888"  />
</p>
<p>可以用工具互相转换，参考网站：
<a href="https://www.json2yaml.com/">https://www.json2yaml.com/</a>
<a href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p>
<h2 id="playbook-核心组件">Playbook 核心组件<a hidden class="anchor" aria-hidden="true" href="#playbook-核心组件">#</a></h2>
<p>官方文档</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#playbook-keywords
</span></span></code></pre></div><p>一个playbook 中由多个组件组成,其中所用到的常见组件类型如下:</p>
<ul>
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需少元素需包括 name 和 task,一个name只能包括一个task</li>
<li>Variables 内置变量或自定义变量在playbook中调用</li>
<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>
<li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此 会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</li>
</ul>
<h3 id="hosts-组件">hosts 组件<a hidden class="anchor" aria-hidden="true" href="#hosts-组件">#</a></h3>
<p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>one.example.com
</span></span><span style="display:flex;"><span>one.example.com:two.example.com
</span></span><span style="display:flex;"><span>192.168.1.50
</span></span><span style="display:flex;"><span>192.168.1.*
</span></span><span style="display:flex;"><span>Websrvs:dbsrvs #或者，两个组的并集
</span></span><span style="display:flex;"><span>Websrvs:&amp;dbsrvs #与，两个组的交集
</span></span><span style="display:flex;"><span>webservers:!dbsrvs #在websrvs组，但不在dbsrvs组
</span></span></code></pre></div><p>案例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: websrvs:appsrvs
</span></span></code></pre></div><h3 id="remote_user-组件">remote_user 组件<a hidden class="anchor" aria-hidden="true" href="#remote_user-组件">#</a></h3>
<p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: test connection
</span></span><span style="display:flex;"><span>    ping:
</span></span><span style="display:flex;"><span>    remote_user: magedu
</span></span><span style="display:flex;"><span>    sudo: yes #默认sudo为root
</span></span><span style="display:flex;"><span>    sudo_user:wang #sudo为wang
</span></span></code></pre></div><h3 id="task列表和action组件">task列表和action组件<a hidden class="anchor" aria-hidden="true" href="#task列表和action组件">#</a></h3>
<p>play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task
task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致
每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。
如果未提供name，则action的结果将用于输出
task两种格式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-v" data-lang="v"><span style="display:flex;"><span>action: <span style="color:#f92672">module</span> arguments <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">示例</span>: action: shell wall hello
</span></span><span style="display:flex;"><span><span style="color:#f92672">module</span>: arguments <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">建议使用</span> <span style="color:#f92672">#</span><span style="color:#960050;background-color:#1e0010">示例</span>: shell: wall hello
</span></span></code></pre></div><p>注意：shell和command模块后面跟命令，而非key=value
范例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]#cat hello.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>#first yaml文件
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: task1
</span></span><span style="display:flex;"><span>      debug: msg=&#34;task1 running&#34;
</span></span><span style="display:flex;"><span>    - name: task2
</span></span><span style="display:flex;"><span>      debug: msg=&#34;task2 running&#34;
</span></span><span style="display:flex;"><span>- hosts: appsrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: task3
</span></span><span style="display:flex;"><span>      debug: msg=&#34;task3 running&#34;
</span></span><span style="display:flex;"><span>    - name: task4
</span></span><span style="display:flex;"><span>      debug: msg=&#34;task4 running&#34;
</span></span></code></pre></div><h3 id="其它组件说明">其它组件说明<a hidden class="anchor" aria-hidden="true" href="#其它组件说明">#</a></h3>
<p>某任务的状态在运行后为changed时，可通过&quot;notify&quot;通知给相应的handlers任务
还可以通过&quot;tags&quot;给task 打标签，可在ansible-playbook命令上使用-t指定进行调用</p>
<h3 id="shellscripts-vs-playbook-案例">ShellScripts VS Playbook 案例<a hidden class="anchor" aria-hidden="true" href="#shellscripts-vs-playbook-案例">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#SHELL脚本实现</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装Apache</span>
</span></span><span style="display:flex;"><span>yum install --quiet -y httpd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 复制配置文件</span>
</span></span><span style="display:flex;"><span>cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf
</span></span><span style="display:flex;"><span>cp/tmp/vhosts.conf /etc/httpd/conf.d/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动Apache，并设置开机启动</span>
</span></span><span style="display:flex;"><span>systemctl enable --now httpd
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Playbook实现</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: <span style="color:#e6db74">&#34;安装Apache&#34;</span>
</span></span><span style="display:flex;"><span>    yum: name<span style="color:#f92672">=</span>httpd
</span></span><span style="display:flex;"><span>  - name: <span style="color:#e6db74">&#34;复制配置文件&#34;</span>
</span></span><span style="display:flex;"><span>	copy: src<span style="color:#f92672">=</span>/tmp/httpd.conf dest<span style="color:#f92672">=</span>/etc/httpd/conf/
</span></span><span style="display:flex;"><span>  - name: <span style="color:#e6db74">&#34;复制配置文件&#34;</span>
</span></span><span style="display:flex;"><span>	copy: src<span style="color:#f92672">=</span>/tmp/vhosts.conf dest<span style="color:#f92672">=</span>/etc/httpd/conf.d/
</span></span><span style="display:flex;"><span>  - name: <span style="color:#e6db74">&#34;启动Apache，并设置开机启动&#34;</span>
</span></span><span style="display:flex;"><span>	service: name<span style="color:#f92672">=</span>httpd state<span style="color:#f92672">=</span>started enabled<span style="color:#f92672">=</span>yes
</span></span></code></pre></div><h2 id="playbook-命令">playbook 命令<a hidden class="anchor" aria-hidden="true" href="#playbook-命令">#</a></h2>
<p>格式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-playbook &lt;filename.yml&gt; ... [options]
</span></span></code></pre></div><p>选项</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>--syntax,--syntax-check #语法检查,功能相当于bash -n
</span></span><span style="display:flex;"><span>-C --check #模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作
</span></span><span style="display:flex;"><span>--list-hosts #列出运行任务的主机
</span></span><span style="display:flex;"><span>--list-tags #列出tag
</span></span><span style="display:flex;"><span>--list-tasks #列出task
</span></span><span style="display:flex;"><span>--limit 主机列表 #只针对主机列表中的特定主机执行
</span></span><span style="display:flex;"><span>-i INVENTORY, --inventory INVENTORY #指定主机清单文件,通常一个项对应一个主机清单文件
</span></span><span style="display:flex;"><span>--start-at-task START_AT_TASK #从指定task开始执行,而非从头开始,START_AT_TASK为任务的name
</span></span><span style="display:flex;"><span>-v -vv -vvv #显示过程
</span></span></code></pre></div><p>范例: 一个简单的 playbook</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]#cat hello.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: websrvs
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: hello
</span></span><span style="display:flex;"><span>      command: echo &#34;hello ansible&#34;
</span></span><span style="display:flex;"><span>[root@ansible ansible]#ansible-playbook hello.yml
</span></span><span style="display:flex;"><span>[root@ansible ansible]#ansible-playbook -v hello.yml
</span></span></code></pre></div><p>范例: 检查和限制主机</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-playbook file.yml --check #只检测
</span></span><span style="display:flex;"><span>ansible-playbook file.yml
</span></span><span style="display:flex;"><span>ansible-playbook file.yml --limit websrvs
</span></span></code></pre></div><p>范例: 一个playbook 多个play</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cat test_plays.yaml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: localhost
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: play1
</span></span><span style="display:flex;"><span>      command: echo &#34;play1&#34;
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: play2
</span></span><span style="display:flex;"><span>      command: echo &#34;play2&#34;
</span></span></code></pre></div><h2 id="忽略错误-ignore_errors">忽略错误 ignore_errors<a hidden class="anchor" aria-hidden="true" href="#忽略错误-ignore_errors">#</a></h2>
<p>如果一个task出错,默认将不会继续执行后续的其它task
利用 ignore_errors: yes 可以忽略此task的错误,继续向下执行playbook其它task</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]#cat test_ignore.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: error
</span></span><span style="display:flex;"><span>      command: /bin/false
</span></span><span style="display:flex;"><span>      ignore_errors: yes
</span></span><span style="display:flex;"><span>    - name: continue
</span></span><span style="display:flex;"><span>      command: wall continue
</span></span></code></pre></div><h2 id="ansible-playbook案例">ansible-playbook案例<a hidden class="anchor" aria-hidden="true" href="#ansible-playbook案例">#</a></h2>
<h3 id="安装nginx">安装nginx<a hidden class="anchor" aria-hidden="true" href="#安装nginx">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span># yum install nginx
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: install nginx
</span></span><span style="display:flex;"><span>      yum: name=nginx state=present
</span></span><span style="display:flex;"><span>    - name:
</span></span><span style="display:flex;"><span>      service: name=nginx state=started enabled=yes
</span></span></code></pre></div><h3 id="卸载httpd">卸载httpd<a hidden class="anchor" aria-hidden="true" href="#卸载httpd">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e">#remove_httpd.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">webservers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">remote_user</span>: <span style="color:#ae81ff">root</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gather_facts</span>: <span style="color:#66d9ef">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove httpd package</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">yum</span>: <span style="color:#ae81ff">name=httpd state=absent</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove apache user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#ae81ff">name=apache state=absent</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove config file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>: <span style="color:#ae81ff">name=/etc/httpd state=absent</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">remove web html</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>: <span style="color:#ae81ff">name=/data/html/ state=absent</span>
</span></span></code></pre></div><h2 id="playbook中使用handlers和notify">Playbook中使用handlers和notify<a hidden class="anchor" aria-hidden="true" href="#playbook中使用handlers和notify">#</a></h2>
<h3 id="handlers和notify">handlers和notify<a hidden class="anchor" aria-hidden="true" href="#handlers和notify">#</a></h3>
<p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。
Notify对应的action 在所有task都执行完才会最后被触发，这样可避免多个task多次改变发生时每次都触发执行指定的操作，Handlers仅在所有的变化发生完成后一次性地执行指定操作。
在notify中列出的操作称为handler，也即notify中调用handler中定义的操作
注意:</p>
<ul>
<li>如果多个task通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。</li>
<li>只有notify对应的task发生改变了才会通知handlers， 没有改变则不会触发handlers</li>
<li>handlers 是在所有前面的tasks都成功执行才会执行,如果前面任何一个task失败,会导致handle跳过执行</li>
</ul>
<p>案例:</p>
<p><img loading="lazy" src="../image.assets/1677315798458.png" alt="1677315798458"  />
</p>
<p><img loading="lazy" src="../image.assets/1677315812687.png" alt="1677315812687"  />
</p>
<p>案例：</p>
<p><img loading="lazy" src="../image.assets/1677315839869.png" alt="1677315839869"  />
</p>
<p>案例：</p>
<p><img loading="lazy" src="../image.assets/1677315862982.png" alt="1677315862982"  />
</p>
<p><img loading="lazy" src="../image.assets/1677315872464.png" alt="1677315872464"  />
</p>
<p>范例: 部署haproxy</p>
<p><img loading="lazy" src="../image.assets/1677315902745.png" alt="1677315902745"  />
</p>
<h3 id="force_handlers">force_handlers<a hidden class="anchor" aria-hidden="true" href="#force_handlers">#</a></h3>
<p>如果不论前面的task成功与否,都希望handlers能执行, 可以使用force_handlers: yes 强制执行handler
范例: 强制调用handlers</p>
<p><img loading="lazy" src="../image.assets/1677315975960.png" alt="1677315975960"  />
</p>
<h2 id="playbook中使用tags组件">Playbook中使用tags组件<a hidden class="anchor" aria-hidden="true" href="#playbook中使用tags组件">#</a></h2>
<p>官方文档:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html
</span></span></code></pre></div><p>默认情况下， Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务，在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件
可以一个task对应多个tag,也可以多个task对应同一个tag
还有另外3个特殊关键字用于标签, tagged, untagged 和 all,它们分别是仅运行已标记，只有未标记和所有任务。
tags 主要用于调试环境
范例： tag 标签</p>
<p><img loading="lazy" src="../image.assets/1677316033321.png" alt="1677316033321"  />
</p>
<h2 id="playbook中使用变量">Playbook中使用变量<a hidden class="anchor" aria-hidden="true" href="#playbook中使用变量">#</a></h2>
<p>Playbook中同样也支持变量
变量名：仅能由字母、数字和下划线组成，且只能以字母开头
变量定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>variable=value
</span></span><span style="display:flex;"><span>variable: value
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http_port=80
</span></span><span style="display:flex;"><span>http_port: 80
</span></span></code></pre></div><p>通过 {{ variable_name }} 调用变量，且变量名前后建议加空格，有时用&quot;{{ variable_name }}&ldquo;才生效
变量来源：</p>
<ol>
<li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li>
<li>通过命令行指定变量，优先级最高</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ansible-playbook -e varname=value test.yml
</span></span></code></pre></div><p>3.在playbook文件中定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>vars:
</span></span><span style="display:flex;"><span>var1: value1
</span></span><span style="display:flex;"><span>var2: value2
</span></span></code></pre></div><p>4.在独立的变量YAML文件中定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>vars_files:
</span></span><span style="display:flex;"><span>- vars.yml
</span></span></code></pre></div><ol start="5">
<li>在主机清单文件中定义
主机（普通）变量：主机组中主机单独定义，优先级高于公共变量
组（公共）变量：针对主机组中所有主机定义统一变量</li>
<li>在项目中针对主机和主机组定义
在项目目录中创建 host_vars和group_vars目录</li>
<li>在role中定义</li>
</ol>
<p>变量的优先级从高到低如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>-e 选项定义变量 --&gt;playbook中vars_files --&gt; playbook中vars变量定义 --&gt;host_vars/主机名文件 --&gt;主机清单中主机变量--&gt; group_vars/主机组名文件--&gt;group_vars/all文件--&gt; 主机清单组变量
</span></span></code></pre></div><h3 id="使用-setup-模块中变量">使用 setup 模块中变量<a hidden class="anchor" aria-hidden="true" href="#使用-setup-模块中变量">#</a></h3>
<h4 id="使用-facts-变量">使用 facts 变量<a hidden class="anchor" aria-hidden="true" href="#使用-facts-变量">#</a></h4>
<p>本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中
facts 包括的信息很多,如: 主机名,IP,CPU,内存,网卡等
facts 变量的实际使用场景案例</p>
<ul>
<li>通过facts变量获取被控端CPU的个数信息,从而生成不同的Nginx配置文件</li>
<li>通过facts变量获取被控端内存大小信息,从而生成不同的memcached的配置文件</li>
<li>通过facts变量获取被控端主机名称信息,从而生成不同的Zabbix配置文件</li>
<li>通过facts变量获取被控端网卡信息,从而生成不同的主机名</li>
</ul>
<p>案例：使用setup变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]# ansible localhost -m setup -a &#39;filter=&#34;ansible_default_ipv4&#34;&#39;
</span></span><span style="display:flex;"><span>localhost | SUCCESS =&gt; {
</span></span><span style="display:flex;"><span>    &#34;ansible_facts&#34;: {
</span></span><span style="display:flex;"><span>        &#34;ansible_default_ipv4&#34;: {
</span></span><span style="display:flex;"><span>            &#34;address&#34;: &#34;192.168.32.133&#34;,
</span></span><span style="display:flex;"><span>            &#34;alias&#34;: &#34;ens160&#34;,
</span></span><span style="display:flex;"><span>            &#34;broadcast&#34;: &#34;192.168.32.255&#34;,
</span></span><span style="display:flex;"><span>            &#34;gateway&#34;: &#34;192.168.32.2&#34;,
</span></span><span style="display:flex;"><span>            &#34;interface&#34;: &#34;ens160&#34;,
</span></span><span style="display:flex;"><span>            &#34;macaddress&#34;: &#34;00:0c:29:7c:80:cd&#34;,
</span></span><span style="display:flex;"><span>            &#34;mtu&#34;: 1500,
</span></span><span style="display:flex;"><span>            &#34;netmask&#34;: &#34;255.255.255.0&#34;,
</span></span><span style="display:flex;"><span>            &#34;network&#34;: &#34;192.168.32.0&#34;,
</span></span><span style="display:flex;"><span>            &#34;prefix&#34;: &#34;24&#34;,
</span></span><span style="display:flex;"><span>            &#34;type&#34;: &#34;ether&#34;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    &#34;changed&#34;: false
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>[root@ansible ~]# 
</span></span></code></pre></div><p>范例：显示ens33的网卡的IP地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: show ens33 ip
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: IP address {{ ansible_ens33.ipv4.address }}
</span></span><span style="display:flex;"><span>        #msg: IP address {{ ansible_facts[&#34;ens33&#34;][&#34;ipv4&#34;][&#34;address&#34;] }}
</span></span><span style="display:flex;"><span>        #msg: IP address {{ ansible_facts.ens33.ipv4.address }}
</span></span><span style="display:flex;"><span>        #msg: IP address {{ ansible_default_ipv4.address }}
</span></span><span style="display:flex;"><span>        #msg: IP address {{ ansible_ens33.ipv4.address }}
</span></span><span style="display:flex;"><span>        #msg: IP address {{ ansible_ens33.ipv4.address.split(&#39;.&#39;)[-1] }}  #取IP中的最后一个数字
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]# ansible-playbook -v show_ip.yml 
</span></span><span style="display:flex;"><span>Using /etc/ansible/ansible.cfg as config file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY [centos7] *************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [Gathering Facts] *****************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.179]
</span></span><span style="display:flex;"><span>ok: [192.168.32.178]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [show ens33 ip] *******************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.178] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: &#34;IP address 192.168.32.178&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [192.168.32.179] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: &#34;IP address 192.168.32.179&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP *****************************************************************************************************************************
</span></span><span style="display:flex;"><span>192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible ansible]# 
</span></span></code></pre></div><p>范例：修改主机名称为web-IP</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: 打印facts变量
</span></span><span style="display:flex;"><span>    debug: msg={{ ansible_ens33.ipv4.address }}
</span></span><span style="display:flex;"><span>  - name: 修改主机名
</span></span><span style="display:flex;"><span>    hostname: name=web-{{ ansible_ens33.ipv4.address }}
</span></span><span style="display:flex;"><span>  #- name: 获取facts变量提取IP地址，以.结尾的最后一列,修改主机名为web-hostid
</span></span><span style="display:flex;"><span>    #hostname: name=web-{{ ansible_ens33.ipv4.address.split(&#39;.&#39;)[-1] }}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]# ansible-playbook change_hostname.yml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY [centos7] *************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [Gathering Facts] *****************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.178]
</span></span><span style="display:flex;"><span>ok: [192.168.32.179]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [打印facts变量] *******************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.178] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: &#34;192.168.32.178&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [192.168.32.179] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: &#34;192.168.32.179&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [修改主机名] **********************************************************************************************************************
</span></span><span style="display:flex;"><span>changed: [192.168.32.179]
</span></span><span style="display:flex;"><span>changed: [192.168.32.178]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP *****************************************************************************************************************************
</span></span><span style="display:flex;"><span>192.168.32.178             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>192.168.32.179             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible ansible]# 
</span></span></code></pre></div><p>####　性能优化</p>
<p>每次执行playbook,默认会收集每个主机的所有facts变量,将会导致速度很慢,可以采用下面方法加速
方法1
关闭facts采集加速执行,此方法将导致无法使用facts变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  gather_facts: no
</span></span></code></pre></div><p>方法2
当使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置facts 的缓存,将facts变量信息存在redis服务器中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]# cat /etc/ansible/ansible.cfg
</span></span><span style="display:flex;"><span>[defaults]
</span></span><span style="display:flex;"><span># smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts
</span></span><span style="display:flex;"><span># implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False
</span></span><span style="display:flex;"><span># explicit 则表示默认不收集，要显式收集，必须使用gather_facts: True
</span></span><span style="display:flex;"><span>gathering = smart #在使用 facts 缓存时设置为smart
</span></span><span style="display:flex;"><span>fact_caching_timeout = 86400 #缓存时长
</span></span><span style="display:flex;"><span>fact_caching = redis #缓存存在redis中
</span></span><span style="display:flex;"><span>fact_caching_connection = 10.0.0.100:6379:0 #0表示redis的0号数据库
</span></span><span style="display:flex;"><span>#若redis设置了密码
</span></span><span style="display:flex;"><span>fact_caching_connection = 10.0.0.100:6379:0:password
</span></span></code></pre></div><h3 id="register-注册变量">register 注册变量<a hidden class="anchor" aria-hidden="true" href="#register-注册变量">#</a></h3>
<p>在playbook中可以使用register将捕获命令的输出保存在临时变量中，方便后续调用此变量,比如可以使用debug模块进行显示输出
范例: 利用debug 模块输出变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: get variable
</span></span><span style="display:flex;"><span>      shell: hostname
</span></span><span style="display:flex;"><span>      register: name
</span></span><span style="display:flex;"><span>    - name: print variable
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: &#34;{{ name }}&#34; #输出register注册的name变量的全部信息,注意变量要加&#34; &#34;引起来
</span></span><span style="display:flex;"><span>         #msg: &#34;{{ name.cmd }}&#34; #显示命令
</span></span><span style="display:flex;"><span>         #msg: &#34;{{ name.rc }}&#34; #显示命令成功与否
</span></span><span style="display:flex;"><span>		 #msg: &#34;{{ name.stdout }}&#34; #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出
</span></span><span style="display:flex;"><span>	    #msg: &#34;{{ name.stdout_lines }}&#34; #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示
</span></span><span style="display:flex;"><span>		#msg: &#34;{{ name[&#39;stdout_lines&#39;] }}&#34; #显示命令的执行结果为列表形式,和效果上面相同
</span></span><span style="display:flex;"><span>		#msg: &#34;{{ name.stdout_lines[0] }}&#34; #显示命令的输出结果的列表中的第一个元素
</span></span><span style="display:flex;"><span>#说明 第一个 task 中，使用了 register 注册变量名为 name ；当 shell 模块执行完毕后，会将数据放到该变量中。第二给 task 中，使用了 debug 模块，并从变量name中获取数据。
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]# ansible-playbook -C register.yml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY [centos7] *************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [Gathering Facts] *****************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.179]
</span></span><span style="display:flex;"><span>ok: [192.168.32.178]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [get variable] ********************************************************************************************************************
</span></span><span style="display:flex;"><span>skipping: [192.168.32.179]
</span></span><span style="display:flex;"><span>skipping: [192.168.32.178]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK [print variable] ******************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: [192.168.32.178] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: {
</span></span><span style="display:flex;"><span>        &#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>        &#34;cmd&#34;: &#34;hostname&#34;,
</span></span><span style="display:flex;"><span>        &#34;delta&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;end&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;failed&#34;: false,
</span></span><span style="display:flex;"><span>        &#34;msg&#34;: &#34;Command would have run if not in check mode&#34;,
</span></span><span style="display:flex;"><span>        &#34;rc&#34;: 0,
</span></span><span style="display:flex;"><span>        &#34;skipped&#34;: true,
</span></span><span style="display:flex;"><span>        &#34;start&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;stderr&#34;: &#34;&#34;,
</span></span><span style="display:flex;"><span>        &#34;stderr_lines&#34;: [],
</span></span><span style="display:flex;"><span>        &#34;stdout&#34;: &#34;&#34;,
</span></span><span style="display:flex;"><span>        &#34;stdout_lines&#34;: []
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [192.168.32.179] =&gt; {
</span></span><span style="display:flex;"><span>    &#34;msg&#34;: {
</span></span><span style="display:flex;"><span>        &#34;changed&#34;: false,
</span></span><span style="display:flex;"><span>        &#34;cmd&#34;: &#34;hostname&#34;,
</span></span><span style="display:flex;"><span>        &#34;delta&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;end&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;failed&#34;: false,
</span></span><span style="display:flex;"><span>        &#34;msg&#34;: &#34;Command would have run if not in check mode&#34;,
</span></span><span style="display:flex;"><span>        &#34;rc&#34;: 0,
</span></span><span style="display:flex;"><span>        &#34;skipped&#34;: true,
</span></span><span style="display:flex;"><span>        &#34;start&#34;: null,
</span></span><span style="display:flex;"><span>        &#34;stderr&#34;: &#34;&#34;,
</span></span><span style="display:flex;"><span>        &#34;stderr_lines&#34;: [],
</span></span><span style="display:flex;"><span>        &#34;stdout&#34;: &#34;&#34;,
</span></span><span style="display:flex;"><span>        &#34;stdout_lines&#34;: []
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP *****************************************************************************************************************************
</span></span><span style="display:flex;"><span>192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible ansible]# 
</span></span></code></pre></div><p>范例: 安装启动服务并检查</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    package_name: nginx
</span></span><span style="display:flex;"><span>    service_name: nginx
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: install {{ package_name }}
</span></span><span style="display:flex;"><span>    yum: name={{ package_name }}
</span></span><span style="display:flex;"><span>  - name: start {{ service_name }}
</span></span><span style="display:flex;"><span>    service: name={{ service_name }} state=started enabled=yes
</span></span><span style="display:flex;"><span>  - name: check
</span></span><span style="display:flex;"><span>    shell: ps axu|grep {{ service_name }}
</span></span><span style="display:flex;"><span>    register: check_service
</span></span><span style="display:flex;"><span>  - name: debug
</span></span><span style="display:flex;"><span>    debug:
</span></span><span style="display:flex;"><span>      msg: &#34;{{ check_service.stdout_lines }}&#34;
</span></span></code></pre></div><p>范例: 修改主机名形式为 web_&lt;随机字符&gt;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: genarate random
</span></span><span style="display:flex;"><span>    shell:
</span></span><span style="display:flex;"><span>      cmd: openssl rand -base64 12 |tr -dc &#39;[:alnum:]&#39;
</span></span><span style="display:flex;"><span>    register:
</span></span><span style="display:flex;"><span>      num
</span></span><span style="display:flex;"><span>  - name: show random
</span></span><span style="display:flex;"><span>    debug:
</span></span><span style="display:flex;"><span>      msg: &#34;{{ num }}&#34;
</span></span><span style="display:flex;"><span>  - name: change hostname
</span></span><span style="display:flex;"><span>    hostname:
</span></span><span style="display:flex;"><span>      name: web-{{ num.stdout }}
</span></span></code></pre></div><p>范例: 修改主机名形式为 web_随机数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: 定义一个随机数，设定为变量，然后后续调用
</span></span><span style="display:flex;"><span>    shell: echo $((RANDOM%255))
</span></span><span style="display:flex;"><span>    register: web_number
</span></span><span style="display:flex;"><span>  - name: 使用debug输出变量结果
</span></span><span style="display:flex;"><span>    debug: msg={{ web_number }}
</span></span><span style="display:flex;"><span>  - name: 使用hostname模块将主机名修改为web_随机数
</span></span><span style="display:flex;"><span>    hostname: name=web_{{ web_number.stdout }}
</span></span></code></pre></div><p>范例: 批量修改主机名为随机字符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    host: web
</span></span><span style="display:flex;"><span>    domain: wang.org
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: get variable
</span></span><span style="display:flex;"><span>    shell: echo $RANDOM | md5sum | cut -c 1-8
</span></span><span style="display:flex;"><span>    register: get_random
</span></span><span style="display:flex;"><span>  - name: print variable
</span></span><span style="display:flex;"><span>    debug:
</span></span><span style="display:flex;"><span>      msg: &#34;{{ get_random.stdout }}&#34;
</span></span><span style="display:flex;"><span>  - name: set hostname
</span></span><span style="display:flex;"><span>    hostname: name={{ host }}-{{ get_random.stdout }}.{{ domain }}
</span></span></code></pre></div><p>范例: 批量修改主机名为IP最后1位数字</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    host: web
</span></span><span style="display:flex;"><span>    domain: wang.org
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: get variable
</span></span><span style="display:flex;"><span>      shell: hostname -I | awk &#39;{print $1}&#39;
</span></span><span style="display:flex;"><span>      register: get_ip
</span></span><span style="display:flex;"><span>    - name: print variable
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: &#34;{{ get_ip.stdout.split(&#39;.&#39;)[3] }}&#34;
</span></span><span style="display:flex;"><span>    - name: set hostname
</span></span><span style="display:flex;"><span>      hostname: name={{ host }}-{{ get_ip.stdout.split(&#39;.&#39;)[3] }}.{{ domain }}
</span></span></code></pre></div><h3 id="在-playbook-命令行中定义变量">在 Playbook 命令行中定义变量<a hidden class="anchor" aria-hidden="true" href="#在-playbook-命令行中定义变量">#</a></h3>
<p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: install nginx
</span></span><span style="display:flex;"><span>    yum: name={{ pkname }} state=present
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-playbook -e pkname=nginx var2.yml
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#也可以将多个变量放在一个文件中</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ansible</span> <span style="color:#960050;background-color:#1e0010">~</span>]<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">cat</span> <span style="color:#a6e22e">vars</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pkname1</span>: <span style="color:#a6e22e">memcached</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pkname2</span>: <span style="color:#a6e22e">vsftpd</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ansible</span> <span style="color:#960050;background-color:#1e0010">~</span>]<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">vim</span> <span style="color:#a6e22e">var2</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#a6e22e">hosts</span>: <span style="color:#a6e22e">centos7</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">remote_user</span>: <span style="color:#a6e22e">root</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tasks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">install</span> <span style="color:#f92672">package</span> {{ <span style="color:#a6e22e">pkname1</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">yum</span>: <span style="color:#a6e22e">name</span>={{ <span style="color:#a6e22e">pkname1</span> }} <span style="color:#a6e22e">state</span>=<span style="color:#a6e22e">present</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">install</span> <span style="color:#f92672">package</span> {{ <span style="color:#a6e22e">pkname2</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">yum</span>: <span style="color:#a6e22e">name</span>={{ <span style="color:#a6e22e">pkname2</span> }} <span style="color:#a6e22e">state</span>=<span style="color:#a6e22e">present</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ansible</span> <span style="color:#960050;background-color:#1e0010">~</span>]<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">ansible</span><span style="color:#f92672">-</span><span style="color:#a6e22e">playbook</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">e</span> <span style="color:#a6e22e">pkname1</span>=<span style="color:#a6e22e">memcached</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">e</span> <span style="color:#a6e22e">pkname2</span>=<span style="color:#a6e22e">httpd</span> <span style="color:#a6e22e">var2</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ansible</span> <span style="color:#960050;background-color:#1e0010">~</span>]<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">ansible</span><span style="color:#f92672">-</span><span style="color:#a6e22e">playbook</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">e</span> <span style="color:#960050;background-color:#1e0010">&#39;@</span><span style="color:#a6e22e">vars</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#a6e22e">var2</span>.<span style="color:#a6e22e">yml</span>
</span></span></code></pre></div><h3 id="在playbook文件中定义变量">在playbook文件中定义变量<a hidden class="anchor" aria-hidden="true" href="#在playbook文件中定义变量">#</a></h3>
<p>此方式定义的是私有变量,即只能在当前playbook中使用,不能被其它Playbook共用
范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    username: user1
</span></span><span style="display:flex;"><span>    groupname: group1
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: create group {{ groupname }}
</span></span><span style="display:flex;"><span>    group: name={{ groupname }} state=present
</span></span><span style="display:flex;"><span>  - name: create user {{ username }}
</span></span><span style="display:flex;"><span>    user: name={{ username }} group={{ groupname }} state=present
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-playbook -e &#34;username=user2 groupname=group2&#34; var3.yml
</span></span></code></pre></div><p>范例：变量的相互调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    collect_info: &#34;/data/test/{{ansible_default_ipv4[&#39;address&#39;]}}/&#34;
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: create IP directory
</span></span><span style="display:flex;"><span>    file: name=&#34;{{collect_info}}&#34; state=directory
</span></span></code></pre></div><h3 id="使用专用的公共的变量文件">使用专用的公共的变量文件<a hidden class="anchor" aria-hidden="true" href="#使用专用的公共的变量文件">#</a></h3>
<p>可以在一个独立的playbook文件中定义公共变量，在其它的playbook文件中可以引用变量文件中的变量
此方式比playbook中定义的变量优化级高</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">vim</span> <span style="color:#a6e22e">vars</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">variables</span> <span style="color:#a6e22e">file</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">package_name</span>: <span style="color:#a6e22e">mariadb</span><span style="color:#f92672">-</span><span style="color:#a6e22e">server</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">service_name</span>: <span style="color:#a6e22e">mariadb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vim</span> <span style="color:#a6e22e">var5</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">install</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">start</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#a6e22e">hosts</span>: <span style="color:#a6e22e">dbsrvs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">remote_user</span>: <span style="color:#a6e22e">root</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">vars_files</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">指定变量文件名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> <span style="color:#a6e22e">vars</span>.<span style="color:#a6e22e">yml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tasks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">install</span> <span style="color:#f92672">package</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">yum</span>: <span style="color:#a6e22e">name</span>={{ <span style="color:#a6e22e">package_name</span> }}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tags</span>: <span style="color:#a6e22e">install</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">start</span> <span style="color:#a6e22e">service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">service</span>: <span style="color:#a6e22e">name</span>={{ <span style="color:#a6e22e">service_name</span> }} <span style="color:#a6e22e">state</span>=<span style="color:#a6e22e">started</span> <span style="color:#a6e22e">enabled</span>=<span style="color:#a6e22e">yes</span>
</span></span></code></pre></div><h3 id="在主机清单中定义主机和主机组的变量">在主机清单中定义主机和主机组的变量<a hidden class="anchor" aria-hidden="true" href="#在主机清单中定义主机和主机组的变量">#</a></h3>
<h4 id="所有项目的主机变量">所有项目的主机变量<a hidden class="anchor" aria-hidden="true" href="#所有项目的主机变量">#</a></h4>
<p>在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用
范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[webservers]
</span></span><span style="display:flex;"><span>www1.wang.org http_port=80 maxRequestsPerChild=808
</span></span><span style="display:flex;"><span>www2.wang.org http_port=8080 maxRequestsPerChild=909
</span></span></code></pre></div><h4 id="所有项目的组公共变量">所有项目的组（公共）变量<a hidden class="anchor" aria-hidden="true" href="#所有项目的组公共变量">#</a></h4>
<p>在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量</p>
<p>案例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[webservers:vars]
</span></span><span style="display:flex;"><span>http_port=80
</span></span><span style="display:flex;"><span>ntp_server=ntp.wang.org
</span></span><span style="display:flex;"><span>nfs_server=nfs.wang.org
</span></span><span style="display:flex;"><span>[all:vars]
</span></span><span style="display:flex;"><span># --------- Main Variables ---------------
</span></span><span style="display:flex;"><span># Cluster container-runtime supported: docker, containerd
</span></span><span style="display:flex;"><span>CONTAINER_RUNTIME=&#34;docker&#34;
</span></span><span style="display:flex;"><span># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn
</span></span><span style="display:flex;"><span>CLUSTER_NETWORK=&#34;calico&#34;
</span></span><span style="display:flex;"><span># Service proxy mode of kube-proxy: &#39;iptables&#39; or &#39;ipvs&#39;
</span></span><span style="display:flex;"><span>PROXY_MODE=&#34;ipvs&#34;
</span></span><span style="display:flex;"><span># K8S Service CIDR, not overlap with node(host) networking
</span></span><span style="display:flex;"><span>SERVICE_CIDR=&#34;192.168.0.0/16&#34;
</span></span><span style="display:flex;"><span># Cluster CIDR (Pod CIDR), not overlap with node(host) networking
</span></span><span style="display:flex;"><span>CLUSTER_CIDR=&#34;172.16.0.0/16&#34;
</span></span><span style="display:flex;"><span># NodePort Range
</span></span><span style="display:flex;"><span>NODE_PORT_RANGE=&#34;20000-60000&#34;
</span></span><span style="display:flex;"><span># Cluster DNS Domain
</span></span><span style="display:flex;"><span>CLUSTER_DNS_DOMAIN=&#34;magedu.local.&#34;
</span></span></code></pre></div><p>范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#vim /etc/ansible/hosts
</span></span><span style="display:flex;"><span>[webservers]
</span></span><span style="display:flex;"><span>10.0.0.8 hname=www1 domain=magedu.io
</span></span><span style="display:flex;"><span>10.0.0.7 hname=www2
</span></span><span style="display:flex;"><span>[webservers:vars]
</span></span><span style="display:flex;"><span>mark=&#34;-&#34;
</span></span><span style="display:flex;"><span>[all:vars]
</span></span><span style="display:flex;"><span>domain=wang.org
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible webservers -m hostname -a &#39;name={{ hname }}{{ mark }}
</span></span><span style="display:flex;"><span>{{ domain }}&#39;
</span></span><span style="display:flex;"><span>#命令行指定变量：
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible webservers -e domain=magedu.cn -m hostname -a &#39;name=
</span></span><span style="display:flex;"><span>{{ hname }}{{ mark }}{{ domain }}&#39;
</span></span></code></pre></div><h3 id="针对当前项目的主机和主机组的变量">针对当前项目的主机和主机组的变量<a hidden class="anchor" aria-hidden="true" href="#针对当前项目的主机和主机组的变量">#</a></h3>
<p>上面的方式是针对所有项目都有效,而官方更建议的方式是使用ansible特定项目的主机变量和组变量.生产建议在每个项目对应的目录中创建额外的两个变量目录,分别是host_vars和group_vars</p>
<ul>
<li>host_vars下面的文件名和主机清单主机名一致,针对单个主机进行变量定义格式:host_vars/hostname</li>
<li>group_vars下面的文件名和主机清单中组名一致, 针对单个组进行变量定义格式: group_vars/groupname</li>
<li>group_vars/all文件内定义的变量对所有组都有效</li>
</ul>
<p>范例: 特定项目的主机和组变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ansible]#pwd
</span></span><span style="display:flex;"><span>/data/ansible
</span></span><span style="display:flex;"><span>[root@ansible ansible]#mkdir host_vars
</span></span><span style="display:flex;"><span>[root@ansible ansible]#mkdir group_vars
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat host_vars/10.0.0.8
</span></span><span style="display:flex;"><span>id: 2
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat host_vars/10.0.0.7
</span></span><span style="display:flex;"><span>id: 1
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat group_vars/webservers
</span></span><span style="display:flex;"><span>name: web
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat group_vars/all
</span></span><span style="display:flex;"><span>domain: wang.org
</span></span><span style="display:flex;"><span>[root@ansible ansible]#tree host_vars/ group_vars/
</span></span><span style="display:flex;"><span>host_vars/
</span></span><span style="display:flex;"><span>├── 10.0.0.7
</span></span><span style="display:flex;"><span>└── 10.0.0.8
</span></span><span style="display:flex;"><span>group_vars/
</span></span><span style="display:flex;"><span>├── all
</span></span><span style="display:flex;"><span>└── webservers
</span></span><span style="display:flex;"><span>0 directories, 4 files
</span></span><span style="display:flex;"><span>[root@ansible ansible]#cat test.yml
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>tasks:
</span></span><span style="display:flex;"><span>- name: get variable
</span></span><span style="display:flex;"><span>command: echo &#34;{{name}}{{id}}.{{domain}}&#34;
</span></span><span style="display:flex;"><span>register: result
</span></span><span style="display:flex;"><span>- name: print variable
</span></span><span style="display:flex;"><span>debug:
</span></span><span style="display:flex;"><span>msg: &#34;{{result.stdout}}&#34;
</span></span><span style="display:flex;"><span>[root@ansible ansible]#ansible-playbook test.yml
</span></span><span style="display:flex;"><span>PLAY [webservers]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>***************************************
</span></span><span style="display:flex;"><span>TASK [Gathering Facts]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7]
</span></span><span style="display:flex;"><span>ok: [10.0.0.8]
</span></span><span style="display:flex;"><span>TASK [get variable]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>**********************************
</span></span><span style="display:flex;"><span>changed: [10.0.0.7]
</span></span><span style="display:flex;"><span>changed: [10.0.0.8]
</span></span><span style="display:flex;"><span>TASK [print variable]
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>********************************
</span></span><span style="display:flex;"><span>ok: [10.0.0.7] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;web1.wang.org&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ok: [10.0.0.8] =&gt; {
</span></span><span style="display:flex;"><span>&#34;msg&#34;: &#34;web2.wang.org&#34;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PLAY RECAP
</span></span><span style="display:flex;"><span>********************************************************************************
</span></span><span style="display:flex;"><span>*******************************************
</span></span><span style="display:flex;"><span>10.0.0.7 : ok=3 changed=1 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span><span style="display:flex;"><span>10.0.0.8 : ok=3 changed=1 unreachable=0 failed=0
</span></span><span style="display:flex;"><span>skipped=0 rescued=0 ignored=0
</span></span></code></pre></div><h2 id="template-模板">Template 模板<a hidden class="anchor" aria-hidden="true" href="#template-模板">#</a></h2>
<p>模板是一个文本文件，可以用于根据每个主机的不同环境而为生成不同的文件
模板文件中支持嵌套jinja2语言的指令,来实现变量,条件判断,循环等功能
需要使用template模块实现文件的复制到远程主机,但和copy模块不同,复制过去的文件每个主机可以会有所不同</p>
<h3 id="jinja2语言">jinja2语言<a hidden class="anchor" aria-hidden="true" href="#jinja2语言">#</a></h3>
<p><img loading="lazy" src="../image.assets/1677662324156.png" alt="1677662324156"  />
</p>
<p>Jinja2 是一个现代的，设计者友好的，仿照 Django 模板的 Python 模板语言。 它速度快，被广泛使用，并且提供了可选的沙箱模板执行环境保证安全:
特性:</p>
<ul>
<li>沙箱中执行</li>
<li>强大的 HTML 自动转义系统保护系统免受 XSS</li>
<li>模板继承</li>
<li>及时编译最优的 python 代码</li>
<li>可选提前编译模板的时间</li>
<li>易于调试。异常的行数直接指向模板中的对应行。</li>
<li>可配置的语法</li>
</ul>
<p>官方网站：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://jinja.pocoo.org/
</span></span><span style="display:flex;"><span>https://jinja.palletsprojects.com/en/2.11.x/
</span></span></code></pre></div><p>官方中文文档</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>http://docs.jinkan.org/docs/jinja2/
</span></span><span style="display:flex;"><span>https://www.w3cschool.cn/yshfid/
</span></span></code></pre></div><p>jinja2 语言支持多种数据类型和操作:
字面量，如: 字符串：使用单引号或双引号,数字：整数，浮点数
列表：[item1, item2, &hellip;]
元组：(item1, item2, &hellip;)
字典：{key1:value1, key2:value2, &hellip;}
布尔型：true/false
算术运算：+, -, *, /, //, %, **
比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>逻辑运算：and，or，not
流表达式：For，If，When</p>
<p><strong>字面量：</strong>
表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如&quot;Hello World&rdquo;
双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如42，42.23
数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的</p>
<p><strong>算术运算：</strong>
Jinja 允许用计算值。支持下面的运算符
+：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接
它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 {{ 1 + 1 }} 等于 2
-：用第一个数减去第二个数。 {{ 3 - 2 }} 等于 1
/：对两个数做除法。返回值会是一个浮点数。 {{ 1 / 2 }} 等于 0.5
//：对两个数做除法，返回整数商。 {{ 20 // 7 }} 等于 2
%：计算整数除法的余数。 {{ 11 % 7 }} 等于 4
*：用右边的数乘左边的操作数。 {{ 2 * 2 }} 会返回 4 。也可以用于重 复一个字符串多次。 {{ &lsquo;=&rsquo; * 80 }}
会打印 80 个等号的横条<br>
<strong>：取左操作数的右操作数次幂。 {{ 2</strong>3 }} 会返回 8</p>
<p><strong>比较操作符</strong></p>
<p>== 比较两个对象是否相等
!= 比较两个对象是否不等</p>
<blockquote>
<p>如果左边大于右边，返回 true
= 如果左边大于等于右边，返回 true
&lt; 如果左边小于右边，返回 true
&lt;= 如果左边小于等于右边，返回 true
逻辑运算符</p>
</blockquote>
<p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式
and 如果左操作数和右操作数同为真，返回 true
or 如果左操作数和右操作数有一个为真，返回 true
not 对一个表达式取反
(expr)表达式组
true / false true 永远是 true ，而 false 始终是 false</p>
<h3 id="template">template<a hidden class="anchor" aria-hidden="true" href="#template">#</a></h3>
<p>template功能：可以根据和参考模块文件，动态生成相类似的配置文件
template文件存建议放于templates目录下，且命名为 .j2 结尾</p>
<p>yaml/yml 文件和templates目录平级，此时playbook中指定模版文件时可不用指定路径, 目录结构如下
示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── temnginx.yml
</span></span><span style="display:flex;"><span>└── templates
</span></span><span style="display:flex;"><span>   └── nginx.conf.j2
</span></span></code></pre></div><p>范例：利用template 同步nginx配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#准备templates/nginx.conf.j2文件
</span></span><span style="display:flex;"><span>[root@ansible ~]#vim temnginx.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: template config to remote hosts
</span></span><span style="display:flex;"><span>    template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-playbook temnginx.yml
</span></span></code></pre></div><p>template变更替换
范例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#修改文件nginx.conf.j2
</span></span><span style="display:flex;"><span>[root@ansible ~]#mkdir templates
</span></span><span style="display:flex;"><span>[root@ansible ~]#vim templates/nginx.conf.j2
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>worker_processes {{ ansible_processor_vcpus }};
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>[root@ansible ~]#vim temnginx2.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: install nginx
</span></span><span style="display:flex;"><span>    yum: name=nginx
</span></span><span style="display:flex;"><span>  - name: template config to remote hosts
</span></span><span style="display:flex;"><span>    template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>  - name: start service
</span></span><span style="display:flex;"><span>    service: name=nginx state=started enabled=yes
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-playbook temnginx2.yml
</span></span></code></pre></div><h2 id="roles-角色">Roles 角色<a hidden class="anchor" aria-hidden="true" href="#roles-角色">#</a></h2>
<p>角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中
运维复杂的场景：建议使用 roles，代码复用度高
roles：多个角色的集合目录， 可以将多个的role，分别放至roles目录下的独立子目录中,如下示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>roles/
</span></span><span style="display:flex;"><span>mysql/
</span></span><span style="display:flex;"><span>nginx/
</span></span><span style="display:flex;"><span>tomcat/
</span></span><span style="display:flex;"><span>redis/
</span></span></code></pre></div><p>默认roles存放路径</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/root/.ansible/roles
</span></span><span style="display:flex;"><span>/usr/share/ansible/roles
</span></span><span style="display:flex;"><span>/etc/ansible/roles
</span></span></code></pre></div><p>官方文档:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html
</span></span></code></pre></div><h3 id="ansible-roles目录编排">Ansible Roles目录编排<a hidden class="anchor" aria-hidden="true" href="#ansible-roles目录编排">#</a></h3>
<p>roles目录结构如下所示</p>
<p><img loading="lazy" src="../image.assets/1677664119238.png" alt="1677664119238"  />
</p>
<p>每个角色，以特定的层级目录结构进行组织
roles目录结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playbook1.yml
</span></span><span style="display:flex;"><span>playbook2.yml
</span></span><span style="display:flex;"><span>roles/
</span></span><span style="display:flex;"><span>project1/
</span></span><span style="display:flex;"><span>tasks/
</span></span><span style="display:flex;"><span>files/
</span></span><span style="display:flex;"><span>vars/
</span></span><span style="display:flex;"><span>templates/
</span></span><span style="display:flex;"><span>handlers/
</span></span><span style="display:flex;"><span>default/
</span></span><span style="display:flex;"><span>meta/
</span></span><span style="display:flex;"><span>project2/
</span></span><span style="display:flex;"><span>tasks/
</span></span><span style="display:flex;"><span>files/
</span></span><span style="display:flex;"><span>vars/
</span></span><span style="display:flex;"><span>templates/
</span></span><span style="display:flex;"><span>handlers/
</span></span><span style="display:flex;"><span>default/
</span></span><span style="display:flex;"><span>meta/
</span></span></code></pre></div><p>Roles各目录作用
roles/project/ :项目名称,有以下子目录</p>
<ul>
<li>files/ ：存放由copy或script模块等调用的文件</li>
<li>templates/：template模块查找所需要模板文件的目录</li>
<li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>handlers/：至少应该包含一个名为main.yml的文件；此目录下的其它的文件需要在此文件中通过include进行包含</li>
<li>vars/：定义变量，至少应该包含一个名为main.yml的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含,也可以通过项目目录中的group_vars/all定义变量,从而实现角色通用代码和项目数据的分离</li>
<li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li>
<li>default/：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低</li>
</ul>
<h3 id="创建-role">创建 role<a hidden class="anchor" aria-hidden="true" href="#创建-role">#</a></h3>
<p>创建role的步骤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1 创建role的目录结构.在以roles命名的目录下分别创建以各角色名称命名的目录，如mysql等,在每个角色命名的目录中分别创建相关的目录和文件,比如tasks、files、handlers、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建
</span></span><span style="display:flex;"><span>2 编写和准备指定role的功能文件,包括: tasks,templates,vars等相关文件
</span></span><span style="display:flex;"><span>3 编写playbook文件调用上面定义的role,应用到指定的主机
</span></span></code></pre></div><p>针对大型项目使用Roles进行编排
范例: 利用 ansible-galaxy 创建角色目录的结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#创建初始化目录结构
</span></span><span style="display:flex;"><span>[root@ansible roles]#ansible-galaxy role init test_role
</span></span><span style="display:flex;"><span>- Role test_role was created successfully
</span></span><span style="display:flex;"><span>[root@ansible roles]#tree test_role/
</span></span><span style="display:flex;"><span>test_role/
</span></span><span style="display:flex;"><span>├── defaults
</span></span><span style="display:flex;"><span>│ └── main.yml
</span></span><span style="display:flex;"><span>├── files
</span></span><span style="display:flex;"><span>├── handlers
</span></span><span style="display:flex;"><span>│ └── main.yml
</span></span><span style="display:flex;"><span>├── meta
</span></span><span style="display:flex;"><span>│ └── main.yml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── tasks
</span></span><span style="display:flex;"><span>│ └── main.yml
</span></span><span style="display:flex;"><span>├── templates
</span></span><span style="display:flex;"><span>├── tests
</span></span><span style="display:flex;"><span>│ ├── inventory
</span></span><span style="display:flex;"><span>│ └── test.yml
</span></span><span style="display:flex;"><span>└── vars
</span></span><span style="display:flex;"><span>└── main.yml
</span></span><span style="display:flex;"><span>8 directories, 8 files
</span></span></code></pre></div><p>范例：roles的目录结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>nginx-role.yml
</span></span><span style="display:flex;"><span>roles/
</span></span><span style="display:flex;"><span>└── nginx
</span></span><span style="display:flex;"><span>├── files
</span></span><span style="display:flex;"><span>│ └── nginx.conf
</span></span><span style="display:flex;"><span>├── tasks
</span></span><span style="display:flex;"><span>│ ├── groupadd.yml
</span></span><span style="display:flex;"><span>│ ├── install.yml
</span></span><span style="display:flex;"><span>│ ├── main.yml
</span></span><span style="display:flex;"><span>│ ├── restart.yml
</span></span><span style="display:flex;"><span>│ └── useradd.yml
</span></span><span style="display:flex;"><span>└── vars
</span></span><span style="display:flex;"><span>└── main.yml
</span></span></code></pre></div><h3 id="playbook-调用角色">Playbook 调用角色<a hidden class="anchor" aria-hidden="true" href="#playbook-调用角色">#</a></h3>
<p>调用角色方法1：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - mysql
</span></span><span style="display:flex;"><span>    - memcached
</span></span><span style="display:flex;"><span>    - nginx
</span></span></code></pre></div><p>调用角色方法2：
键role用于指定角色名称，后续的k/v用于传递变量给角色</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - role: mysql
</span></span><span style="display:flex;"><span>    username: mysql
</span></span><span style="display:flex;"><span>    - { role: nginx, username: nginx }
</span></span></code></pre></div><p>调用角色方法3：
还可基于条件测试实现角色调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>   - { role: nginx, username: nginx, when: ansible_distribution_major_version == &#39;7&#39; }
</span></span></code></pre></div><h3 id="roles-中-tags-使用">Roles 中 Tags 使用<a hidden class="anchor" aria-hidden="true" href="#roles-中-tags-使用">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible ~]#vi app-role.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>#可以有多个play
</span></span><span style="display:flex;"><span>- hosts: lbserver
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - role: haproxy
</span></span><span style="display:flex;"><span>    - role: keepalived
</span></span><span style="display:flex;"><span>    - hosts: appsrvs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - { role: nginx ,tags: [ &#39;nginx&#39;, &#39;web&#39; ] ,when:
</span></span><span style="display:flex;"><span>    ansible_distribution_major_version == &#34;6&#34; }
</span></span><span style="display:flex;"><span>    - { role: httpd ,tags: [ &#39;httpd&#39;, &#39;web&#39; ] }
</span></span><span style="display:flex;"><span>    - { role: mysql ,tags: [ &#39;mysql&#39;, &#39;db&#39; ] }
</span></span><span style="display:flex;"><span>    - role: mariadb
</span></span><span style="display:flex;"><span>      tags:
</span></span><span style="display:flex;"><span>      - mariadb
</span></span><span style="display:flex;"><span>      - db
</span></span><span style="display:flex;"><span>  tags: app #play的tag
</span></span><span style="display:flex;"><span>[root@ansible ~]#ansible-playbook --tags=&#34;nginx,mysql&#34; app-role.yml
</span></span></code></pre></div><h3 id="实战案例">实战案例<a hidden class="anchor" aria-hidden="true" href="#实战案例">#</a></h3>
<h4 id="实现httpd角色">实现httpd角色<a hidden class="anchor" aria-hidden="true" href="#实现httpd角色">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 创建role目录
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-galaxy role init httpd
</span></span><span style="display:flex;"><span>- Role htppd was created successfully
</span></span><span style="display:flex;"><span>[root@ansible data]# tree httpd/
</span></span><span style="display:flex;"><span>httpd/
</span></span><span style="display:flex;"><span>├── defaults
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── files
</span></span><span style="display:flex;"><span>├── handlers
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── meta
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── tasks
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── templates
</span></span><span style="display:flex;"><span>├── tests
</span></span><span style="display:flex;"><span>│   ├── inventory
</span></span><span style="display:flex;"><span>│   └── test.yml
</span></span><span style="display:flex;"><span>└── vars
</span></span><span style="display:flex;"><span>    └── main.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>8 directories, 8 files
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#main.yml 是task的入口文件
</span></span><span style="display:flex;"><span>[root@ansible tasks]# cat main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># tasks file for httpd
</span></span><span style="display:flex;"><span>- include: group.yml
</span></span><span style="display:flex;"><span>- include: user.yml
</span></span><span style="display:flex;"><span>- include: install_httpd.yml
</span></span><span style="display:flex;"><span>- include: config.yml
</span></span><span style="display:flex;"><span>- inclusde: index.yml
</span></span><span style="display:flex;"><span>- include: service.yml
</span></span><span style="display:flex;"><span>[root@ansible tasks]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建用户组
</span></span><span style="display:flex;"><span>[root@ansible httpd]# cat tasks/group.yml 
</span></span><span style="display:flex;"><span>- name: add group 
</span></span><span style="display:flex;"><span>  group: name={{ httpd_group}} system=yes gid={{ httpd_gid }}
</span></span><span style="display:flex;"><span>[root@ansible htppd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建用户
</span></span><span style="display:flex;"><span>[root@ansible httpd]# cat tasks/user.yml 
</span></span><span style="display:flex;"><span>- name: add httpd user
</span></span><span style="display:flex;"><span>  user: name={{ httpd_user }} system=yes shel=/sbin/nologin home=/var/www uid={{ httpd_uid }} group={{ httpd_group }}
</span></span><span style="display:flex;"><span>[root@ansible htppd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># yum install httpd
</span></span><span style="display:flex;"><span>[root@ansible httpd]# cat tasks/install_httpd.yml 
</span></span><span style="display:flex;"><span>- name: install httpd
</span></span><span style="display:flex;"><span>  yum: name=httpd
</span></span><span style="display:flex;"><span>[root@ansible httpd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 拷贝配置文件
</span></span><span style="display:flex;"><span>#注意: 文件是放在files目录下,但src的路径无需写files目录名
</span></span><span style="display:flex;"><span>[root@ansible htppd]# cat tasks/config.yml
</span></span><span style="display:flex;"><span>- name: httpd config
</span></span><span style="display:flex;"><span>  copy: src=httpd.conf dest=/etc/httpd/conf backup=yes
</span></span><span style="display:flex;"><span>  notify: restart httpd
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> # 准备测试文件
</span></span><span style="display:flex;"><span>[root@ansible htppd]# cat tasks/index.yml 
</span></span><span style="display:flex;"><span>- name: copy index.html
</span></span><span style="display:flex;"><span>  copy: src=index.html dest=/var/www/html
</span></span><span style="display:flex;"><span>[root@ansible htppd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># start httpd
</span></span><span style="display:flex;"><span>[root@ansible htppd]# cat tasks/service.yml 
</span></span><span style="display:flex;"><span>- name: start httpd
</span></span><span style="display:flex;"><span>  service: name=httpd state=started enabled=yes
</span></span><span style="display:flex;"><span>[root@ansible htppd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 配置文件修改则重启httpd
</span></span><span style="display:flex;"><span>[root@ansible htppd]# cat handlers/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># handlers file for httpd
</span></span><span style="display:flex;"><span>- name: restart httpd
</span></span><span style="display:flex;"><span>  service: name=httpd state=restarted
</span></span><span style="display:flex;"><span>[root@ansible htppd]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#在files目录下准备两个文件
</span></span><span style="display:flex;"><span>[root@ansible data]# ll httpd/files
</span></span><span style="display:flex;"><span>total 16
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root 11753 Mar  1 18:36 httpd.conf
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root    23 Mar  1 21:10 index.html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 准备变量文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat httpd/vars/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># vars file for httpd
</span></span><span style="display:flex;"><span>httpd_group: apache
</span></span><span style="display:flex;"><span>httpd_gid: 88
</span></span><span style="display:flex;"><span>httpd_user: apache
</span></span><span style="display:flex;"><span>httpd_uid: 88
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#在playbook中调用角色
</span></span><span style="display:flex;"><span>[root@ansible data]# cat web_roles.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - httpd
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>#运行playbook
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-playbook /data/web_roles.yml
</span></span></code></pre></div><h4 id="实现nginx角色">实现Nginx角色<a hidden class="anchor" aria-hidden="true" href="#实现nginx角色">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 创建roles目录
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-galaxy init nginx
</span></span><span style="display:flex;"><span>- Role nginx was created successfully
</span></span><span style="display:flex;"><span>[root@ansible data]# ll
</span></span><span style="display:flex;"><span>total 12
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root  614 Mar  1 21:07 ansible.cfg
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root 1382 Mar  1 21:07 hosts
</span></span><span style="display:flex;"><span>drwxr-xr-x 10 root root  154 Mar  1 18:07 httpd
</span></span><span style="display:flex;"><span>drwxr-xr-x 10 root root  154 Mar  1 21:52 nginx
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root   63 Mar  1 21:14 web_roles.yml
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建tasks文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/tasks/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># tasks file for nginx
</span></span><span style="display:flex;"><span>- include: install_nginx.yml
</span></span><span style="display:flex;"><span>- import_playbook: config.yml
</span></span><span style="display:flex;"><span>- include: index.yml
</span></span><span style="display:flex;"><span>- import_playbook: service.yml
</span></span><span style="display:flex;"><span>[root@ansible data]#
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 安装nginx
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/tasks/install_nginx.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: install nginx
</span></span><span style="display:flex;"><span>  yum:
</span></span><span style="display:flex;"><span>    name: nginx
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 配置文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/tasks/config.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: copy config
</span></span><span style="display:flex;"><span>  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>  notify: restart nginx
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span># 创建测试文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/tasks/index.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: copt index.html
</span></span><span style="display:flex;"><span>  copy: src=index.html dest=/usr/share/nginx/html/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 启动nginx
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/tasks/service.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: start nginx
</span></span><span style="display:flex;"><span>  service: name=nginx state=started enabled=yes
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>#创建handler文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat nginx/handlers/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># handlers file for nginx
</span></span><span style="display:flex;"><span>- name: restart nginx
</span></span><span style="display:flex;"><span>  service: naem=nginx state=restarted
</span></span><span style="display:flex;"><span>[root@ansible data]# ll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#创建template文件
</span></span><span style="display:flex;"><span>[root@ansible data]# ll nginx/templates/
</span></span><span style="display:flex;"><span>total 4
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root 2336 Mar  1 22:12 nginx.conf.j2
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建测试文件
</span></span><span style="display:flex;"><span>[root@ansible data]# ll nginx/files/
</span></span><span style="display:flex;"><span>total 4
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root 23 Mar  1 22:14 index.html
</span></span><span style="display:flex;"><span>[root@ansible data]#
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#在playbook中调用角色
</span></span><span style="display:flex;"><span>[root@ansible data]# cat web_roles.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>  #  - httpd
</span></span><span style="display:flex;"><span>    - nginx
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>#运行playbook
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-playbook web_roles.yml 
</span></span></code></pre></div><h4 id="实现mysql8角色">实现MySql8角色<a hidden class="anchor" aria-hidden="true" href="#实现mysql8角色">#</a></h4>
<ul>
<li>创建角色目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[root@ansible data]# ansible-galaxy init mysql8
</span></span><span style="display:flex;"><span>[root@ansible data]# ll
</span></span><span style="display:flex;"><span>total 12
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root  614 Mar  1 21:07 ansible.cfg
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root 1382 Mar  1 21:07 hosts
</span></span><span style="display:flex;"><span>drwxr-xr-x 10 root root  154 Mar  1 18:07 httpd
</span></span><span style="display:flex;"><span>drwxr-xr-x 10 root root  154 Mar  1 22:55 mysql8
</span></span><span style="display:flex;"><span>drwxr-xr-x  8 root root  125 Mar  1 22:44 nginx
</span></span><span style="display:flex;"><span>-rw-r--r--  1 root root   75 Mar  1 22:38 web_roles.yml
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span></code></pre></div><ul>
<li>创建tasks yml文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 安装包
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/install_package.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: install package
</span></span><span style="display:flex;"><span>  yum: name={{ item }} state=latest
</span></span><span style="display:flex;"><span>  loop:
</span></span><span style="display:flex;"><span>    - libaio
</span></span><span style="display:flex;"><span>    - numactl-libs
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span># add group
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/group.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: add group
</span></span><span style="display:flex;"><span>  group: name={{ group }} gid={{ group_gid }}
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># add user
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/user.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: add user
</span></span><span style="display:flex;"><span>  user: name={{ user }} uid={{ user_uid }} shell=/sbin/nologin group={{ group }} create_home=no system=yes home=/data/mysql
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 准备my.cnf文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/files/my.cnf
</span></span><span style="display:flex;"><span>[mysqld]
</span></span><span style="display:flex;"><span>server-id=1
</span></span><span style="display:flex;"><span>log-bin
</span></span><span style="display:flex;"><span>datadir=/data/mysql
</span></span><span style="display:flex;"><span>socket=/data/mysql/mysql.sock
</span></span><span style="display:flex;"><span>log-error=/data/mysql/mysql.log
</span></span><span style="display:flex;"><span>pid-file=/data/mysql/mysql.pid
</span></span><span style="display:flex;"><span>[client]
</span></span><span style="display:flex;"><span>socket=/data/mysql/mysql.sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 准备mysql二进制包
</span></span><span style="display:flex;"><span>[root@ansible data]# ll mysql8/files/
</span></span><span style="display:flex;"><span>total 1176056
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root        181 Mar  1 23:10 my.cnf
</span></span><span style="display:flex;"><span>-rw-r--r-- 1 root root 1204277208 Dec 18  2021 mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 将mysql二进制包解压到远程主机
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/unarchive.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: copy mysql tar host
</span></span><span style="display:flex;"><span>  # mysql_tar 为mysql二进制的压缩包名称
</span></span><span style="display:flex;"><span>  unarchive: src={{ mysql_tar }} dest=/usr/local/ owner=root group=root
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 将远程主机解压出的二进制包创建软连接
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/linkfile.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: create link
</span></span><span style="display:flex;"><span>  file: src=/usr/local/mysql-{{ mysql_version }}-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 初始化数据库
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/init_mysql_data.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: create datadir dir
</span></span><span style="display:flex;"><span>  file: path=/data/mysql state=directory owner={{ user }} group={{ group }
</span></span><span style="display:flex;"><span>- name: init mysql data
</span></span><span style="display:flex;"><span>  shell: /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --datadir=/data/mysql
</span></span><span style="display:flex;"><span>[root@ansible data]#
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># copy config.con
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/config.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: copy my.cnf
</span></span><span style="display:flex;"><span>  copy: src=my.cnf dest=/etc/my.cnf
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/script.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: service script
</span></span><span style="display:flex;"><span>  shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/path.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: path
</span></span><span style="display:flex;"><span>  copy: content=&#39;PATH=/usr/local/mysql/bin:$PATH&#39; dest=/etc/profile.d/mysql.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/service.yml
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: service
</span></span><span style="display:flex;"><span>  shell: chkconfig --add mysqld;/etc/init.d/mysqld start
</span></span><span style="display:flex;"><span>[root@ansible data]#
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/tasks/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># tasks file for mysql8
</span></span><span style="display:flex;"><span>- include: install_package.yml
</span></span><span style="display:flex;"><span>- include: group.yml
</span></span><span style="display:flex;"><span>- include: user.yml
</span></span><span style="display:flex;"><span>- include: unarchive.yml
</span></span><span style="display:flex;"><span>- include: linkfile.yml
</span></span><span style="display:flex;"><span>- include: linkfile.yml
</span></span><span style="display:flex;"><span>- include: init_mysql_data.yml
</span></span><span style="display:flex;"><span>- include: config.yml
</span></span><span style="display:flex;"><span>- include: script.yml
</span></span><span style="display:flex;"><span>- include: path.yml
</span></span><span style="display:flex;"><span>- include: service.yml
</span></span><span style="display:flex;"><span>- include: secure.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建变量文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat mysql8/vars/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># vars file for mysql8
</span></span><span style="display:flex;"><span>group: mysql
</span></span><span style="display:flex;"><span>group_gid: 306
</span></span><span style="display:flex;"><span>user: mysql
</span></span><span style="display:flex;"><span>user_uid: 306
</span></span><span style="display:flex;"><span>mysql_tar: mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz
</span></span><span style="display:flex;"><span>mysql_version: 8.0.28
</span></span><span style="display:flex;"><span>mysql_root_password: 123456
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 调用角色
</span></span><span style="display:flex;"><span>[root@ansible data]# cat web_roles.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - mysql8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 运行
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-playbook web_roles.yml
</span></span></code></pre></div><h4 id="实现redis角色">实现Redis角色<a hidden class="anchor" aria-hidden="true" href="#实现redis角色">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 创建角色目录
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-galaxy init redis
</span></span><span style="display:flex;"><span>[root@ansible data]# tree redis/
</span></span><span style="display:flex;"><span>redis/
</span></span><span style="display:flex;"><span>├── defaults
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── files
</span></span><span style="display:flex;"><span>├── handlers
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── meta
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── tasks
</span></span><span style="display:flex;"><span>│   └── main.yml
</span></span><span style="display:flex;"><span>├── templates
</span></span><span style="display:flex;"><span>├── tests
</span></span><span style="display:flex;"><span>│   ├── inventory
</span></span><span style="display:flex;"><span>│   └── test.yml
</span></span><span style="display:flex;"><span>└── vars
</span></span><span style="display:flex;"><span>    └── main.yml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span># 创建tasks文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat redis/tasks/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># tasks file for redis
</span></span><span style="display:flex;"><span>- name: Installed Redis Server
</span></span><span style="display:flex;"><span>  yum:
</span></span><span style="display:flex;"><span>    name: redis
</span></span><span style="display:flex;"><span>    state: present
</span></span><span style="display:flex;"><span>- name: Configure Redis Server
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    src: redis.conf.j2
</span></span><span style="display:flex;"><span>    dest: /etc/redis.conf
</span></span><span style="display:flex;"><span>    owner: redis
</span></span><span style="display:flex;"><span>    group: root
</span></span><span style="display:flex;"><span>    mode: &#39;0640&#39;
</span></span><span style="display:flex;"><span>  notify: Restart Redis Server
</span></span><span style="display:flex;"><span>- name: Start Redis Server
</span></span><span style="display:flex;"><span>  systemd:
</span></span><span style="display:flex;"><span>    name: redis
</span></span><span style="display:flex;"><span>    state: started
</span></span><span style="display:flex;"><span>    enabled: yes
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 创建handlers文件
</span></span><span style="display:flex;"><span>[root@ansible data]# cat redis/handlers/main.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span># handlers file for redis
</span></span><span style="display:flex;"><span>- name: Restart Redis Server
</span></span><span style="display:flex;"><span>  systemd:
</span></span><span style="display:flex;"><span>    name: redis
</span></span><span style="display:flex;"><span>    state: restarted
</span></span><span style="display:flex;"><span>[root@ansible data]# 
</span></span><span style="display:flex;"><span># 在/data/redis/templates目录下准备如下文件
</span></span><span style="display:flex;"><span>[root@ansible data]# ll redis/templates/
</span></span><span style="display:flex;"><span>total 48
</span></span><span style="display:flex;"><span>-rw-r----- 1 root root 46729 Mar  2 02:51 redis.conf.j2
</span></span><span style="display:flex;"><span>[root@ansible data]#
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 调用角色
</span></span><span style="display:flex;"><span># 调用角色
</span></span><span style="display:flex;"><span>[root@ansible data]# cat web_roles.yml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: centos7
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 运行
</span></span><span style="display:flex;"><span>[root@ansible data]# ansible-playbook web_roles.yml
</span></span></code></pre></div><h2 id="ansible推荐学习资料">Ansible推荐学习资料<a hidden class="anchor" aria-hidden="true" href="#ansible推荐学习资料">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>http://galaxy.ansible.com
</span></span><span style="display:flex;"><span>https://galaxy.ansible.com/explore#/
</span></span><span style="display:flex;"><span>http://github.com/
</span></span><span style="display:flex;"><span>http://ansible.com.cn/
</span></span><span style="display:flex;"><span>https://github.com/ansible/ansible
</span></span><span style="display:flex;"><span>https://github.com/ansible/ansible-examples
</span></span></code></pre></div>

        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="http://hugo.itshare.work/posts/zabbix/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/">
    <span class="title">« 上一页</span>
    <br>
    <span>zabbix5部署安装</span>
  </a>
  <a class="next" href="http://hugo.itshare.work/posts/ansible/ansible/">
    <span class="title">下一页 »</span>
    <br>
    <span>运维自动化工具Ansible(一)</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="http://hugo.itshare.work/" style="color:#939393;">Cookie</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
