<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>搭建Kubernetes集群 | Cookie</title>
<meta name="keywords" content="Kubernetes">
<meta name="description" content="Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理">
<meta name="author" content="Cookie">
<link rel="canonical" href="http://hugo.itshare.work/posts/kubernetes/%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://hugo.itshare.work/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://hugo.itshare.work/img/Q.gif">
<link rel="apple-touch-icon" href="http://hugo.itshare.work/img/Q.gif">
<link rel="mask-icon" href="http://hugo.itshare.work/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="搭建Kubernetes集群" />
<meta property="og:description" content="Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hugo.itshare.work/posts/kubernetes/%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4/" />
<meta property="og:image" content="http://oss.itshare.work/itshare-work-images/6.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-21T00:17:58+08:00" />
<meta property="article:modified_time" content="2022-03-21T00:17:58+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://oss.itshare.work/itshare-work-images/6.jpg" />
<meta name="twitter:title" content="搭建Kubernetes集群"/>
<meta name="twitter:description" content="Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "http://hugo.itshare.work/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "📕 Kubernetes",
          "item": "http://hugo.itshare.work/posts/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "搭建Kubernetes集群",
      "item": "http://hugo.itshare.work/posts/kubernetes/%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "搭建Kubernetes集群",
  "name": "搭建Kubernetes集群",
  "description": "Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理",
  "keywords": [
    "Kubernetes"
  ],
  "articleBody": "搭建Kubernetes集群 部署前提 使用kubeadm部署Kubernetes集群的前提条件 支持Kubernetes运行的Linux主机，例如Debian、RedHat及其变体等 每主机2GB以上的内存，以及2颗以上的CPU 各主机间能够通过网络无障碍通信 独占的hostname、MAC地址以及product_uuid，主机名能够正常解析 放行由Kubernetes使用到的各端口，或直接禁用iptables 禁用各主机的上的Swap设备 各主机时间同步 部署环境 OS: Ubuntu 20.04.2 LTS Docker：20.10.10，CGroup Driver: systemd Kubernetes：v1.26.3, CRI: containerd, CNI: Flannel 主机 主机IP 主机名称 角色 192.168.32.200 k8s-master01.org master 192.168.32.203 k8s-node01.org node01 192.168.32.204 k8s-node02.org node02 192.168.32.205 k8s-node03.org node03 修改主机名称 # 修改192.168.32.200的主机名称为k8s-master01.org # 修改192.168.32.203的主机名称为k8s-node01.org # 修改192.168.32.204的主机名称为k8s-node02.org # 修改192.168.32.205的主机名称为k8s-node03.org 主机时间同步 在所有主机上安装 chrony\n## 所有主机上执行 root@k8s-master01:~# apt install -y chrony 建议用户配置使用本地的的时间服务器，在节点数量众多时尤其如此。存在可用的本地时间服务器时，修改节点的/etc/chrony/chrony.conf配置文件，并将时间服务器指向相应的主机即可，配置格式如下：\nserver CHRONY-SERVER-NAME-OR-IP iburst 主机名称解析 出于简化配置步骤的目的，本测试环境使用hosts文件进行各节点名称解析，文件内容如下所示。其中，我们使用kubeapi主机名作为API Server在高可用环境中的专用接入名称，也为控制平面的高可用配置留下便于配置的余地。\n# 编辑/etc/hosts文件加入如下内容 root@k8s-master01:~# vim /etc/hosts 192.168.32.200 k8s-master01.org 192.168.32.203 k8s-node01.org 192.168.32.204 k8s-node02.org 192.168.32.205 k8s-node03.org 禁用Swap设备 部署集群时，kubeadm默认会预先检查当前主机是否禁用了Swap设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的Swap设备，否则，就需要在后文的kubeadm init及kubeadm join命令执行时额外使用相关的选项忽略检查错误。\n关闭Swap设备，需要分两步完成。首先是关闭当前已启用的所有Swap设备：\n# 临时关闭，所有机器执行 root@k8s-master01:~# swapoff -a 而后编辑/etc/fstab配置文件，注释用于挂载Swap设备的所有行\n# 所有机器执行 root@k8s-master01:~#vim /etc/fstab # 注释如下一行 #/swap.img none swap sw 0 0 禁用默认的防火墙服务 Ubuntu和Debian等Linux发行版默认使用ufw（Uncomplicated FireWall）作为前端来简化 iptables的使用，处于启用状态时，它默认会生成一些规则以加强系统安全。出于降低配置复杂度之目的，本文选择直接将其禁用。\nroot@k8s-master01:~# ufw disable Firewall stopped and disabled on system startup root@k8s-master01:~# ufw status Status: inactive root@k8s-master01:~# 安装程序包 提示：以下操作需要在本示例中的所有四台主机上分别进行\n安装并启动docker 首先，生成docker-ce相关程序包的仓库，这里以阿里云的镜像服务器为例进行说明\ndocker-ce镜像_docker-ce下载地址_docker-ce安装教程-阿里巴巴开源镜像站 (aliyun.com)\n# step 1: 安装必要的一些系统工具 sudo apt-get update sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common # step 2: 安装GPG证书 curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - # Step 3: 写入软件源信息 sudo add-apt-repository \"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable\" # Step 4: 更新并安装Docker-CE sudo apt-get -y update sudo apt-get -y install docker-ce # 安装指定版本的Docker-CE: # Step 1: 查找Docker-CE的版本: # apt-cache madison docker-ce # docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages # docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages # Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial) # sudo apt-get -y install docker-ce=[VERSION] 本文以为20.10.10版本为例\nroot@k8s-node3:~# apt install docker-ce=5:20.10.10~3-0~ubuntu-focal docker-ce-cli=5:20.10.10~3-0~ubuntu-focal kubelet需要让docker容器引擎使用systemd作为CGroup的驱动，其默认值为cgroupfs，因而，我们还需要编辑docker的配置文件/etc/docker/daemon.json，添加如下内容，其中的registry-mirrors用于指明使用的镜像加速服务。\nvim /etc/docker/daemon.json { \"registry-mirrors\": [ \"https://ung2thfc.mirror.aliyuncs.com\", \"https://mirror.ccs.tencentyun.com\", \"https://registry.docker-cn.com\", \"http://hub-mirror.c.163.com\", \"https://docker.mirrors.ustc.edu.cn\"], \"exec-opts\": [\"native.cgroupdriver=systemd\"] } systemctl daemon-reload \u0026\u0026 systemctl restart docker 安装cri-dockerd Kubernetes自v1.24移除了对docker-shim的支持，而Docker Engine默认又不支持CRI规范，因而二者将无法直接完成整合。为此，Mirantis和Docker联合创建了cri-dockerd项目，用于为Docker Engine提供一个能够支持到CRI规范的垫片，从而能够让Kubernetes基于CRI控制Docker 。\n项目地址\ncri-dockerd项目提供了预制的二进制格式的程序包，用户按需下载相应的系统和对应平台的版本即可完成安装，这里以Ubuntu 2004 64bits系统环境，以及cri-dockerd目前最新的程序版本v0.3.0为例。\nwget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.0/cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb dpkg -i cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb 完成安装后，相应的服务cri-dockerd.service便会自动启动。我们也可以使用如下命令进行验证，若服务处于Running状态即可进行后续步骤 。\nroot@k8s-master01:~# systemctl status cri-docker.service ● cri-docker.service - CRI Interface for Docker Application Container Engine Loaded: loaded (/lib/systemd/system/cri-docker.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2023-03-21 10:59:57 CST; 1min 20s ago TriggeredBy: ● cri-docker.socket Docs: https://docs.mirantis.com Main PID: 17591 (cri-dockerd) Tasks: 7 Memory: 11.9M CGroup: /system.slice/cri-docker.service └─17591 /usr/bin/cri-dockerd --container-runtime-endpoint fd:// Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Start docker client with request timeout 0s\" Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Hairpin mode is set to none\" Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Loaded network plugin cni\" Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Docker cri networking managed by network plugin cni\" Mar 21 10:59:57 k8s-master01.org systemd[1]: Started CRI Interface for Docker Application Container Engine. Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Docker Info: \u0026{ID:WQBA:P7R2:H6ZI:KWU3:FVFW:MHLC:QTT7:CJCX\u003e Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Setting cgroupDriver cgroupfs\" Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Docker cri received runtime config \u0026RuntimeConfig{Network\u003e Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Starting the GRPC backend for the Docker CRI interface.\" Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=\"2023-03-21T10:59:57+08:00\" level=info msg=\"Start cri-dockerd grpc backend\" lines 1-21/21 (END) 安装kubelet、kubeadm和kubectl 首先，在各主机上生成kubelet和kubeadm等相关程序包的仓库，这里以阿里云的镜像服务为例\napt-get update \u0026\u0026 apt-get install -y apt-transport-https curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - cat \u003c/etc/apt/sources.list.d/kubernetes.list deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main EOF apt-get update apt-get install -y kubelet kubeadm kubectl 安装完成后，要确保kubeadm等程序文件的版本，这将也是后面初始化Kubernetes集群时需要明确指定的版本号\n整合kubelet和cri-dockerd 仅支持CRI规范的kubelet需要经由遵循该规范的cri-dockerd完成与docker-ce的整合。\n配置cri-dockerd 配置cri-dockerd，确保其能够正确加载到CNI插件。编辑/usr/lib/systemd/system/cri-docker.service文件，确保其[Service]配置段中的ExecStart的值类似如下内容\nExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7 --cni-bin-dir=/opt/cni/bin --cni-cache-dir=/var/lib/cni/cache --cni-conf-dir=/etc/cni/net.d 需要添加的各配置参数（各参数的值要与系统部署的CNI插件的实际路径相对应）：\n–network-plugin：指定网络插件规范的类型，这里要使用CNI； –cni-bin-dir：指定CNI插件二进制程序文件的搜索目录； –cni-cache-dir：CNI插件使用的缓存目录； –cni-conf-dir：CNI插件加载配置文件的目录； 配置完成后，重载并重启cri-docker.service服务。\nroot@k8s-master01:~# systemctl daemon-reload;systemctl restart cri-docker 配置kubelet 配置kubelet，为其指定cri-dockerd在本地打开的Unix Sock文件的路径，该路径一般默认为“/run/cri-dockerd.sock“。编辑文件/etc/sysconfig/kubelet，为其添加 如下指定参数。\n提示：若/etc/sysconfig目录不存在，则需要先创建该目录。\nKUBELET_KUBEADM_ARGS=\"--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock\" 需要说明的是，该配置也可不进行，而是直接在后面的各kubeadm命令上使用“–cri-socket unix:///run/cri-dockerd.sock”选项。\n初始化第一个主节点 该步骤开始尝试构建Kubernetes集群的master节点，配置完成后，各worker节点直接加入到集群中的即可。需要特别说明的是，由kubeadm部署的Kubernetes集群上，集群核心组件kube-apiserver、kube-controller-manager、kube-scheduler和etcd等均会以静态Pod的形式运行，它们所依赖的镜像文件默认来自于registry.k8s.io这一Registry服务之上。但我们无法直接访问该服务，常用的解决办法有如下两种\n使用能够到达该服务的代理服务； 使用国内的镜像服务器上的服务，例如registry.aliyuncs.com/google_containers等。 初始化master节点（在k8s-master01上完成如下操作） 运行如下命令完成k8s-master01节点的初始化：\nkubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version=v1.26.3 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --token-ttl=0 --cri-socket unix:///run/cri-dockerd.sock 命令中的各选项简单说明如下：\n–image-repository：指定要使用的镜像仓库，默认为registry.k8s.io； –kubernetes-version：kubernetes程序组件的版本号，它必须要与安装的kubelet程序包的版本号相同； –control-plane-endpoint：控制平面的固定访问端点，可以是IP地址或DNS名称，会被用于集群管理员及集群组件的kubeconfig配置文件的API Server的访问地址；单控制平面部署时可以不使用该选项； –pod-network-cidr：Pod网络的地址范围，其值为CIDR格式的网络地址，通常，Flannel网络插件的默认为10.244.0.0/16，Project Calico插件的默认值为192.168.0.0/16； –service-cidr：Service的网络地址范围，其值为CIDR格式的网络地址，默认为10.96.0.0/12；通常，仅Flannel一类的网络插件需要手动指定该地址； –apiserver-advertise-address：apiserver通告给其他组件的IP地址，一般应该为Master节点的用于集群内部通信的IP地址，0.0.0.0表示节点上所有可用地址； –token-ttl：共享令牌（token）的过期时长，默认为24小时，0表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在token过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建token，并生成节点加入命令。 初始化完成后的操作步骤 对于Kubernetes系统的新用户来说，无论使用上述哪种方法，命令运行结束后，请记录最后的kubeadm join命令输出的最后提示的操作步骤。下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要的操作步骤。\n# 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤 Your Kubernetes control-plane has initialized successfully! # 为了完成初始化操作，管理员需要额外手动完成几个必要的步骤 To start using your cluster, you need to run the following as a regular user: # 第1个步骤提示， Kubernetes集群管理员认证到Kubernetes集群时使用的kubeconfig配置文件 mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config # 我们也可以不做上述设定，而使用环境变量KUBECONFIG为kubectl等指定默认使用的kubeconfig； Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf # 第2个步骤提示，为Kubernetes集群部署一个网络插件，具体选用的插件则取决于管理员； You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ # 第3个步骤提示，向集群添加额外的控制平面节点，但本文会略过该步骤，并将在其它文章介绍其实现方式。 You can now join any number of the control-plane node running the following command on each as root: # 第4个步骤提示，向集群添加工作节点 Then you can join any number of worker nodes by running the following on each as root: # 在部署好kubeadm等程序包的各工作节点上以root用户运行类似如下命令； # 提示：与cri-dockerd结合使用docker-ce作为container runtime时，通常需要为下面的命令 # 额外附加“--cri-socket unix:///run/cri-dockerd.sock”选项； kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 \\ --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d 设定kubectl kubectl是kube-apiserver的命令行客户端程序，实现了除系统部署之外的几乎全部的管理操作，是kubernetes管理员使用最多的命令之一。kubectl需经由API server认证及授权后方能执行相应的管理操作，kubeadm部署的集群为其生成了一个具有管理员权限的认证配置文件/etc/kubernetes/admin.conf，它可由kubectl通过默认的“$HOME/.kube/config”的路径进行加载。当然，用户也可在kubectl命令上使用–kubeconfig选项指定一个别的位置。\n下面复制认证为Kubernetes系统管理员的配置文件至目标用户（例如当前用户root）的家目录下：\n~# mkdir ~/.kube\n~# cp /etc/kubernetes/admin.conf ~/.kube/config\n部署网络插件 Kubernetes系统上Pod网络的实现依赖于第三方插件进行，这类插件有近数十种之多，较为著名的有flannel、calico、canal和kube-router等，简单易用的实现是为CoreOS提供的flannel项目。下面的命令用于在线部署flannel至Kubernetes系统之上：\n首先，下载适配系统及硬件平台环境的flanneld至每个节点，并放置于/opt/bin/目录下。我们这里选用flanneld-amd64，目前最新的版本为v0.21.3，因而，我们需要在集群的每个节点上执行如下命令：\n~# mkdir /opt/cni/bin/ ~# curl -L https://github.com/flannel-io/flannel/releases/download/v0.20.2/flanneld-amd64 -o /opt/cni/bin/flanneld ~# chmod +x /opt/cni/bin/flanneld 提示：下载flanneld的地址为 https://github.com/flannel-io/flannel/releases 随后，在初始化的第一个master节点k8s-master01上运行如下命令，向Kubernetes部署kube-flannel\nkubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/v0.21.3/Documentation/kube-flannel.yml 而后使用如下命令确认其输出结果中Pod的状态为“Running”，类似如下命令及其输入的结果所示：\nroot@k8s-master01:~# kubectl get pods -n kube-flannel NAME READY STATUS RESTARTS AGE kube-flannel-ds-jgkxd 1/1 Running 0 2m59s root@k8s-master01:~# 验证master节点已经就绪 kubectl get nodes\n上述命令应该会得到类似如下输出，这表示k8s-master01节点已经就绪\nroot@k8s-master01:~# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master01.org Ready control-plane 62m v1.26.3 root@k8s-master01:~# 添加节点到集群中 下面的两个步骤，需要分别在k8s-node01、k8s-node02和k8s-node03上各自完成。\n1、若未禁用Swap设备，编辑kubelet的配置文件/etc/default/kubelet，设置其忽略Swap启用的状态错误，内容如下：KUBELET_EXTRA_ARGS=\"–fail-swap-on=false\"\n2、将节点加入第二步中创建的master的集群中，要使用主节点初始化过程中记录的kubeadm join命令；\nroot@k8s-node01:/opt/cni/bin# kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d --cri-socket unix:///run/cri-dockerd.sock 验证节点添加结果 在每个节点添加完成后，即可通过kubectl验证添加结果。下面的命令及其输出是在所有的三个节点均添加完成后运行的，其输出结果表明三个Worker Node已经准备就绪。\n~# kubectl get nodes\nroot@k8s-master01:~# kubectl get nodes NAME STATUS ROLES AGE VERSION k8s-master01.org Ready control-plane 80m v1.26.3 k8s-node01.org Ready 15m v1.26.3 k8s-node2.org Ready 114s v1.26.3 k8s-node3.org Ready 11m v1.26.3 root@k8s-master01:~# 测试应用编排及服务访问 到此为止，一个master，并附带有三个worker的kubernetes集群基础设施已经部署完成，用户随后即可测试其核心功能。\nroot@k8s-master01:~# kubectl create deployment test-nginx --image=nginx:latest --replicas=3 deployment.apps/test-nginx created root@k8s-master01:~# root@k8s-master01:~# kubectl create service nodeport test-nginx --tcp=80:80 service/test-nginx created root@k8s-master01:~# 而后，使用如下命令了解Service对象test-nginx使用的NodePort，以便于在集群外部进行访问：\nroot@k8s-master01:~# kubectl get svc -l app=test-nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE test-nginx NodePort 10.100.229.239 80:31888/TCP 50s root@k8s-master01:~# 因此，用户可以于集群外部通过\"http://NodeIP:31888\"这个URL访问we应用，例如于集群外通过浏览器访问\"http://192.168.32.203:31888\" 小结 本文给出了部署Kubernetes分布式集群的具体步骤，并在最后测试了将应用部署并运行于Kubernetes系统上的结果。在读者朋友们自行测试时，cri-dockerd、docker-ce、flannel、kubeadm、kubectl和kubelet的版本均可能存在版本上的不同，也因此可能会存在一定程度上的配置差异，具体调整方式请大家自行参考相关的文档进行\n",
  "wordCount" : "6501",
  "inLanguage": "en",
  "image":"http://oss.itshare.work/itshare-work-images/6.jpg","datePublished": "2022-03-21T00:17:58+08:00",
  "dateModified": "2022-03-21T00:17:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "Cookie"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://hugo.itshare.work/posts/kubernetes/%E6%90%AD%E5%BB%BAkubernetes%E9%9B%86%E7%BE%A4/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie",
    "logo": {
      "@type": "ImageObject",
      "url": "http://hugo.itshare.work/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://hugo.itshare.work/" accesskey="h" title="Cookie (Alt + H)">
            <img src="http://hugo.itshare.work/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Cookie</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://hugo.itshare.work/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://hugo.itshare.work/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="http://hugo.itshare.work/">🏠 主页</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/">📚文章</a>&nbsp;»&nbsp;<a href="http://hugo.itshare.work/posts/kubernetes/">📕 Kubernetes</a></div>
            <h1 class="post-title">
                搭建Kubernetes集群
            </h1>
            <div class="post-description">
                Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2022-03-21
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>6501字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>13分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Cookie
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="http://hugo.itshare.work/tags/kubernetes/" style="color: var(--secondary)!important;">Kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "http://hugo.itshare.work/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="http://oss.itshare.work/itshare-work-images/6.jpg" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%90%ad%e5%bb%bakubernetes%e9%9b%86%e7%be%a4" aria-label="搭建Kubernetes集群">搭建Kubernetes集群</a><ul>
                        
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2%e5%89%8d%e6%8f%90" aria-label="部署前提">部署前提</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2%e7%8e%af%e5%a2%83" aria-label="部署环境">部署环境</a></li>
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9%e4%b8%bb%e6%9c%ba%e5%90%8d%e7%a7%b0" aria-label="修改主机名称">修改主机名称</a></li>
                <li>
                    <a href="#%e4%b8%bb%e6%9c%ba%e6%97%b6%e9%97%b4%e5%90%8c%e6%ad%a5" aria-label="主机时间同步">主机时间同步</a></li>
                <li>
                    <a href="#%e4%b8%bb%e6%9c%ba%e5%90%8d%e7%a7%b0%e8%a7%a3%e6%9e%90" aria-label="主机名称解析">主机名称解析</a></li>
                <li>
                    <a href="#%e7%a6%81%e7%94%a8swap%e8%ae%be%e5%a4%87" aria-label="禁用Swap设备">禁用Swap设备</a></li>
                <li>
                    <a href="#%e7%a6%81%e7%94%a8%e9%bb%98%e8%ae%a4%e7%9a%84%e9%98%b2%e7%81%ab%e5%a2%99%e6%9c%8d%e5%8a%a1" aria-label="禁用默认的防火墙服务">禁用默认的防火墙服务</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e7%a8%8b%e5%ba%8f%e5%8c%85" aria-label="安装程序包">安装程序包</a><ul>
                        
                <li>
                    <a href="#%e5%ae%89%e8%a3%85%e5%b9%b6%e5%90%af%e5%8a%a8docker" aria-label="安装并启动docker">安装并启动docker</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85cri-dockerd" aria-label="安装cri-dockerd">安装cri-dockerd</a></li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85kubeletkubeadm%e5%92%8ckubectl" aria-label="安装kubelet、kubeadm和kubectl">安装kubelet、kubeadm和kubectl</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e5%90%88kubelet%e5%92%8ccri-dockerd" aria-label="整合kubelet和cri-dockerd">整合kubelet和cri-dockerd</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecri-dockerd" aria-label="配置cri-dockerd">配置cri-dockerd</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aekubelet" aria-label="配置kubelet">配置kubelet</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%b8%bb%e8%8a%82%e7%82%b9" aria-label="初始化第一个主节点">初始化第一个主节点</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96master%e8%8a%82%e7%82%b9%e5%9c%a8k8s-master01%e4%b8%8a%e5%ae%8c%e6%88%90%e5%a6%82%e4%b8%8b%e6%93%8d%e4%bd%9c" aria-label="初始化master节点（在k8s-master01上完成如下操作）">初始化master节点（在k8s-master01上完成如下操作）</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%ae%8c%e6%88%90%e5%90%8e%e7%9a%84%e6%93%8d%e4%bd%9c%e6%ad%a5%e9%aa%a4" aria-label="初始化完成后的操作步骤">初始化完成后的操作步骤</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%ae%be%e5%ae%9akubectl" aria-label="设定kubectl">设定kubectl</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6" aria-label="部署网络插件">部署网络插件</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81master%e8%8a%82%e7%82%b9%e5%b7%b2%e7%bb%8f%e5%b0%b1%e7%bb%aa" aria-label="验证master节点已经就绪">验证master节点已经就绪</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e8%8a%82%e7%82%b9%e5%88%b0%e9%9b%86%e7%be%a4%e4%b8%ad" aria-label="添加节点到集群中">添加节点到集群中</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e8%8a%82%e7%82%b9%e6%b7%bb%e5%8a%a0%e7%bb%93%e6%9e%9c" aria-label="验证节点添加结果">验证节点添加结果</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e5%ba%94%e7%94%a8%e7%bc%96%e6%8e%92%e5%8f%8a%e6%9c%8d%e5%8a%a1%e8%ae%bf%e9%97%ae" aria-label="测试应用编排及服务访问">测试应用编排及服务访问</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="搭建kubernetes集群">搭建Kubernetes集群<a hidden class="anchor" aria-hidden="true" href="#搭建kubernetes集群">#</a></h1>
<h2 id="部署前提">部署前提<a hidden class="anchor" aria-hidden="true" href="#部署前提">#</a></h2>
<ul>
<li>使用kubeadm部署Kubernetes集群的前提条件</li>
<li>支持Kubernetes运行的Linux主机，例如Debian、RedHat及其变体等</li>
<li>每主机2GB以上的内存，以及2颗以上的CPU</li>
<li>各主机间能够通过网络无障碍通信</li>
<li>独占的hostname、MAC地址以及product_uuid，主机名能够正常解析</li>
<li>放行由Kubernetes使用到的各端口，或直接禁用iptables</li>
<li>禁用各主机的上的Swap设备</li>
<li>各主机时间同步</li>
</ul>
<h2 id="部署环境">部署环境<a hidden class="anchor" aria-hidden="true" href="#部署环境">#</a></h2>
<ul>
<li>OS: Ubuntu 20.04.2 LTS</li>
<li>Docker：20.10.10，CGroup Driver: systemd</li>
<li>Kubernetes：v1.26.3, CRI: containerd, CNI: Flannel</li>
<li>主机</li>
</ul>
<table>
<thead>
<tr>
<th>主机IP</th>
<th>主机名称</th>
<th>角色</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.32.200</td>
<td>k8s-master01.org</td>
<td>master</td>
</tr>
<tr>
<td>192.168.32.203</td>
<td>k8s-node01.org</td>
<td>node01</td>
</tr>
<tr>
<td>192.168.32.204</td>
<td>k8s-node02.org</td>
<td>node02</td>
</tr>
<tr>
<td>192.168.32.205</td>
<td>k8s-node03.org</td>
<td>node03</td>
</tr>
</tbody>
</table>
<h2 id="修改主机名称">修改主机名称<a hidden class="anchor" aria-hidden="true" href="#修改主机名称">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 修改192.168.32.200的主机名称为k8s-master01.org</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改192.168.32.203的主机名称为k8s-node01.org</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改192.168.32.204的主机名称为k8s-node02.org</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改192.168.32.205的主机名称为k8s-node03.org</span>
</span></span></code></pre></div><h2 id="主机时间同步">主机时间同步<a hidden class="anchor" aria-hidden="true" href="#主机时间同步">#</a></h2>
<p>在所有主机上安装 chrony</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">## 所有主机上执行</span>
</span></span><span style="display:flex;"><span>root@k8s-master01:~# apt install -y chrony
</span></span></code></pre></div><p>建议用户配置使用本地的的时间服务器，在节点数量众多时尤其如此。存在可用的本地时间服务器时，修改节点的/etc/chrony/chrony.conf配置文件，并将时间服务器指向相应的主机即可，配置格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>server CHRONY-SERVER-NAME-OR-IP iburst
</span></span></code></pre></div><h2 id="主机名称解析">主机名称解析<a hidden class="anchor" aria-hidden="true" href="#主机名称解析">#</a></h2>
<p>出于简化配置步骤的目的，本测试环境使用hosts文件进行各节点名称解析，文件内容如下所示。其中，我们使用kubeapi主机名作为API Server在高可用环境中的专用接入名称，也为控制平面的高可用配置留下便于配置的余地。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 编辑/etc/hosts文件加入如下内容</span>
</span></span><span style="display:flex;"><span>root@k8s-master01:~# vim /etc/hosts
</span></span><span style="display:flex;"><span>192.168.32.200 k8s-master01.org
</span></span><span style="display:flex;"><span>192.168.32.203 k8s-node01.org
</span></span><span style="display:flex;"><span>192.168.32.204 k8s-node02.org
</span></span><span style="display:flex;"><span>192.168.32.205 k8s-node03.org
</span></span></code></pre></div><h2 id="禁用swap设备">禁用Swap设备<a hidden class="anchor" aria-hidden="true" href="#禁用swap设备">#</a></h2>
<p>部署集群时，kubeadm默认会预先检查当前主机是否禁用了Swap设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的Swap设备，否则，就需要在后文的kubeadm init及kubeadm join命令执行时额外使用相关的选项忽略检查错误。</p>
<p>关闭Swap设备，需要分两步完成。首先是关闭当前已启用的所有Swap设备：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 临时关闭，所有机器执行</span>
</span></span><span style="display:flex;"><span>root@k8s-master01:~# swapoff -a
</span></span></code></pre></div><p>而后编辑/etc/fstab配置文件，注释用于挂载Swap设备的所有行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 所有机器执行</span>
</span></span><span style="display:flex;"><span>root@k8s-master01:~#vim /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注释如下一行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#/swap.img      none    swap    sw      0       0</span>
</span></span></code></pre></div><h2 id="禁用默认的防火墙服务">禁用默认的防火墙服务<a hidden class="anchor" aria-hidden="true" href="#禁用默认的防火墙服务">#</a></h2>
<p>Ubuntu和Debian等Linux发行版默认使用ufw（Uncomplicated FireWall）作为前端来简化 iptables的使用，处于启用状态时，它默认会生成一些规则以加强系统安全。出于降低配置复杂度之目的，本文选择直接将其禁用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# ufw disable
</span></span><span style="display:flex;"><span>Firewall stopped and disabled on system startup
</span></span><span style="display:flex;"><span>root@k8s-master01:~# ufw status
</span></span><span style="display:flex;"><span>Status: inactive
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><h2 id="安装程序包">安装程序包<a hidden class="anchor" aria-hidden="true" href="#安装程序包">#</a></h2>
<p>提示：以下操作需要在本示例中的所有四台主机上分别进行</p>
<h3 id="安装并启动docker">安装并启动docker<a hidden class="anchor" aria-hidden="true" href="#安装并启动docker">#</a></h3>
<p>首先，生成docker-ce相关程序包的仓库，这里以阿里云的镜像服务器为例进行说明<br>
<a href="https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11ewAl2r">docker-ce镜像_docker-ce下载地址_docker-ce安装教程-阿里巴巴开源镜像站 (aliyun.com)</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># step 1: 安装必要的一些系统工具</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
</span></span><span style="display:flex;"><span><span style="color:#75715e"># step 2: 安装GPG证书</span>
</span></span><span style="display:flex;"><span>curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: 写入软件源信息</span>
</span></span><span style="display:flex;"><span>sudo add-apt-repository <span style="color:#e6db74">&#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: 更新并安装Docker-CE</span>
</span></span><span style="display:flex;"><span>sudo apt-get -y update
</span></span><span style="display:flex;"><span>sudo apt-get -y install docker-ce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装指定版本的Docker-CE:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: 查找Docker-CE的版本:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># apt-cache madison docker-ce</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sudo apt-get -y install docker-ce=[VERSION]</span>
</span></span></code></pre></div><p>本文以为20.10.10版本为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-node3:~# apt install docker-ce<span style="color:#f92672">=</span>5:20.10.10~3-0~ubuntu-focal docker-ce-cli<span style="color:#f92672">=</span>5:20.10.10~3-0~ubuntu-focal
</span></span></code></pre></div><p>kubelet需要让docker容器引擎使用systemd作为CGroup的驱动，其默认值为cgroupfs，因而，我们还需要编辑docker的配置文件/etc/docker/daemon.json，添加如下内容，其中的registry-mirrors用于指明使用的镜像加速服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vim /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;https://ung2thfc.mirror.aliyuncs.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;https://mirror.ccs.tencentyun.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;https://registry.docker-cn.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;http://hub-mirror.c.163.com&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;https://docker.mirrors.ustc.edu.cn&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl restart docker
</span></span></code></pre></div><h2 id="安装cri-dockerd">安装cri-dockerd<a hidden class="anchor" aria-hidden="true" href="#安装cri-dockerd">#</a></h2>
<p>Kubernetes自v1.24移除了对docker-shim的支持，而Docker Engine默认又不支持CRI规范，因而二者将无法直接完成整合。为此，Mirantis和Docker联合创建了cri-dockerd项目，用于为Docker Engine提供一个能够支持到CRI规范的垫片，从而能够让Kubernetes基于CRI控制Docker 。</p>
<p><a href="https://github.com/Mirantis/cri-dockerd">项目地址</a></p>
<p>cri-dockerd项目提供了预制的二进制格式的程序包，用户按需下载相应的系统和对应平台的版本即可完成安装，这里以Ubuntu 2004 64bits系统环境，以及cri-dockerd目前最新的程序版本v0.3.0为例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.0/cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dpkg -i cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb
</span></span></code></pre></div><p>完成安装后，相应的服务cri-dockerd.service便会自动启动。我们也可以使用如下命令进行验证，若服务处于Running状态即可进行后续步骤 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# systemctl status cri-docker.service
</span></span><span style="display:flex;"><span>● cri-docker.service - CRI Interface <span style="color:#66d9ef">for</span> Docker Application Container Engine
</span></span><span style="display:flex;"><span>     Loaded: loaded <span style="color:#f92672">(</span>/lib/systemd/system/cri-docker.service; enabled; vendor preset: enabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>     Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since Tue 2023-03-21 10:59:57 CST; 1min 20s ago
</span></span><span style="display:flex;"><span>TriggeredBy: ● cri-docker.socket
</span></span><span style="display:flex;"><span>       Docs: https://docs.mirantis.com
</span></span><span style="display:flex;"><span>   Main PID: <span style="color:#ae81ff">17591</span> <span style="color:#f92672">(</span>cri-dockerd<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      Tasks: <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>     Memory: 11.9M
</span></span><span style="display:flex;"><span>     CGroup: /system.slice/cri-docker.service
</span></span><span style="display:flex;"><span>             └─17591 /usr/bin/cri-dockerd --container-runtime-endpoint fd://
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:57 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Start docker client with request timeout 0s&#34;</span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:57 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Hairpin mode is set to none&#34;</span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:57 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Loaded network plugin cni&#34;</span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:57 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Docker cri networking managed by network plugin cni&#34;</span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:57 k8s-master01.org systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Started CRI Interface <span style="color:#66d9ef">for</span> Docker Application Container Engine.
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:58 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Docker Info: &amp;{ID:WQBA:P7R2:H6ZI:KWU3:FVFW:MHLC:QTT7:CJCX&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=&#34;</span>2023-03-21T10:59:57+08:00<span style="color:#e6db74">&#34; level=info msg=&#34;</span>Setting cgroupDriver cgroupfs<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=&#34;</span>2023-03-21T10:59:57+08:00<span style="color:#e6db74">&#34; level=info msg=&#34;</span>Docker cri received runtime config &amp;RuntimeConfig<span style="color:#f92672">{</span>Network&gt;
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:58 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Starting the GRPC backend for the Docker CRI interface.&#34;</span>
</span></span><span style="display:flex;"><span>Mar <span style="color:#ae81ff">21</span> 10:59:58 k8s-master01.org cri-dockerd<span style="color:#f92672">[</span>17591<span style="color:#f92672">]</span>: time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2023-03-21T10:59:57+08:00&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Start cri-dockerd grpc backend&#34;</span>
</span></span><span style="display:flex;"><span>lines 1-21/21 <span style="color:#f92672">(</span>END<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="安装kubeletkubeadm和kubectl">安装kubelet、kubeadm和kubectl<a hidden class="anchor" aria-hidden="true" href="#安装kubeletkubeadm和kubectl">#</a></h2>
<p>首先，在各主机上生成kubelet和kubeadm等相关程序包的仓库，这里以阿里云的镜像服务为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y apt-transport-https
</span></span><span style="display:flex;"><span>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - 
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y kubelet kubeadm kubectl
</span></span></code></pre></div><p>安装完成后，要确保kubeadm等程序文件的版本，这将也是后面初始化Kubernetes集群时需要明确指定的版本号</p>
<h3 id="整合kubelet和cri-dockerd">整合kubelet和cri-dockerd<a hidden class="anchor" aria-hidden="true" href="#整合kubelet和cri-dockerd">#</a></h3>
<p>仅支持CRI规范的kubelet需要经由遵循该规范的cri-dockerd完成与docker-ce的整合。</p>
<h3 id="配置cri-dockerd">配置cri-dockerd<a hidden class="anchor" aria-hidden="true" href="#配置cri-dockerd">#</a></h3>
<p>配置cri-dockerd，确保其能够正确加载到CNI插件。编辑/usr/lib/systemd/system/cri-docker.service文件，确保其[Service]配置段中的ExecStart的值类似如下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin<span style="color:#f92672">=</span>cni --pod-infra-container-image<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers/pause:3.7 --cni-bin-dir<span style="color:#f92672">=</span>/opt/cni/bin --cni-cache-dir<span style="color:#f92672">=</span>/var/lib/cni/cache --cni-conf-dir<span style="color:#f92672">=</span>/etc/cni/net.d
</span></span></code></pre></div><p>需要添加的各配置参数（各参数的值要与系统部署的CNI插件的实际路径相对应）：</p>
<ul>
<li>&ndash;network-plugin：指定网络插件规范的类型，这里要使用CNI；</li>
<li>&ndash;cni-bin-dir：指定CNI插件二进制程序文件的搜索目录；</li>
<li>&ndash;cni-cache-dir：CNI插件使用的缓存目录；</li>
<li>&ndash;cni-conf-dir：CNI插件加载配置文件的目录；</li>
</ul>
<p>配置完成后，重载并重启cri-docker.service服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# systemctl daemon-reload;systemctl restart cri-docker
</span></span></code></pre></div><h2 id="配置kubelet">配置kubelet<a hidden class="anchor" aria-hidden="true" href="#配置kubelet">#</a></h2>
<p>配置kubelet，为其指定cri-dockerd在本地打开的Unix Sock文件的路径，该路径一般默认为“/run/cri-dockerd.sock“。编辑文件/etc/sysconfig/kubelet，为其添加 如下指定参数。</p>
<blockquote>
<p>提示：若/etc/sysconfig目录不存在，则需要先创建该目录。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>KUBELET_KUBEADM_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock&#34;</span>
</span></span></code></pre></div><p>需要说明的是，该配置也可不进行，而是直接在后面的各kubeadm命令上使用“&ndash;cri-socket unix:///run/cri-dockerd.sock”选项。</p>
<h3 id="初始化第一个主节点">初始化第一个主节点<a hidden class="anchor" aria-hidden="true" href="#初始化第一个主节点">#</a></h3>
<p>该步骤开始尝试构建Kubernetes集群的master节点，配置完成后，各worker节点直接加入到集群中的即可。需要特别说明的是，由kubeadm部署的Kubernetes集群上，集群核心组件kube-apiserver、kube-controller-manager、kube-scheduler和etcd等均会以静态Pod的形式运行，它们所依赖的镜像文件默认来自于registry.k8s.io这一Registry服务之上。但我们无法直接访问该服务，常用的解决办法有如下两种</p>
<ul>
<li>使用能够到达该服务的代理服务；</li>
<li>使用国内的镜像服务器上的服务，例如registry.aliyuncs.com/google_containers等。</li>
</ul>
<h3 id="初始化master节点在k8s-master01上完成如下操作">初始化master节点（在k8s-master01上完成如下操作）<a hidden class="anchor" aria-hidden="true" href="#初始化master节点在k8s-master01上完成如下操作">#</a></h3>
<p>运行如下命令完成k8s-master01节点的初始化：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version<span style="color:#f92672">=</span>v1.26.3 --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16 --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 --token-ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> --cri-socket unix:///run/cri-dockerd.sock
</span></span></code></pre></div><p>命令中的各选项简单说明如下：</p>
<ul>
<li>&ndash;image-repository：指定要使用的镜像仓库，默认为registry.k8s.io；</li>
<li>&ndash;kubernetes-version：kubernetes程序组件的版本号，它必须要与安装的kubelet程序包的版本号相同；</li>
<li>&ndash;control-plane-endpoint：控制平面的固定访问端点，可以是IP地址或DNS名称，会被用于集群管理员及集群组件的kubeconfig配置文件的API Server的访问地址；单控制平面部署时可以不使用该选项；</li>
<li>&ndash;pod-network-cidr：Pod网络的地址范围，其值为CIDR格式的网络地址，通常，Flannel网络插件的默认为10.244.0.0/16，Project Calico插件的默认值为192.168.0.0/16；</li>
<li>&ndash;service-cidr：Service的网络地址范围，其值为CIDR格式的网络地址，默认为10.96.0.0/12；通常，仅Flannel一类的网络插件需要手动指定该地址；</li>
<li>&ndash;apiserver-advertise-address：apiserver通告给其他组件的IP地址，一般应该为Master节点的用于集群内部通信的IP地址，0.0.0.0表示节点上所有可用地址；</li>
<li>&ndash;token-ttl：共享令牌（token）的过期时长，默认为24小时，0表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在token过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建token，并生成节点加入命令。</li>
</ul>
<h4 id="初始化完成后的操作步骤">初始化完成后的操作步骤<a hidden class="anchor" aria-hidden="true" href="#初始化完成后的操作步骤">#</a></h4>
<p>对于Kubernetes系统的新用户来说，无论使用上述哪种方法，命令运行结束后，请记录最后的kubeadm join命令输出的最后提示的操作步骤。下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要的操作步骤。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤</span>
</span></span><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为了完成初始化操作，管理员需要额外手动完成几个必要的步骤</span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第1个步骤提示， Kubernetes集群管理员认证到Kubernetes集群时使用的kubeconfig配置文件</span>
</span></span><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 我们也可以不做上述设定，而使用环境变量KUBECONFIG为kubectl等指定默认使用的kubeconfig；</span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第2个步骤提示，为Kubernetes集群部署一个网络插件，具体选用的插件则取决于管理员；</span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第3个步骤提示，向集群添加额外的控制平面节点，但本文会略过该步骤，并将在其它文章介绍其实现方式。</span>
</span></span><span style="display:flex;"><span>You can now join any number of the control-plane node running the following command on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 第4个步骤提示，向集群添加工作节点</span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在部署好kubeadm等程序包的各工作节点上以root用户运行类似如下命令；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 提示：与cri-dockerd结合使用docker-ce作为container runtime时，通常需要为下面的命令</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     额外附加“--cri-socket unix:///run/cri-dockerd.sock”选项；</span>
</span></span><span style="display:flex;"><span>kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--discovery-token-ca-cert-hash
</span></span><span style="display:flex;"><span>sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d
</span></span></code></pre></div><h3 id="设定kubectl">设定kubectl<a hidden class="anchor" aria-hidden="true" href="#设定kubectl">#</a></h3>
<p>kubectl是kube-apiserver的命令行客户端程序，实现了除系统部署之外的几乎全部的管理操作，是kubernetes管理员使用最多的命令之一。kubectl需经由API server认证及授权后方能执行相应的管理操作，kubeadm部署的集群为其生成了一个具有管理员权限的认证配置文件/etc/kubernetes/admin.conf，它可由kubectl通过默认的“$HOME/.kube/config”的路径进行加载。当然，用户也可在kubectl命令上使用&ndash;kubeconfig选项指定一个别的位置。</p>
<p>下面复制认证为Kubernetes系统管理员的配置文件至目标用户（例如当前用户root）的家目录下：</p>
<p>~# mkdir ~/.kube</p>
<p>~# cp /etc/kubernetes/admin.conf  ~/.kube/config</p>
<h3 id="部署网络插件">部署网络插件<a hidden class="anchor" aria-hidden="true" href="#部署网络插件">#</a></h3>
<p>Kubernetes系统上Pod网络的实现依赖于第三方插件进行，这类插件有近数十种之多，较为著名的有flannel、calico、canal和kube-router等，简单易用的实现是为CoreOS提供的flannel项目。下面的命令用于在线部署flannel至Kubernetes系统之上：</p>
<p>首先，下载适配系统及硬件平台环境的flanneld至每个节点，并放置于/opt/bin/目录下。我们这里选用flanneld-amd64，目前最新的版本为v0.21.3，因而，我们需要在集群的每个节点上执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>~# mkdir /opt/cni/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# curl -L https://github.com/flannel-io/flannel/releases/download/v0.20.2/flanneld-amd64  -o /opt/cni/bin/flanneld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# chmod +x /opt/cni/bin/flanneld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>提示：下载flanneld的地址为 https://github.com/flannel-io/flannel/releases
</span></span></code></pre></div><p>随后，在初始化的第一个master节点k8s-master01上运行如下命令，向Kubernetes部署kube-flannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/v0.21.3/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>而后使用如下命令确认其输出结果中Pod的状态为“Running”，类似如下命令及其输入的结果所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~#  kubectl get pods -n kube-flannel
</span></span><span style="display:flex;"><span>NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-flannel-ds-jgkxd   1/1     Running   <span style="color:#ae81ff">0</span>          2m59s
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><h3 id="验证master节点已经就绪">验证master节点已经就绪<a hidden class="anchor" aria-hidden="true" href="#验证master节点已经就绪">#</a></h3>
<p>kubectl get nodes</p>
<p>上述命令应该会得到类似如下输出，这表示k8s-master01节点已经就绪</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# kubectl get nodes
</span></span><span style="display:flex;"><span>NAME               STATUS   ROLES           AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01.org   Ready    control-plane   62m   v1.26.3
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><h3 id="添加节点到集群中">添加节点到集群中<a hidden class="anchor" aria-hidden="true" href="#添加节点到集群中">#</a></h3>
<p>下面的两个步骤，需要分别在k8s-node01、k8s-node02和k8s-node03上各自完成。</p>
<p>1、若未禁用Swap设备，编辑kubelet的配置文件/etc/default/kubelet，设置其忽略Swap启用的状态错误，内容如下：KUBELET_EXTRA_ARGS=&quot;&ndash;fail-swap-on=false&quot;</p>
<p>2、将节点加入第二步中创建的master的集群中，要使用主节点初始化过程中记录的kubeadm join命令；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-node01:/opt/cni/bin# kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d --cri-socket unix:///run/cri-dockerd.sock
</span></span></code></pre></div><h3 id="验证节点添加结果">验证节点添加结果<a hidden class="anchor" aria-hidden="true" href="#验证节点添加结果">#</a></h3>
<p>在每个节点添加完成后，即可通过kubectl验证添加结果。下面的命令及其输出是在所有的三个节点均添加完成后运行的，其输出结果表明三个Worker Node已经准备就绪。</p>
<p>~# kubectl get nodes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# kubectl get nodes
</span></span><span style="display:flex;"><span>NAME               STATUS   ROLES           AGE    VERSION
</span></span><span style="display:flex;"><span>k8s-master01.org   Ready    control-plane   80m    v1.26.3
</span></span><span style="display:flex;"><span>k8s-node01.org     Ready    &lt;none&gt;          15m    v1.26.3
</span></span><span style="display:flex;"><span>k8s-node2.org      Ready    &lt;none&gt;          114s   v1.26.3
</span></span><span style="display:flex;"><span>k8s-node3.org      Ready    &lt;none&gt;          11m    v1.26.3
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><h3 id="测试应用编排及服务访问">测试应用编排及服务访问<a hidden class="anchor" aria-hidden="true" href="#测试应用编排及服务访问">#</a></h3>
<p>到此为止，一个master，并附带有三个worker的kubernetes集群基础设施已经部署完成，用户随后即可测试其核心功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# kubectl create deployment test-nginx --image<span style="color:#f92672">=</span>nginx:latest --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>deployment.apps/test-nginx created
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span><span style="display:flex;"><span>root@k8s-master01:~# kubectl create service nodeport test-nginx --tcp<span style="color:#f92672">=</span>80:80
</span></span><span style="display:flex;"><span>service/test-nginx created
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><p>而后，使用如下命令了解Service对象test-nginx使用的NodePort，以便于在集群外部进行访问：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@k8s-master01:~# kubectl get svc -l app<span style="color:#f92672">=</span>test-nginx
</span></span><span style="display:flex;"><span>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>test-nginx   NodePort   10.100.229.239   &lt;none&gt;        80:31888/TCP   50s
</span></span><span style="display:flex;"><span>root@k8s-master01:~# 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span> 因此，用户可以于集群外部通过&#34;http://NodeIP:31888&#34;这个URL访问we应用，例如于集群外通过浏览器访问&#34;http://192.168.32.203:31888&#34;  
</span></span></code></pre></div><p><img loading="lazy" src="../image.assets/1679388005874.png" alt="1679388005874"  />
</p>
<h2 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h2>
<p>本文给出了部署Kubernetes分布式集群的具体步骤，并在最后测试了将应用部署并运行于Kubernetes系统上的结果。在读者朋友们自行测试时，cri-dockerd、docker-ce、flannel、kubeadm、kubectl和kubelet的版本均可能存在版本上的不同，也因此可能会存在一定程度上的配置差异，具体调整方式请大家自行参考相关的文档进行</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="http://hugo.itshare.work/posts/docker/docker/">
    <span class="title">« 上一页</span>
    <br>
    <span>Docker基础详细教程</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="http://hugo.itshare.work/" style="color:#939393;">Cookie</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"Cookie"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
